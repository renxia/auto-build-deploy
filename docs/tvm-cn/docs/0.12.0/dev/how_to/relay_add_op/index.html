<!doctype html><html lang=zh-Hans dir=ltr class="docs-wrapper plugin-docs plugin-id-default docs-version-0.12.0 docs-doc-page docs-doc-id-dev/how_to/relay_add_op" data-has-hydrated=false><meta charset=UTF-8><meta name=generator content="Docusaurus v3.7.0"><title data-rh=true>向 Relay 中添加算子 | Apache TVM 中文站</title><meta data-rh=true name=viewport content="width=device-width, initial-scale=1.0"><meta data-rh=true name=twitter:card content=summary_large_image><meta data-rh=true property=og:url content=https://lzw.me/docs/tvm-cn/docs/0.12.0/dev/how_to/relay_add_op><meta data-rh=true property=og:locale content=zh_Hans><meta data-rh=true name=docusaurus_locale content=zh-Hans><meta data-rh=true name=docsearch:language content=zh-Hans><meta data-rh=true name=docusaurus_version content=0.12.0><meta data-rh=true name=docusaurus_tag content=docs-default-0.12.0><meta data-rh=true name=docsearch:version content=0.12.0><meta data-rh=true name=docsearch:docusaurus_tag content=docs-default-0.12.0><meta data-rh=true property=og:title content="向 Relay 中添加算子 | Apache TVM 中文站"><meta data-rh=true name=description content="本文档将以添加 cumulative product 算子的 PR（基于 cumulative sum 算子 PR）为例，介绍在 Relay 中注册一个新的 TVM 算子所需的步骤。"><meta data-rh=true property=og:description content="本文档将以添加 cumulative product 算子的 PR（基于 cumulative sum 算子 PR）为例，介绍在 Relay 中注册一个新的 TVM 算子所需的步骤。"><link data-rh=true rel=icon href=/docs/tvm-cn/img/favicon.png><link data-rh=true rel=canonical href=https://lzw.me/docs/tvm-cn/docs/0.12.0/dev/how_to/relay_add_op><link data-rh=true rel=alternate href=https://lzw.me/docs/tvm-cn/docs/0.12.0/dev/how_to/relay_add_op hreflang=zh-Hans><link data-rh=true rel=alternate href=https://lzw.me/docs/tvm-cn/docs/0.12.0/dev/how_to/relay_add_op hreflang=x-default><link data-rh=true rel=preconnect href=https://KU6TD2KAGA-dsn.algolia.net crossorigin=anonymous><link rel=preconnect href=https://www.google-analytics.com><link rel=preconnect href=https://www.googletagmanager.com><script async src="https://www.googletagmanager.com/gtag/js?id=GTM-TVRNTQWL"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","GTM-TVRNTQWL",{})</script><link rel=search type=application/opensearchdescription+xml title="Apache TVM 中文站" href=/docs/tvm-cn/opensearch.xml><link rel=stylesheet href=https://fastly.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css type=text/css integrity=sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM crossorigin=anonymous><script src=https://lzw.me/x/lib/utils/h5-common.js defer data-domain=lzw.me></script><link rel=stylesheet href=/docs/tvm-cn/assets/css/styles.d660bc20.css><script src=/docs/tvm-cn/assets/js/runtime~main.412de774.js defer></script><script src=/docs/tvm-cn/assets/js/main.60e49e7b.js defer></script><body class=navigation-with-keyboard><script>!function(){var t,e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t=null!==e?e:window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":(window.matchMedia("(prefers-color-scheme: light)").matches,"light"),document.documentElement.setAttribute("data-theme",t)}(),function(){try{for(var[t,e]of new URLSearchParams(window.location.search).entries())if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id=__docusaurus><link rel=preload as=image href=/docs/tvm-cn/img/favicon-dark.svg><link rel=preload as=image href=/docs/tvm-cn/img/favicon.svg><div role=region aria-label=跳到主要内容><a class=skipToContent_ZYxR href=#__docusaurus_skipToContent_fallback>跳到主要内容</a></div><nav aria-label=主导航 class="navbar navbar--fixed-top"><div class=navbar__inner><div class=navbar__items><button aria-label=切换导航栏 aria-expanded=false class="navbar__toggle clean-btn" type=button><svg width=30 height=30 viewBox="0 0 30 30" aria-hidden=true><path stroke=currentColor stroke-linecap=round stroke-miterlimit=10 stroke-width=2 d="M4 7h22M4 15h22M4 23h22"/></svg></button><a class=navbar__brand href=/docs/tvm-cn/><div class=navbar__logo><img src=/docs/tvm-cn/img/favicon-dark.svg alt="TVM Logo" class="themedComponent_PKz1 themedComponent--light_TYnW"><img src=/docs/tvm-cn/img/favicon.svg alt="TVM Logo" class="themedComponent_PKz1 themedComponent--dark_RKZm"></div><b class="navbar__title text--truncate">TVM 中文站</b></a><a aria-current=page class="navbar__item navbar__link navbar__link--active" href=/docs/tvm-cn/docs/0.12.0/>查看文档</a><a class="navbar__item navbar__link" href=/docs/tvm-cn/about>关于</a><a href=https://tool.lzw.me target=_blank rel="noopener noreferrer" class="navbar__item navbar__link">有趣工具箱<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_wR_l><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><a href=https://lzw.me/x/reference/ target=_blank rel="noopener noreferrer" class="navbar__item navbar__link">IT速查清单<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_wR_l><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a></div><div class="navbar__items navbar__items--right"><a href=https://github.com/hyperai/tvm-cn target=_blank rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_wR_l><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class=navbar__link aria-haspopup=true aria-expanded=false role=button href=/docs/tvm-cn/docs/0.12.0/dev/how_to/relay_add_op>0.12.0</a><ul class=dropdown__menu><li><a class=dropdown__link href=/docs/tvm-cn/docs/dev/how_to/relay_add_op>0.13.0</a><li><a aria-current=page class="dropdown__link dropdown__link--active" href=/docs/tvm-cn/docs/0.12.0/dev/how_to/relay_add_op>0.12.0</a><li><a class=dropdown__link href=/docs/tvm-cn/docs/0.10.0/dev/how_to/relay_add_op>0.10.0</a></ul></div><div class="toggle_azEg colorModeToggle_ACQd"><button class="clean-btn toggleButton_rDEP toggleButtonDisabled_BTpm" type=button disabled title=切换浅色/暗黑模式（当前为浅色模式） aria-label=切换浅色/暗黑模式（当前为浅色模式） aria-live=polite aria-pressed=false><svg viewBox="0 0 24 24" width=24 height=24 class=lightToggleIcon_FWei><path fill=currentColor d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"/></svg><svg viewBox="0 0 24 24" width=24 height=24 class=darkToggleIcon_OH98><path fill=currentColor d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"/></svg></button></div><div class=navbarSearchContainer_CQDF><button type=button class="DocSearch DocSearch-Button" aria-label="搜索 (Command+K)"><span class=DocSearch-Button-Container><svg width=20 height=20 class=DocSearch-Search-Icon viewBox="0 0 20 20" aria-hidden=true><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke=currentColor fill=none fill-rule=evenodd stroke-linecap=round stroke-linejoin=round /></svg><span class=DocSearch-Button-Placeholder>搜索</span></span><span class=DocSearch-Button-Keys></span></button></div></div></div><div role=presentation class=navbar-sidebar__backdrop></div></nav><div id=__docusaurus_skipToContent_fallback class="main-wrapper mainWrapper_YyXw"><div class=docsWrapper_QpQH><button aria-label=回到顶部 class="clean-btn theme-back-to-top-button backToTopButton_J2hp" type=button></button><div class=docRoot_e4fL><aside class="theme-doc-sidebar-container docSidebarContainer_lAUu"><div class=sidebarViewport_u_LW><div class=sidebar_CdZN><nav aria-label=文档侧边栏 class="menu thin-scrollbar menu_MbTs"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class=menu__link href=/docs/tvm-cn/docs/0.12.0/>欢迎</a><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class=menu__list-item-collapsible><a class=menu__link>快速上手</a></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/docs/tvm-cn/docs/0.12.0/install>安装 TVM</a><button aria-label="展开侧边栏分类 '安装 TVM'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/docs/tvm-cn/docs/0.12.0/contribute>贡献指南</a><button aria-label="展开侧边栏分类 '贡献指南'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div></ul><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class=menu__list-item-collapsible><a class=menu__link>用户手册</a></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/docs/tvm-cn/docs/0.12.0/tutorial>用户教程</a><button aria-label="展开侧边栏分类 '用户教程'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/docs/tvm-cn/docs/0.12.0/how_to>常见问题</a><button aria-label="展开侧边栏分类 '常见问题'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div></ul><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--active">开发手册</a></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/docs/tvm-cn/docs/0.12.0/dev/>开发者教程</a><button aria-label="展开侧边栏分类 '开发者教程'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--active" tabindex=0 href=/docs/tvm-cn/docs/0.12.0/dev/how_to>开发者指南</a><button aria-label="折叠侧边栏分类 '开发者指南'" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/docs/tvm-cn/docs/0.12.0/dev/how_to/debugging_tvm>调试 TVM</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current=page tabindex=0 href=/docs/tvm-cn/docs/0.12.0/dev/how_to/relay_add_op>向 Relay 中添加算子</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/docs/tvm-cn/docs/0.12.0/dev/how_to/relay_add_pass>向 Relay 中添加 Compiler Pass</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/docs/tvm-cn/docs/0.12.0/dev/how_to/relay_bring_your_own_codegen>向 TVM 中添加 Codegen</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/docs/tvm-cn/docs/0.12.0/dev/how_to/python_target_parametrization>Python Target 参数化</a></ul></ul><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class=menu__list-item-collapsible><a class=menu__link>设计与架构</a></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/docs/tvm-cn/docs/0.12.0/arch/>设计与架构</a><button aria-label="展开侧边栏分类 '设计与架构'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div></ul><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class=menu__list-item-collapsible><a class=menu__link>主题指南</a></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/docs/tvm-cn/docs/0.12.0/topic/microtvm/>microTVM：裸机上的 TVM</a><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/docs/tvm-cn/docs/0.12.0/topic/vta>VTA：多功能张量加速器</a><button aria-label="展开侧边栏分类 'VTA：多功能张量加速器'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div></ul></ul></nav></div></div></aside><main class=docMainContainer_ch7h><div class="container padding-top--md padding-bottom--lg"><div class=row><div class="col docItemCol__o6A"><div class="theme-doc-version-banner alert alert--warning margin-bottom--md" role=alert><div>此为 <!-- -->Apache TVM 中文站<!-- --> <b>0.12.0</b> 版的文档，现已不再积极维护。</div><div class=margin-top--md>最新的文档请参阅 <b><a href=/docs/tvm-cn/docs/dev/how_to/relay_add_op>最新版本</a></b> (<!-- -->0.13.0<!-- -->)。</div></div><div class=docItemContainer_Wtch><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_fS1C" aria-label=页面路径><ul class=breadcrumbs itemscope itemtype=https://schema.org/BreadcrumbList><li class=breadcrumbs__item><a aria-label=主页面 class=breadcrumbs__link href=/docs/tvm-cn/><svg viewBox="0 0 24 24" class=breadcrumbHomeIcon_jcRj><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill=currentColor /></svg></a><li class=breadcrumbs__item><span class=breadcrumbs__link>开发手册</span><meta itemprop=position content=1><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class=breadcrumbs__item><a class=breadcrumbs__link itemprop=item href=/docs/tvm-cn/docs/0.12.0/dev/how_to><span itemprop=name>开发者指南</span></a><meta itemprop=position content=2><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class="breadcrumbs__item breadcrumbs__item--active"><span class=breadcrumbs__link itemprop=name>向 Relay 中添加算子</span><meta itemprop=position content=3></ul></nav><span class="theme-doc-version-badge badge badge--secondary">版本：0.12.0</span><div class="tocCollapsible_hZNL theme-doc-toc-mobile tocMobile_UGcD"><button type=button class="clean-btn tocCollapsibleButton_z7oa">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>向 Relay 中添加算子</h1></header>
<p>本文档将以添加 <a href=https://github.com/apache/tvm/pull/7722 target=_blank rel="noopener noreferrer">cumulative product</a> 算子的 PR（基于 <a href=https://github.com/apache/tvm/pull/7334 target=_blank rel="noopener noreferrer">cumulative sum</a> 算子 PR）为例，介绍在 Relay 中注册一个新的 TVM 算子所需的步骤。</p>
<p>注册一个新的算子需要如下几个步骤：</p>
<ol>
<li>添加一个属性节点，声明在编译时已知的固定参数</li>
<li>为算子编写一个类型关系，以整合到 Relay 的类型系统中</li>
<li>使用 C++ 中的 <code>RELAY_REGISTER_OP</code> 宏，为编译器注册算子的数量、类型和其他提示</li>
<li>编写算子的计算方式</li>
<li>用 Relay 注册算子和 schedule</li>
<li>定义一个为算子产生调用节点的 C++ 函数，并为该函数注册一个 Python API hook</li>
<li>将上述 Python API hook 放在一个更简洁的接口中</li>
<li>为新的 Relay 算子编写测试</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_csPL" id=1-定义属性节点>1. 定义属性节点<a href=#1-定义属性节点 class=hash-link aria-label="1. 定义属性节点的直接链接" title="1. 定义属性节点的直接链接">​</a></h2>
<p>属性是在编译时已知的固定参数。卷积算子的步长和扩张可能属于卷积算子属性节点字段的恰当示例。</p>
<p>属性应在文件夹 <a href=https://github.com/apache/tvm/tree/main/include/tvm/relay/attrs target=_blank rel="noopener noreferrer">include/tvm/relay/attrs/</a> 内的文件中定义。</p>
<p>最终我们要创建一个算子，它的接口可以在最终的 Python 接口中清晰可见：</p>
<div class="language-python codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-python codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token keyword" style=color:#00009f>def</span><span class="token plain"> </span><span class="token function" style=color:#d73a49>cumprod</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">data</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> axis</span><span class="token operator" style=color:#393A34>=</span><span class="token boolean" style=color:#36acaa>None</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> dtype</span><span class="token operator" style=color:#393A34>=</span><span class="token boolean" style=color:#36acaa>None</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> exclusive</span><span class="token operator" style=color:#393A34>=</span><span class="token boolean" style=color:#36acaa>None</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token triple-quoted-string string" style=color:#e3116c>"""Numpy style cumprod op. Return the cumulative inclusive product of the elements along a given axis.</span><br></span><span class=token-line style=color:#393A34><span class="token triple-quoted-string string" style=color:#e3116c>    参数</span><br></span><span class=token-line style=color:#393A34><span class="token triple-quoted-string string" style=color:#e3116c>    ----------</span><br></span><span class=token-line style=color:#393A34><span class="token triple-quoted-string string" style=color:#e3116c>    data : relay.Expr 类型</span><br></span><span class=token-line style=color:#393A34><span class="token triple-quoted-string string" style=color:#e3116c>        算子的输入数据。</span><br></span><span class=token-line style=color:#393A34><span class="token triple-quoted-string string" style=color:#e3116c>    axis : int 类型，可选</span><br></span><span class=token-line style=color:#393A34><span class="token triple-quoted-string string" style=color:#e3116c>        Axis along which the cumulative product is computed. The default (None) is to compute the cumprod over the flattened array.</span><br></span><span class=token-line style=color:#393A34><span class="token triple-quoted-string string" style=color:#e3116c>    dtype : string 类型，可选</span><br></span><span class=token-line style=color:#393A34><span class="token triple-quoted-string string" style=color:#e3116c>        Type of the returned array and of the accumulator in which the elements are multiplied.</span><br></span><span class=token-line style=color:#393A34><span class="token triple-quoted-string string" style=color:#e3116c>        如果 dtype 没有被指定, 那么它默认为 data 的 dtype。</span><br></span><span class=token-line style=color:#393A34><span class="token triple-quoted-string string" style=color:#e3116c>    exclusive : bool 类型，可选</span><br></span><span class=token-line style=color:#393A34><span class="token triple-quoted-string string" style=color:#e3116c>        If true will return exclusive product in which the first element is not included. In other terms, if true, the j-th output element would be the product of the first (j-1) elements. Otherwise, it would be the product of the first j elements. The product of zero elements will be 1.</span><br></span><span class=token-line style=color:#393A34><span class="token triple-quoted-string string" style=color:#e3116c>    返回</span><br></span><span class=token-line style=color:#393A34><span class="token triple-quoted-string string" style=color:#e3116c>    -------</span><br></span><span class=token-line style=color:#393A34><span class="token triple-quoted-string string" style=color:#e3116c>    result : relay.Expr 类型</span><br></span><span class=token-line style=color:#393A34><span class="token triple-quoted-string string" style=color:#e3116c>        如果 axis 不为空的话，结果的大小和形状和 data 一样。</span><br></span><span class=token-line style=color:#393A34><span class="token triple-quoted-string string" style=color:#e3116c>        如果 axis 为空的话, 结果是一个一维数组。</span><br></span><span class=token-line style=color:#393A34><span class="token triple-quoted-string string" style=color:#e3116c>    """</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p><code>cumsum()</code> 存在类似的接口。</p>
<p>因此，在 <code>include/tvm/relay/attrs/transform.h</code> 中定义属性时，可以选择算子的 axis、accumulation dtype 及 exclusivity 作为结构体的合适字段。</p>
<div class="language-cpp codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-cpp codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token comment" style=color:#999988;font-style:italic>/*! 用在 cumsum 和 cumprod 算子中的简单属性 */</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>struct</span><span class="token plain"> </span><span class="token class-name">ScanopAttrs</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token base-clause keyword" style=color:#00009f>public</span><span class="token base-clause"> tvm</span><span class="token base-clause double-colon punctuation" style=color:#393A34>::</span><span class="token base-clause class-name">AttrsNode</span><span class="token base-clause operator" style=color:#393A34>&lt;</span><span class="token base-clause class-name">ScanopAttrs</span><span class="token base-clause operator" style=color:#393A34>></span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  Integer axis</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  DataType dtype</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  Bool exclusive </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token function" style=color:#d73a49>Bool</span><span class="token punctuation" style=color:#393A34>(</span><span class="token boolean" style=color:#36acaa>false</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token function" style=color:#d73a49>TVM_DECLARE_ATTRS</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">ScanopAttrs</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"relay.attrs.ScanopAttrs"</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token function" style=color:#d73a49>TVM_ATTR_FIELD</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">axis</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>describe</span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>"The axis to operate over"</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>set_default</span><span class="token punctuation" style=color:#393A34>(</span><span class="token generic-function function" style=color:#d73a49>NullValue</span><span class="token generic-function generic class-name operator" style=color:#393A34>&lt;</span><span class="token generic-function generic class-name">Integer</span><span class="token generic-function generic class-name operator" style=color:#393A34>></span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token function" style=color:#d73a49>TVM_ATTR_FIELD</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">dtype</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>describe</span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>"Output data type"</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>set_default</span><span class="token punctuation" style=color:#393A34>(</span><span class="token generic-function function" style=color:#d73a49>NullValue</span><span class="token generic-function generic class-name operator" style=color:#393A34>&lt;</span><span class="token generic-function generic class-name">DataType</span><span class="token generic-function generic class-name operator" style=color:#393A34>></span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token function" style=color:#d73a49>TVM_ATTR_FIELD</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">exclusive</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>describe</span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>"The first element is not included"</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>set_default</span><span class="token punctuation" style=color:#393A34>(</span><span class="token function" style=color:#d73a49>Bool</span><span class="token punctuation" style=color:#393A34>(</span><span class="token boolean" style=color:#36acaa>false</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>;</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_csPL" id=2-编写类型关系>2. 编写类型关系<a href=#2-编写类型关系 class=hash-link aria-label="2. 编写类型关系的直接链接" title="2. 编写类型关系的直接链接">​</a></h2>
<p>为了提高注册算子的灵活性，在 Relay 中表示类型时更突出，算子使用输入和输出类型之间的关系进行类型化。这些关系被表示为函数，它接收一个输入类型和输出类型的列表（这些类型中的任何一个都可能是不完整的），然后返回一个满足关系的输入和输出类型的列表，包括可以在编译时静态确定的形状信息。基本上，一个算子的关系除了计算输出类型外，还可以执行所有必要的类型化规则（即通过检查输入类型）。</p>
<p>在 <code>src/relay/op/tensor/transform.cc</code> 中可以找到 cumulative product 与 cumulative product 算子的类型关系。</p>
<div class="language-cpp codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-cpp codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token function" style=color:#d73a49>TVM_REGISTER_NODE_TYPE</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">ScanopAttrs</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>bool</span><span class="token plain"> </span><span class="token function" style=color:#d73a49>ScanopRel</span><span class="token punctuation" style=color:#393A34>(</span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> Array</span><span class="token operator" style=color:#393A34>&lt;</span><span class="token plain">Type</span><span class="token operator" style=color:#393A34>></span><span class="token operator" style=color:#393A34>&</span><span class="token plain"> types</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>int</span><span class="token plain"> num_inputs</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> Attrs</span><span class="token operator" style=color:#393A34>&</span><span class="token plain"> attrs</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> TypeReporter</span><span class="token operator" style=color:#393A34>&</span><span class="token plain"> reporter</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token comment" style=color:#999988;font-style:italic>// types: [data, output]</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token function" style=color:#d73a49>ICHECK_EQ</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">types</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>size</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token number" style=color:#36acaa>2</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>&lt;&lt;</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"Expects two types, one for the input and another for the output"</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>auto</span><span class="token operator" style=color:#393A34>*</span><span class="token plain"> data </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> types</span><span class="token punctuation" style=color:#393A34>[</span><span class="token number" style=color:#36acaa>0</span><span class="token punctuation" style=color:#393A34>]</span><span class="token punctuation" style=color:#393A34>.</span><span class="token generic-function function" style=color:#d73a49>as</span><span class="token generic-function generic class-name operator" style=color:#393A34>&lt;</span><span class="token generic-function generic class-name">TensorTypeNode</span><span class="token generic-function generic class-name operator" style=color:#393A34>></span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token keyword" style=color:#00009f>if</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">data </span><span class="token operator" style=color:#393A34>==</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>nullptr</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token function" style=color:#d73a49>ICHECK</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">types</span><span class="token punctuation" style=color:#393A34>[</span><span class="token number" style=color:#36acaa>0</span><span class="token punctuation" style=color:#393A34>]</span><span class="token punctuation" style=color:#393A34>.</span><span class="token generic-function function" style=color:#d73a49>as</span><span class="token generic-function generic class-name operator" style=color:#393A34>&lt;</span><span class="token generic-function generic class-name">IncompleteTypeNode</span><span class="token generic-function generic class-name operator" style=color:#393A34>></span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token operator" style=color:#393A34>&lt;&lt;</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"Scanop: expect input type to be TensorType but get "</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>&lt;&lt;</span><span class="token plain"> types</span><span class="token punctuation" style=color:#393A34>[</span><span class="token number" style=color:#36acaa>0</span><span class="token punctuation" style=color:#393A34>]</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token keyword" style=color:#00009f>return</span><span class="token plain"> </span><span class="token boolean" style=color:#36acaa>false</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>auto</span><span class="token operator" style=color:#393A34>*</span><span class="token plain"> param </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> attrs</span><span class="token punctuation" style=color:#393A34>.</span><span class="token generic-function function" style=color:#d73a49>as</span><span class="token generic-function generic class-name operator" style=color:#393A34>&lt;</span><span class="token generic-function generic class-name">ScanopAttrs</span><span class="token generic-function generic class-name operator" style=color:#393A34>></span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token keyword" style=color:#00009f>auto</span><span class="token plain"> dtype </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> param</span><span class="token operator" style=color:#393A34>-></span><span class="token plain">dtype</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token keyword" style=color:#00009f>if</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">dtype</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>is_void</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        dtype </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> data</span><span class="token operator" style=color:#393A34>-></span><span class="token plain">dtype</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token keyword" style=color:#00009f>if</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">param</span><span class="token operator" style=color:#393A34>-></span><span class="token plain">axis</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>defined</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        reporter</span><span class="token operator" style=color:#393A34>-></span><span class="token function" style=color:#d73a49>Assign</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">types</span><span class="token punctuation" style=color:#393A34>[</span><span class="token number" style=color:#36acaa>1</span><span class="token punctuation" style=color:#393A34>]</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token function" style=color:#d73a49>TensorType</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">data</span><span class="token operator" style=color:#393A34>-></span><span class="token plain">shape</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> dtype</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>else</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token keyword" style=color:#00009f>auto</span><span class="token plain"> prod </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> data</span><span class="token operator" style=color:#393A34>-></span><span class="token plain">shape</span><span class="token punctuation" style=color:#393A34>[</span><span class="token number" style=color:#36acaa>0</span><span class="token punctuation" style=color:#393A34>]</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token keyword" style=color:#00009f>for</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">size_t i </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token number" style=color:#36acaa>1</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> i </span><span class="token operator" style=color:#393A34>&lt;</span><span class="token plain"> data</span><span class="token operator" style=color:#393A34>-></span><span class="token plain">shape</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>size</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>++</span><span class="token plain">i</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            prod </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> prod </span><span class="token operator" style=color:#393A34>*</span><span class="token plain"> data</span><span class="token operator" style=color:#393A34>-></span><span class="token plain">shape</span><span class="token punctuation" style=color:#393A34>[</span><span class="token plain">i</span><span class="token punctuation" style=color:#393A34>]</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        reporter</span><span class="token operator" style=color:#393A34>-></span><span class="token function" style=color:#d73a49>Assign</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">types</span><span class="token punctuation" style=color:#393A34>[</span><span class="token number" style=color:#36acaa>1</span><span class="token punctuation" style=color:#393A34>]</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token function" style=color:#d73a49>TensorType</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain">prod</span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> dtype</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token keyword" style=color:#00009f>return</span><span class="token plain"> </span><span class="token boolean" style=color:#36acaa>true</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>}</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_csPL" id=3-将参数数量和属性与算子关联起来>3. 将参数数量和属性与算子关联起来<a href=#3-将参数数量和属性与算子关联起来 class=hash-link aria-label="3. 将参数数量和属性与算子关联起来的直接链接" title="3. 将参数数量和属性与算子关联起来的直接链接">​</a></h2>
<p>注册新算子的名称，并为其添加调用接口的注解。C++ 中的 <code>RELAY_REGISTER_OP</code> 宏允许开发者在 Relay 中指定一个算子的以下信息：</p>
<ul>
<li>参数数量</li>
<li>位置参数的名称和描述</li>
<li>支持级别（1 表示内部固有的；更高的数字表示集成度低或外部支持的算子）</li>
<li>算子的类型关系</li>
<li>其他在优化算子时有用的注解</li>
</ul>
<p>再次将其添加到 <code>src/relay/op/tensor/transform.cc</code> 中：</p>
<div class="language-cpp codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-cpp codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token function" style=color:#d73a49>RELAY_REGISTER_OP</span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>"cumsum"</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>describe</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token raw-string string" style=color:#e3116c>R"doc(Return the cumulative sum of the elements along a given axis.)doc"</span><span class="token plain"> TVM_ADD_FILELINE</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>set_num_inputs</span><span class="token punctuation" style=color:#393A34>(</span><span class="token number" style=color:#36acaa>1</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>add_argument</span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>"data"</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"Tensor"</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"The input tensor."</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>set_support_level</span><span class="token punctuation" style=color:#393A34>(</span><span class="token number" style=color:#36acaa>3</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>add_type_rel</span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>"Cumsum"</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> ScanopRel</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>.</span><span class="token generic-function function" style=color:#d73a49>set_attr</span><span class="token generic-function generic class-name operator" style=color:#393A34>&lt;</span><span class="token generic-function generic class-name">TOpPattern</span><span class="token generic-function generic class-name operator" style=color:#393A34>></span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>"TOpPattern"</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> kOpaque</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token function" style=color:#d73a49>RELAY_REGISTER_OP</span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>"cumprod"</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>describe</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token raw-string string" style=color:#e3116c>R"doc(Return the cumulative product of the elements along a given axis.)doc"</span><span class="token plain"> TVM_ADD_FILELINE</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>set_num_inputs</span><span class="token punctuation" style=color:#393A34>(</span><span class="token number" style=color:#36acaa>1</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>add_argument</span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>"data"</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"Tensor"</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"The input tensor."</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>set_support_level</span><span class="token punctuation" style=color:#393A34>(</span><span class="token number" style=color:#36acaa>3</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>add_type_rel</span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>"Cumprod"</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> ScanopRel</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>.</span><span class="token generic-function function" style=color:#d73a49>set_attr</span><span class="token generic-function generic class-name operator" style=color:#393A34>&lt;</span><span class="token generic-function generic class-name">TOpPattern</span><span class="token generic-function generic class-name operator" style=color:#393A34>></span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>"TOpPattern"</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> kOpaque</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>在这种情况下，<code>TOpPattern</code> 是对编译器关于算子执行的计算模式的提示，这对于融合算子可能很有用。<code>kOpaque</code> 提示 TVM 无需融合这个算子。</p>
<h2 class="anchor anchorWithStickyNavbar_csPL" id=4-定义算子的计算>4. 定义算子的计算<a href=#4-定义算子的计算 class=hash-link aria-label="4. 定义算子的计算的直接链接" title="4. 定义算子的计算的直接链接">​</a></h2>
<p>为算子定义接口后，仍需定义如何执行 cumulative sum 和 cumulative product 的实际计算。</p>
<p>假设算子计算的实现方式，经过了多轮测试且表现良好。推荐查看 <a href=/docs/tvm-cn/docs/tutorial/tensor_expr>张量表达式教程</a>、<a href=/docs/tvm-cn/docs/tutorial/TOPI>TVM 算子清单（topi）</a>、<a href=https://github.com/apache/tvm/blob/main/python/tvm/topi/scan.py target=_blank rel="noopener noreferrer">python/tvm/topi/scan.py</a> 中 cumulative sum 及 cumulative product 相关实现案例，以及 <a href=https://github.com/apache/tvm/blob/main/python/tvm/topi/cuda/scan.py target=_blank rel="noopener noreferrer">python/tvm/topi/cuda/scan.py</a> 中的 GPU 版本。在 cumulative sum 及 cumulative product 算子中，可以直接用 <a href=https://tvm.apache.org/docs/reference/api/python/tir.html#api-python-tir target=_blank rel="noopener noreferrer">TIR</a>，张量表达式及 topi 降级后表示为 TIR。</p>
<h2 class="anchor anchorWithStickyNavbar_csPL" id=5-将计算compute和策略strategy与-relay-关联起来>5. 将计算（compute）和策略（strategy）与 Relay 关联起来<a href=#5-将计算compute和策略strategy与-relay-关联起来 class=hash-link aria-label="5. 将计算（compute）和策略（strategy）与 Relay 关联起来的直接链接" title="5. 将计算（compute）和策略（strategy）与 Relay 关联起来的直接链接">​</a></h2>
<p>实现计算函数后，需要将其与 Relay 算子粘合在一起。在 TVM 中，这意味着不仅要定义 computation，还要定义算子的 schedule。策略决定使用哪种 computation 及 schedule。例如，对于二维卷积，识别出这属于一种深度卷积后，最终将其分配给一个更有效的 computation 和 schedule。</p>
<p>实际上除了在 CPU 和 GPU 的实现之间进行调度外，基本没有类似需求。在  <code>python/tvm/relay/op/strategy/generic.py</code> 和 <code>python/tvm/relay/op/strategy/cuda.py</code> 中，我们添加了如下策略：</p>
<div class="language-python codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-python codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token keyword" style=color:#00009f>def</span><span class="token plain"> </span><span class="token function" style=color:#d73a49>wrap_compute_scanop</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">topi_compute</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token triple-quoted-string string" style=color:#e3116c>"""Wrap scanop style topi compute"""</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token keyword" style=color:#00009f>def</span><span class="token plain"> </span><span class="token function" style=color:#d73a49>_compute_scanop</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">attrs</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> inputs</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> _</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token keyword" style=color:#00009f>return</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>[</span><span class="token plain">topi_compute</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">inputs</span><span class="token punctuation" style=color:#393A34>[</span><span class="token number" style=color:#36acaa>0</span><span class="token punctuation" style=color:#393A34>]</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> attrs</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">axis</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> attrs</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">dtype</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> attrs</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">exclusive</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>]</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token keyword" style=color:#00009f>return</span><span class="token plain"> _compute_scanop</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token decorator annotation punctuation" style=color:#393A34>@override_native_generic_func</span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>"cumsum_strategy"</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>def</span><span class="token plain"> </span><span class="token function" style=color:#d73a49>cumsum_strategy</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">attrs</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> inputs</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> out_type</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> target</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token triple-quoted-string string" style=color:#e3116c>"""cumsum 基本策略"""</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    strategy </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> _op</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">OpStrategy</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    strategy</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">add_implementation</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        wrap_compute_scanop</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">topi</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">cumsum</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        wrap_topi_schedule</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">topi</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">generic</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">schedule_extern</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        name</span><span class="token operator" style=color:#393A34>=</span><span class="token string" style=color:#e3116c>"cumsum.generic"</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token keyword" style=color:#00009f>return</span><span class="token plain"> strategy</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token decorator annotation punctuation" style=color:#393A34>@override_native_generic_func</span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>"cumprod_strategy"</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>def</span><span class="token plain"> </span><span class="token function" style=color:#d73a49>cumprod_strategy</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">attrs</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> inputs</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> out_type</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> target</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token triple-quoted-string string" style=color:#e3116c>"""cumprod 基本策略"""</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    strategy </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> _op</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">OpStrategy</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    strategy</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">add_implementation</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        wrap_compute_scanop</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">topi</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">cumprod</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        wrap_topi_schedule</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">topi</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">generic</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">schedule_extern</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        name</span><span class="token operator" style=color:#393A34>=</span><span class="token string" style=color:#e3116c>"cumprod.generic"</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token keyword" style=color:#00009f>return</span><span class="token plain"> strategy</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token decorator annotation punctuation" style=color:#393A34>@cumsum_strategy</span><span class="token decorator annotation punctuation" style=color:#393A34>.</span><span class="token decorator annotation punctuation" style=color:#393A34>register</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>[</span><span class="token string" style=color:#e3116c>"cuda"</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"gpu"</span><span class="token punctuation" style=color:#393A34>]</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>def</span><span class="token plain"> </span><span class="token function" style=color:#d73a49>cumsum_strategy_cuda</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">attrs</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> inputs</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> out_type</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> target</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token triple-quoted-string string" style=color:#e3116c>"""cumsum cuda 策略"""</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    strategy </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> _op</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">OpStrategy</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    strategy</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">add_implementation</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        wrap_compute_scanop</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">topi</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">cuda</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">cumsum</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        wrap_topi_schedule</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">topi</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">cuda</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">schedule_scan</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        name</span><span class="token operator" style=color:#393A34>=</span><span class="token string" style=color:#e3116c>"cumsum.cuda"</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token keyword" style=color:#00009f>return</span><span class="token plain"> strategy</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token decorator annotation punctuation" style=color:#393A34>@cumprod_strategy</span><span class="token decorator annotation punctuation" style=color:#393A34>.</span><span class="token decorator annotation punctuation" style=color:#393A34>register</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>[</span><span class="token string" style=color:#e3116c>"cuda"</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"gpu"</span><span class="token punctuation" style=color:#393A34>]</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>def</span><span class="token plain"> </span><span class="token function" style=color:#d73a49>cumprod_strategy_cuda</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">attrs</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> inputs</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> out_type</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> target</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token triple-quoted-string string" style=color:#e3116c>"""cumprod cuda 策略"""</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    strategy </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> _op</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">OpStrategy</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    strategy</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">add_implementation</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        wrap_compute_scanop</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">topi</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">cuda</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">cumprod</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        wrap_topi_schedule</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">topi</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">cuda</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">schedule_scan</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        name</span><span class="token operator" style=color:#393A34>=</span><span class="token string" style=color:#e3116c>"cumprod.cuda"</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token keyword" style=color:#00009f>return</span><span class="token plain"> strategy</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>每个策略都定义了写入的 compute 以及在 <code>add_implementation()</code> 中使用的 schedule。最后，将 strategy 和 compute 与<code>python/tvm/relay/op/_transform.py</code> 中定义的 Relay 算子关联起来。</p>
<div class="language-python codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-python codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token comment" style=color:#999988;font-style:italic># cumsum</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token decorator annotation punctuation" style=color:#393A34>@_reg</span><span class="token decorator annotation punctuation" style=color:#393A34>.</span><span class="token decorator annotation punctuation" style=color:#393A34>register_compute</span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>"cumsum"</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>def</span><span class="token plain"> </span><span class="token function" style=color:#d73a49>compute_cumsum</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">attrs</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> inputs</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> output_type</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token triple-quoted-string string" style=color:#e3116c>"""cumsum 的计算定义"""</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token keyword" style=color:#00009f>return</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>[</span><span class="token plain">topi</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">cumsum</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">inputs</span><span class="token punctuation" style=color:#393A34>[</span><span class="token number" style=color:#36acaa>0</span><span class="token punctuation" style=color:#393A34>]</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> attrs</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">axis</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> attrs</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">dtype</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> attrs</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">exclusive</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>]</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">_reg</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">register_strategy</span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>"cumsum"</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> strategy</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">cumsum_strategy</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">_reg</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">register_shape_func</span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>"cumsum"</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token boolean" style=color:#36acaa>False</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> elemwise_shape_func</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic># cumprod</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token decorator annotation punctuation" style=color:#393A34>@_reg</span><span class="token decorator annotation punctuation" style=color:#393A34>.</span><span class="token decorator annotation punctuation" style=color:#393A34>register_compute</span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>"cumprod"</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>def</span><span class="token plain"> </span><span class="token function" style=color:#d73a49>compute_cumprod</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">attrs</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> inputs</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> output_type</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token triple-quoted-string string" style=color:#e3116c>"""cumprod 的计算定义"""</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token keyword" style=color:#00009f>return</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>[</span><span class="token plain">topi</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">cumprod</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">inputs</span><span class="token punctuation" style=color:#393A34>[</span><span class="token number" style=color:#36acaa>0</span><span class="token punctuation" style=color:#393A34>]</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> attrs</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">axis</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> attrs</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">dtype</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> attrs</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">exclusive</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>]</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">_reg</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">register_strategy</span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>"cumprod"</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> strategy</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">cumprod_strategy</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">_reg</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">register_shape_func</span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>"cumprod"</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token boolean" style=color:#36acaa>False</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> elemwise_shape_func</span><span class="token punctuation" style=color:#393A34>)</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>shape 函数用于确定 output shape，给定一个动态 shaped tensor。在这种情况下，TVM 的 output shape 与 input shape 保持一致。</p>
<h2 class="anchor anchorWithStickyNavbar_csPL" id=6-创建-relay-调用节点并提供-python-hook>6. 创建 Relay 调用节点并提供 Python Hook<a href=#6-创建-relay-调用节点并提供-python-hook class=hash-link aria-label="6. 创建 Relay 调用节点并提供 Python Hook的直接链接" title="6. 创建 Relay 调用节点并提供 Python Hook的直接链接">​</a></h2>
<p>现在已经有了一个可以运行的算子，接下来只需通过一个 Relay 调用节点（Relay Call Node）正确地调用即可。这一步需要简单地编写一个函数，接收算子的参数（作为 Relay 表达式），并向算子返回一个的调用节点（即应该被放在调用算子的 Relay AST 中的节点）。</p>
<p>目前不支持调用属性和类型参数（最后两个字段），所以只需使用  <code>Op::Get</code> 从算子注册表中获取算子信息，并将参数传递给调用节点（如下所示）。在 <code>src/relay/op/tensor/transform.cc</code>：</p>
<div class="language-cpp codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-cpp codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token plain">Expr </span><span class="token function" style=color:#d73a49>MakeCumsum</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">Expr data</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> Integer axis</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> DataType dtype</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> Bool exclusive</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token keyword" style=color:#00009f>auto</span><span class="token plain"> attrs </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token generic-function function" style=color:#d73a49>make_object</span><span class="token generic-function generic class-name operator" style=color:#393A34>&lt;</span><span class="token generic-function generic class-name">ScanopAttrs</span><span class="token generic-function generic class-name operator" style=color:#393A34>></span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    attrs</span><span class="token operator" style=color:#393A34>-></span><span class="token plain">dtype </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> dtype</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    attrs</span><span class="token operator" style=color:#393A34>-></span><span class="token plain">axis </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> axis</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    attrs</span><span class="token operator" style=color:#393A34>-></span><span class="token plain">exclusive </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> exclusive</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token keyword" style=color:#00009f>static</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> Op</span><span class="token operator" style=color:#393A34>&</span><span class="token plain"> op </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token class-name">Op</span><span class="token double-colon punctuation" style=color:#393A34>::</span><span class="token function" style=color:#d73a49>Get</span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>"cumsum"</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token keyword" style=color:#00009f>return</span><span class="token plain"> </span><span class="token function" style=color:#d73a49>Call</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">op</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain">data</span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token function" style=color:#d73a49>Attrs</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">attrs</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token function" style=color:#d73a49>TVM_REGISTER_GLOBAL</span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>"relay.op._make.cumsum"</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>set_body_typed</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">MakeCumsum</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">Expr </span><span class="token function" style=color:#d73a49>MakeCumprod</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">Expr data</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> Integer axis</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> DataType dtype</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> Bool exclusive</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token keyword" style=color:#00009f>auto</span><span class="token plain"> attrs </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token generic-function function" style=color:#d73a49>make_object</span><span class="token generic-function generic class-name operator" style=color:#393A34>&lt;</span><span class="token generic-function generic class-name">ScanopAttrs</span><span class="token generic-function generic class-name operator" style=color:#393A34>></span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    attrs</span><span class="token operator" style=color:#393A34>-></span><span class="token plain">dtype </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> dtype</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    attrs</span><span class="token operator" style=color:#393A34>-></span><span class="token plain">axis </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> axis</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    attrs</span><span class="token operator" style=color:#393A34>-></span><span class="token plain">exclusive </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> exclusive</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token keyword" style=color:#00009f>static</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> Op</span><span class="token operator" style=color:#393A34>&</span><span class="token plain"> op </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token class-name">Op</span><span class="token double-colon punctuation" style=color:#393A34>::</span><span class="token function" style=color:#d73a49>Get</span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>"cumprod"</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token keyword" style=color:#00009f>return</span><span class="token plain"> </span><span class="token function" style=color:#d73a49>Call</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">op</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain">data</span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token function" style=color:#d73a49>Attrs</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">attrs</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token function" style=color:#d73a49>TVM_REGISTER_GLOBAL</span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>"relay.op._make.cumsum"</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>set_body_typed</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">MakeCumprod</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>其中 <code>TVM_REGISTER_GLOBAL</code> 通过 <code>relay.op._make.cumsum(...)</code> 和 <code>relay.op._make.cumsum(...)</code> 分别暴露（expose）Python 中的 <code>MakeCumsum</code> 和 <code>MakeCumprod</code> 函数。</p>
<h2 class="anchor anchorWithStickyNavbar_csPL" id=7-包含一个更简洁的-python-api-hook>7. 包含一个更简洁的 Python API hook<a href=#7-包含一个更简洁的-python-api-hook class=hash-link aria-label="7. 包含一个更简洁的 Python API hook的直接链接" title="7. 包含一个更简洁的 Python API hook的直接链接">​</a></h2>
<p>通常 Relay 中约定俗成的是，通过 <code>TVM_REGISTER_GLOBAL</code> 导出的函数应该包装在单独的 Python 函数中，而不是直接在 Python 中调用。对于算子，我们在  <code>python/tvm/relay/op/transform.py</code> 中提供了更简洁的接口：</p>
<div class="language-python codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-python codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token keyword" style=color:#00009f>def</span><span class="token plain"> </span><span class="token function" style=color:#d73a49>cumsum</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">data</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> axis</span><span class="token operator" style=color:#393A34>=</span><span class="token boolean" style=color:#36acaa>None</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> dtype</span><span class="token operator" style=color:#393A34>=</span><span class="token boolean" style=color:#36acaa>None</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> exclusive</span><span class="token operator" style=color:#393A34>=</span><span class="token boolean" style=color:#36acaa>None</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token keyword" style=color:#00009f>return</span><span class="token plain"> _make</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">cumsum</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">data</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> axis</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> dtype</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> exclusive</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>def</span><span class="token plain"> </span><span class="token function" style=color:#d73a49>cumprod</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">data</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> axis</span><span class="token operator" style=color:#393A34>=</span><span class="token boolean" style=color:#36acaa>None</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> dtype</span><span class="token operator" style=color:#393A34>=</span><span class="token boolean" style=color:#36acaa>None</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> exclusive</span><span class="token operator" style=color:#393A34>=</span><span class="token boolean" style=color:#36acaa>None</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token keyword" style=color:#00009f>return</span><span class="token plain"> _make</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">cumprod</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">data</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> axis</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> dtype</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> exclusive</span><span class="token punctuation" style=color:#393A34>)</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>注意，这些 Python wrapper 也可能为算子提供更简洁的接口。例如 <code>concat</code> 算子被注册为只接受一个算子（即一个带有要连接的张量的元组），但是 Python wrapper 将张量作为参数，并在产生调用节点之前将它们组合成一个元组。</p>
<div class="language-python codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-python codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token keyword" style=color:#00009f>def</span><span class="token plain"> </span><span class="token function" style=color:#d73a49>concat</span><span class="token punctuation" style=color:#393A34>(</span><span class="token operator" style=color:#393A34>*</span><span class="token plain">args</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token triple-quoted-string string" style=color:#e3116c>"""围绕零轴连接输入张量。</span><br></span><span class=token-line style=color:#393A34><span class="token triple-quoted-string string" style=display:inline-block;color:#e3116c></span><br></span><span class=token-line style=color:#393A34><span class="token triple-quoted-string string" style=color:#e3116c>    参数</span><br></span><span class=token-line style=color:#393A34><span class="token triple-quoted-string string" style=color:#e3116c>    ----------</span><br></span><span class=token-line style=color:#393A34><span class="token triple-quoted-string string" style=color:#e3116c>    args: Tensor 列表</span><br></span><span class=token-line style=color:#393A34><span class="token triple-quoted-string string" style=display:inline-block;color:#e3116c></span><br></span><span class=token-line style=color:#393A34><span class="token triple-quoted-string string" style=color:#e3116c>    返回</span><br></span><span class=token-line style=color:#393A34><span class="token triple-quoted-string string" style=color:#e3116c>    -------</span><br></span><span class=token-line style=color:#393A34><span class="token triple-quoted-string string" style=color:#e3116c>    tensor: 连接的张量。</span><br></span><span class=token-line style=color:#393A34><span class="token triple-quoted-string string" style=color:#e3116c>    """</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    tup </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> Tuple</span><span class="token punctuation" style=color:#393A34>(</span><span class="token builtin">list</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">args</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token keyword" style=color:#00009f>return</span><span class="token plain"> _make</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">concat</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">tup</span><span class="token punctuation" style=color:#393A34>)</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_csPL" id=8-编写单元测试>8. 编写单元测试<a href=#8-编写单元测试 class=hash-link aria-label="8. 编写单元测试的直接链接" title="8. 编写单元测试的直接链接">​</a></h2>
<p>更多用于 cumulative sum 和 cumulative product 算子的单元测试示例，请查看 <a href=https://github.com/apache/tvm/blob/main/tests/python/relay/test_op_level3.py target=_blank rel="noopener noreferrer">tests/python/relay/test_op_level3.py</a>。</p>
<h1>其他主题</h1>
<h2 class="anchor anchorWithStickyNavbar_csPL" id=梯度算子>梯度算子<a href=#梯度算子 class=hash-link aria-label=梯度算子的直接链接 title=梯度算子的直接链接>​</a></h2>
<p>梯度算子对于在 Relay 中编写可微分程序很重要。虽然 Relay 的 autodiff 算法可以得到优秀的语言结构的微分，但算子是不透明的。因为 Relay 无法查看它的实现，所以必须提供明确的微分规则。</p>
<p>Python 和 C++ 都可用于编写梯度算子，这里重点介绍更为常用的 Python 实例。</p>
<h2 class="anchor anchorWithStickyNavbar_csPL" id=在-python-中添加梯度算子>在 Python 中添加梯度算子<a href=#在-python-中添加梯度算子 class=hash-link aria-label="在 Python 中添加梯度算子的直接链接" title="在 Python 中添加梯度算子的直接链接">​</a></h2>
<p>Python 梯度算子集合可以在 <code>python/tvm/relay/op/_tensor_grad.py</code> 中找到 。本部分内容将详细介绍两个有代表性的例子：<code>sigmoid</code> 和 <code>multiply</code>。</p>
<div class="language-python codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-python codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token decorator annotation punctuation" style=color:#393A34>@register_gradient</span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>"sigmoid"</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>def</span><span class="token plain"> </span><span class="token function" style=color:#d73a49>sigmoid_grad</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">orig</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> grad</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token triple-quoted-string string" style=color:#e3116c>"""返回 [grad * sigmoid(x) * (1 - sigmoid(x))]."""</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token keyword" style=color:#00009f>return</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>[</span><span class="token plain">grad </span><span class="token operator" style=color:#393A34>*</span><span class="token plain"> orig </span><span class="token operator" style=color:#393A34>*</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">ones_like</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">orig</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>-</span><span class="token plain"> orig</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>]</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>这里的输入是原始算子 <code>orig</code> 以及梯度算子 <code>grad</code>，返回是一个列表，其中第 i 个索引的元素，是算子相对于算子第 i 个输入的导数。通常，梯度算子将返回一个列表，其元素的个数和基础算子（base operator）的输入一样多。</p>
<p>进一步分析这个定义之前，先回忆一下 sigmoid 函数的导数：∂σ/∂x=σ(x)(1−σ(x))。上面的定义看起来类似于数学定义，但有一个重要的补充：</p>
<p>术语 <code>orig * (ones_like(orig) - orig)</code> 直接匹配导数，因为这里的 <code>orig</code> 是 sigmoid 函数。除了要了解如何计算该函数的梯度之外，还要掌握该梯度与其他梯度组合的方法，即在整个程序中累积梯度。这就是 <code>grad</code> 的作用。在表达式  <code>grad * orig * (ones_like(orig) - orig)</code>中，乘以 <code>grad</code> 指定了到目前为止如何用梯度组合导数。</p>
<p>接下来请看 <code>multiply</code>的示例：</p>
<div class="language-python codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-python codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token decorator annotation punctuation" style=color:#393A34>@register_gradient</span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>"multiply"</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>def</span><span class="token plain"> </span><span class="token function" style=color:#d73a49>multiply_grad</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">orig</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> grad</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token triple-quoted-string string" style=color:#e3116c>"""返回 [grad * y, grad * x]"""</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    x</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> y </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> orig</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">args</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token keyword" style=color:#00009f>return</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>[</span><span class="token plain">collapse_sum_like</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">grad </span><span class="token operator" style=color:#393A34>*</span><span class="token plain"> y</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> x</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            collapse_sum_like</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">grad </span><span class="token operator" style=color:#393A34>*</span><span class="token plain"> x</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> y</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>]</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>在此示例中，返回列表中有两个元素，因为 <code>multiply</code> 是二元运算符（binary operator）。如果 f(x,y) = xy，偏导数是 ∂f / ∂x = y 和 ∂f / ∂y = x。</p>
<p>与 <code>sigmoid</code> 相比，<code>multiply</code> 需要一个额外的步骤，因为 <code>multiply</code> 具有广播语义（broadcasting semantics）。由于 <code>grad</code> 的 shape 可能与输入 shape 不匹配，所以我们使用 <code>collapse_sum_like</code> 来获取 <code>grad * &lt;var></code> 项的内容，并使其 shape 与做微分的输入 shape 相匹配。</p>
<h2 class="anchor anchorWithStickyNavbar_csPL" id=在-c-中添加梯度算子>在 C++ 中添加梯度算子<a href=#在-c-中添加梯度算子 class=hash-link aria-label="在 C++ 中添加梯度算子的直接链接" title="在 C++ 中添加梯度算子的直接链接">​</a></h2>
<p>在 C++ 中添加梯度算子的方法，与在 Python 中添加梯度算子类似，但注册的接口略有不同。</p>
<p>首先，确保 <code>src/relay/transforms/pattern_utils.h</code> 被包含在内。它提供了用于在 Relay AST 中创建节点的辅助函数。定义梯度算子的方式与 Python 类似：</p>
<div class="language-cpp codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-cpp codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token plain">tvm</span><span class="token double-colon punctuation" style=color:#393A34>::</span><span class="token plain">Array</span><span class="token operator" style=color:#393A34>&lt;</span><span class="token plain">Expr</span><span class="token operator" style=color:#393A34>></span><span class="token plain"> </span><span class="token function" style=color:#d73a49>MultiplyGrad</span><span class="token punctuation" style=color:#393A34>(</span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> Expr</span><span class="token operator" style=color:#393A34>&</span><span class="token plain"> orig_call</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> Expr</span><span class="token operator" style=color:#393A34>&</span><span class="token plain"> output_grad</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> Call</span><span class="token operator" style=color:#393A34>&</span><span class="token plain"> call </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> orig_call</span><span class="token punctuation" style=color:#393A34>.</span><span class="token generic-function function" style=color:#d73a49>Downcast</span><span class="token generic-function generic class-name operator" style=color:#393A34>&lt;</span><span class="token generic-function generic class-name">Call</span><span class="token generic-function generic class-name operator" style=color:#393A34>></span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token keyword" style=color:#00009f>return</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> </span><span class="token function" style=color:#d73a49>CollapseSumLike</span><span class="token punctuation" style=color:#393A34>(</span><span class="token function" style=color:#d73a49>Multiply</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">output_grad</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> call</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">args</span><span class="token punctuation" style=color:#393A34>[</span><span class="token number" style=color:#36acaa>1</span><span class="token punctuation" style=color:#393A34>]</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> call</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">args</span><span class="token punctuation" style=color:#393A34>[</span><span class="token number" style=color:#36acaa>0</span><span class="token punctuation" style=color:#393A34>]</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">             </span><span class="token function" style=color:#d73a49>CollapseSumLike</span><span class="token punctuation" style=color:#393A34>(</span><span class="token function" style=color:#d73a49>Multiply</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">output_grad</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> call</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">args</span><span class="token punctuation" style=color:#393A34>[</span><span class="token number" style=color:#36acaa>0</span><span class="token punctuation" style=color:#393A34>]</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> call</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">args</span><span class="token punctuation" style=color:#393A34>[</span><span class="token number" style=color:#36acaa>1</span><span class="token punctuation" style=color:#393A34>]</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>}</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>注意，在 C++ 中不能使用与 Python 相同的运算符重载（operator overloading），而是需要向下转换，因此实现更加冗长。即便如此，我们仍然可以轻易地验证这个定义反映了 Python 中先前的例子。</p>
<p>要注册梯度算子，这里无需使用 Python 修饰器，只需要在基础算子注册的末尾添加 <code>set_attr</code> 调用 "FPrimalGradient" 即可。</p>
<div class="language-cpp codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-cpp codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token function" style=color:#d73a49>RELAY_REGISTER_OP</span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>"multiply"</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token comment" style=color:#999988;font-style:italic>// ...</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token comment" style=color:#999988;font-style:italic>// 设置其他属性</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token comment" style=color:#999988;font-style:italic>// ...</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>.</span><span class="token generic-function function" style=color:#d73a49>set_attr</span><span class="token generic-function generic class-name operator" style=color:#393A34>&lt;</span><span class="token generic-function generic class-name">FPrimalGradient</span><span class="token generic-function generic class-name operator" style=color:#393A34>></span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>"FPrimalGradient"</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> MultiplyGrad</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class=col><a href=https://github.com/hyperai/tvm-cn/edit/master/versioned_docs/version-0.12.0/dev/how_to/02-relay_add_op.md target=_blank rel="noopener noreferrer" class=theme-edit-this-page><svg fill=currentColor height=20 width=20 viewBox="0 0 40 40" class=iconEdit_OUzX aria-hidden=true><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"/></g></svg>编辑此页</a></div><div class="col lastUpdated_ccpN"><span class=theme-last-updated>最后<!-- -->由 <b>sparanoid</b> <!-- -->于 <b><time datetime=2025-04-15T11:50:10.000Z itemprop=dateModified>2025年4月15日</time></b> <!-- -->更新</span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label=文件选项卡><a class="pagination-nav__link pagination-nav__link--prev" href=/docs/tvm-cn/docs/0.12.0/dev/how_to/debugging_tvm><div class=pagination-nav__sublabel>上一页</div><div class=pagination-nav__label>调试 TVM</div></a><a class="pagination-nav__link pagination-nav__link--next" href=/docs/tvm-cn/docs/0.12.0/dev/how_to/relay_add_pass><div class=pagination-nav__sublabel>下一页</div><div class=pagination-nav__label>向 Relay 中添加 Compiler Pass</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_cD69 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href=#1-定义属性节点 class="table-of-contents__link toc-highlight">1. 定义属性节点</a><li><a href=#2-编写类型关系 class="table-of-contents__link toc-highlight">2. 编写类型关系</a><li><a href=#3-将参数数量和属性与算子关联起来 class="table-of-contents__link toc-highlight">3. 将参数数量和属性与算子关联起来</a><li><a href=#4-定义算子的计算 class="table-of-contents__link toc-highlight">4. 定义算子的计算</a><li><a href=#5-将计算compute和策略strategy与-relay-关联起来 class="table-of-contents__link toc-highlight">5. 将计算（compute）和策略（strategy）与 Relay 关联起来</a><li><a href=#6-创建-relay-调用节点并提供-python-hook class="table-of-contents__link toc-highlight">6. 创建 Relay 调用节点并提供 Python Hook</a><li><a href=#7-包含一个更简洁的-python-api-hook class="table-of-contents__link toc-highlight">7. 包含一个更简洁的 Python API hook</a><li><a href=#8-编写单元测试 class="table-of-contents__link toc-highlight">8. 编写单元测试</a><li><a href=#梯度算子 class="table-of-contents__link toc-highlight">梯度算子</a><li><a href=#在-python-中添加梯度算子 class="table-of-contents__link toc-highlight">在 Python 中添加梯度算子</a><li><a href=#在-c-中添加梯度算子 class="table-of-contents__link toc-highlight">在 C++ 中添加梯度算子</a></ul></div></div></div></div></main></div></div></div><footer class=footer><div class="container container-fluid"><div class="footer__bottom text--center"><div class=footer__copyright>© 2025 Apache Software Foundation and Hyper.AI for Chinese Simplified mirror</div></div></div></footer></div>