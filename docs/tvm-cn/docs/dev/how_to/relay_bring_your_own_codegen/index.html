<!doctype html><html lang=zh-Hans dir=ltr class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-dev/how_to/relay_bring_your_own_codegen" data-has-hydrated=false><meta charset=UTF-8><meta name=generator content="Docusaurus v3.7.0"><title data-rh=true>向 TVM 中添加 Codegen | Apache TVM 中文站</title><meta data-rh=true name=viewport content="width=device-width, initial-scale=1.0"><meta data-rh=true name=twitter:card content=summary_large_image><meta data-rh=true property=og:url content=https://lzw.me/docs/tvm-cn/docs/dev/how_to/relay_bring_your_own_codegen><meta data-rh=true property=og:locale content=zh_Hans><meta data-rh=true name=docusaurus_locale content=zh-Hans><meta data-rh=true name=docsearch:language content=zh-Hans><meta data-rh=true name=docusaurus_version content=current><meta data-rh=true name=docusaurus_tag content=docs-default-current><meta data-rh=true name=docsearch:version content=current><meta data-rh=true name=docsearch:docusaurus_tag content=docs-default-current><meta data-rh=true property=og:title content="向 TVM 中添加 Codegen | Apache TVM 中文站"><meta data-rh=true name=description content="随着深度学习工作负载所针对的硬件设备数量不断增加，用户在各种设备上实现高性能所需的知识也在不断增加。为了让数据科学家在开发新模型时不必担心性能问题，硬件厂商或是基于一些常见的深度学习算子，提供 MKLDNN 或 cuDNN 等库，或是提供 TensorRT 等框架，让用户按照某种方式描述模型，从而提高模型性能。"><meta data-rh=true property=og:description content="随着深度学习工作负载所针对的硬件设备数量不断增加，用户在各种设备上实现高性能所需的知识也在不断增加。为了让数据科学家在开发新模型时不必担心性能问题，硬件厂商或是基于一些常见的深度学习算子，提供 MKLDNN 或 cuDNN 等库，或是提供 TensorRT 等框架，让用户按照某种方式描述模型，从而提高模型性能。"><link data-rh=true rel=icon href=/docs/tvm-cn/img/favicon.png><link data-rh=true rel=canonical href=https://lzw.me/docs/tvm-cn/docs/dev/how_to/relay_bring_your_own_codegen><link data-rh=true rel=alternate href=https://lzw.me/docs/tvm-cn/docs/dev/how_to/relay_bring_your_own_codegen hreflang=zh-Hans><link data-rh=true rel=alternate href=https://lzw.me/docs/tvm-cn/docs/dev/how_to/relay_bring_your_own_codegen hreflang=x-default><link data-rh=true rel=preconnect href=https://KU6TD2KAGA-dsn.algolia.net crossorigin=anonymous><link rel=preconnect href=https://www.google-analytics.com><link rel=preconnect href=https://www.googletagmanager.com><script async src="https://www.googletagmanager.com/gtag/js?id=GTM-TVRNTQWL"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","GTM-TVRNTQWL",{})</script><link rel=search type=application/opensearchdescription+xml title="Apache TVM 中文站" href=/docs/tvm-cn/opensearch.xml><link rel=stylesheet href=https://fastly.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css type=text/css integrity=sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM crossorigin=anonymous><script src=https://lzw.me/x/lib/utils/h5-common.js defer data-domain=lzw.me></script><link rel=stylesheet href=/docs/tvm-cn/assets/css/styles.d660bc20.css><script src=/docs/tvm-cn/assets/js/runtime~main.412de774.js defer></script><script src=/docs/tvm-cn/assets/js/main.60e49e7b.js defer></script><body class=navigation-with-keyboard><script>!function(){var t,e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t=null!==e?e:window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":(window.matchMedia("(prefers-color-scheme: light)").matches,"light"),document.documentElement.setAttribute("data-theme",t)}(),function(){try{for(var[t,e]of new URLSearchParams(window.location.search).entries())if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id=__docusaurus><link rel=preload as=image href=/docs/tvm-cn/img/favicon-dark.svg><link rel=preload as=image href=/docs/tvm-cn/img/favicon.svg><div role=region aria-label=跳到主要内容><a class=skipToContent_ZYxR href=#__docusaurus_skipToContent_fallback>跳到主要内容</a></div><nav aria-label=主导航 class="navbar navbar--fixed-top"><div class=navbar__inner><div class=navbar__items><button aria-label=切换导航栏 aria-expanded=false class="navbar__toggle clean-btn" type=button><svg width=30 height=30 viewBox="0 0 30 30" aria-hidden=true><path stroke=currentColor stroke-linecap=round stroke-miterlimit=10 stroke-width=2 d="M4 7h22M4 15h22M4 23h22"/></svg></button><a class=navbar__brand href=/docs/tvm-cn/><div class=navbar__logo><img src=/docs/tvm-cn/img/favicon-dark.svg alt="TVM Logo" class="themedComponent_PKz1 themedComponent--light_TYnW"><img src=/docs/tvm-cn/img/favicon.svg alt="TVM Logo" class="themedComponent_PKz1 themedComponent--dark_RKZm"></div><b class="navbar__title text--truncate">TVM 中文站</b></a><a aria-current=page class="navbar__item navbar__link navbar__link--active" href=/docs/tvm-cn/docs/>查看文档</a><a class="navbar__item navbar__link" href=/docs/tvm-cn/about>关于</a><a href=https://tool.lzw.me target=_blank rel="noopener noreferrer" class="navbar__item navbar__link">有趣工具箱<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_wR_l><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><a href=https://lzw.me/x/reference/ target=_blank rel="noopener noreferrer" class="navbar__item navbar__link">IT速查清单<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_wR_l><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a></div><div class="navbar__items navbar__items--right"><a href=https://github.com/hyperai/tvm-cn target=_blank rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_wR_l><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class=navbar__link aria-haspopup=true aria-expanded=false role=button href=/docs/tvm-cn/docs/dev/how_to/relay_bring_your_own_codegen>0.13.0</a><ul class=dropdown__menu><li><a aria-current=page class="dropdown__link dropdown__link--active" href=/docs/tvm-cn/docs/dev/how_to/relay_bring_your_own_codegen>0.13.0</a><li><a class=dropdown__link href=/docs/tvm-cn/docs/0.12.0/dev/how_to/relay_bring_your_own_codegen>0.12.0</a><li><a class=dropdown__link href=/docs/tvm-cn/docs/0.10.0/dev/how_to/relay_bring_your_own_codegen>0.10.0</a></ul></div><div class="toggle_azEg colorModeToggle_ACQd"><button class="clean-btn toggleButton_rDEP toggleButtonDisabled_BTpm" type=button disabled title=切换浅色/暗黑模式（当前为浅色模式） aria-label=切换浅色/暗黑模式（当前为浅色模式） aria-live=polite aria-pressed=false><svg viewBox="0 0 24 24" width=24 height=24 class=lightToggleIcon_FWei><path fill=currentColor d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"/></svg><svg viewBox="0 0 24 24" width=24 height=24 class=darkToggleIcon_OH98><path fill=currentColor d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"/></svg></button></div><div class=navbarSearchContainer_CQDF><button type=button class="DocSearch DocSearch-Button" aria-label="搜索 (Command+K)"><span class=DocSearch-Button-Container><svg width=20 height=20 class=DocSearch-Search-Icon viewBox="0 0 20 20" aria-hidden=true><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke=currentColor fill=none fill-rule=evenodd stroke-linecap=round stroke-linejoin=round /></svg><span class=DocSearch-Button-Placeholder>搜索</span></span><span class=DocSearch-Button-Keys></span></button></div></div></div><div role=presentation class=navbar-sidebar__backdrop></div></nav><div id=__docusaurus_skipToContent_fallback class="main-wrapper mainWrapper_YyXw"><div class=docsWrapper_QpQH><button aria-label=回到顶部 class="clean-btn theme-back-to-top-button backToTopButton_J2hp" type=button></button><div class=docRoot_e4fL><aside class="theme-doc-sidebar-container docSidebarContainer_lAUu"><div class=sidebarViewport_u_LW><div class=sidebar_CdZN><nav aria-label=文档侧边栏 class="menu thin-scrollbar menu_MbTs"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class=menu__link href=/docs/tvm-cn/docs/>欢迎</a><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class=menu__list-item-collapsible><a class=menu__link>快速上手</a></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/docs/tvm-cn/docs/install>安装 TVM</a><button aria-label="展开侧边栏分类 '安装 TVM'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/docs/tvm-cn/docs/contribute>贡献指南</a><button aria-label="展开侧边栏分类 '贡献指南'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div></ul><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class=menu__list-item-collapsible><a class=menu__link>用户手册</a></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/docs/tvm-cn/docs/tutorial>用户教程</a><button aria-label="展开侧边栏分类 '用户教程'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/docs/tvm-cn/docs/how_to>常见问题</a><button aria-label="展开侧边栏分类 '常见问题'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div></ul><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--active">开发手册</a></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/docs/tvm-cn/docs/dev/>开发者教程</a><button aria-label="展开侧边栏分类 '开发者教程'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--active" tabindex=0 href=/docs/tvm-cn/docs/dev/how_to>开发者指南</a><button aria-label="折叠侧边栏分类 '开发者指南'" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/docs/tvm-cn/docs/dev/how_to/debugging_tvm>调试 TVM</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/docs/tvm-cn/docs/dev/how_to/relay_add_op>向 Relay 中添加算子</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/docs/tvm-cn/docs/dev/how_to/relay_add_pass>向 Relay 中添加 Compiler Pass</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current=page tabindex=0 href=/docs/tvm-cn/docs/dev/how_to/relay_bring_your_own_codegen>向 TVM 中添加 Codegen</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/docs/tvm-cn/docs/dev/how_to/python_target_parametrization>Python Target 参数化</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/docs/tvm-cn/docs/dev/how_to/setup_rpc_system>设置 RPC 系统</a></ul></ul><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class=menu__list-item-collapsible><a class=menu__link>设计与架构</a></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/docs/tvm-cn/docs/arch/>设计与架构</a><button aria-label="展开侧边栏分类 '设计与架构'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div></ul><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class=menu__list-item-collapsible><a class=menu__link>主题指南</a></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/docs/tvm-cn/docs/topic/microtvm/>microTVM：裸机上的 TVM</a><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/docs/tvm-cn/docs/topic/vta>VTA：多功能张量加速器</a><button aria-label="展开侧边栏分类 'VTA：多功能张量加速器'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div></ul></ul></nav></div></div></aside><main class=docMainContainer_ch7h><div class="container padding-top--md padding-bottom--lg"><div class=row><div class="col docItemCol__o6A"><div class=docItemContainer_Wtch><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_fS1C" aria-label=页面路径><ul class=breadcrumbs itemscope itemtype=https://schema.org/BreadcrumbList><li class=breadcrumbs__item><a aria-label=主页面 class=breadcrumbs__link href=/docs/tvm-cn/><svg viewBox="0 0 24 24" class=breadcrumbHomeIcon_jcRj><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill=currentColor /></svg></a><li class=breadcrumbs__item><span class=breadcrumbs__link>开发手册</span><meta itemprop=position content=1><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class=breadcrumbs__item><a class=breadcrumbs__link itemprop=item href=/docs/tvm-cn/docs/dev/how_to><span itemprop=name>开发者指南</span></a><meta itemprop=position content=2><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class="breadcrumbs__item breadcrumbs__item--active"><span class=breadcrumbs__link itemprop=name>向 TVM 中添加 Codegen</span><meta itemprop=position content=3></ul></nav><span class="theme-doc-version-badge badge badge--secondary">版本：0.13.0</span><div class="tocCollapsible_hZNL theme-doc-toc-mobile tocMobile_UGcD"><button type=button class="clean-btn tocCollapsibleButton_z7oa">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>向 TVM 中添加 Codegen</h1></header>
<p>随着深度学习工作负载所针对的硬件设备数量不断增加，用户在各种设备上实现高性能所需的知识也在不断增加。为了让数据科学家在开发新模型时不必担心性能问题，硬件厂商或是基于一些常见的深度学习算子，提供 MKLDNN 或 cuDNN 等库，或是提供 TensorRT 等框架，让用户按照某种方式描述模型，从而提高模型性能。</p>
<p>然而，用户在尝试使用新的库或设备时，必须学习新的编程接口。因此，一个统一的编程接口变得越来越重要：1）让所有用户及硬件厂商信息同步，2）提供一个可行的解决方案，让特定硬件或库只支持具有极高性能的、广泛使用的算子，不受支持的算子则回退到 CPU/GPU 等通用设备。</p>
<p>本开发手册演示了硬件厂商如何轻松实现自己的 Codegen，并将其注册为 Relay 后端编译器，从而支持自己的硬件设备/库。本手册涵盖了两种基于不同计算图的 codegen：</p>
<p><strong>1. 希望生成 C 代码。</strong></p>
<p>如果你的硬件已经具备了一个高度优化的 C/C++ 库，如对于 CPU 而言的 Intel CBLAS/MKL 库，或针对 GPU 而言的 NVIDIA CUBLAS 库，那么本节内容非常适合你。幸运的是，C 源代码模块与 TVM runtime 模块完全兼容，这意味着生成的代码可以由任何具有适当编译标志的 C/C++ 编译器编译，因此用户只需实现一个能为子图生成 C 代码的 codegen，并将 C 源代码模块集成到 TVM runtime 模块中。下一节内容讲详细演示如何为硬件实现 C codegen。</p>
<p><strong>2. 希望生成任意计算图。</strong></p>
<p>有时候，硬件可能需要其他形式的计算图如 JSON。这种情况下，用户不仅要实现一个 codegen，还要实现一个自定义 TVM runtime 模块，从而使得 TVM runtime 知道如何执行这个计算图。如果你的硬件已经拥有完整的计算图执行引擎（graph execution engine），如适用于 GPU 的 TensorRT，那么该解决方案对你而言非常具有参考价值。</p>
<p>完成 codegen 和 runtime 后，可以让客户借助你的自定义标签，对模型进行注释并加以利用。终端用户如何注释和启动特定 codegen 的教程，将在后续进行补充。</p>
<h1>实现 C Codegen</h1>
<p>在这一部分中，我们将演示如何借助预实现的算子函数，生成 C 代码的 codegen。简单起见，本示例 codegen 不依赖于第三方库。相反，我们在 C 中手动实现了两个宏：</p>
<div class="language-c codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-c codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token macro property directive-hash" style=color:#36acaa>#</span><span class="token macro property directive keyword" style=color:#00009f>define</span><span class="token macro property" style=color:#36acaa> </span><span class="token macro property macro-name function" style=color:#d73a49>CSOURCE_BINARY_OP_1D</span><span class="token macro property expression punctuation" style=color:#393A34>(</span><span class="token macro property expression" style=color:#36acaa>p_ID_</span><span class="token macro property expression punctuation" style=color:#393A34>,</span><span class="token macro property expression" style=color:#36acaa> p_OP_</span><span class="token macro property expression punctuation" style=color:#393A34>,</span><span class="token macro property expression" style=color:#36acaa> p_DIM1_</span><span class="token macro property expression punctuation" style=color:#393A34>)</span><span class="token macro property expression" style=color:#36acaa>         </span><span class="token macro property punctuation" style=color:#393A34>\</span><span class="token macro property" style=color:#36acaa></span><br></span><span class=token-line style=color:#393A34><span class="token macro property" style=color:#36acaa>    </span><span class="token macro property expression keyword" style=color:#00009f>extern</span><span class="token macro property expression" style=color:#36acaa> </span><span class="token macro property string" style=color:#e3116c>"C"</span><span class="token macro property" style=color:#36acaa> </span><span class="token macro property expression keyword" style=color:#00009f>void</span><span class="token macro property expression" style=color:#36acaa> </span><span class="token macro property expression function" style=color:#d73a49>p_ID_</span><span class="token macro property expression punctuation" style=color:#393A34>(</span><span class="token macro property expression keyword" style=color:#00009f>float</span><span class="token macro property expression operator" style=color:#393A34>*</span><span class="token macro property expression" style=color:#36acaa> a</span><span class="token macro property expression punctuation" style=color:#393A34>,</span><span class="token macro property expression" style=color:#36acaa> </span><span class="token macro property expression keyword" style=color:#00009f>float</span><span class="token macro property expression operator" style=color:#393A34>*</span><span class="token macro property expression" style=color:#36acaa> b</span><span class="token macro property expression punctuation" style=color:#393A34>,</span><span class="token macro property expression" style=color:#36acaa> </span><span class="token macro property expression keyword" style=color:#00009f>float</span><span class="token macro property expression operator" style=color:#393A34>*</span><span class="token macro property expression" style=color:#36acaa> out</span><span class="token macro property expression punctuation" style=color:#393A34>)</span><span class="token macro property expression" style=color:#36acaa> </span><span class="token macro property expression punctuation" style=color:#393A34>{</span><span class="token macro property expression" style=color:#36acaa> </span><span class="token macro property punctuation" style=color:#393A34>\</span><span class="token macro property" style=color:#36acaa></span><br></span><span class=token-line style=color:#393A34><span class="token macro property" style=color:#36acaa>        </span><span class="token macro property expression keyword" style=color:#00009f>for</span><span class="token macro property expression" style=color:#36acaa> </span><span class="token macro property expression punctuation" style=color:#393A34>(</span><span class="token macro property expression class-name" style=color:#36acaa>int64_t</span><span class="token macro property expression" style=color:#36acaa> i </span><span class="token macro property expression operator" style=color:#393A34>=</span><span class="token macro property expression" style=color:#36acaa> </span><span class="token macro property expression number" style=color:#36acaa>0</span><span class="token macro property expression punctuation" style=color:#393A34>;</span><span class="token macro property expression" style=color:#36acaa> i </span><span class="token macro property expression operator" style=color:#393A34>&lt;</span><span class="token macro property expression" style=color:#36acaa> p_DIM1_</span><span class="token macro property expression punctuation" style=color:#393A34>;</span><span class="token macro property expression" style=color:#36acaa> </span><span class="token macro property expression operator" style=color:#393A34>++</span><span class="token macro property expression" style=color:#36acaa>i</span><span class="token macro property expression punctuation" style=color:#393A34>)</span><span class="token macro property expression" style=color:#36acaa> </span><span class="token macro property expression punctuation" style=color:#393A34>{</span><span class="token macro property expression" style=color:#36acaa>             </span><span class="token macro property punctuation" style=color:#393A34>\</span><span class="token macro property" style=color:#36acaa></span><br></span><span class=token-line style=color:#393A34><span class="token macro property" style=color:#36acaa>            </span><span class="token macro property expression" style=color:#36acaa>out</span><span class="token macro property expression punctuation" style=color:#393A34>[</span><span class="token macro property expression" style=color:#36acaa>i</span><span class="token macro property expression punctuation" style=color:#393A34>]</span><span class="token macro property expression" style=color:#36acaa> </span><span class="token macro property expression operator" style=color:#393A34>=</span><span class="token macro property expression" style=color:#36acaa> a</span><span class="token macro property expression punctuation" style=color:#393A34>[</span><span class="token macro property expression" style=color:#36acaa>i</span><span class="token macro property expression punctuation" style=color:#393A34>]</span><span class="token macro property expression" style=color:#36acaa> p_OP_ b</span><span class="token macro property expression punctuation" style=color:#393A34>[</span><span class="token macro property expression" style=color:#36acaa>i</span><span class="token macro property expression punctuation" style=color:#393A34>]</span><span class="token macro property expression punctuation" style=color:#393A34>;</span><span class="token macro property expression" style=color:#36acaa>                       </span><span class="token macro property punctuation" style=color:#393A34>\</span><span class="token macro property" style=color:#36acaa></span><br></span><span class=token-line style=color:#393A34><span class="token macro property" style=color:#36acaa>        </span><span class="token macro property expression punctuation" style=color:#393A34>}</span><span class="token macro property expression" style=color:#36acaa>                                                   </span><span class="token macro property punctuation" style=color:#393A34>\</span><span class="token macro property" style=color:#36acaa></span><br></span><span class=token-line style=color:#393A34><span class="token macro property" style=color:#36acaa>    </span><span class="token macro property expression punctuation" style=color:#393A34>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token macro property directive-hash" style=color:#36acaa>#</span><span class="token macro property directive keyword" style=color:#00009f>define</span><span class="token macro property" style=color:#36acaa> </span><span class="token macro property macro-name function" style=color:#d73a49>CSOURCE_BINARY_OP_2D</span><span class="token macro property expression punctuation" style=color:#393A34>(</span><span class="token macro property expression" style=color:#36acaa>p_ID_</span><span class="token macro property expression punctuation" style=color:#393A34>,</span><span class="token macro property expression" style=color:#36acaa> p_OP_</span><span class="token macro property expression punctuation" style=color:#393A34>,</span><span class="token macro property expression" style=color:#36acaa> p_DIM1_</span><span class="token macro property expression punctuation" style=color:#393A34>,</span><span class="token macro property expression" style=color:#36acaa> p_DIM2_</span><span class="token macro property expression punctuation" style=color:#393A34>)</span><span class="token macro property expression" style=color:#36acaa>  </span><span class="token macro property punctuation" style=color:#393A34>\</span><span class="token macro property" style=color:#36acaa></span><br></span><span class=token-line style=color:#393A34><span class="token macro property" style=color:#36acaa>    </span><span class="token macro property expression keyword" style=color:#00009f>extern</span><span class="token macro property expression" style=color:#36acaa> </span><span class="token macro property string" style=color:#e3116c>"C"</span><span class="token macro property" style=color:#36acaa> </span><span class="token macro property expression keyword" style=color:#00009f>void</span><span class="token macro property expression" style=color:#36acaa> </span><span class="token macro property expression function" style=color:#d73a49>p_ID_</span><span class="token macro property expression punctuation" style=color:#393A34>(</span><span class="token macro property expression keyword" style=color:#00009f>float</span><span class="token macro property expression operator" style=color:#393A34>*</span><span class="token macro property expression" style=color:#36acaa> a</span><span class="token macro property expression punctuation" style=color:#393A34>,</span><span class="token macro property expression" style=color:#36acaa> </span><span class="token macro property expression keyword" style=color:#00009f>float</span><span class="token macro property expression operator" style=color:#393A34>*</span><span class="token macro property expression" style=color:#36acaa> b</span><span class="token macro property expression punctuation" style=color:#393A34>,</span><span class="token macro property expression" style=color:#36acaa> </span><span class="token macro property expression keyword" style=color:#00009f>float</span><span class="token macro property expression operator" style=color:#393A34>*</span><span class="token macro property expression" style=color:#36acaa> out</span><span class="token macro property expression punctuation" style=color:#393A34>)</span><span class="token macro property expression" style=color:#36acaa> </span><span class="token macro property expression punctuation" style=color:#393A34>{</span><span class="token macro property expression" style=color:#36acaa>   </span><span class="token macro property punctuation" style=color:#393A34>\</span><span class="token macro property" style=color:#36acaa></span><br></span><span class=token-line style=color:#393A34><span class="token macro property" style=color:#36acaa>        </span><span class="token macro property expression keyword" style=color:#00009f>for</span><span class="token macro property expression" style=color:#36acaa> </span><span class="token macro property expression punctuation" style=color:#393A34>(</span><span class="token macro property expression class-name" style=color:#36acaa>int64_t</span><span class="token macro property expression" style=color:#36acaa> i </span><span class="token macro property expression operator" style=color:#393A34>=</span><span class="token macro property expression" style=color:#36acaa> </span><span class="token macro property expression number" style=color:#36acaa>0</span><span class="token macro property expression punctuation" style=color:#393A34>;</span><span class="token macro property expression" style=color:#36acaa> i </span><span class="token macro property expression operator" style=color:#393A34>&lt;</span><span class="token macro property expression" style=color:#36acaa> p_DIM1_</span><span class="token macro property expression punctuation" style=color:#393A34>;</span><span class="token macro property expression" style=color:#36acaa> </span><span class="token macro property expression operator" style=color:#393A34>++</span><span class="token macro property expression" style=color:#36acaa>i</span><span class="token macro property expression punctuation" style=color:#393A34>)</span><span class="token macro property expression" style=color:#36acaa> </span><span class="token macro property expression punctuation" style=color:#393A34>{</span><span class="token macro property expression" style=color:#36acaa>               </span><span class="token macro property punctuation" style=color:#393A34>\</span><span class="token macro property" style=color:#36acaa></span><br></span><span class=token-line style=color:#393A34><span class="token macro property" style=color:#36acaa>            </span><span class="token macro property expression keyword" style=color:#00009f>for</span><span class="token macro property expression" style=color:#36acaa> </span><span class="token macro property expression punctuation" style=color:#393A34>(</span><span class="token macro property expression class-name" style=color:#36acaa>int64_t</span><span class="token macro property expression" style=color:#36acaa> j </span><span class="token macro property expression operator" style=color:#393A34>=</span><span class="token macro property expression" style=color:#36acaa> </span><span class="token macro property expression number" style=color:#36acaa>0</span><span class="token macro property expression punctuation" style=color:#393A34>;</span><span class="token macro property expression" style=color:#36acaa> j </span><span class="token macro property expression operator" style=color:#393A34>&lt;</span><span class="token macro property expression" style=color:#36acaa> p_DIM2_</span><span class="token macro property expression punctuation" style=color:#393A34>;</span><span class="token macro property expression" style=color:#36acaa> </span><span class="token macro property expression operator" style=color:#393A34>++</span><span class="token macro property expression" style=color:#36acaa>j</span><span class="token macro property expression punctuation" style=color:#393A34>)</span><span class="token macro property expression" style=color:#36acaa> </span><span class="token macro property expression punctuation" style=color:#393A34>{</span><span class="token macro property expression" style=color:#36acaa>           </span><span class="token macro property punctuation" style=color:#393A34>\</span><span class="token macro property" style=color:#36acaa></span><br></span><span class=token-line style=color:#393A34><span class="token macro property" style=color:#36acaa>                </span><span class="token macro property expression class-name" style=color:#36acaa>int64_t</span><span class="token macro property expression" style=color:#36acaa> k </span><span class="token macro property expression operator" style=color:#393A34>=</span><span class="token macro property expression" style=color:#36acaa> i </span><span class="token macro property expression operator" style=color:#393A34>*</span><span class="token macro property expression" style=color:#36acaa> p_DIM2_ </span><span class="token macro property expression operator" style=color:#393A34>+</span><span class="token macro property expression" style=color:#36acaa> j</span><span class="token macro property expression punctuation" style=color:#393A34>;</span><span class="token macro property expression" style=color:#36acaa>                  </span><span class="token macro property punctuation" style=color:#393A34>\</span><span class="token macro property" style=color:#36acaa></span><br></span><span class=token-line style=color:#393A34><span class="token macro property" style=color:#36acaa>                </span><span class="token macro property expression" style=color:#36acaa>out</span><span class="token macro property expression punctuation" style=color:#393A34>[</span><span class="token macro property expression" style=color:#36acaa>k</span><span class="token macro property expression punctuation" style=color:#393A34>]</span><span class="token macro property expression" style=color:#36acaa> </span><span class="token macro property expression operator" style=color:#393A34>=</span><span class="token macro property expression" style=color:#36acaa> a</span><span class="token macro property expression punctuation" style=color:#393A34>[</span><span class="token macro property expression" style=color:#36acaa>k</span><span class="token macro property expression punctuation" style=color:#393A34>]</span><span class="token macro property expression" style=color:#36acaa> p_OP_ b</span><span class="token macro property expression punctuation" style=color:#393A34>[</span><span class="token macro property expression" style=color:#36acaa>k</span><span class="token macro property expression punctuation" style=color:#393A34>]</span><span class="token macro property expression punctuation" style=color:#393A34>;</span><span class="token macro property expression" style=color:#36acaa>                     </span><span class="token macro property punctuation" style=color:#393A34>\</span><span class="token macro property" style=color:#36acaa></span><br></span><span class=token-line style=color:#393A34><span class="token macro property" style=color:#36acaa>            </span><span class="token macro property expression punctuation" style=color:#393A34>}</span><span class="token macro property expression" style=color:#36acaa>                                                 </span><span class="token macro property punctuation" style=color:#393A34>\</span><span class="token macro property" style=color:#36acaa></span><br></span><span class=token-line style=color:#393A34><span class="token macro property" style=color:#36acaa>        </span><span class="token macro property expression punctuation" style=color:#393A34>}</span><span class="token macro property expression" style=color:#36acaa>                                                     </span><span class="token macro property punctuation" style=color:#393A34>\</span><span class="token macro property" style=color:#36acaa></span><br></span><span class=token-line style=color:#393A34><span class="token macro property" style=color:#36acaa>    </span><span class="token macro property expression punctuation" style=color:#393A34>}</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>使用这两个宏，可以为一维和二维张量生成二元算子（binary operator）。例如，给定如下所示的子图，假设所有输入都是 shape 为（10, 10）的二维张量：</p>
<div class="language-text codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-text codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token plain">c_compiler_input0</span><br></span><span class=token-line style=color:#393A34><span class="token plain">       |</span><br></span><span class=token-line style=color:#393A34><span class="token plain">      add &lt;-- c_compiler_input1</span><br></span><span class=token-line style=color:#393A34><span class="token plain">       |</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    subtract &lt;-- c_compiler_input2</span><br></span><span class=token-line style=color:#393A34><span class="token plain">       |</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    multiply &lt;-- c_compiler_input3</span><br></span><span class=token-line style=color:#393A34><span class="token plain">       |</span><br></span><span class=token-line style=color:#393A34><span class="token plain">      out</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>我们的目标是生成以下可编译代码来执行子图：</p>
<div class="language-cpp codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-cpp codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token macro property directive-hash" style=color:#36acaa>#</span><span class="token macro property directive keyword" style=color:#00009f>include</span><span class="token macro property" style=color:#36acaa> </span><span class="token macro property string" style=color:#e3116c>&lt;tvm/runtime/c_runtime_api.h></span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token macro property directive-hash" style=color:#36acaa>#</span><span class="token macro property directive keyword" style=color:#00009f>include</span><span class="token macro property" style=color:#36acaa> </span><span class="token macro property string" style=color:#e3116c>&lt;tvm/runtime/packed_func.h></span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token macro property directive-hash" style=color:#36acaa>#</span><span class="token macro property directive keyword" style=color:#00009f>include</span><span class="token macro property" style=color:#36acaa> </span><span class="token macro property string" style=color:#e3116c>&lt;dlpack/dlpack.h></span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token macro property directive-hash" style=color:#36acaa>#</span><span class="token macro property directive keyword" style=color:#00009f>include</span><span class="token macro property" style=color:#36acaa> </span><span class="token macro property string" style=color:#e3116c>&lt;cstdint></span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token macro property directive-hash" style=color:#36acaa>#</span><span class="token macro property directive keyword" style=color:#00009f>include</span><span class="token macro property" style=color:#36acaa> </span><span class="token macro property string" style=color:#e3116c>&lt;cstring></span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token macro property directive-hash" style=color:#36acaa>#</span><span class="token macro property directive keyword" style=color:#00009f>include</span><span class="token macro property" style=color:#36acaa> </span><span class="token macro property string" style=color:#e3116c>&lt;iostream></span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token macro property directive-hash" style=color:#36acaa>#</span><span class="token macro property directive keyword" style=color:#00009f>define</span><span class="token macro property" style=color:#36acaa> </span><span class="token macro property macro-name function" style=color:#d73a49>GCC_BINARY_OP_1D</span><span class="token macro property expression punctuation" style=color:#393A34>(</span><span class="token macro property expression" style=color:#36acaa>p_ID_</span><span class="token macro property expression punctuation" style=color:#393A34>,</span><span class="token macro property expression" style=color:#36acaa> p_OP_</span><span class="token macro property expression punctuation" style=color:#393A34>,</span><span class="token macro property expression" style=color:#36acaa> p_DIM1_</span><span class="token macro property expression punctuation" style=color:#393A34>)</span><span class="token macro property expression" style=color:#36acaa>           </span><span class="token macro property punctuation" style=color:#393A34>\</span><span class="token macro property" style=color:#36acaa></span><br></span><span class=token-line style=color:#393A34><span class="token macro property" style=color:#36acaa>  </span><span class="token macro property expression keyword" style=color:#00009f>extern</span><span class="token macro property expression" style=color:#36acaa> </span><span class="token macro property string" style=color:#e3116c>"C"</span><span class="token macro property" style=color:#36acaa> </span><span class="token macro property expression keyword" style=color:#00009f>void</span><span class="token macro property expression" style=color:#36acaa> </span><span class="token macro property expression function" style=color:#d73a49>p_ID_</span><span class="token macro property expression punctuation" style=color:#393A34>(</span><span class="token macro property expression keyword" style=color:#00009f>float</span><span class="token macro property expression operator" style=color:#393A34>*</span><span class="token macro property expression" style=color:#36acaa> a</span><span class="token macro property expression punctuation" style=color:#393A34>,</span><span class="token macro property expression" style=color:#36acaa> </span><span class="token macro property expression keyword" style=color:#00009f>float</span><span class="token macro property expression operator" style=color:#393A34>*</span><span class="token macro property expression" style=color:#36acaa> b</span><span class="token macro property expression punctuation" style=color:#393A34>,</span><span class="token macro property expression" style=color:#36acaa> </span><span class="token macro property expression keyword" style=color:#00009f>float</span><span class="token macro property expression operator" style=color:#393A34>*</span><span class="token macro property expression" style=color:#36acaa> out</span><span class="token macro property expression punctuation" style=color:#393A34>)</span><span class="token macro property expression" style=color:#36acaa> </span><span class="token macro property expression punctuation" style=color:#393A34>{</span><span class="token macro property expression" style=color:#36acaa> </span><span class="token macro property punctuation" style=color:#393A34>\</span><span class="token macro property" style=color:#36acaa></span><br></span><span class=token-line style=color:#393A34><span class="token macro property" style=color:#36acaa>    </span><span class="token macro property expression keyword" style=color:#00009f>for</span><span class="token macro property expression" style=color:#36acaa> </span><span class="token macro property expression punctuation" style=color:#393A34>(</span><span class="token macro property expression keyword" style=color:#00009f>int64_t</span><span class="token macro property expression" style=color:#36acaa> i </span><span class="token macro property expression operator" style=color:#393A34>=</span><span class="token macro property expression" style=color:#36acaa> </span><span class="token macro property expression number" style=color:#36acaa>0</span><span class="token macro property expression punctuation" style=color:#393A34>;</span><span class="token macro property expression" style=color:#36acaa> i </span><span class="token macro property expression operator" style=color:#393A34>&lt;</span><span class="token macro property expression" style=color:#36acaa> p_DIM1_</span><span class="token macro property expression punctuation" style=color:#393A34>;</span><span class="token macro property expression" style=color:#36acaa> </span><span class="token macro property expression operator" style=color:#393A34>++</span><span class="token macro property expression" style=color:#36acaa>i</span><span class="token macro property expression punctuation" style=color:#393A34>)</span><span class="token macro property expression" style=color:#36acaa> </span><span class="token macro property expression punctuation" style=color:#393A34>{</span><span class="token macro property expression" style=color:#36acaa>               </span><span class="token macro property punctuation" style=color:#393A34>\</span><span class="token macro property" style=color:#36acaa></span><br></span><span class=token-line style=color:#393A34><span class="token macro property" style=color:#36acaa>      </span><span class="token macro property expression" style=color:#36acaa>out</span><span class="token macro property expression punctuation" style=color:#393A34>[</span><span class="token macro property expression" style=color:#36acaa>i</span><span class="token macro property expression punctuation" style=color:#393A34>]</span><span class="token macro property expression" style=color:#36acaa> </span><span class="token macro property expression operator" style=color:#393A34>=</span><span class="token macro property expression" style=color:#36acaa> a</span><span class="token macro property expression punctuation" style=color:#393A34>[</span><span class="token macro property expression" style=color:#36acaa>i</span><span class="token macro property expression punctuation" style=color:#393A34>]</span><span class="token macro property expression" style=color:#36acaa> p_OP_ b</span><span class="token macro property expression punctuation" style=color:#393A34>[</span><span class="token macro property expression" style=color:#36acaa>i</span><span class="token macro property expression punctuation" style=color:#393A34>]</span><span class="token macro property expression punctuation" style=color:#393A34>;</span><span class="token macro property expression" style=color:#36acaa>                           </span><span class="token macro property punctuation" style=color:#393A34>\</span><span class="token macro property" style=color:#36acaa></span><br></span><span class=token-line style=color:#393A34><span class="token macro property" style=color:#36acaa>    </span><span class="token macro property expression punctuation" style=color:#393A34>}</span><span class="token macro property expression" style=color:#36acaa>                                                     </span><span class="token macro property punctuation" style=color:#393A34>\</span><span class="token macro property" style=color:#36acaa></span><br></span><span class=token-line style=color:#393A34><span class="token macro property" style=color:#36acaa>  </span><span class="token macro property expression punctuation" style=color:#393A34>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token macro property directive-hash" style=color:#36acaa>#</span><span class="token macro property directive keyword" style=color:#00009f>define</span><span class="token macro property" style=color:#36acaa> </span><span class="token macro property macro-name function" style=color:#d73a49>GCC_BINARY_OP_2D</span><span class="token macro property expression punctuation" style=color:#393A34>(</span><span class="token macro property expression" style=color:#36acaa>p_ID_</span><span class="token macro property expression punctuation" style=color:#393A34>,</span><span class="token macro property expression" style=color:#36acaa> p_OP_</span><span class="token macro property expression punctuation" style=color:#393A34>,</span><span class="token macro property expression" style=color:#36acaa> p_DIM1_</span><span class="token macro property expression punctuation" style=color:#393A34>,</span><span class="token macro property expression" style=color:#36acaa> p_DIM2_</span><span class="token macro property expression punctuation" style=color:#393A34>)</span><span class="token macro property expression" style=color:#36acaa>  </span><span class="token macro property punctuation" style=color:#393A34>\</span><span class="token macro property" style=color:#36acaa></span><br></span><span class=token-line style=color:#393A34><span class="token macro property" style=color:#36acaa>  </span><span class="token macro property expression keyword" style=color:#00009f>extern</span><span class="token macro property expression" style=color:#36acaa> </span><span class="token macro property string" style=color:#e3116c>"C"</span><span class="token macro property" style=color:#36acaa> </span><span class="token macro property expression keyword" style=color:#00009f>void</span><span class="token macro property expression" style=color:#36acaa> </span><span class="token macro property expression function" style=color:#d73a49>p_ID_</span><span class="token macro property expression punctuation" style=color:#393A34>(</span><span class="token macro property expression keyword" style=color:#00009f>float</span><span class="token macro property expression operator" style=color:#393A34>*</span><span class="token macro property expression" style=color:#36acaa> a</span><span class="token macro property expression punctuation" style=color:#393A34>,</span><span class="token macro property expression" style=color:#36acaa> </span><span class="token macro property expression keyword" style=color:#00009f>float</span><span class="token macro property expression operator" style=color:#393A34>*</span><span class="token macro property expression" style=color:#36acaa> b</span><span class="token macro property expression punctuation" style=color:#393A34>,</span><span class="token macro property expression" style=color:#36acaa> </span><span class="token macro property expression keyword" style=color:#00009f>float</span><span class="token macro property expression operator" style=color:#393A34>*</span><span class="token macro property expression" style=color:#36acaa> out</span><span class="token macro property expression punctuation" style=color:#393A34>)</span><span class="token macro property expression" style=color:#36acaa> </span><span class="token macro property expression punctuation" style=color:#393A34>{</span><span class="token macro property expression" style=color:#36acaa> </span><span class="token macro property punctuation" style=color:#393A34>\</span><span class="token macro property" style=color:#36acaa></span><br></span><span class=token-line style=color:#393A34><span class="token macro property" style=color:#36acaa>    </span><span class="token macro property expression keyword" style=color:#00009f>for</span><span class="token macro property expression" style=color:#36acaa> </span><span class="token macro property expression punctuation" style=color:#393A34>(</span><span class="token macro property expression keyword" style=color:#00009f>int64_t</span><span class="token macro property expression" style=color:#36acaa> i </span><span class="token macro property expression operator" style=color:#393A34>=</span><span class="token macro property expression" style=color:#36acaa> </span><span class="token macro property expression number" style=color:#36acaa>0</span><span class="token macro property expression punctuation" style=color:#393A34>;</span><span class="token macro property expression" style=color:#36acaa> i </span><span class="token macro property expression operator" style=color:#393A34>&lt;</span><span class="token macro property expression" style=color:#36acaa> p_DIM1_</span><span class="token macro property expression punctuation" style=color:#393A34>;</span><span class="token macro property expression" style=color:#36acaa> </span><span class="token macro property expression operator" style=color:#393A34>++</span><span class="token macro property expression" style=color:#36acaa>i</span><span class="token macro property expression punctuation" style=color:#393A34>)</span><span class="token macro property expression" style=color:#36acaa> </span><span class="token macro property expression punctuation" style=color:#393A34>{</span><span class="token macro property expression" style=color:#36acaa>               </span><span class="token macro property punctuation" style=color:#393A34>\</span><span class="token macro property" style=color:#36acaa></span><br></span><span class=token-line style=color:#393A34><span class="token macro property" style=color:#36acaa>      </span><span class="token macro property expression keyword" style=color:#00009f>for</span><span class="token macro property expression" style=color:#36acaa> </span><span class="token macro property expression punctuation" style=color:#393A34>(</span><span class="token macro property expression keyword" style=color:#00009f>int64_t</span><span class="token macro property expression" style=color:#36acaa> j </span><span class="token macro property expression operator" style=color:#393A34>=</span><span class="token macro property expression" style=color:#36acaa> </span><span class="token macro property expression number" style=color:#36acaa>0</span><span class="token macro property expression punctuation" style=color:#393A34>;</span><span class="token macro property expression" style=color:#36acaa> j </span><span class="token macro property expression operator" style=color:#393A34>&lt;</span><span class="token macro property expression" style=color:#36acaa> p_DIM2_</span><span class="token macro property expression punctuation" style=color:#393A34>;</span><span class="token macro property expression" style=color:#36acaa> </span><span class="token macro property expression operator" style=color:#393A34>++</span><span class="token macro property expression" style=color:#36acaa>j</span><span class="token macro property expression punctuation" style=color:#393A34>)</span><span class="token macro property expression" style=color:#36acaa> </span><span class="token macro property expression punctuation" style=color:#393A34>{</span><span class="token macro property expression" style=color:#36acaa>             </span><span class="token macro property punctuation" style=color:#393A34>\</span><span class="token macro property" style=color:#36acaa></span><br></span><span class=token-line style=color:#393A34><span class="token macro property" style=color:#36acaa>        </span><span class="token macro property expression keyword" style=color:#00009f>int64_t</span><span class="token macro property expression" style=color:#36acaa> k </span><span class="token macro property expression operator" style=color:#393A34>=</span><span class="token macro property expression" style=color:#36acaa> i </span><span class="token macro property expression operator" style=color:#393A34>*</span><span class="token macro property expression" style=color:#36acaa> p_DIM2_ </span><span class="token macro property expression operator" style=color:#393A34>+</span><span class="token macro property expression" style=color:#36acaa> j</span><span class="token macro property expression punctuation" style=color:#393A34>;</span><span class="token macro property expression" style=color:#36acaa>                      </span><span class="token macro property punctuation" style=color:#393A34>\</span><span class="token macro property" style=color:#36acaa></span><br></span><span class=token-line style=color:#393A34><span class="token macro property" style=color:#36acaa>        </span><span class="token macro property expression" style=color:#36acaa>out</span><span class="token macro property expression punctuation" style=color:#393A34>[</span><span class="token macro property expression" style=color:#36acaa>k</span><span class="token macro property expression punctuation" style=color:#393A34>]</span><span class="token macro property expression" style=color:#36acaa> </span><span class="token macro property expression operator" style=color:#393A34>=</span><span class="token macro property expression" style=color:#36acaa> a</span><span class="token macro property expression punctuation" style=color:#393A34>[</span><span class="token macro property expression" style=color:#36acaa>k</span><span class="token macro property expression punctuation" style=color:#393A34>]</span><span class="token macro property expression" style=color:#36acaa> p_OP_ b</span><span class="token macro property expression punctuation" style=color:#393A34>[</span><span class="token macro property expression" style=color:#36acaa>k</span><span class="token macro property expression punctuation" style=color:#393A34>]</span><span class="token macro property expression punctuation" style=color:#393A34>;</span><span class="token macro property expression" style=color:#36acaa>                         </span><span class="token macro property punctuation" style=color:#393A34>\</span><span class="token macro property" style=color:#36acaa></span><br></span><span class=token-line style=color:#393A34><span class="token macro property" style=color:#36acaa>      </span><span class="token macro property expression punctuation" style=color:#393A34>}</span><span class="token macro property expression" style=color:#36acaa>                                                   </span><span class="token macro property punctuation" style=color:#393A34>\</span><span class="token macro property" style=color:#36acaa></span><br></span><span class=token-line style=color:#393A34><span class="token macro property" style=color:#36acaa>    </span><span class="token macro property expression punctuation" style=color:#393A34>}</span><span class="token macro property expression" style=color:#36acaa>                                                     </span><span class="token macro property punctuation" style=color:#393A34>\</span><span class="token macro property" style=color:#36acaa></span><br></span><span class=token-line style=color:#393A34><span class="token macro property" style=color:#36acaa>  </span><span class="token macro property expression punctuation" style=color:#393A34>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic>// 注 1</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token function" style=color:#d73a49>GCC_BINARY_OP_2D</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">gcc_0_0</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>*</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token number" style=color:#36acaa>10</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token number" style=color:#36acaa>10</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token function" style=color:#d73a49>GCC_BINARY_OP_2D</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">gcc_0_1</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>-</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token number" style=color:#36acaa>10</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token number" style=color:#36acaa>10</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token function" style=color:#d73a49>GCC_BINARY_OP_2D</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">gcc_0_2</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>+</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token number" style=color:#36acaa>10</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token number" style=color:#36acaa>10</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic>// 注 2</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>extern</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"C"</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>void</span><span class="token plain"> </span><span class="token function" style=color:#d73a49>gcc_0_</span><span class="token punctuation" style=color:#393A34>(</span><span class="token keyword" style=color:#00009f>float</span><span class="token operator" style=color:#393A34>*</span><span class="token plain"> gcc_input0</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>float</span><span class="token operator" style=color:#393A34>*</span><span class="token plain"> gcc_input1</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">                       </span><span class="token keyword" style=color:#00009f>float</span><span class="token operator" style=color:#393A34>*</span><span class="token plain"> gcc_input2</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>float</span><span class="token operator" style=color:#393A34>*</span><span class="token plain"> gcc_input3</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>float</span><span class="token operator" style=color:#393A34>*</span><span class="token plain"> out</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token keyword" style=color:#00009f>float</span><span class="token operator" style=color:#393A34>*</span><span class="token plain"> buf_0 </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token keyword" style=color:#00009f>float</span><span class="token operator" style=color:#393A34>*</span><span class="token punctuation" style=color:#393A34>)</span><span class="token function" style=color:#d73a49>malloc</span><span class="token punctuation" style=color:#393A34>(</span><span class="token number" style=color:#36acaa>4</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>*</span><span class="token plain"> </span><span class="token number" style=color:#36acaa>100</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token keyword" style=color:#00009f>float</span><span class="token operator" style=color:#393A34>*</span><span class="token plain"> buf_1 </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token keyword" style=color:#00009f>float</span><span class="token operator" style=color:#393A34>*</span><span class="token punctuation" style=color:#393A34>)</span><span class="token function" style=color:#d73a49>malloc</span><span class="token punctuation" style=color:#393A34>(</span><span class="token number" style=color:#36acaa>4</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>*</span><span class="token plain"> </span><span class="token number" style=color:#36acaa>100</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token function" style=color:#d73a49>gcc_0_2</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">gcc_input0</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> gcc_input1</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> buf_0</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token function" style=color:#d73a49>gcc_0_1</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">buf_0</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> gcc_input2</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> buf_1</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token function" style=color:#d73a49>gcc_0_0</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">buf_1</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> gcc_input3</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> out</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token function" style=color:#d73a49>free</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">buf_0</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token function" style=color:#d73a49>free</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">buf_1</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic>// 注 3</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>extern</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"C"</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>int</span><span class="token plain"> </span><span class="token function" style=color:#d73a49>gcc_0_wrapper</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">DLTensor</span><span class="token operator" style=color:#393A34>*</span><span class="token plain"> arg0</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> DLTensor</span><span class="token operator" style=color:#393A34>*</span><span class="token plain"> arg1</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> DLTensor</span><span class="token operator" style=color:#393A34>*</span><span class="token plain"> arg2</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">                             DLTensor</span><span class="token operator" style=color:#393A34>*</span><span class="token plain"> arg3</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> DLTensor</span><span class="token operator" style=color:#393A34>*</span><span class="token plain"> out</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token function" style=color:#d73a49>gcc_0_</span><span class="token punctuation" style=color:#393A34>(</span><span class="token generic-function function" style=color:#d73a49>static_cast</span><span class="token generic-function generic class-name operator" style=color:#393A34>&lt;</span><span class="token generic-function generic class-name keyword" style=color:#00009f>float</span><span class="token generic-function generic class-name operator" style=color:#393A34>*</span><span class="token generic-function generic class-name operator" style=color:#393A34>></span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">arg0</span><span class="token operator" style=color:#393A34>-></span><span class="token plain">data</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token generic-function function" style=color:#d73a49>static_cast</span><span class="token generic-function generic class-name operator" style=color:#393A34>&lt;</span><span class="token generic-function generic class-name keyword" style=color:#00009f>float</span><span class="token generic-function generic class-name operator" style=color:#393A34>*</span><span class="token generic-function generic class-name operator" style=color:#393A34>></span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">arg1</span><span class="token operator" style=color:#393A34>-></span><span class="token plain">data</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">         </span><span class="token generic-function function" style=color:#d73a49>static_cast</span><span class="token generic-function generic class-name operator" style=color:#393A34>&lt;</span><span class="token generic-function generic class-name keyword" style=color:#00009f>float</span><span class="token generic-function generic class-name operator" style=color:#393A34>*</span><span class="token generic-function generic class-name operator" style=color:#393A34>></span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">arg2</span><span class="token operator" style=color:#393A34>-></span><span class="token plain">data</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token generic-function function" style=color:#d73a49>static_cast</span><span class="token generic-function generic class-name operator" style=color:#393A34>&lt;</span><span class="token generic-function generic class-name keyword" style=color:#00009f>float</span><span class="token generic-function generic class-name operator" style=color:#393A34>*</span><span class="token generic-function generic class-name operator" style=color:#393A34>></span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">arg3</span><span class="token operator" style=color:#393A34>-></span><span class="token plain">data</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">         </span><span class="token generic-function function" style=color:#d73a49>static_cast</span><span class="token generic-function generic class-name operator" style=color:#393A34>&lt;</span><span class="token generic-function generic class-name keyword" style=color:#00009f>float</span><span class="token generic-function generic class-name operator" style=color:#393A34>*</span><span class="token generic-function generic class-name operator" style=color:#393A34>></span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">out</span><span class="token operator" style=color:#393A34>-></span><span class="token plain">data</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token keyword" style=color:#00009f>return</span><span class="token plain"> </span><span class="token number" style=color:#36acaa>0</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token function" style=color:#d73a49>TVM_DLL_EXPORT_TYPED_FUNC</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">gcc_0</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> gcc_0_wrapper</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>这里详细介绍一下上面代码里的注释：</p>
<ul>
<li><strong>注1</strong>：子图中三个节点的函数实现。</li>
<li><strong>注2</strong>：通过分配中间数组（intermediate buffer）并调用相应函数来执行子图的函数。</li>
<li><strong>注3</strong>：TVM runtime 兼容的包装函数。它接收一个输入张量列表和一个输出张量（最后一个参数），并将其转换为正确的数据类型，调用注2 中描述的子图函数。此外，<code>TVM_DLL_EXPORT_TYPED_FUNC</code> 是一个 TVM 宏，它通过将所有张量打包到 <code>TVMArgs</code> 来生成另一个函数 <code>gcc_0</code>，该函数具有统一的函数参数。因此，TVM runtime 可以直接调用 <code>gcc_0</code> 来执行子图，无需其他操作。生成上述代码后，TVM 能够将其与计算图的其余部分一起编译并导出单个库以进行部署。</li>
</ul>
<p>在本节的其余部分，我们将逐步创建一个 codegen，来实现上述代码。你的 codegen 必须位于 <code>src/relay/backend/contrib/&lt;your-codegen-name>/</code>。在这个例子中，我们将 codegen 命名为 "codegen_c"，并将其放在 <a href=https://github.com/apache/tvm/blob/main/src/relay/backend/contrib/codegen_c/codegen.cc target=_blank rel="noopener noreferrer">/src/relay/backend/contrib/codegen_c/</a> 目录下。你可以随时查看这个文件，了解完整的实现过程。</p>
<p>具体来说，我们将在这个文件中实现两个类，两个类的关系如下：</p>
<div class="language-text codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-text codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token plain">            subgraph                                subgraph</span><br></span><span class=token-line style=color:#393A34><span class="token plain">TVM backend -----------------------------> CSourceCodegen -------------> CodegenC</span><br></span><span class=token-line style=color:#393A34><span class="token plain">       ^                                       |    ^                       |</span><br></span><span class=token-line style=color:#393A34><span class="token plain">       |                                       |    |                       |</span><br></span><span class=token-line style=color:#393A34><span class="token plain">       ----------------------------------------      ------------------------</span><br></span><span class=token-line style=color:#393A34><span class="token plain">          generated C source runtime module              generated C code</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>当 TVM 后端发现 Relay 计算图中的函数（子图），用注册的编译器标签（本例中为 <code>ccompiler</code>）进行了注释时，TVM 后端就会调用 <code>CSourceCodegen</code> 并传递子图。 <code>CSourceCodegen</code> 的成员函数 <code>CreateCSourceModule</code> 将：</p>
<p>1）为子图生成 C 代码；</p>
<p>2）将生成的 C 代码包装到 C source runtime 模块中，以便 TVM 后端进行编译和部署。</p>
<p>特别是，C codegen 对 <code>CodegenC</code> 类是透明的，因为它提供了许多有用的实用程序来简化 codegen 实现。下面的章节将自下而上实现这两个类。</p>
<h2 class="anchor anchorWithStickyNavbar_csPL" id=实现-codegenc>实现 CodegenC<a href=#实现-codegenc class=hash-link aria-label="实现 CodegenC的直接链接" title="实现 CodegenC的直接链接">​</a></h2>
<p>在 <code>src/relay/backend/contrib/codegen_c/codegen.cc</code> 中，首先在 <code>tvm.relay.contrib</code> 的命名空间下创建一个 codegen 类骨架：</p>
<div class="language-cpp codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-cpp codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token macro property directive-hash" style=color:#36acaa>#</span><span class="token macro property directive keyword" style=color:#00009f>include</span><span class="token macro property" style=color:#36acaa> </span><span class="token macro property string" style=color:#e3116c>&lt;tvm/relay/expr_functor.h></span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token macro property directive-hash" style=color:#36acaa>#</span><span class="token macro property directive keyword" style=color:#00009f>include</span><span class="token macro property" style=color:#36acaa> </span><span class="token macro property string" style=color:#e3116c>&lt;tvm/relay/transform.h></span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token macro property directive-hash" style=color:#36acaa>#</span><span class="token macro property directive keyword" style=color:#00009f>include</span><span class="token macro property" style=color:#36acaa> </span><span class="token macro property string" style=color:#e3116c>&lt;tvm/relay/type.h></span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token macro property directive-hash" style=color:#36acaa>#</span><span class="token macro property directive keyword" style=color:#00009f>include</span><span class="token macro property" style=color:#36acaa> </span><span class="token macro property string" style=color:#e3116c>&lt;tvm/runtime/module.h></span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token macro property directive-hash" style=color:#36acaa>#</span><span class="token macro property directive keyword" style=color:#00009f>include</span><span class="token macro property" style=color:#36acaa> </span><span class="token macro property string" style=color:#e3116c>&lt;tvm/runtime/object.h></span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token macro property directive-hash" style=color:#36acaa>#</span><span class="token macro property directive keyword" style=color:#00009f>include</span><span class="token macro property" style=color:#36acaa> </span><span class="token macro property string" style=color:#e3116c>&lt;fstream></span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token macro property directive-hash" style=color:#36acaa>#</span><span class="token macro property directive keyword" style=color:#00009f>include</span><span class="token macro property" style=color:#36acaa> </span><span class="token macro property string" style=color:#e3116c>&lt;sstream></span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token macro property directive-hash" style=color:#36acaa>#</span><span class="token macro property directive keyword" style=color:#00009f>include</span><span class="token macro property" style=color:#36acaa> </span><span class="token macro property string" style=color:#e3116c>"codegen_c.h"</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>namespace</span><span class="token plain"> tvm </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>namespace</span><span class="token plain"> relay </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>namespace</span><span class="token plain"> contrib </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>class</span><span class="token plain"> </span><span class="token class-name">CodegenC</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token base-clause keyword" style=color:#00009f>public</span><span class="token base-clause"> </span><span class="token base-clause class-name">ExprVisitor</span><span class="token base-clause punctuation" style=color:#393A34>,</span><span class="token base-clause"> </span><span class="token base-clause keyword" style=color:#00009f>public</span><span class="token base-clause"> </span><span class="token base-clause class-name">CodegenCBase</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token keyword" style=color:#00009f>public</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token keyword" style=color:#00009f>explicit</span><span class="token plain"> </span><span class="token function" style=color:#d73a49>CodegenC</span><span class="token punctuation" style=color:#393A34>(</span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> std</span><span class="token double-colon punctuation" style=color:#393A34>::</span><span class="token plain">string</span><span class="token operator" style=color:#393A34>&</span><span class="token plain"> id</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>this</span><span class="token operator" style=color:#393A34>-></span><span class="token plain">ext_func_id_ </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> id</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token keyword" style=color:#00009f>void</span><span class="token plain"> </span><span class="token function" style=color:#d73a49>VisitExpr_</span><span class="token punctuation" style=color:#393A34>(</span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> VarNode</span><span class="token operator" style=color:#393A34>*</span><span class="token plain"> node</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token keyword" style=color:#00009f>void</span><span class="token plain"> </span><span class="token function" style=color:#d73a49>VisitExpr_</span><span class="token punctuation" style=color:#393A34>(</span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> CallNode</span><span class="token operator" style=color:#393A34>*</span><span class="token plain"> call</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>final</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    std</span><span class="token double-colon punctuation" style=color:#393A34>::</span><span class="token plain">string </span><span class="token function" style=color:#d73a49>JIT</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token keyword" style=color:#00009f>private</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token comment" style=color:#999988;font-style:italic>/*! \brief The function id that represents a C source function. */</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    std</span><span class="token double-colon punctuation" style=color:#393A34>::</span><span class="token plain">string ext_func_id_ </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>""</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token comment" style=color:#999988;font-style:italic>/*! \brief The index of a wrapped C function. */</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token keyword" style=color:#00009f>int</span><span class="token plain"> func_idx </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token number" style=color:#36acaa>0</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token comment" style=color:#999988;font-style:italic>/*! \brief The index of allocated buffers. */</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token keyword" style=color:#00009f>int</span><span class="token plain"> buf_idx_ </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token number" style=color:#36acaa>0</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token comment" style=color:#999988;font-style:italic>/*! \brief The arguments of a C compiler compatible function. */</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    std</span><span class="token double-colon punctuation" style=color:#393A34>::</span><span class="token plain">vector</span><span class="token operator" style=color:#393A34>&lt;</span><span class="token plain">std</span><span class="token double-colon punctuation" style=color:#393A34>::</span><span class="token plain">string</span><span class="token operator" style=color:#393A34>></span><span class="token plain"> ext_func_args_</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token comment" style=color:#999988;font-style:italic>/*! \brief The statements of a C compiler compatible function. */</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    std</span><span class="token double-colon punctuation" style=color:#393A34>::</span><span class="token plain">vector</span><span class="token operator" style=color:#393A34>&lt;</span><span class="token plain">std</span><span class="token double-colon punctuation" style=color:#393A34>::</span><span class="token plain">string</span><span class="token operator" style=color:#393A34>></span><span class="token plain"> ext_func_body</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token comment" style=color:#999988;font-style:italic>/*! \brief The declaration statements of a C compiler compatible function. */</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    std</span><span class="token double-colon punctuation" style=color:#393A34>::</span><span class="token plain">vector</span><span class="token operator" style=color:#393A34>&lt;</span><span class="token plain">std</span><span class="token double-colon punctuation" style=color:#393A34>::</span><span class="token plain">string</span><span class="token operator" style=color:#393A34>></span><span class="token plain"> func_decl_</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token comment" style=color:#999988;font-style:italic>/*! \brief The declaration statements of buffers. */</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    std</span><span class="token double-colon punctuation" style=color:#393A34>::</span><span class="token plain">vector</span><span class="token operator" style=color:#393A34>&lt;</span><span class="token plain">std</span><span class="token double-colon punctuation" style=color:#393A34>::</span><span class="token plain">string</span><span class="token operator" style=color:#393A34>></span><span class="token plain"> buf_decl_</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token comment" style=color:#999988;font-style:italic>/*! \brief The name and index pairs for output. */</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    std</span><span class="token double-colon punctuation" style=color:#393A34>::</span><span class="token plain">vector</span><span class="token operator" style=color:#393A34>&lt;</span><span class="token plain">std</span><span class="token double-colon punctuation" style=color:#393A34>::</span><span class="token plain">pair</span><span class="token operator" style=color:#393A34>&lt;</span><span class="token plain">std</span><span class="token double-colon punctuation" style=color:#393A34>::</span><span class="token plain">string</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>int</span><span class="token operator" style=color:#393A34>>></span><span class="token plain"> out_</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>}</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p><code>CodegenC</code> 类继承了两个类： <code>ExprVisitor</code> 提供遍历子图的能力，然后收集所需的信息并生成子图函数，例如 <code>gcc_0_</code>。</p>
<p><code>CodegenCBase</code> 提供了生成包装函数的能力和实用程序，例如上例中的 <code>gcc_0</code>。可以看出，我们只需要在这个 codegen 类中实现三个函数就可以了。</p>
<h3 class="anchor anchorWithStickyNavbar_csPL" id=算子的代码生成>算子的代码生成<a href=#算子的代码生成 class=hash-link aria-label=算子的代码生成的直接链接 title=算子的代码生成的直接链接>​</a></h3>
<p>首先实现 <code>VisitExpr_(const CallNode* call)</code>。该函数在遍历子图时会访问所有调用节点。每个调用节点都包含一个我们想要卸载（offload）到硬件中的算子。因此，我们需要按照拓扑顺序生成具有正确算子的相应 C 代码。完整实现过程如下：</p>
<h4 class="anchor anchorWithStickyNavbar_csPL" id=1-生成函数声明>1. 生成函数声明<a href=#1-生成函数声明 class=hash-link aria-label="1. 生成函数声明的直接链接" title="1. 生成函数声明的直接链接">​</a></h4>
<p>示例结果：<code>GCC_BINARY_OP_2D(gcc_0_0, *, 10, 10);</code></p>
<p>要生成函数声明，如上所示，我们需要：</p>
<p>1）函数名（例如 <code>gcc_0_0</code>）</p>
<p>2）算子的类型（例如 <code>*</code> ）</p>
<p>3）输入张量 shape（例如 <code>(10, 10)</code> ）</p>
<p>这些信息可以从 <code>CallNode</code> 轻松获取：</p>
<div class="language-cpp codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-cpp codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token plain">std</span><span class="token double-colon punctuation" style=color:#393A34>::</span><span class="token plain">ostringstream macro_stream</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">std</span><span class="token double-colon punctuation" style=color:#393A34>::</span><span class="token plain">ostringstream decl_stream</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">std</span><span class="token double-colon punctuation" style=color:#393A34>::</span><span class="token plain">ostringstream buf_stream</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic>// Generate a unique function name you like.</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">std</span><span class="token double-colon punctuation" style=color:#393A34>::</span><span class="token plain">string func_name </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> ext_func_id_ </span><span class="token operator" style=color:#393A34>+</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"_"</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>+</span><span class="token plain"> std</span><span class="token double-colon punctuation" style=color:#393A34>::</span><span class="token function" style=color:#d73a49>to_string</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">func_idx</span><span class="token operator" style=color:#393A34>++</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic>// Make function declaration string.</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">macro_stream </span><span class="token operator" style=color:#393A34>&lt;&lt;</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"CSOURCE_BINARY_OP_"</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>&lt;&lt;</span><span class="token plain"> call</span><span class="token operator" style=color:#393A34>-></span><span class="token plain">args</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>size</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>&lt;&lt;</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"D("</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>&lt;&lt;</span><span class="token plain"> func_name </span><span class="token operator" style=color:#393A34>&lt;&lt;</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>", "</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic>// Check the operator type.</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>if</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token function" style=color:#d73a49>IsOp</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">call</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"add"</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  macro_stream </span><span class="token operator" style=color:#393A34>&lt;&lt;</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"+"</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>else</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>if</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token function" style=color:#d73a49>IsOp</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">call</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"subtract"</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  macro_stream </span><span class="token operator" style=color:#393A34>&lt;&lt;</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"-"</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>else</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>if</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token function" style=color:#d73a49>IsOp</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">call</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"multiply"</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  macro_stream </span><span class="token operator" style=color:#393A34>&lt;&lt;</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"*"</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>else</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token function" style=color:#d73a49>LOG</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">FATAL</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>&lt;&lt;</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"Unrecognized op"</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic>// Extract the input tensor shape.</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>auto</span><span class="token plain"> in_shape </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token function" style=color:#d73a49>GetShape</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">call</span><span class="token operator" style=color:#393A34>-></span><span class="token plain">args</span><span class="token punctuation" style=color:#393A34>[</span><span class="token number" style=color:#36acaa>0</span><span class="token punctuation" style=color:#393A34>]</span><span class="token operator" style=color:#393A34>-></span><span class="token function" style=color:#d73a49>checked_type</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>for</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">size_t i </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token number" style=color:#36acaa>0</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> i </span><span class="token operator" style=color:#393A34>&lt;</span><span class="token plain"> in_shape</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>size</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>++</span><span class="token plain">i</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  macro_stream </span><span class="token operator" style=color:#393A34>&lt;&lt;</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>", "</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>&lt;&lt;</span><span class="token plain"> in_shape</span><span class="token punctuation" style=color:#393A34>[</span><span class="token plain">i</span><span class="token punctuation" style=color:#393A34>]</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">macro_stream </span><span class="token operator" style=color:#393A34>&lt;&lt;</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>");"</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">func_decl_</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>push_back</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">macro_stream</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>str</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>可以看出，我们将生成的代码推送到类成员变量 <code>func_decl_</code> 中。这意味着在我们完成遍历整个子图之后，我们已经收集了所有必需的函数声明，我们唯一需要做的就是用 GCC 编译它们。 <code>VisitExpr_(const CallNode* call)</code> 的其余实现也遵循这个概念。</p>
<h4 class="anchor anchorWithStickyNavbar_csPL" id=2-生成函数调用>2. 生成函数调用<a href=#2-生成函数调用 class=hash-link aria-label="2. 生成函数调用的直接链接" title="2. 生成函数调用的直接链接">​</a></h4>
<p>示例结果：<code>gcc_0_0(buf_1, gcc_input3, out);</code></p>
<p>生成函数声明后，我们需要生成一个具有正确输入和输出的函数调用。要想知道调用这个函数时应该放置哪些输入或数组，必须访问它的参数：</p>
<div class="language-cpp codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-cpp codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token keyword" style=color:#00009f>bool</span><span class="token plain"> first </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token boolean" style=color:#36acaa>true</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">decl_stream </span><span class="token operator" style=color:#393A34>&lt;&lt;</span><span class="token plain"> func_name </span><span class="token operator" style=color:#393A34>&lt;&lt;</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"("</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>for</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">size_t i </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token number" style=color:#36acaa>0</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> i </span><span class="token operator" style=color:#393A34>&lt;</span><span class="token plain"> call</span><span class="token operator" style=color:#393A34>-></span><span class="token plain">args</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>size</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>++</span><span class="token plain">i</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token function" style=color:#d73a49>VisitExpr</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">call</span><span class="token operator" style=color:#393A34>-></span><span class="token plain">args</span><span class="token punctuation" style=color:#393A34>[</span><span class="token plain">i</span><span class="token punctuation" style=color:#393A34>]</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// 注 1</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token keyword" style=color:#00009f>for</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token keyword" style=color:#00009f>auto</span><span class="token plain"> out </span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> out_</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token keyword" style=color:#00009f>if</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token operator" style=color:#393A34>!</span><span class="token plain">first</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">      decl_stream </span><span class="token operator" style=color:#393A34>&lt;&lt;</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>", "</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    first </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token boolean" style=color:#36acaa>false</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    decl_stream </span><span class="token operator" style=color:#393A34>&lt;&lt;</span><span class="token plain"> out</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">first</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic>// 注 2</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>同样，重点介绍一下上述代码中的注释：</p>
<p><strong>注1</strong>：<code>VisitExpr(call->args[i])</code> 是访问当前函数参数的递归调用。参数可以是另一个节点的输出或输入张量。在该示例中，需要确保每个节点在离开访问器之前，都更新一个类变量 <code>out_</code>。图解如下：</p>
<div class="language-text codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-text codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token plain"> arg_node                 arg_node &lt;- Visit arg (Note 1)       arg_node</span><br></span><span class=token-line style=color:#393A34><span class="token plain">     |                        |                                    |</span><br></span><span class=token-line style=color:#393A34><span class="token plain"> curr_node &lt;- Process      curr_node                            curr_node &lt;- Put "buf_0" as an input buffer</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">(a) out_ = {}            (b) out_ = {}                   (c) out_ = {("buf_0", 20)}</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>从上图中可以看出，类变量 <code>out_</code> 在访问参数节点前是空的，它被填充了 <code>arg_node</code> 输出数组的名称和大小。因此在完成对参数节点的访问时，可以通过查看 <code>out_</code> 得知应该放置的正确输入数组。本节末尾以及下一节中，我们将介绍如何更新 <code>out_</code>。</p>
<p><strong>注2</strong>：你可能注意到，我们在这一步没有关闭函数调用字符串。当前函数调用字符串看起来像：<code>gcc_0_0(buf_1, gcc_input3</code>。这是因为我们没有将最后一个参数（如 output）放入此调用中。函数调用的输出可以是分配的临时数组或子图输出张量。简单起见，在本例中我们为每个调用节点都分配老一个输出数组（下一步），并将最后一个数组中的结果复制到了输出张量。</p>
<h4 class="anchor anchorWithStickyNavbar_csPL" id=3-生成输出数组output-buffer>3. 生成输出数组（output buffer）<a href=#3-生成输出数组output-buffer class=hash-link aria-label="3. 生成输出数组（output buffer）的直接链接" title="3. 生成输出数组（output buffer）的直接链接">​</a></h4>
<p>示例结果：<code>float buf_0 = (float)malloc(4 * 100);</code></p>
<p>如上一步所述，除了子图输入和输出张量外，还需要数组来保存中间结果。为了生成数组，我们提取 shape 信息，以确定数组的类型和大小：</p>
<div class="language-cpp codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-cpp codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token comment" style=color:#999988;font-style:italic>// 这个例子仅支持单个输出。</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>auto</span><span class="token plain"> type_node </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> call</span><span class="token operator" style=color:#393A34>-></span><span class="token function" style=color:#d73a49>checked_type</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>.</span><span class="token generic-function function" style=color:#d73a49>as</span><span class="token generic-function generic class-name operator" style=color:#393A34>&lt;</span><span class="token generic-function generic class-name">TensorTypeNode</span><span class="token generic-function generic class-name operator" style=color:#393A34>></span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token function" style=color:#d73a49>ICHECK</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">type_node </span><span class="token operator" style=color:#393A34>!=</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>nullptr</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>&&</span><span class="token plain"> runtime</span><span class="token double-colon punctuation" style=color:#393A34>::</span><span class="token function" style=color:#d73a49>TypeMatch</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">type_node</span><span class="token operator" style=color:#393A34>-></span><span class="token plain">dtype</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> kDLFloat</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token number" style=color:#36acaa>32</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">      </span><span class="token operator" style=color:#393A34>&lt;&lt;</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"Only support single output tensor with float type"</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic>// 生成一个唯一的数组名字。</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">std</span><span class="token double-colon punctuation" style=color:#393A34>::</span><span class="token plain">string out </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"buf_"</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>+</span><span class="token plain"> std</span><span class="token double-colon punctuation" style=color:#393A34>::</span><span class="token function" style=color:#d73a49>to_string</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">buf_idx_</span><span class="token operator" style=color:#393A34>++</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic>// 提取 shape 作为数组大小。</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>auto</span><span class="token plain"> out_shape </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token function" style=color:#d73a49>GetShape</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">call</span><span class="token operator" style=color:#393A34>-></span><span class="token function" style=color:#d73a49>checked_type</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>int</span><span class="token plain"> out_size </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token number" style=color:#36acaa>1</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>for</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">size_t i </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token number" style=color:#36acaa>0</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> i </span><span class="token operator" style=color:#393A34>&lt;</span><span class="token plain"> out_shape</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>size</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>++</span><span class="token plain">i</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  out_size </span><span class="token operator" style=color:#393A34>*=</span><span class="token plain"> out_shape</span><span class="token punctuation" style=color:#393A34>[</span><span class="token plain">i</span><span class="token punctuation" style=color:#393A34>]</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic>// 分配数组并推送至数组声明</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">buf_stream </span><span class="token operator" style=color:#393A34>&lt;&lt;</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"float* "</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>&lt;&lt;</span><span class="token plain"> out </span><span class="token operator" style=color:#393A34>&lt;&lt;</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>" = (float*)std::malloc(4 * "</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>&lt;&lt;</span><span class="token plain"> out_size </span><span class="token operator" style=color:#393A34>&lt;&lt;</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>");"</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">buf_decl_</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>push_back</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">buf_stream</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>str</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>分配了输出数组之后，现在可以关闭函数调用字符串，并将生成的函数调用推送到类变量 <code>ext_func_body</code>。</p>
<div class="language-plain codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-plain codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token plain">decl_stream &lt;&lt; ", " &lt;&lt; out &lt;&lt; ");";</span><br></span><span class=token-line style=color:#393A34><span class="token plain">ext_func_body.push_back(decl_stream.str());</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_csPL" id=4-更新输出数组>4. 更新输出数组<a href=#4-更新输出数组 class=hash-link aria-label="4. 更新输出数组的直接链接" title="4. 更新输出数组的直接链接">​</a></h4>
<p>为了使得下一个节点（接受当前调用节点的输出，作为其输入）知道它应该使用哪个数组，我们需要在离开这个访问函数之前更新类变量 <code>out_</code>：</p>
<div class="language-plain codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-plain codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token plain">out_.clear();</span><br></span><span class=token-line style=color:#393A34><span class="token plain">out_.push_back({out, out_size});</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>恭喜！到这一步我们已经完成了这个类中最困难的函数。接下来的两节中，我们将进一步完善这个函数的功能。</p>
<h3 class="anchor anchorWithStickyNavbar_csPL" id=输入变量的代码生成>输入变量的代码生成<a href=#输入变量的代码生成 class=hash-link aria-label=输入变量的代码生成的直接链接 title=输入变量的代码生成的直接链接>​</a></h3>
<p>回想一下，我们通过访问调用节点的参数（上一节中的第 2 步）收集了输入数组信息，并处理了参数是另一个调用节点的情况（第 4 步）。本节我们将以 <code>VarNode</code> 为例，演示如何处理其他节点。</p>
<p><code>VarNode</code> 表示模型中的输入张量。它非常重要的一点就是名称提示（例如，<code>data</code>、<code>weight</code> 等）。访问 <code>VarNode</code> 时，只需更新类变量 <code>out_</code> 传递名称提示，后代（descendant）调用节点就可以生成正确的函数调用。</p>
<div class="language-cpp codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-cpp codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token keyword" style=color:#00009f>void</span><span class="token plain"> </span><span class="token function" style=color:#d73a49>VisitExpr_</span><span class="token punctuation" style=color:#393A34>(</span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> VarNode</span><span class="token operator" style=color:#393A34>*</span><span class="token plain"> node</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  ext_func_args_</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>push_back</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">node</span><span class="token operator" style=color:#393A34>-></span><span class="token function" style=color:#d73a49>name_hint</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  out_</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>clear</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  out_</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>push_back</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain">node</span><span class="token operator" style=color:#393A34>-></span><span class="token function" style=color:#d73a49>name_hint</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token number" style=color:#36acaa>0</span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>}</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>注意：在这个例子中，我们假设要卸载的子图只有调用节点和变量节点。如果子图包含其他类型的节点，如 <code>TupleNode</code>，那么你也需要访问它们并绕过输出数组信息。</p>
<h3 class="anchor anchorWithStickyNavbar_csPL" id=code-emitting>Code Emitting<a href=#code-emitting class=hash-link aria-label="Code Emitting的直接链接" title="Code Emitting的直接链接">​</a></h3>
<p>Codegen Class 的最后一部分是 <code>JIT</code> 函数，它为子图 emit 一个 C 函数，并将刚生成的 C 代码作为函数体。注意，除了在前几节中生成的子图函数外，还需要一个具有统一参数的 wrapper 函数，供 TVM runtime 调用和传递数据。幸运的是，我们继承的基类已经提供了一个实现，即 <code>JitImpl</code>，来生成该函数。调用 <code>JitImpl</code>的方式如下：</p>
<div class="language-cpp codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-cpp codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token function" style=color:#d73a49>JitImpl</span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>"gcc_0"</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>/* Subgraph symbol (ID) */</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token punctuation" style=color:#393A34>{</span><span class="token string" style=color:#e3116c>"gcc_input0"</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"gcc_input1"</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"gcc_input2"</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"gcc_input3"</span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>/* Input arguments */</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token punctuation" style=color:#393A34>{</span><span class="token string" style=color:#e3116c>"float *buf_0 = (float*)malloc(4 * 20)"</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>.</span><span class="token punctuation" style=color:#393A34>.</span><span class="token punctuation" style=color:#393A34>.</span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>/* Buffer allocations */</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token punctuation" style=color:#393A34>{</span><span class="token string" style=color:#e3116c>"gcc_0_2(gcc_input0, gcc_input1, buf_0);"</span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>/* Function body */</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token punctuation" style=color:#393A34>{</span><span class="token string" style=color:#e3116c>"out"</span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>/* Output */</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>上述调用将生成三个函数（一个来自 TVM wrapper 宏）：</p>
<ol>
<li>子图函数 <code>gcc_0_</code>（函数名末尾多了一个下划线）以及为执行子图而生成的所有 C 代码；</li>
<li>带有 <code>DLTensor</code> 参数列表的 wrapper 函数 <code>gcc_0__wrapper_</code> ，将数据转换为正确的类型并调用 <code>gcc_0_</code></li>
<li>TVM runtime 兼容函数 <code>gcc_0</code> 具有 TVM 统一函数参数，可解包 TVM 打包张量并调用  <code>gcc_0__wrapper_</code></li>
</ol>
<p>因此，在 <code>JIT</code> 实现中唯一要做的，就是将生成的所有子图函数代码传递给 <code>JitImpl</code>：</p>
<div class="language-cpp codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-cpp codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token plain">std</span><span class="token double-colon punctuation" style=color:#393A34>::</span><span class="token plain">string </span><span class="token function" style=color:#d73a49>JIT</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token comment" style=color:#999988;font-style:italic>// Write function macros</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token keyword" style=color:#00009f>for</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token keyword" style=color:#00009f>auto</span><span class="token plain"> decl </span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> func_decl_</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    code_stream_ </span><span class="token operator" style=color:#393A34>&lt;&lt;</span><span class="token plain"> decl </span><span class="token operator" style=color:#393A34>&lt;&lt;</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"\n"</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token keyword" style=color:#00009f>return</span><span class="token plain"> </span><span class="token function" style=color:#d73a49>JitImpl</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">ext_func_id_</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> ext_func_args_</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> buf_decl_</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> ext_func_body</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> out_</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>}</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>传递的所有变量（<code>ext_func_id</code> 等）都是类变量，并在遍历子图时被填充。</p>
<h4 class="anchor anchorWithStickyNavbar_csPL" id=实现-csourcecodegen>实现 CSourceCodegen<a href=#实现-csourcecodegen class=hash-link aria-label="实现 CSourceCodegen的直接链接" title="实现 CSourceCodegen的直接链接">​</a></h4>
<p>创建一个类并实现所需功能，注意：需要继承自 <code>CSourceModuleCodegenBase</code>：</p>
<div class="language-cpp codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-cpp codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token keyword" style=color:#00009f>class</span><span class="token plain"> </span><span class="token class-name">CSourceCodegen</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token base-clause keyword" style=color:#00009f>public</span><span class="token base-clause"> </span><span class="token base-clause class-name">CSourceModuleCodegenBase</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"> </span><span class="token keyword" style=color:#00009f>public</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token comment" style=color:#999988;font-style:italic>// 传递一个子图函数, 并生成 C 代码。</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token keyword" style=color:#00009f>void</span><span class="token plain"> </span><span class="token function" style=color:#d73a49>GenCFunc</span><span class="token punctuation" style=color:#393A34>(</span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> Function</span><span class="token operator" style=color:#393A34>&</span><span class="token plain"> func</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token comment" style=color:#999988;font-style:italic>// 使用 GenCFunc 来生成 C 代码并将它包装成一个 C 源模块。</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  runtime</span><span class="token double-colon punctuation" style=color:#393A34>::</span><span class="token plain">Module </span><span class="token function" style=color:#d73a49>CreateCSourceModule</span><span class="token punctuation" style=color:#393A34>(</span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> NodeRef</span><span class="token operator" style=color:#393A34>&</span><span class="token plain"> ref</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>override</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"> </span><span class="token keyword" style=color:#00009f>private</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  std</span><span class="token double-colon punctuation" style=color:#393A34>::</span><span class="token plain">ostringstream code_stream_</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>;</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_csPL" id=实现-gencfunc>实现 GenCFunc<a href=#实现-gencfunc class=hash-link aria-label="实现 GenCFunc的直接链接" title="实现 GenCFunc的直接链接">​</a></h4>
<p><code>GenCFunc</code> 只是简单地使用我们刚刚实现的 <code>CodegenC</code> 来遍历一个 Relay 函数（子图），得到生成的 C 代码。内置函数 <code>GetExtSymbol</code> 在 Relay 函数中检索唯一的符号名称（例如 <code>gcc_0</code>），注意：<strong>必须</strong>将其用作 C 函数名称，因为该符号将用于 DSO 运行查找。</p>
<div class="language-plain codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-plain codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token plain">void GenCFunc(const Function& func) {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  ICHECK(func.defined()) &lt;&lt; "Input error: expect a Relay function.";</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  // 记录运行查找的外部符号。</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  auto sid = GetExtSymbol(func);</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  CodeGenC builder(sid);</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  builder.VisitExpr(func->body);</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  code_stream_ &lt;&lt; builder.JIT();</span><br></span><span class=token-line style=color:#393A34><span class="token plain">}</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_csPL" id=实现-createcsourcemodule>实现 CreateCSourceModule<a href=#实现-createcsourcemodule class=hash-link aria-label="实现 CreateCSourceModule的直接链接" title="实现 CreateCSourceModule的直接链接">​</a></h4>
<p>此函数为外部库创建了一个 runtime 模块。本事例中，我们创建了一个可以直接被编译并与 TVM 生成的 DSOModule 链接在一起的 CSourceModule。<code>CodegenC</code> 实现之后，再实现这个功能就比较简单了：</p>
<div class="language-cpp codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-cpp codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token plain">runtime</span><span class="token double-colon punctuation" style=color:#393A34>::</span><span class="token plain">Module </span><span class="token function" style=color:#d73a49>CreateCSourceModule</span><span class="token punctuation" style=color:#393A34>(</span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> NodeRef</span><span class="token operator" style=color:#393A34>&</span><span class="token plain"> ref</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>override</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token comment" style=color:#999988;font-style:italic>// 创建头文件</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  code_stream_ </span><span class="token operator" style=color:#393A34>&lt;&lt;</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"#include &lt;cstdint>\n"</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  code_stream_ </span><span class="token operator" style=color:#393A34>&lt;&lt;</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"#include &lt;iostream>\n"</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  code_stream_ </span><span class="token operator" style=color:#393A34>&lt;&lt;</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"#include &lt;cstdlib>\n"</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  code_stream_ </span><span class="token operator" style=color:#393A34>&lt;&lt;</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"#include &lt;stdio.h>\n"</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  code_stream_ </span><span class="token operator" style=color:#393A34>&lt;&lt;</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"#include &lt;cstring>\n"</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  code_stream_ </span><span class="token operator" style=color:#393A34>&lt;&lt;</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"#include &lt;tvm/runtime/c_runtime_api.h>\n"</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  code_stream_ </span><span class="token operator" style=color:#393A34>&lt;&lt;</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"#include &lt;dlpack/dlpack.h>\n"</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token comment" style=color:#999988;font-style:italic>// 为算子定义添加一些公共宏。</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>char</span><span class="token operator" style=color:#393A34>*</span><span class="token plain"> operator_macro </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token raw-string string" style=color:#e3116c>R"op_macro(</span><br></span><span class=token-line style=color:#393A34><span class="token raw-string string" style=color:#e3116c>  #define CSOURCE_BINARY_OP_1D(p_ID_, p_OP_, p_DIM1_)       \</span><br></span><span class=token-line style=color:#393A34><span class="token raw-string string" style=color:#e3116c>    extern "C" void p_ID_(float* a, float* b, float* out) { \</span><br></span><span class=token-line style=color:#393A34><span class="token raw-string string" style=color:#e3116c>      for (int64_t i = 0; i &lt; p_DIM1_; ++i) {               \</span><br></span><span class=token-line style=color:#393A34><span class="token raw-string string" style=color:#e3116c>        out[i] = a[i] p_OP_ b[i];                           \</span><br></span><span class=token-line style=color:#393A34><span class="token raw-string string" style=color:#e3116c>      }                                                     \</span><br></span><span class=token-line style=color:#393A34><span class="token raw-string string" style=color:#e3116c>    }</span><br></span><span class=token-line style=color:#393A34><span class="token raw-string string" style=display:inline-block;color:#e3116c></span><br></span><span class=token-line style=color:#393A34><span class="token raw-string string" style=color:#e3116c>  #define CSOURCE_BINARY_OP_2D(p_ID_, p_OP_, p_DIM1_, p_DIM2_)  \</span><br></span><span class=token-line style=color:#393A34><span class="token raw-string string" style=color:#e3116c>    extern "C" void p_ID_(float* a, float* b, float* out) {     \</span><br></span><span class=token-line style=color:#393A34><span class="token raw-string string" style=color:#e3116c>      for (int64_t i = 0; i &lt; p_DIM1_; ++i) {                   \</span><br></span><span class=token-line style=color:#393A34><span class="token raw-string string" style=color:#e3116c>        for (int64_t j = 0; j &lt; p_DIM2_; ++j) {                 \</span><br></span><span class=token-line style=color:#393A34><span class="token raw-string string" style=color:#e3116c>          int64_t k = i * p_DIM2_ + j;                          \</span><br></span><span class=token-line style=color:#393A34><span class="token raw-string string" style=color:#e3116c>          out[k] = a[k] p_OP_ b[k];                             \</span><br></span><span class=token-line style=color:#393A34><span class="token raw-string string" style=color:#e3116c>        }                                                       \</span><br></span><span class=token-line style=color:#393A34><span class="token raw-string string" style=color:#e3116c>      }                                                         \</span><br></span><span class=token-line style=color:#393A34><span class="token raw-string string" style=color:#e3116c>    }</span><br></span><span class=token-line style=color:#393A34><span class="token raw-string string" style=color:#e3116c>  )op_macro"</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  code_stream_ </span><span class="token operator" style=color:#393A34>&lt;&lt;</span><span class="token plain"> operator_macro </span><span class="token operator" style=color:#393A34>&lt;&lt;</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"\n\n"</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token comment" style=color:#999988;font-style:italic>// 为子图生成 C 代码。</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token keyword" style=color:#00009f>if</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">ref</span><span class="token operator" style=color:#393A34>-></span><span class="token generic-function function" style=color:#d73a49>IsInstance</span><span class="token generic-function generic class-name operator" style=color:#393A34>&lt;</span><span class="token generic-function generic class-name">FunctionNode</span><span class="token generic-function generic class-name operator" style=color:#393A34>></span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token function" style=color:#d73a49>GenCFunc</span><span class="token punctuation" style=color:#393A34>(</span><span class="token generic-function function" style=color:#d73a49>Downcast</span><span class="token generic-function generic class-name operator" style=color:#393A34>&lt;</span><span class="token generic-function generic class-name">Function</span><span class="token generic-function generic class-name operator" style=color:#393A34>></span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">ref</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>else</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>if</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">ref</span><span class="token operator" style=color:#393A34>-></span><span class="token generic-function function" style=color:#d73a49>IsInstance</span><span class="token generic-function generic class-name operator" style=color:#393A34>&lt;</span><span class="token generic-function generic class-name">relay</span><span class="token generic-function generic class-name double-colon punctuation" style=color:#393A34>::</span><span class="token generic-function generic class-name">ModuleNode</span><span class="token generic-function generic class-name operator" style=color:#393A34>></span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    relay</span><span class="token double-colon punctuation" style=color:#393A34>::</span><span class="token plain">Module mod </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token generic-function function" style=color:#d73a49>Downcast</span><span class="token generic-function generic class-name operator" style=color:#393A34>&lt;</span><span class="token generic-function generic class-name">relay</span><span class="token generic-function generic class-name double-colon punctuation" style=color:#393A34>::</span><span class="token generic-function generic class-name">Module</span><span class="token generic-function generic class-name operator" style=color:#393A34>></span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">ref</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token keyword" style=color:#00009f>for</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>auto</span><span class="token operator" style=color:#393A34>&</span><span class="token plain"> it </span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> mod</span><span class="token operator" style=color:#393A34>-></span><span class="token plain">functions</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">      </span><span class="token function" style=color:#d73a49>GenCFunc</span><span class="token punctuation" style=color:#393A34>(</span><span class="token generic-function function" style=color:#d73a49>Downcast</span><span class="token generic-function generic class-name operator" style=color:#393A34>&lt;</span><span class="token generic-function generic class-name">Function</span><span class="token generic-function generic class-name operator" style=color:#393A34>></span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">it</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">second</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>else</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token function" style=color:#d73a49>LOG</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">FATAL</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>&lt;&lt;</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"The input ref is expected to be a Relay function or module"</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">               </span><span class="token operator" style=color:#393A34>&lt;&lt;</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"\n"</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token comment" style=color:#999988;font-style:italic>// 创建一个 CSourceModule</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>auto</span><span class="token operator" style=color:#393A34>*</span><span class="token plain"> pf </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> runtime</span><span class="token double-colon punctuation" style=color:#393A34>::</span><span class="token class-name">Registry</span><span class="token double-colon punctuation" style=color:#393A34>::</span><span class="token function" style=color:#d73a49>Get</span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>"module.csource_module_create"</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token function" style=color:#d73a49>ICHECK</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">pf </span><span class="token operator" style=color:#393A34>!=</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>nullptr</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>&lt;&lt;</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"Cannot find csource module to create the external runtime module"</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token keyword" style=color:#00009f>return</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token operator" style=color:#393A34>*</span><span class="token plain">pf</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">code_stream_</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>str</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"cc"</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>}</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_csPL" id=注册-codegenc>注册 CodegenC<a href=#注册-codegenc class=hash-link aria-label="注册 CodegenC的直接链接" title="注册 CodegenC的直接链接">​</a></h3>
<p>最后一步是将 codegen 注册到 TVM 后端。首先实现一个简单的函数，调用 codegen 并生成一个 runtime 模块：</p>
<div class="language-cpp codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-cpp codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token plain">runtime</span><span class="token double-colon punctuation" style=color:#393A34>::</span><span class="token plain">Module </span><span class="token function" style=color:#d73a49>CCompiler</span><span class="token punctuation" style=color:#393A34>(</span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> NodeRef</span><span class="token operator" style=color:#393A34>&</span><span class="token plain"> ref</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  CSourceCodegen csource</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token keyword" style=color:#00009f>return</span><span class="token plain"> csource</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>CreateCSourceModule</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">ref</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>}</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>接下来将此函数注册到 TVM 后端：</p>
<div class="language-cpp codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-cpp codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token function" style=color:#d73a49>TVM_REGISTER_GLOBAL</span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>"relay.ext.ccompiler"</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>set_body_typed</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">CCompiler</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>其中 <code>ccompiler</code> 是一个自定义标签，它告知 TVM 这是用 <code>ccompiler</code> 注释子图时，应该用来生成和卸载子图的 codegen。</p>
<p>最后，设置一个 CMake 配置标志，只包含客户的编译器。首先创建一个 cmake 文件：<code>cmake/modules/contrib/CODEGENC.cmake</code>：</p>
<div class="language-cpp codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-cpp codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token keyword" style=color:#00009f>if</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">USE_CODEGENC</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token function" style=color:#d73a49>file</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">GLOB CSOURCE_RELAY_CONTRIB_SRC src</span><span class="token operator" style=color:#393A34>/</span><span class="token plain">relay</span><span class="token operator" style=color:#393A34>/</span><span class="token plain">backend</span><span class="token operator" style=color:#393A34>/</span><span class="token plain">contrib</span><span class="token operator" style=color:#393A34>/</span><span class="token plain">codegen_c</span><span class="token operator" style=color:#393A34>/</span><span class="token plain">codegen</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">cc</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token function" style=color:#d73a49>list</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">APPEND COMPILER_SRCS $</span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain">CSOURCE_RELAY_CONTRIB_SRC</span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token function" style=color:#d73a49>endif</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">USE_CODEGENC</span><span class="token punctuation" style=color:#393A34>)</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>用户在使用 <code>config.cmake</code> 配置 TVM 时，可以自行决定是否配置编译器：</p>
<div class="language-cmake codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-cmake codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token plain">set(USE_CODEGENC ON)</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_csPL" id=为表征representation实现-codegen>为表征（Representation）实现 Codegen<a href=#为表征representation实现-codegen class=hash-link aria-label="为表征（Representation）实现 Codegen的直接链接" title="为表征（Representation）实现 Codegen的直接链接">​</a></h2>
<p>尽管我们已经演示了如何实现 C codegen，但用户硬件可能还需要其他形式的计算图表征（Graph Representation），如 JSON。在这种情况下，用户可以通过修改 <code>CodegenC</code> 类，生成自己的计算图表征，并实现一个自定义 runtime 模块，告诉 TVM runtime 如何执行这个计算图表征。</p>
<p>简单起见，本指南中定义了一个名为 "ExampleJSON" 的计算图表征。 ExampleJSON 并不是 JSON，而是没有控制流的计算图的简单表示。例如，假设有以下名为 <code>subgraph_0</code> 的子图：</p>
<div class="language-text codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-text codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token plain">input0</span><br></span><span class=token-line style=color:#393A34><span class="token plain">   |</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  add &lt;-- input1</span><br></span><span class=token-line style=color:#393A34><span class="token plain">   |</span><br></span><span class=token-line style=color:#393A34><span class="token plain">subtract &lt;-- input2</span><br></span><span class=token-line style=color:#393A34><span class="token plain">   |</span><br></span><span class=token-line style=color:#393A34><span class="token plain">multiply &lt;-- input3</span><br></span><span class=token-line style=color:#393A34><span class="token plain">   |</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  out</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>那么这个子图的 ExampleJON 看起来类似：</p>
<div class="language-text codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-text codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token plain">subgraph_0</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  input 0 10 10</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  input 1 10 10</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  input 2 10 10</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  input 3 10 10</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  add 4 inputs: 0 1 shape: 10 10</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  sub 5 inputs: 4 2 shape: 10 10</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  mul 6 inputs: 5 3 shape: 10 10</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p><code>input</code> 关键字声明一个输入张量及其 ID 和 shape；其他语句用 <code>&lt;op> &lt;output ID> inputs: [input ID] shape: [shape]</code> 语法描述了其计算过程。</p>
<p>在本节中，我们试图实现以下自定义 TVM runtime 模块，来执行 ExampleJSON 计算图。</p>
<div class="language-cpp codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-cpp codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token plain">runtime</span><span class="token double-colon punctuation" style=color:#393A34>::</span><span class="token plain">Module </span><span class="token function" style=color:#d73a49>ExampleJsonCompiler</span><span class="token punctuation" style=color:#393A34>(</span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> NodeRef</span><span class="token operator" style=color:#393A34>&</span><span class="token plain"> ref</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    ExampleJsonCodeGen </span><span class="token function" style=color:#d73a49>codegen</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">ref</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    std</span><span class="token double-colon punctuation" style=color:#393A34>::</span><span class="token plain">string code </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> codegen</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>gen</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// 注 1</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>auto</span><span class="token operator" style=color:#393A34>*</span><span class="token plain"> pf </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> runtime</span><span class="token double-colon punctuation" style=color:#393A34>::</span><span class="token class-name">Registry</span><span class="token double-colon punctuation" style=color:#393A34>::</span><span class="token function" style=color:#d73a49>Get</span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>"module.examplejson_module_create"</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// 注 2</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token function" style=color:#d73a49>ICHECK</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">pf </span><span class="token operator" style=color:#393A34>!=</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>nullptr</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>&lt;&lt;</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"Cannot find ExampleJson module to create the external runtime module"</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token keyword" style=color:#00009f>return</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token operator" style=color:#393A34>*</span><span class="token plain">pf</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">code</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token function" style=color:#d73a49>TVM_REGISTER_GLOBAL</span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>"relay.ext.examplejsoncompiler"</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>set_body_typed</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">ExampleJsonCompiler</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p><strong>注1</strong>：稍后我们将实现一个自定义 codegen，通过取一个子图来生成一个 ExampleJSON 代码字符串。</p>
<p><strong>注2</strong>：此行获取了一个用于创建自定义 runtime 模块的函数的指针。可以看到它采用刚刚生成的 ExampleJSON 格式的子图代码，并对一个 runtime 模块进行了初始化。</p>
<p>后续章节中，我们将介绍 1）如何实现 <code>ExampleJsonCodeGen</code> 和 2）如何实现和注册 <code>examplejson_module_create</code>。</p>
<h3 class="anchor anchorWithStickyNavbar_csPL" id=实现-examplejsoncodegen>实现 ExampleJsonCodeGen<a href=#实现-examplejsoncodegen class=hash-link aria-label="实现 ExampleJsonCodeGen的直接链接" title="实现 ExampleJsonCodeGen的直接链接">​</a></h3>
<p>与 C codegen 类似，从 <code>ExprVisitor</code> 派生 <code>ExampleJsonCodeGen</code> 以访问器模式进行子图遍历。另一方面，因为不会用到 TVM C++ wrapper，所以不必继承 <code>CodegenCBase</code>。 codegen 类实现如下：</p>
<div class="language-c++ codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-c++ codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token plain">#include &lt;tvm/relay/expr_functor.h></span><br></span><span class=token-line style=color:#393A34><span class="token plain">#include &lt;tvm/relay/transform.h></span><br></span><span class=token-line style=color:#393A34><span class="token plain">#include &lt;tvm/relay/type.h></span><br></span><span class=token-line style=color:#393A34><span class="token plain">#include &lt;tvm/runtime/module.h></span><br></span><span class=token-line style=color:#393A34><span class="token plain">#include &lt;tvm/runtime/object.h></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">#include &lt;fstream></span><br></span><span class=token-line style=color:#393A34><span class="token plain">#include &lt;sstream></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">namespace tvm {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">namespace relay {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">namespace contrib {</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">class ExampleJsonCodeGen : public ExprVisitor {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  public:</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    explicit ExampleJsonCodeGen();</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    // 注 1</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    void VisitExpr_(const VarNode* node) { /* Skip in this example. */ }</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    void VisitExpr_(const CallNode* call) final { /* Skip in this example. */ }</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    // 注 2</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    std::string gen(NodeRef& ref) {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">        this->code = "";</span><br></span><span class=token-line style=color:#393A34><span class="token plain">        if (ref->IsInstance&lt;FunctionNode>()) {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">            this->visit(Downcast&lt;Function>(ref));</span><br></span><span class=token-line style=color:#393A34><span class="token plain">        } else if (ref->IsInstance&lt;relay::ModuleNode>()) {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">            relay::Module mod = Downcast&lt;relay::Module>(ref);</span><br></span><span class=token-line style=color:#393A34><span class="token plain">            for (const auto& it : mod->functions) {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">                this->visit(Downcast&lt;Function>(it.second));</span><br></span><span class=token-line style=color:#393A34><span class="token plain">            }</span><br></span><span class=token-line style=color:#393A34><span class="token plain">        } else {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">            LOG(FATAL) &lt;&lt; "The input ref is expected to be a Relay function or module";</span><br></span><span class=token-line style=color:#393A34><span class="token plain">        }</span><br></span><span class=token-line style=color:#393A34><span class="token plain">        return this->code;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    }</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  private:</span><br></span><span class=token-line style=color:#393A34><span class="token plain">      /*! \brief The function id that represents a C source function. */</span><br></span><span class=token-line style=color:#393A34><span class="token plain">     std::string code;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">}</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p><strong>注1</strong>：再次实现相应的 visitor 函数，以生成 ExampleJSON 代码，并将其存储到类变量 <code>code</code> 中（由于与 C codegen 基本一致，这里跳过了 visitor 函数的实现）。完成计算图访问后，在 <code>code</code> 中会生成一个 ExampleJSON 计算图。</p>
<p><strong>注2</strong>：定义内部 API <code>gen</code> 来获取子图，并生成 ExampleJSON 代码。用户可以依据个人喜好，为这个 API 命名。</p>
<p>接下来，实现一个自定义 runtime，来利用 <code>ExampleJsonCodeGen</code> 的输出。</p>
<h3 class="anchor anchorWithStickyNavbar_csPL" id=实现自定义-runtime>实现自定义 runtime<a href=#实现自定义-runtime class=hash-link aria-label="实现自定义 runtime的直接链接" title="实现自定义 runtime的直接链接">​</a></h3>
<p>本节将逐步演示如何自定义 TVM runtime，并将其注册到 TVM runtime 模块。自定义 runtime 应位于 <code>src/runtime/contrib/&lt;your-runtime-name>/</code>。本示例中，我们将 runtime 命名为 "example_ext_runtime"。</p>
<p>首先，如下所示定义一个自定义 runtime 类。注意：这个类必须由 TVM <code>ModuleNode</code> 派生，以保证与其他 TVM runtime 模块兼容。</p>
<div class="language-c++ codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-c++ codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token plain">#include &lt;dmlc/logging.h></span><br></span><span class=token-line style=color:#393A34><span class="token plain">#include &lt;tvm/runtime/c_runtime_api.h></span><br></span><span class=token-line style=color:#393A34><span class="token plain">#include &lt;tvm/runtime/memory.h></span><br></span><span class=token-line style=color:#393A34><span class="token plain">#include &lt;tvm/runtime/module.h></span><br></span><span class=token-line style=color:#393A34><span class="token plain">#include &lt;tvm/runtime/ndarray.h></span><br></span><span class=token-line style=color:#393A34><span class="token plain">#include &lt;tvm/runtime/object.h></span><br></span><span class=token-line style=color:#393A34><span class="token plain">#include &lt;tvm/runtime/packed_func.h></span><br></span><span class=token-line style=color:#393A34><span class="token plain">#include &lt;tvm/runtime/registry.h></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">#include &lt;fstream></span><br></span><span class=token-line style=color:#393A34><span class="token plain">#include &lt;cmath></span><br></span><span class=token-line style=color:#393A34><span class="token plain">#include &lt;map></span><br></span><span class=token-line style=color:#393A34><span class="token plain">#include &lt;sstream></span><br></span><span class=token-line style=color:#393A34><span class="token plain">#include &lt;string></span><br></span><span class=token-line style=color:#393A34><span class="token plain">#include &lt;vector></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">namespace tvm {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">namespace runtime {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">class ExampleJsonModule : public ModuleNode {</span><br></span><span class=token-line style=color:#393A34><span class="token plain"> public:</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  explicit ExampleJsonModule(std::string graph_json);</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  PackedFunc GetFunction(const std::string& name,</span><br></span><span class=token-line style=color:#393A34><span class="token plain">                         const ObjectPtr&lt;Object>& sptr_to_self) final;</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  const char* type_key() const { return "examplejson"; }</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  void SaveToBinary(dmlc::Stream* stream) final;</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  static Module LoadFromBinary(void* strm);</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  static Module Create(const std::string& path);</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  std::string GetSource(const std::string& format = "");</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  void Run(int id, const std::vector&lt;int>& inputs, int output);</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  void ParseJson(const std::string& json);</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"> private:</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  /* \brief 代表计算图的 json 字符串。 */</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  std::string graph_json_;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  /* \brief 正在被处理的子图。 */</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  std::string curr_subgraph_;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  /*! \brief 由子图 id 到节点条目的简单图。 */</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  std::map&lt;std::string, std::vector&lt;NodeEntry> > graph_;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  /* \brief 包含图中每一个节点的张量的简单池。 */</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  std::vector&lt;NDArray> data_entry_;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  /* \brief 从节点 id 到算子名字的映射。 */</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  std::vector&lt;std::string> op_id_;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">};</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>以下这些从 <code>ModuleNode</code> 派生的函数，必须在 <code>ExampleJsonModule</code> 中实现：</p>
<ul>
<li>构造函数：这个类的构造函数，应该接收一个表征中的子图，用户可以自行决定处理和存储的格式。保存的子图可以被以下两个函数使用。</li>
<li><code>GetFunction</code>：这是这个类中最重要的函数。当 TVM runtime 要使用编译器标签（compiler tag）执行子图时，它会从自定义 runtime 模块中调用此函数。它提供函数名及 runtime 参数，<code>GetFunction</code> 会返回一个打包的函数实现，以供 TVM runtime 执行。</li>
<li><code>SaveToBinary</code> 和 <code>LoadFromBinary</code>：<code>SaveToBinary</code> 将 runtime 模块序列化为二进制格式以供后续部署。用户使用 <code>export_library</code> API 时，TVM 会调用这个函数。另一方面，由于用户这时使用的是自己的计算图表征，因此必须确保 <code>LoadFromBinary</code> 能够采用<code>SaveToBinary</code> 生成的序列化二进制文件，来构造相同的 runtime 模块。</li>
<li><code>GetSource</code>（可选）：如果想查看生成的 ExampleJSON 代码，可以实现这个函数来转存；否则则可以跳过实现。</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_csPL" id=实现构造函数>实现构造函数<a href=#实现构造函数 class=hash-link aria-label=实现构造函数的直接链接 title=实现构造函数的直接链接>​</a></h4>
<div class="language-c++ codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-c++ codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token plain">explicit ExampleJsonModule(std::string graph_json) {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  this->graph_json_ = graph_json;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  ParseJson(this->graph_json_);</span><br></span><span class=token-line style=color:#393A34><span class="token plain">}</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>接下来，实现 <code>ParseJson</code> 来解析 ExampleJSON 格式的子图，并在内存中构造一个计算图供后续使用。由于本示例不支持带有分支的子图，因此只需用一个数组，按顺序存储子图中的每个节点。</p>
<div class="language-c++ codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-c++ codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token plain">void ParseJson(const std::string& json) {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  std::string line;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  std::string curr_subgraph;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  std::stringstream ss(json);</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  while (std::getline(ss, line, '\n')) {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    std::stringstream ss2(line);</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    std::string token;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    int id = 0;</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    ss2 >> token;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    if (token.find("subgraph_") != std::string::npos) {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">      curr_subgraph = token;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">      continue;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    }</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    ss2 >> id;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    if (op_id_.size() &lt;= static_cast&lt;size_t>(id)) {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">      op_id_.resize(id + 1);</span><br></span><span class=token-line style=color:#393A34><span class="token plain">      data_entry_.resize(id + 1);</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    }</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    int64_t total_elements = 1;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    std::vector&lt;int64_t> shape;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    if (token == "input") {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">      int64_t size = 0;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">      while (ss2 >> size) {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">        total_elements *= size;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">        shape.push_back(size);</span><br></span><span class=token-line style=color:#393A34><span class="token plain">      }</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    } else {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">      op_id_[id] = token; // 注 1</span><br></span><span class=token-line style=color:#393A34><span class="token plain">      bool shape_data = false;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">      NodeEntry entry;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">      while (ss2 >> token) {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">        if (token == "shape:") {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">          shape_data = true;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">        } else if (shape_data) {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">          total_elements *= std::stoll(token);</span><br></span><span class=token-line style=color:#393A34><span class="token plain">          shape.push_back(std::stoll(token));</span><br></span><span class=token-line style=color:#393A34><span class="token plain">        } else if (token != "inputs:") {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">          entry.inputs.push_back(std::stoi(token));</span><br></span><span class=token-line style=color:#393A34><span class="token plain">        }</span><br></span><span class=token-line style=color:#393A34><span class="token plain">      }</span><br></span><span class=token-line style=color:#393A34><span class="token plain">      entry.id = id;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">      entry.output = id;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">      graph_[curr_subgraph].push_back(entry); // 注 2</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    }</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    DLDevice dev;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    dev.device_type = static_cast&lt;DLDeviceType>(1);</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    dev.device_id = 0;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    data_entry_[id] = NDArray::Empty(shape, DLDataType{kDLFloat, 32, 1}, dev); // 注 3</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  }</span><br></span><span class=token-line style=color:#393A34><span class="token plain">}</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p><strong>注1</strong>：使用类变量 <code>op_id_</code> 将子图节点 ID 映射到算子名称（例如 <code>add</code>），以便在 runtime 中调用相应的算子函数。</p>
<p><strong>注2</strong>：使用类变量 <code>graph_</code> 从子图名称映射到节点数组。<code>GetFunction</code> 将在 runtime 通过子图 ID 查询计算图节点。</p>
<p><strong>注3</strong>：使用类变量 <em>data_entry_</em> 将子图节点 ID 映射到张量数据占位符。将输入和输出放入 runtime 中对应的数据条目中。</p>
<h4 class="anchor anchorWithStickyNavbar_csPL" id=实现-getfunction>实现 GetFunction<a href=#实现-getfunction class=hash-link aria-label="实现 GetFunction的直接链接" title="实现 GetFunction的直接链接">​</a></h4>
<p>构造函数实现后，以上类变量准备就绪。接下来实现 <code>GetFunction</code> 为 TVM runtime 提供可执行的子图函数：</p>
<div class="language-c++ codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-c++ codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token plain">PackedFunc GetFunction(const std::string& name,</span><br></span><span class=token-line style=color:#393A34><span class="token plain">                       const ObjectPtr&lt;Object>& sptr_to_self) final {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  if (this->graph_.find(name) != this->graph_.end()) {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    this->curr_subgraph_ = name;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    return PackedFunc([sptr_to_self, this](TVMArgs args, TVMRetValue* rv) {</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">      // Copy input tensors to corresponding data entries.</span><br></span><span class=token-line style=color:#393A34><span class="token plain">      for (auto i = 0; i &lt; args.size(); ++i) {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">        ICHECK(args[i].type_code() == kNDArrayContainer || args[i].type_code() == kArrayHandle)</span><br></span><span class=token-line style=color:#393A34><span class="token plain">            &lt;&lt; "Expect NDArray or DLTensor as inputs\n";</span><br></span><span class=token-line style=color:#393A34><span class="token plain">        if (args[i].type_code() == kArrayHandle) {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">          DLTensor* arg = args[i];</span><br></span><span class=token-line style=color:#393A34><span class="token plain">          this->data_entry_[i].CopyFrom(arg);</span><br></span><span class=token-line style=color:#393A34><span class="token plain">        } else {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">          NDArray arg = args[i];</span><br></span><span class=token-line style=color:#393A34><span class="token plain">          this->data_entry_[i].CopyFrom(arg);</span><br></span><span class=token-line style=color:#393A34><span class="token plain">        }</span><br></span><span class=token-line style=color:#393A34><span class="token plain">      }</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">      // Execute the subgraph.</span><br></span><span class=token-line style=color:#393A34><span class="token plain">      for (const auto& it : this->graph_[this->curr_subgraph_]) {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">        this->Run(it.id, it.inputs, it.output);</span><br></span><span class=token-line style=color:#393A34><span class="token plain">      }</span><br></span><span class=token-line style=color:#393A34><span class="token plain">      ICHECK_GT(graph_.count(this->curr_subgraph_), 0U);</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">      // Copy the output from a data entry back to TVM runtime argument.</span><br></span><span class=token-line style=color:#393A34><span class="token plain">      auto out_idx = graph_[this->curr_subgraph_].back().output;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">      if (args[args.size() - 1].type_code() == kArrayHandle) {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">        DLTensor* arg = args[args.size() - 1];</span><br></span><span class=token-line style=color:#393A34><span class="token plain">        this->data_entry_[out_idx].CopyTo(arg);</span><br></span><span class=token-line style=color:#393A34><span class="token plain">      } else {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">        NDArray arg = args[args.size() - 1];</span><br></span><span class=token-line style=color:#393A34><span class="token plain">        this->data_entry_[out_idx].CopyTo(arg);</span><br></span><span class=token-line style=color:#393A34><span class="token plain">      }</span><br></span><span class=token-line style=color:#393A34><span class="token plain">      *rv = data_entry_.back();</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    });</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  } else {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    LOG(FATAL) &lt;&lt; "Unknown subgraph: " &lt;&lt; name &lt;&lt; "\n";</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    return PackedFunc();</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  }</span><br></span><span class=token-line style=color:#393A34><span class="token plain">}</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>可以看出，<code>GetFunction</code> 由三个主要部分组成。第一部分将数据从 TVM runtime 参数，复制到构造函数中指定的对应数据条目。第二部分使用 <code>Run</code> 函数执行子图（并稍后实现），并将结果保存到另一个数据条目。第三部分将输出数据条目中的结果，复制回对应的 TVM runtime 参数进行输出。</p>
<h4 class="anchor anchorWithStickyNavbar_csPL" id=实现-run>实现 Run<a href=#实现-run class=hash-link aria-label="实现 Run的直接链接" title="实现 Run的直接链接">​</a></h4>
<p><code>Run</code> 函数接收 1）子图 ID，2）输入数据条目索引列表和 3）输出数据条目索引。</p>
<div class="language-c++ codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-c++ codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token plain">void Run(int id, const std::vector&lt;int>& inputs, int output) {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  // Make a list data entry indexs.</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  std::vector&lt;int> args(inputs.begin(), inputs.end());</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  args.push_back(output);</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  // Initialize data holders.</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  std::vector&lt;TVMValue> values(args.size());</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  std::vector&lt;int> type_codes(args.size());</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  // Initialize a TVM arg setter with TVMValue and its type code.</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  TVMArgsSetter setter(values.data(), type_codes.data());</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  // Set each argument to its corresponding data entry.</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  if (op_id_[id] == "add" || op_id_[id] == "sub" || op_id_[id] == "mul") {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    for (size_t i = 0; i &lt; args.size(); i++) {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">      setter(i, data_entry_[args[i]]);</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    }</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  }</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  // Invoke the corresponding operator function.</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  if (op_id_[id] == "add") {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    Add(values.data(), type_codes.data(), args.size());</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  } else if (op_id_[id] == "sub") {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    Sub(values.data(), type_codes.data(), args.size());</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  } else if (op_id_[id] == "mul") {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    Mul(values.data(), type_codes.data(), args.size());</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  } else {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    LOG(FATAL) &lt;&lt; "Unknown op: " &lt;&lt; op_id_[id] &lt;&lt; "\n";</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  }</span><br></span><span class=token-line style=color:#393A34><span class="token plain">}</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p><code>Run</code> 函数主要包括两部分。第一部分负责分配 <code>TVMValue</code> 列表，并映射相应的数据输入块。这也会成为算子函数的参数。第二部分调用算子函数。尽管使用的 C 函数与上一个示例相同，但用户可以将 <code>Add</code>、<code>Sub</code> 和 <code>Mul</code> 替换为自己的引擎。注意，这里需要确保引擎将结果存储到最后一个参数，从而使得它们可以传输回 TVM runtime。</p>
<p>实现上述功能后，用户自定义的 codegen 和 runtime 就可以执行子图了。最后一步是注册一个 API（<code>examplejson_module_create</code>）来创建这个模块：</p>
<div class="language-c++ codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-c++ codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token plain">TVM_REGISTER_GLOBAL("module.examplejson_module_create")</span><br></span><span class=token-line style=color:#393A34><span class="token plain">.set_body_typed([](std::string code){</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    auto n = make_object&lt;ExampleJsonModule>(code);</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    return runtime::Module(n);</span><br></span><span class=token-line style=color:#393A34><span class="token plain">});</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_csPL" id=实现-savetobinary-和-loadfrombinary>实现 SaveToBinary 和 LoadFromBinary<a href=#实现-savetobinary-和-loadfrombinary class=hash-link aria-label="实现 SaveToBinary 和 LoadFromBinary的直接链接" title="实现 SaveToBinary 和 LoadFromBinary的直接链接">​</a></h4>
<p>到目前为止，我们已经实现了与其他 TVM runtime 用法一致的自定义 runtime 的主要功能。但是，当用户想要将构建的 runtime 保存到磁盘以进行部署时，TVM 不知道如何保存。这就是实现 <code>SaveToBinary</code> 和 <code>LoadFromBinary</code> 的原因，它们会告诉 TVM 这个自定义 runtime 如何持久化和复原。</p>
<p>首先实现 <code>SaveToBinary</code> 函数，允许用户将此模块保存在磁盘中。</p>
<div class="language-c++ codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-c++ codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token plain">void SaveToBinary(dmlc::Stream* stream) final {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    stream->Write(this->graph_json_);</span><br></span><span class=token-line style=color:#393A34><span class="token plain">}</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>这个函数非常简单。在构造函数中，我们采取的唯一参数是一个子图表征（subgraph representation）。也就是说只需一个子图表征来构造/恢复这个自定义 runtime 模块。<code>SaveToBinary</code> 只是将子图写到一个输出的 DMLC 流中，当用户使用 <code>export_library</code> API 输出模块时，自定义模块将是一个子图的 ExampleJSON 流。</p>
<p><code>LoadFromBinary</code> 读取子图流并重新构建自定义 runtime 模块的流程与此类似：</p>
<div class="language-c++ codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-c++ codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token plain">static Module LoadFromBinary(void* strm) {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  dmlc::Stream* stream = static_cast&lt;dmlc::Stream*>(strm);</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  std::string graph_json;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  stream->Read(&graph_json);</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  auto n = tvm::runtime::make_object&lt;ExampleJsonModule>(graph_json);</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  return Module(n);</span><br></span><span class=token-line style=color:#393A34><span class="token plain">}</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>此外，还需要注册以下函数，启用相应的 Python API：</p>
<div class="language-c++ codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-c++ codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token plain">TVM_REGISTER_GLOBAL("module.loadbinary_examplejson")</span><br></span><span class=token-line style=color:#393A34><span class="token plain">.set_body_typed(ExampleJsonModule::LoadFromBinary);</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>上述注册意味着当用户调用 <code>tvm.runtime.load_module(lib_path)</code> API，并且导出库有一个 ExampleJSON 流时，<code>LoadFromBinary</code> 将被调用以创建相同的自定义 runtime 模块。</p>
<p>另外，如果想支持直接从 ExampleJSON 文件创建模块，还可以实现一个非常简单的函数，并注册一个 Python API，如下所示：</p>
<div class="language-c++ codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-c++ codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token plain">static Module Create(const std::string& path) {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    std::ifstream filep;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    filep.open(path, std::ios::in);</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    std::string graph_json;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    std::string line;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    while (std::getline(filep, line)) {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">        graph_json += line;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">        graph_json += "\n";</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    }</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    filep.close();</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    auto n = tvm::runtime::make_object&lt;ExampleJsonModule>(graph_json);</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    return Module(n);</span><br></span><span class=token-line style=color:#393A34><span class="token plain">}</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">TVM_REGISTER_GLOBAL("module.loadfile_examplejson")</span><br></span><span class=token-line style=color:#393A34><span class="token plain">.set_body([](TVMArgs args, TVMRetValue* rv) {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    *rv = ExampleJsonModule::Create(args[0]);</span><br></span><span class=token-line style=color:#393A34><span class="token plain">});</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>这意味着用户可以手动编写/修改 ExampleJSON 文件，并使用 Python API <code>tvm.runtime.load_module("mysubgraph.examplejson", "examplejson")</code> 构建自定义模块。</p>
<h2 class="anchor anchorWithStickyNavbar_csPL" id=总结>总结<a href=#总结 class=hash-link aria-label=总结的直接链接 title=总结的直接链接>​</a></h2>
<p>汇总前文重点：</p>
<ul>
<li>从 <code>ExprVisitor</code> 和 <code>CodegenCBase</code>（仅适用于 C codegen）派生的 codegen 类，具有以下功能：<!-- -->
<ul>
<li><code>VisitExpr_(const CallNode* call)</code> 收集调用节点信息。</li>
<li>收集子图信息所需的其他 visitor 函数。</li>
<li><code>JIT</code> 生成子图代码。</li>
<li>注册 codegen。</li>
</ul>
</li>
<li>创建 <code>CSourceModule</code> 的函数（用于 C codegen）。</li>
<li>从 <code>ModuleNode</code> 派生的 runtime 模块类，具有以下功能（用于计算图表征）。<!-- -->
<ul>
<li>构造函数。</li>
<li><code>GetFunction</code> 生成与 TVM runtime 兼容的 <code>PackedFunc</code>。</li>
<li><code>Run</code> 执行子图。</li>
<li>注册 runtime creation API。</li>
<li><code>SaveToBinary</code> 和 <code>LoadFromBinary</code> 序列化/反序列化自定义 runtime 模块。</li>
<li>注册 <code>LoadFromBinary</code> API 为<code>tvm.runtime.load_module(your_module_lib_path)</code>提供支持。</li>
<li>（可选）<code>Create</code> 支持从表征的子图文件，构建自定义 runtime 模块。</li>
</ul>
</li>
<li>一个注释器，用于注释用户 Relay 程序，利用编译器和 runtime（待定）。</li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class=col><a href=https://github.com/hyperai/tvm-cn/edit/master/docs/dev/how_to/04-relay_bring_your_own_codegen.md target=_blank rel="noopener noreferrer" class=theme-edit-this-page><svg fill=currentColor height=20 width=20 viewBox="0 0 40 40" class=iconEdit_OUzX aria-hidden=true><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"/></g></svg>编辑此页</a></div><div class="col lastUpdated_ccpN"><span class=theme-last-updated>最后<!-- -->由 <b>sparanoid</b> <!-- -->于 <b><time datetime=2025-04-15T11:50:10.000Z itemprop=dateModified>2025年4月15日</time></b> <!-- -->更新</span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label=文件选项卡><a class="pagination-nav__link pagination-nav__link--prev" href=/docs/tvm-cn/docs/dev/how_to/relay_add_pass><div class=pagination-nav__sublabel>上一页</div><div class=pagination-nav__label>向 Relay 中添加 Compiler Pass</div></a><a class="pagination-nav__link pagination-nav__link--next" href=/docs/tvm-cn/docs/dev/how_to/python_target_parametrization><div class=pagination-nav__sublabel>下一页</div><div class=pagination-nav__label>Python Target 参数化</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_cD69 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href=#实现-codegenc class="table-of-contents__link toc-highlight">实现 CodegenC</a><ul><li><a href=#算子的代码生成 class="table-of-contents__link toc-highlight">算子的代码生成</a><li><a href=#输入变量的代码生成 class="table-of-contents__link toc-highlight">输入变量的代码生成</a><li><a href=#code-emitting class="table-of-contents__link toc-highlight">Code Emitting</a><li><a href=#注册-codegenc class="table-of-contents__link toc-highlight">注册 CodegenC</a></ul><li><a href=#为表征representation实现-codegen class="table-of-contents__link toc-highlight">为表征（Representation）实现 Codegen</a><ul><li><a href=#实现-examplejsoncodegen class="table-of-contents__link toc-highlight">实现 ExampleJsonCodeGen</a><li><a href=#实现自定义-runtime class="table-of-contents__link toc-highlight">实现自定义 runtime</a></ul><li><a href=#总结 class="table-of-contents__link toc-highlight">总结</a></ul></div></div></div></div></main></div></div></div><footer class=footer><div class="container container-fluid"><div class="footer__bottom text--center"><div class=footer__copyright>© 2025 Apache Software Foundation and Hyper.AI for Chinese Simplified mirror</div></div></div></footer></div>