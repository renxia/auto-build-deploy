<!doctype html><html lang=zh-Hans dir=ltr class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-arch/arch/inferbound" data-has-hydrated=false><meta charset=UTF-8><meta name=generator content="Docusaurus v3.7.0"><title data-rh=true>InferBound Pass | Apache TVM 中文站</title><meta data-rh=true name=viewport content="width=device-width, initial-scale=1.0"><meta data-rh=true name=twitter:card content=summary_large_image><meta data-rh=true property=og:url content=https://lzw.me/docs/tvm-cn/docs/arch/arch/inferbound><meta data-rh=true property=og:locale content=zh_Hans><meta data-rh=true name=docusaurus_locale content=zh-Hans><meta data-rh=true name=docsearch:language content=zh-Hans><meta data-rh=true name=docusaurus_version content=current><meta data-rh=true name=docusaurus_tag content=docs-default-current><meta data-rh=true name=docsearch:version content=current><meta data-rh=true name=docsearch:docusaurus_tag content=docs-default-current><meta data-rh=true property=og:title content="InferBound Pass | Apache TVM 中文站"><meta data-rh=true name=description content="InferBound pass 在 normalize 之后、ScheduleOps buildmodule.py 之前运行。InferBound 的主要工作是创建 bounds map，为程序中的每个 IterVar 指定一个 Range。接下来这些 bounds 会传递给 ScheduleOps，用于设置 For 循环的范围，参阅 MakeLoopNest，以及设置分配缓冲区的大小（BuildRealize）以及其他用途。"><meta data-rh=true property=og:description content="InferBound pass 在 normalize 之后、ScheduleOps buildmodule.py 之前运行。InferBound 的主要工作是创建 bounds map，为程序中的每个 IterVar 指定一个 Range。接下来这些 bounds 会传递给 ScheduleOps，用于设置 For 循环的范围，参阅 MakeLoopNest，以及设置分配缓冲区的大小（BuildRealize）以及其他用途。"><link data-rh=true rel=icon href=/docs/tvm-cn/img/favicon.png><link data-rh=true rel=canonical href=https://lzw.me/docs/tvm-cn/docs/arch/arch/inferbound><link data-rh=true rel=alternate href=https://lzw.me/docs/tvm-cn/docs/arch/arch/inferbound hreflang=zh-Hans><link data-rh=true rel=alternate href=https://lzw.me/docs/tvm-cn/docs/arch/arch/inferbound hreflang=x-default><link data-rh=true rel=preconnect href=https://KU6TD2KAGA-dsn.algolia.net crossorigin=anonymous><link rel=preconnect href=https://www.google-analytics.com><link rel=preconnect href=https://www.googletagmanager.com><script async src="https://www.googletagmanager.com/gtag/js?id=GTM-TVRNTQWL"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","GTM-TVRNTQWL",{})</script><link rel=search type=application/opensearchdescription+xml title="Apache TVM 中文站" href=/docs/tvm-cn/opensearch.xml><link rel=stylesheet href=https://fastly.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css type=text/css integrity=sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM crossorigin=anonymous><script src=https://lzw.me/x/lib/utils/h5-common.js defer data-domain=lzw.me></script><link rel=stylesheet href=/docs/tvm-cn/assets/css/styles.d660bc20.css><script src=/docs/tvm-cn/assets/js/runtime~main.412de774.js defer></script><script src=/docs/tvm-cn/assets/js/main.60e49e7b.js defer></script><body class=navigation-with-keyboard><script>!function(){var t,e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t=null!==e?e:window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":(window.matchMedia("(prefers-color-scheme: light)").matches,"light"),document.documentElement.setAttribute("data-theme",t)}(),function(){try{for(var[t,e]of new URLSearchParams(window.location.search).entries())if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id=__docusaurus><link rel=preload as=image href=/docs/tvm-cn/img/favicon-dark.svg><link rel=preload as=image href=/docs/tvm-cn/img/favicon.svg><div role=region aria-label=跳到主要内容><a class=skipToContent_ZYxR href=#__docusaurus_skipToContent_fallback>跳到主要内容</a></div><nav aria-label=主导航 class="navbar navbar--fixed-top"><div class=navbar__inner><div class=navbar__items><button aria-label=切换导航栏 aria-expanded=false class="navbar__toggle clean-btn" type=button><svg width=30 height=30 viewBox="0 0 30 30" aria-hidden=true><path stroke=currentColor stroke-linecap=round stroke-miterlimit=10 stroke-width=2 d="M4 7h22M4 15h22M4 23h22"/></svg></button><a class=navbar__brand href=/docs/tvm-cn/><div class=navbar__logo><img src=/docs/tvm-cn/img/favicon-dark.svg alt="TVM Logo" class="themedComponent_PKz1 themedComponent--light_TYnW"><img src=/docs/tvm-cn/img/favicon.svg alt="TVM Logo" class="themedComponent_PKz1 themedComponent--dark_RKZm"></div><b class="navbar__title text--truncate">TVM 中文站</b></a><a aria-current=page class="navbar__item navbar__link navbar__link--active" href=/docs/tvm-cn/docs/>查看文档</a><a class="navbar__item navbar__link" href=/docs/tvm-cn/about>关于</a><a href=https://tool.lzw.me target=_blank rel="noopener noreferrer" class="navbar__item navbar__link">有趣工具箱<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_wR_l><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><a href=https://lzw.me/x/reference/ target=_blank rel="noopener noreferrer" class="navbar__item navbar__link">IT速查清单<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_wR_l><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a></div><div class="navbar__items navbar__items--right"><a href=https://github.com/hyperai/tvm-cn target=_blank rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_wR_l><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class=navbar__link aria-haspopup=true aria-expanded=false role=button href=/docs/tvm-cn/docs/arch/arch/inferbound>0.13.0</a><ul class=dropdown__menu><li><a aria-current=page class="dropdown__link dropdown__link--active" href=/docs/tvm-cn/docs/arch/arch/inferbound>0.13.0</a><li><a class=dropdown__link href=/docs/tvm-cn/docs/0.12.0/arch/arch/inferbound>0.12.0</a><li><a class=dropdown__link href=/docs/tvm-cn/docs/0.10.0/arch/arch/inferbound>0.10.0</a></ul></div><div class="toggle_azEg colorModeToggle_ACQd"><button class="clean-btn toggleButton_rDEP toggleButtonDisabled_BTpm" type=button disabled title=切换浅色/暗黑模式（当前为浅色模式） aria-label=切换浅色/暗黑模式（当前为浅色模式） aria-live=polite aria-pressed=false><svg viewBox="0 0 24 24" width=24 height=24 class=lightToggleIcon_FWei><path fill=currentColor d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"/></svg><svg viewBox="0 0 24 24" width=24 height=24 class=darkToggleIcon_OH98><path fill=currentColor d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"/></svg></button></div><div class=navbarSearchContainer_CQDF><button type=button class="DocSearch DocSearch-Button" aria-label="搜索 (Command+K)"><span class=DocSearch-Button-Container><svg width=20 height=20 class=DocSearch-Search-Icon viewBox="0 0 20 20" aria-hidden=true><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke=currentColor fill=none fill-rule=evenodd stroke-linecap=round stroke-linejoin=round /></svg><span class=DocSearch-Button-Placeholder>搜索</span></span><span class=DocSearch-Button-Keys></span></button></div></div></div><div role=presentation class=navbar-sidebar__backdrop></div></nav><div id=__docusaurus_skipToContent_fallback class="main-wrapper mainWrapper_YyXw"><div class=docsWrapper_QpQH><button aria-label=回到顶部 class="clean-btn theme-back-to-top-button backToTopButton_J2hp" type=button></button><div class=docRoot_e4fL><aside class="theme-doc-sidebar-container docSidebarContainer_lAUu"><div class=sidebarViewport_u_LW><div class=sidebar_CdZN><nav aria-label=文档侧边栏 class="menu thin-scrollbar menu_MbTs"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class=menu__link href=/docs/tvm-cn/docs/>欢迎</a><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class=menu__list-item-collapsible><a class=menu__link>快速上手</a></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/docs/tvm-cn/docs/install>安装 TVM</a><button aria-label="展开侧边栏分类 '安装 TVM'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/docs/tvm-cn/docs/contribute>贡献指南</a><button aria-label="展开侧边栏分类 '贡献指南'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div></ul><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class=menu__list-item-collapsible><a class=menu__link>用户手册</a></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/docs/tvm-cn/docs/tutorial>用户教程</a><button aria-label="展开侧边栏分类 '用户教程'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/docs/tvm-cn/docs/how_to>常见问题</a><button aria-label="展开侧边栏分类 '常见问题'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div></ul><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class=menu__list-item-collapsible><a class=menu__link>开发手册</a></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/docs/tvm-cn/docs/dev/>开发者教程</a><button aria-label="展开侧边栏分类 '开发者教程'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/docs/tvm-cn/docs/dev/how_to>开发者指南</a><button aria-label="展开侧边栏分类 '开发者指南'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div></ul><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--active">设计与架构</a></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--active" tabindex=0 href=/docs/tvm-cn/docs/arch/>设计与架构</a><button aria-label="折叠侧边栏分类 '设计与架构'" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/docs/tvm-cn/docs/arch/arch/runtimes/>TVM Runtime 系统</a><button aria-label="展开侧边栏分类 'TVM Runtime 系统'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/docs/tvm-cn/docs/arch/arch/debugger>调试器</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/docs/tvm-cn/docs/arch/arch/virtual_machine>向 TVM 中添加虚拟机：Relay 虚拟机</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/docs/tvm-cn/docs/arch/arch/introduction_to_module_serialization>模块序列化简介</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/docs/tvm-cn/docs/arch/arch/device_target_interactions>设备/Target 交互</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/docs/tvm-cn/docs/arch/arch/pass_infra>Pass Infrastructure</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current=page tabindex=0 href=/docs/tvm-cn/docs/arch/arch/inferbound>InferBound Pass</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/docs/tvm-cn/docs/arch/arch/hybrid_script>混合前端开发者指南</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/docs/tvm-cn/docs/arch/arch/relay_intro>Relay IR 简介</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/docs/tvm-cn/docs/arch/arch/relay_op_strategy>Relay 算子策略</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/docs/tvm-cn/docs/arch/arch/convert_layout>Convert Layout Pass</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/docs/tvm-cn/docs/arch/arch/benchmark>Benchmark 性能日志格式</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/docs/tvm-cn/docs/arch/arch/tensorflow>TensorFlow 前端</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/docs/tvm-cn/docs/arch/arch/security>安全指南</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/docs/tvm-cn/docs/arch/arch/microtvm_design>microTVM 设计文档</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/docs/tvm-cn/docs/arch/arch/microtvm_project_api>关于 microTVM 项目 API</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/docs/tvm-cn/docs/arch/arch/model_library_format>模型库格式</a></ul></ul><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class=menu__list-item-collapsible><a class=menu__link>主题指南</a></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/docs/tvm-cn/docs/topic/microtvm/>microTVM：裸机上的 TVM</a><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/docs/tvm-cn/docs/topic/vta>VTA：多功能张量加速器</a><button aria-label="展开侧边栏分类 'VTA：多功能张量加速器'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div></ul></ul></nav></div></div></aside><main class=docMainContainer_ch7h><div class="container padding-top--md padding-bottom--lg"><div class=row><div class="col docItemCol__o6A"><div class=docItemContainer_Wtch><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_fS1C" aria-label=页面路径><ul class=breadcrumbs itemscope itemtype=https://schema.org/BreadcrumbList><li class=breadcrumbs__item><a aria-label=主页面 class=breadcrumbs__link href=/docs/tvm-cn/><svg viewBox="0 0 24 24" class=breadcrumbHomeIcon_jcRj><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill=currentColor /></svg></a><li class=breadcrumbs__item><span class=breadcrumbs__link>设计与架构</span><meta itemprop=position content=1><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class=breadcrumbs__item><a class=breadcrumbs__link itemprop=item href=/docs/tvm-cn/docs/arch/><span itemprop=name>设计与架构</span></a><meta itemprop=position content=2><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class="breadcrumbs__item breadcrumbs__item--active"><span class=breadcrumbs__link itemprop=name>InferBound Pass</span><meta itemprop=position content=3></ul></nav><span class="theme-doc-version-badge badge badge--secondary">版本：0.13.0</span><div class="tocCollapsible_hZNL theme-doc-toc-mobile tocMobile_UGcD"><button type=button class="clean-btn tocCollapsibleButton_z7oa">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>InferBound Pass</h1></header>
<p>InferBound pass 在 normalize 之后、ScheduleOps <a href=https://github.com/apache/tvm/blob/main/python/tvm/driver/build_module.py target=_blank rel="noopener noreferrer">build_module.py</a> 之前运行。InferBound 的主要工作是创建 bounds map，为程序中的每个 IterVar 指定一个 Range。接下来这些 bounds 会传递给 ScheduleOps，用于设置 For 循环的范围，参阅 <a href=https://github.com/apache/tvm/blob/main/src/te/operation/op_util.cc target=_blank rel="noopener noreferrer">MakeLoopNest</a>，以及设置分配缓冲区的大小（<a href=https://github.com/apache/tvm/blob/main/src/te/operation/compute_op.cc target=_blank rel="noopener noreferrer">BuildRealize</a>）以及其他用途。</p>
<p>InferBound 的输出是从 IterVar 到 Range 的映射：</p>
<div class="language-c++ codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-c++ codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token plain">Map&lt;IterVar, Range> InferBound(const Schedule& sch);</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>回顾 Range 和 IterVar 类：</p>
<div class="language-c++ codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-c++ codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token plain">namespace HalideIR {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">namespace IR {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">     class RangeNode : public Node {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">     public:</span><br></span><span class=token-line style=color:#393A34><span class="token plain">             Expr min;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">             Expr extent;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">             // 剩余部分省略</span><br></span><span class=token-line style=color:#393A34><span class="token plain">     };</span><br></span><span class=token-line style=color:#393A34><span class="token plain">     }}</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">namespace tvm {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">     class IterVarNode : public Node {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">     public:</span><br></span><span class=token-line style=color:#393A34><span class="token plain">             Range dom;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">             Var var;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">             // 剩余部分省略</span><br></span><span class=token-line style=color:#393A34><span class="token plain">     };</span><br></span><span class=token-line style=color:#393A34><span class="token plain">}</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>注意，IterVarNode 还包含一个 Range <code>dom</code>。这个 <code>dom</code> 的值是否有意义，取决于 IterVar 的创建时间。例如，调用 <code>tvm.compute</code> 时，会为每个 axis 和 reduce axis <a href=https://github.com/apache/tvm/blob/main/src/te/operation/compute_op.cc target=_blank rel="noopener noreferrer">创建一个 IterVar</a> ，其中 dom 等于调用 <code>tvm.compute</code> 时提供的 shape。</p>
<p>另一方面，调用 <code>tvm.split</code> 时，会为内轴和外轴 <a href=https://github.com/apache/tvm/blob/main/src/te/schedule/schedule_lang.cc target=_blank rel="noopener noreferrer">创建 IterVars</a>，但这些 IterVars 没有被赋予有意义的 <code>dom</code> 值。</p>
<p>在任何情况下，IterVar 的 <code>dom</code> 成员在 InferBound 期间都不会被修改。但 IterVar 的 <code>dom</code> 成员有时用作 Range InferBound 计算的默认值。</p>
<p>为了理解 InferBound pass，我们先来看一下 TVM 代码库概念。</p>
<p>InferBound 接收一个参数，即 Schedule。这个 schedule 对象及其成员包含正在编译的程序的所有信息。</p>
<p>TVM schedule 由 stage 组成。每个 stage 只有一个 Operation，例如 ComputeOp 或 TensorComputeOp。每个 Operation 都有一个 root_iter_vars 列表，在 ComputeOp 的情况下，它由 axis IterVar 和 reduce axis IterVar 组成。</p>
<p>每个 Operation 还包含许多其他 IterVar，它们通过 Operation 的 IterVarRelations 列表相关联。每个 IterVarRelation 代表 schedule 中的 split、fuse 或 rebase。例如，在 split 的情况下，IterVarRelation 指定被拆分的父级 IterVar，以及两个子级 IterVar：内部和外部。</p>
<div class="language-c++ codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-c++ codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token plain">namespace tvm {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">     class ScheduleNode : public Node {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">     public:</span><br></span><span class=token-line style=color:#393A34><span class="token plain">             Array&lt;Operation> outputs;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">             Array&lt;Stage> stages;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">             Map&lt;Operation, Stage> stage_map;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">             // 剩余部分省略</span><br></span><span class=token-line style=color:#393A34><span class="token plain">     };</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">     class StageNode : public Node {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">     public:</span><br></span><span class=token-line style=color:#393A34><span class="token plain">             Operation op;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">             Operation origin_op;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">             Array&lt;IterVar> all_iter_vars;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">             Array&lt;IterVar> leaf_iter_vars;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">             Array&lt;IterVarRelation> relations;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">             // 剩余部分省略</span><br></span><span class=token-line style=color:#393A34><span class="token plain">     };</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">     class OperationNode : public Node {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">     public:</span><br></span><span class=token-line style=color:#393A34><span class="token plain">             virtual Array&lt;IterVar> root_iter_vars();</span><br></span><span class=token-line style=color:#393A34><span class="token plain">             virtual Array&lt;Tensor> InputTensors();</span><br></span><span class=token-line style=color:#393A34><span class="token plain">             // 剩余部分省略</span><br></span><span class=token-line style=color:#393A34><span class="token plain">     };</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">     class ComputeOpNode : public OperationNode {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">     public:</span><br></span><span class=token-line style=color:#393A34><span class="token plain">             Array&lt;IterVar> axis;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">             Array&lt;IterVar> reduce_axis;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">             Array&lt;Expr> body;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">             Array&lt;IterVar> root_iter_vars();</span><br></span><span class=token-line style=color:#393A34><span class="token plain">             // 剩余部分省略</span><br></span><span class=token-line style=color:#393A34><span class="token plain">     };</span><br></span><span class=token-line style=color:#393A34><span class="token plain">}</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>在 TVM 的 context 中，张量表示操作的输出。</p>
<div class="language-c++ codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-c++ codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token plain">class TensorNode : public Node {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">public:</span><br></span><span class=token-line style=color:#393A34><span class="token plain">     // 源操作，可以是 None</span><br></span><span class=token-line style=color:#393A34><span class="token plain">     // 这个 Tensor 是这个 op 输出的</span><br></span><span class=token-line style=color:#393A34><span class="token plain">     Operation op;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">     // 源操作的输出索引</span><br></span><span class=token-line style=color:#393A34><span class="token plain">     int value_index;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">};</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>上面的 Operation 类声明中，可以看到每个 operation 还有一个 InputTensor 列表。因此，schedule 的各个 stage 形成了一个 DAG，其中每个 stage 都是图中的一个节点。若 Stage B 的 operation 有一个输入张量，其源操作是 Stage A 的 op，那么图中从 Stage A 到 Stage B 有一个 edge。简而言之，若 B 消耗了一个由 A 产生的张量，则从 A 到 B 会出现一个 edge。参见下图。这个计算图是在 InferBound 开始时调用 <a href=https://github.com/apache/tvm/blob/main/src/te/schedule/bound.cc target=_blank rel="noopener noreferrer">CreateReadGraph</a> 创建的。</p>
<p><img decoding=async loading=lazy alt=图片 src=/docs/tvm-cn/assets/images/stage_graph-b091ae430c96c27e5f76596f1857b8cb.png width=607 height=323 class=img_DHp8></p>
<p>InferBound 使 pass 遍历计算图，每个 stage 访问一次。InferBound 从输出 stage 开始（即上图中的实心蓝色节点），然后向上移动（在边缘的相反方向上）。这是通过对计算图的节点执行反向拓扑排序来实现的。因此，当 InferBound 访问一个 stage 时，它的每个 consumer stage 都已经被访问过。</p>
<p><img decoding=async loading=lazy alt=图片 src=/docs/tvm-cn/assets/images/inferbound_traversal-a1f9b2295cbf65e6282b7d9fa50a9b25.png width=522 height=257 class=img_DHp8></p>
<p>InferBound pass 如以下伪代码所示：</p>
<div class="language-c++ codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-c++ codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token plain">Map&lt;IterVar, Range> InferBound(const Schedule& sch) {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">     Array&lt;Operation> outputs = sch->get_outputs();</span><br></span><span class=token-line style=color:#393A34><span class="token plain">     G = CreateGraph(outputs);</span><br></span><span class=token-line style=color:#393A34><span class="token plain">     stage_list = sch->reverse_topological_sort(G);</span><br></span><span class=token-line style=color:#393A34><span class="token plain">     Map&lt;IterVar, Range> rmap;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">     for (Stage s in stage_list) {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">             InferRootBound(s, &rmap);</span><br></span><span class=token-line style=color:#393A34><span class="token plain">             PassDownDomain(s, &rmap);</span><br></span><span class=token-line style=color:#393A34><span class="token plain">     }</span><br></span><span class=token-line style=color:#393A34><span class="token plain">     return rmap;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">}</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>InferBound pass 有两个不是很明显的属性：</p>
<ol>
<li>InferBound 访问一个 stage 后，stage 中所有 IterVar 的范围都会在 <code>rmap</code> 中设置。</li>
<li>每个 IterVar 的 Range 只在 <code>rmap</code> 中设置一次后就不会再变了。</li>
</ol>
<p>因此，仍然需要解释 InferBound 在访问 stage 时的主要作用。从上面的伪代码中可以看出，InferBound 在每个 stage 调用了两个函数：InferRootBound 和 PassDownDomain。InferRootBound 的目的是设置 stage 每个 root_iter_var 的 Range（在 <code>rmap</code> 中）。（注意：InferRootBound 不设置任何其他 IterVar 的 Range，只设置属于 root_iter_vars 的那些）。PassDownDomain 的目的是将此信息传播到 stage 的其余 IterVars。当 PassDownDomain 返回时，stage 的所有 IterVars 在 <code>rmap</code> 中都有已知的 Range。</p>
<p>文档的其余部分将深入探讨 InferRootBound 和 PassDownDomain 的详细信息。由于 PassDownDomain 描述起来更简单，因此首先介绍它。</p>
<h2 class="anchor anchorWithStickyNavbar_csPL" id=itervar-hyper-graph>IterVar Hyper-graph<a href=#itervar-hyper-graph class=hash-link aria-label="IterVar Hyper-graph的直接链接" title="IterVar Hyper-graph的直接链接">​</a></h2>
<p>如上所述，InferBound pass 遍历 stage 计算图。但是，在每个 stage 中都有另一个节点为 IterVars 的计算图。 InferRootBound 和 PassDownDomain 在这些 IterVar 计算图上传递消息。</p>
<p>回想一下，stage 的所有 IterVar 都由 IterVarRelations 关联。一个 stage 的 IterVarRelations 构成一个有向无环 hyper-graph，计算图中每个节点对应一个 IterVar，每条 hyper-edge 对应一个 IterVarRelation。也可以将这个 hyper-graph 表示为 DAG，如下图所示更易于可视化。</p>
<p><img decoding=async loading=lazy alt=图片 src=/docs/tvm-cn/assets/images/relations-72dfc8fdab849fe68d7c602c70654b7c.png width=1043 height=342 class=img_DHp8></p>
<p>上图显示了一个 stage 的 IterVar hyper-graph。该 stage 有一个 root_iter_var <code>i</code>，它已被拆分，生成的内轴 <code>i.inner</code> 已再次拆分。该 stage 的 leaf_iter_vars 为绿色图示：<code>i.outer</code>、<code>i.inner.outer</code> 和 <code>i.inner.inner</code>。</p>
<p>消息传递函数被命名为「PassUp」或「PassDown」，取决于消息是从 DAG 中的子代传递给其父代（「PassUp」），还是从父代传递给其子代（「PassDown」）。例如，上图左侧的大箭头显示 PassDownDomain 从根 IterVar <code>i</code> 向其子 <code>i.outer</code> 和 <code>i.inner</code> 发送消息。</p>
<h2 class="anchor anchorWithStickyNavbar_csPL" id=passdowndomain>PassDownDomain<a href=#passdowndomain class=hash-link aria-label=PassDownDomain的直接链接 title=PassDownDomain的直接链接>​</a></h2>
<p>PassDownDomain 的作用是为 root_iter_vars 取 InferRootBound 产生的 Range，并设置 stage 中所有其他 IterVars 的 Range。</p>
<p>PassDownDomain 遍历 stage 的 IterVarRelations。IterVarRelation 有三种可能的类型：split、fuse 和 rebase。最有趣的案例（因为它还有改进空间）是表示 split 的 IterVarRelations。</p>
<p>根据父级 IterVar 的已知 Range，来设置 split 的内部 IterVar 和外部 IterVar 的 Range，如下：</p>
<div class="language-c++ codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-c++ codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token plain">rmap[split->inner] = Range::FromMinExtent(0, split->factor)</span><br></span><span class=token-line style=color:#393A34><span class="token plain">rmap[split->outer] = Range::FromMinExtent(0, DivCeil(rmap[split->parent]->extent, split->factor))</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>当 <code>split->factor</code> 没有平均划分父节点的范围时，就有机会收紧 InferBound 产生的边界。假设 parent 的范围是 20，split 因子是 16。那么在外部循环的第二次迭代中，内部循环只需要进行 4 次迭代，而非 16 次。如果 PassDownDomain 可以设置 <code>split->inner</code> 的范围为 <code>min (split->factor, rmap[split->parent]->extent - (split->outer * split->factor))</code>，则内部变量的范围将根据正在执行的外部循环的迭代进行适当调整。</p>
<p>对于 Fuse 关系，根据已知的内外 IterVar 的 Range 设置 fuse 后的 IterVar 的 Range，如下：</p>
<div class="language-c++ codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-c++ codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token plain">rmap[fuse->fused] = Range::FromMinExtent(0, rmap[fuse->outer]->extent * rmap[fuse->inner]->extent)</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_csPL" id=inferrootbound>InferRootBound<a href=#inferrootbound class=hash-link aria-label=InferRootBound的直接链接 title=InferRootBound的直接链接>​</a></h2>
<p>InferBound 调用 InferRootBound，然后在 stage 计算图中的每个 stage 调用 <a href=#passdowndomain>PassDownDomain</a>。InferRootBound 的目的是设置 Stage 操作的每个 root_iter_var 的 Range。这些 Range 会用 <a href=#passdowndomain>PassDownDomain</a> 传到 Stage 的其余 IterVars。注意，InferRootBound 不会设置任何其他 IterVar 的 Range，仅设置属于 Stage 的 root_iter_vars 的那些。</p>
<p>若 Stage 是输出 Stage 或占位符，InferRootBound 只需将 root_iter_var Range 设置为其默认值。root_iter_var 的默认 Range 取自 IterVar 的 <code>dom</code> 成员（参阅上面的 IterVarNode 类声明）。</p>
<p>否则，InferRootBound 将遍历 stage 的 consumer。为每个 consumer 的 IterVar 创建 IntSet，如下所示。</p>
<p>阶段 1）IntSet 为 consumer 的 leaf_iter_vars 初始化，并通过 PassUpDomain 传到 consumer 的 root_iter_vars（阶段 2）。这些 IntSet 用于创建 consumer stage（阶段 3）的输入张量的 TensorDom。最后，一旦所有 consumer 都处理完毕，InferRootBound 调用 GatherBound，根据 TensorDoms（阶段 4）设置 stage 的 root_iter_vars 的 Range。</p>
<p>这个过程看起来很复杂。原因之一是一个 stage 可以有多个 consumer。每个 consumer 都有不同的要求，且必须以某种方式整合。类似地，该 stage 可能会输出多个张量，并且每个 consumer 只使用这些张量的特定子集。此外，即使 consumer 使用特定的张量，它也可能不会使用张量的所有元素。</p>
<p>如上所述，consumer 可能只需要每个张量中的少量元素。consumer 可以看成是针对输出张量某些区域，向 stage 发出的请求。阶段 1-3 的工作是建立每个 consumer 所需的每个输出张量的区域。</p>
<p><img decoding=async loading=lazy alt=图片 src=/docs/tvm-cn/assets/images/inferbound_phases-7a00a03b1d41cb07342f7ca19511bd8d.png width=823 height=614 class=img_DHp8></p>
<h3 class="anchor anchorWithStickyNavbar_csPL" id=intset>IntSet<a href=#intset class=hash-link aria-label=IntSet的直接链接 title=IntSet的直接链接>​</a></h3>
<p>在 InferRootBound 期间，Range 被转换为 IntSet，并且在 IntSet 上执行消息传递。因此，了解 Range 和 IntSet 之间的区别很重要。「IntSet」这个名称表明它可以表示任意整数集，例如 A = <!-- -->13<!-- -->。这肯定比 Range 更具表现力，Range 只表示一组连续的整数，例如 B = <!-- -->12<!-- -->。</p>
<p>然而，目前 IntSet 只有三种类型：IntervalSets、StrideSets 和 ModularSets。与 Range 类似，IntervalSets 仅表示连续整数的集合。StrideSet 由基本 IntervalSet、步长列表和范围列表定义。StrideSet 未被使用，ModularSet 只用于前端。</p>
<p>因此，目前在 TVM 中并非所有的整数集合都可以用 IntSet 来表示。例如，上例中的集合 A 不能用 IntSet 表示。将来 IntSet 的功能可以扩展为处理更通用的整数集，而无需对 IntSet 的用户进行修改。</p>
<p><em>对于包含 compute_at 的 schedules<strong>而言</strong>，InferBound 更为复杂。因此首先<strong>针对</strong>不包含 compute_at 的 schedules<strong>解读</strong>InferBound。</em></p>
<h3 class="anchor anchorWithStickyNavbar_csPL" id=阶段-1为-consumer-的-leaf_iter_vars-初始化-intset>阶段 1：为 consumer 的 leaf_iter_vars 初始化 IntSet<a href=#阶段-1为-consumer-的-leaf_iter_vars-初始化-intset class=hash-link aria-label="阶段 1：为 consumer 的 leaf_iter_vars 初始化 IntSet的直接链接" title="阶段 1：为 consumer 的 leaf_iter_vars 初始化 IntSet的直接链接">​</a></h3>
<div class="language-c++ codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-c++ codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token plain">/*</span><br></span><span class=token-line style=color:#393A34><span class="token plain"> * 输入: Map&lt;IterVar, Range> rmap: 包含 consumer stage 的每个 IterVar 的 Range</span><br></span><span class=token-line style=color:#393A34><span class="token plain"> * 输出: Map&lt;IterVar, IntSet> up_state: 包含 consumer 的每个 leaf_iter_var 的 IntSet</span><br></span><span class=token-line style=color:#393A34><span class="token plain"> */</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>在阶段 1，根据 <code>rmap</code> 中 leaf_iter_vars 的 Range 创建每个 consumer 的 leaf_iter_vars 的 IntSet。consumer 已经被 InferBound 访问过，所以它所有的 IterVar 都知道 <code>rmap</code> 中的 Range。</p>
<p>有以下三种案例：</p>
<ul>
<li>案例 1：leaf var 的 Range 范围为 1。这种情况下，leaf 的 up_state 只是一个点，等于 Range 的最小值。</li>
<li>案例 2：<em>不需要释放。这种情况下，leaf 的 up_state 只是一个点，由 leaf var 本身定义。</em></li>
<li>案例 3：需要释放。这种情况下，leaf 的 Range 被简单地转换为 IntSet。</li>
</ul>
<p>简单起见，假设 schedule 不包含线程轴。这种情况下，仅当 schedule 包含 compute_at 时，才和案例 2 相关。参阅 <a href=#inferboundca>InferBound 与 compute_at</a> 节来进一步获取更多信息。</p>
<h3 class="anchor anchorWithStickyNavbar_csPL" id=阶段-2将-intset-从-consumer-的-leaf-传到-consumer-的-root>阶段 2：将 IntSet 从 consumer 的 leaf 传到 consumer 的 root<a href=#阶段-2将-intset-从-consumer-的-leaf-传到-consumer-的-root class=hash-link aria-label="阶段 2：将 IntSet 从 consumer 的 leaf 传到 consumer 的 root的直接链接" title="阶段 2：将 IntSet 从 consumer 的 leaf 传到 consumer 的 root的直接链接">​</a></h3>
<div class="language-c++ codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-c++ codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token plain">/*</span><br></span><span class=token-line style=color:#393A34><span class="token plain"> * Input: Map&lt;IterVar, IntSet> up_state: consumer leaf -> IntSet</span><br></span><span class=token-line style=color:#393A34><span class="token plain"> * Output: Map&lt;IterVar, IntSet> dom_map: consumer root -> IntSet</span><br></span><span class=token-line style=color:#393A34><span class="token plain"> */</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>阶段 2 的目的是将 IntSet 信息从 consumer 的 leaf_iter_vars 传到 consumer 的 root_iter_vars。阶段 2 的结果是另一个映射 <code>dom_map</code>，其中包含每个 consumer 的 root_iter_vars 的 IntSet。</p>
<p>阶段 2 首先调用 PassUpDomain，它访问 consumer stage 的 IterVarRelations。在 Split 关系的情况下，PassUpDomain 根据内部和外部 IntSet 设置父级 IterVar 的 up_state，如下所示：</p>
<ul>
<li>案例 1：外部和内部 IterVar 的范围匹配它们的 <code>up_state</code> 域。在这种情况下，只需将父级的 Range 转换为 IntSet 即可设置父级的 <code>up_state</code>。</li>
<li>案例 2：<em>否则，父级的</em> <code>up_state</code> <em>是相对于外部和内部的</em>*<code>up_state</code><em>通过评估</em>  <code>outer*f + inner + rmap[parent]->min</code> <em>来定义的。这里，TVM 没有使用</em>s**plit 关系的因子，而是用* <code>f = rmap[inner]->extent</code>。</li>
</ul>
<p>仅当 schedule 包含 compute_at 时才需要案例 2。参阅下面的 <a href=#inferboundca>InferBound 与 compute_at</a> 节，进一步了解。</p>
<p>在 PassUpDomain 完成向 consumer 的所有 IterVars 传到 up_state 后，将创建一个从 root_iter_vars 到 IntSet 的新映射。如果 schedule 不包含 compute_at，则 root_iter_var iv 的 IntSet 由以下代码创建：</p>
<div class="language-c++ codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-c++ codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token plain">dom_map[iv->var.get()] = IntSet::range(up_state.at(iv).cover_range(iv->dom));</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>注意，若 schedule 不包含 compute_at，则实际上不需要阶段 1-2。dom_map 可以直接从 rmap 中的已知 Range 构建。Range 只需要转换为 IntSet，不会丢失信息。</p>
<h3 class="anchor anchorWithStickyNavbar_csPL" id=阶段-3将-intset-传到-consumer-的输入张量>阶段 3：将 IntSet 传到 consumer 的输入张量<a href=#阶段-3将-intset-传到-consumer-的输入张量 class=hash-link aria-label="阶段 3：将 IntSet 传到 consumer 的输入张量的直接链接" title="阶段 3：将 IntSet 传到 consumer 的输入张量的直接链接">​</a></h3>
<div class="language-c++ codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-c++ codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token plain">/*</span><br></span><span class=token-line style=color:#393A34><span class="token plain"> * Input: Map&lt;IterVar, IntSet> dom_map: consumer root -> IntSet</span><br></span><span class=token-line style=color:#393A34><span class="token plain"> * Output: Map&lt;Tensor, TensorDom> tmap: output tensor -> vector&lt;vector&lt;IntSet> ></span><br></span><span class=token-line style=color:#393A34><span class="token plain"> */</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>注意，consumer 的输入张量是 InferBound 正在处理的 stage 的输出张量。因此，通过建立有关 consumer 输入张量的信息，实际上也获得了有关 stage 输出张量的信息：consumer 需要计算这些张量的某些区域。然后可以将该信息传到 stage 的其余部分，最终在阶段 4 结束时获得 stage 的 root_iter_vars 的 Range。</p>
<p>阶段 3 的输出是 tmap，它是一个包含所有 stage 输出张量的映射。张量是多维的，具有许多不同的轴。对于每个输出张量，以及每个张量的轴，tmap 包含一个 IntSet 列表。列表中的每个 IntSet 都是来自不同 consumer 的请求。</p>
<p>阶段 3 是通过在 consumer 上调用 PropBoundToInputs 来完成的。PropBoundToInputs 将 IntSet 添加到 tmap 的列表中，用于 consumer 的所有输入张量。</p>
<p>PropBoundToInputs 的具体行为取决于 consumer 操作的类型：ComputeOp、TensorComputeOp、PlaceholderOp、ExternOp 等。TensorComputeOp 的每个张量输入都有一个区域，定义了操作所依赖的张量切片。对于每个输入张量 i 和维度 j，根据 Region 中的相应维度向 tmap 添加一个请求：</p>
<div class="language-c++ codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-c++ codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token plain">for (size_t j = 0; j &lt; t.ndim(); ++j) {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">     // i selects the Tensor t</span><br></span><span class=token-line style=color:#393A34><span class="token plain">     tmap[i][j].push_back(EvalSet(region[j], dom_map));</span><br></span><span class=token-line style=color:#393A34><span class="token plain">}</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_csPL" id=阶段-4整合所有-consumer>阶段 4：整合所有 consumer<a href=#阶段-4整合所有-consumer class=hash-link aria-label="阶段 4：整合所有 consumer的直接链接" title="阶段 4：整合所有 consumer的直接链接">​</a></h3>
<div class="language-c++ codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-c++ codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token plain">/*</span><br></span><span class=token-line style=color:#393A34><span class="token plain"> * Input: Map&lt;Tensor, TensorDom> tmap: output tensor -> vector&lt;vector&lt;IntSet> ></span><br></span><span class=token-line style=color:#393A34><span class="token plain"> * Output: Map&lt;IterVar, Range> rmap: rmap is populated for all of the stage's root_iter_vars</span><br></span><span class=token-line style=color:#393A34><span class="token plain"> */</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>阶段 4 由 GatherBound 执行，其行为取决于 stage 的操作类型。此处只讨论 ComputeOp，TensorComputeOp 情况类似。</p>
<p>ComputeOp 只有一个输出张量，其轴与 ComputeOp 的轴变量一一对应。ComputeOp 的 root_iter_vars 包括这些轴变量，以及 reduce_axis 变量。若 root IterVar 是一个轴变量，它对应一个输出张量的轴。 GatherBound 将此类 root IterVar 的 Range 设置为张量相应轴的所有 IntSet 的并集（即所有 consumer 请求的并集）。如果 root IterVar 是一个 reduce_axis，它的 Range 只是设置为其默认值（即 IterVarNode 的 <code>dom</code> 成员）。</p>
<div class="language-c++ codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-c++ codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token plain">// 'output' 选择输出张量</span><br></span><span class=token-line style=color:#393A34><span class="token plain">// i 是维度</span><br></span><span class=token-line style=color:#393A34><span class="token plain">rmap[axis[i]] = arith::Union(tmap[output][i]).cover_range(axis[i]->dom);</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p><img decoding=async loading=lazy alt=图片 src=/docs/tvm-cn/assets/images/gatherbound-7ecac2c9f688be9ef4786b86e956014a.png width=868 height=435 class=img_DHp8></p>
<p>IntSet 的并集是通过将每个 IntSet 转换为一个区间来计算的，然后取所有最小值中的最小值，以及所有这些区间最大值中的最大值。</p>
<p><img decoding=async loading=lazy alt=图片 src=data:image/png;base64,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 width=603 height=110 class=img_DHp8></p>
<p>计算从未使用过的张量元素，显然会导致一些不必要的计算。</p>
<p>即使 IntervalSet 联合体不会产生非必要的计算，GatherBound 单独考虑张量的每个维度也会导致不必要的计算。例如，在下图中，两个 consumer A 和 B 需要 2D 张量的不相交区域：consumer A 需要 T[0:2, 0:2]，consumer B 需要 T[2:4, 2:4]。 GatherBound 分别对张量的每个维度进行操作。对于张量的第一维，GatherBound 采用区间 0:2 和 2:4 的并集，产生 0:4（注意，此处不需要近似值）。对于张量的第二维也是如此。因此，这两个请求的维度并集为 T[0:4, 0:4]。因此 GatherBound 将导致计算张量 T 的所有 16 个元素，即使这些元素中只有一半会被使用。</p>
<p><img decoding=async loading=lazy alt=图片 src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAfMAAAFmCAYAAAB5pHO7AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAB2ZSURBVHhe7dzBqm1JmhfwfIV6hnyFeoFGIUemKA0l9ANIgpOGHkg5EdGEBEFxICXVorMct1hQhQ6EHDhSatA1THAq1LgRsbn2l3m/zLiREefsXLVWnC/W/v0guGevb6+1I1bEiv85eU7VR+8AgK0JcwDYnDAHgM0JcwDYnDAHgM0JcwDYnDAHgM0JcwDYnDAHgM0JcwDY3Klh/vXXX7/76KOPPmh867PPPvvmfnz55Zfvj8z19/Djjz9+X+Esn3zyyQf3+JF5ubMvvvjig/sRLdbszOhZj3sKvI3T0jY2w3igv/rqq/dH3n3ztSD6Vtyb2Bwf2fDivW24xDm73Mfc5OPfqnIuWnF/27X7bCLM2zWW8zj7Jifr7T2L83cJ9Oh39B/u4rTV/NKD/+zivsQm92jQ9fcyN57KAZkeHeNbefQbqmfTh3mI13F8JOe5DfNYs3FsB8KcuzllNT/6EPf/Ka/96Sgfrvw3W6s/PzeS0QYdr3MjGl07N654Xx7rvxnJcY3qce04Nz47av1Peq22L+3XM/1nZb/bgHypbyH7FS0/M/s42ojzM1rtNaK1n9/ey2hx/b5P0drPqCD61N+rkX4c7djzfsa/We/ntD033hdm89iGaHydx/L8OK+9t3m9Vvv+9nohjrXnt5+fov/tednX2fyN1lB+Riuum587ul57D2O9Rct7OfqM7FfrpXXajjtavO77FG10T2AnryfwA/qNYCQfoFa8zoDJh7S9TjzouXHlgz166OIa/QYXr3NTGF07XkeLhzvkQ5/X71/n5+fGkuPJ/s/0/X7kXsX7s18h3t+O79G+ZT3fn33t3x/yHqV4b9vPvEaKWtvHlNfOz65kNO6ReE+undDfz5iLeJ3jz3uX1417N1oX+b723sQ12vscX/fXitft/Mfrtn9xTvt58XX//v5zeznGtrXX6I3uZbxu+5HXTP34c2wp359jG31GXiPFNV5ap/35qb8O7O6U1RwPX/tAjcSD02/+7Xn9gx7aej7YowDpN68Qr3NTGF07zmk3nhDvyQe/PT/FsTznkTGHeF/bt9EG1Yt620b9eKlv7depHe8jm2RfD3Es73+Mvf+MkNdu73UVj9z72by2Yx/d37YetdE18h639ybOad8bX7dz289LaOdyVO8/p+3bzGjcMc7ROELey7b1nxHnjo7l+PqxhnZtj+arH29fD21f4uv+M8LovsHOTlnN8eC89mCMHrr2vHy4Xtro2g0kHvoUG1v7OrSbwuja7YaY4j3Zx/jc/Ky25Tlx7bZvM69dZyTquRnlPWrv3WvXjHq/gbXjfW2TbO9z37Jfoe1HynPbe11JP4Ze3Ld+LYX2nka9n7+ot9eNet6bvM95j9t7E+fEuamfu3ZeUjuXuT5GLT8nvn5pzGG0nkf9TTnPObY4v39vvB61HF983ferfW77zwjt/cj6qLXXzWPt+Eb3FXZ2ymrOh+qlDWNUbzeQ0cYR7+83mBTHc0OL65wd5u35I23fZ0afG2JccXwmau29ir6043utb6N6P952rCH7mvr6S+K6eS9yLfRjrqK/l73ZvLZzEuf3ayfO6dd3yLmO+zG6N1FvPy++bueun5fQzuWo3mv7PjMad157NJc5lnaNxPntfZndkzSq92u3/4x+vH39Je3c99eB3Z22muMBHD14uUHEQ94/PPE6H9x8uF7a6FrtQx/va8/Nvrx07XZDTPGe7H9eYybqs76luH5uHq3cCGcbXV/L/v+YvrX1fN1vtO3rqLfntBvfa+L6+d7RJl9J9q+f+7gf0eesx5hSfz9jrKPzR/OZc5faa+dntesovm4/uz8/xGf3c9ee04v6bK2lOL/tR3hpDYzmuX8Oo4/9NVt9PV73Y4l6P9Zo6aU+9uI6ea28r9lX2N2Hu8QfKB/mtrXioWtro02rfbjievmw99fuH+D22vnQ5vVH124f7BTvaTenOD+vmS3ro82vF/V2jK2XNqH4nH7z7Te1l/oWRvejPT/vSXtu/Ntqr5Et5EbeH0/xOXm87VMlbd+jtfe7vzfRWnFf2nsZYn7yGvF1e257D/p1HLV2HfVrZjQv/VyG9prR2rUVr/v11Butp9n6DLkG+vmNY23/27WQrX0O23sV58VnjsafbXQ/Zuu0P7e9z6E9r+0T7OjDp4LbGgUAVNOHOfAYYf4khDk7EOZwjDB/EsKcHQhzOEaYA8DmhDkAbE6YA8DmhDkAbE6YA8DmhDkAbE6YA8DmhDkAbE6YA8DmhDkAbO7SMP+jP/1zbXH79PPfDI+vapWN+ruqvfW8vFWzHmGNy8M8/Mkvf/ddG7lb/S03kVkfV6i+eZqX9axHWOPyMM+Qmz3Ud6zbPGsyL+tZj7DGsjAfydrd6jbPmszLetYjrLEkzEfieLaRnes2z5rMy3rWI6yx5HfmvQzB2YO+e93mWZN5Wc96hDWWh3mG4Owhv0Pd5lmTeVnPeoQ1loZ5PNjZRu5St3nWZF7Wsx5hjWVhnkE3e7jvVLd51mRe1rMeYY0lYZ4hN3uw71a3edZkXtazHmGNy8M8Q272UN+xbvOsybysZz3CGsvCfCRrd6vbPGsyL+tZj7DGkjAfiePZRnau2zxrMi/rWY+wxrI/gGtlCM4e9N3rNs+azMt61iOssTzMMwRnD/kd6jbPmszLetYjrLE0zOPBzjZyl7rNsybzsp71CGssC/MMutnDfae6zbMm87Ke9QhrLAnzDLnZg323us2zJvOynvUIa1we5hlys4f6jnWbZ03mZT3rEdZYFuYjWbtb3eZZk3lZz3qENZaE+Ugczzayc93mWZN5Wc96hDWW/QFcK0Nw9qDvXrd51mRe1rMeYY3lYZ4hOHvI71C3edZkXtazHmGNpWEeD3a2kbvUbZ41mZf1rEdYY1mYZ9DNHu471W2eNZmX9axHWGNJmGfIzR7su9VtnjWZl/WsR1jj8jDPkJs91Hes2zxrMi/rWY+wxrIwH8na3eo2z5rMy3rWI6yxJMxH4ni2kZ3rNs+azMt61iOssewP4FoZgrMHffe6zbMm87Ke9QhrLA/zDMHZQ36Heoy7fd+ztE8//837u1BT9G/Ub+2erfp6hDMtDfP2QRu5S91PQjWZl/WsR1hjWZhn0M0e7jvVbZ41mZf1rEdYY0mYZ8jNHuy71W2eNZmX9axHWOPyMM+Qmz3Ud6zbPGsyL+tZj7DGsjAfydrd6jbPmszLetYjrLEkzEfieLaRnes2z5rMy3rWI6yx7A/gWhmCswd997rNsybzsp71CGssD/MMwdlDfoe6zbMm87Ke9QhrLA3zeLCzjdylbvOsybysZz3CGsvCPINu9nDfqW7zrMm8rGc9whpLwjxDbvZg361u86zJvKxnPcIal4d5htzsob5j3eZZk3lZz3qENZaF+UjW7la3edZkXtazHmGNJWE+Esezjexct3nWZF7Wsx5hjWV/ANfKEJw96LvXbZ41mZf1rEdYY3mYZwjOHvI71G2eNZmX9axHWGNpmMeDnW3kLnWbZ03mZT3rEdZYFuYZdLOH+051m2dN5mU96xHWWBLmGXKzB/tudZtnTeZlPesR1rg8zDPkZg/1Hes2z5rMy3rWI6yxLMxHsna3us2zJvOynvUIaywJ85E4nm1k57rNsybzsp71CGss+wO4Vobg7EHfvW7zrMm8rGc9whrLwzxDcPaQ36Fu86zJvKxnPcIaS8M8HuxsI3ep2zxrMi/rWY+wxrIwz6CbPdx3qts8azIv61mPsMaSMM+Qmz3Yd6vbPGsyL+tZj7DG5WGeITd7qO9Yt3nWZF7Wsx5hjWVhPpK1u9VtnjWZl/WsR1hjSZiPxPFsIzvXbZ41mZf1rEdY4/Iw19a22DxHx1e1ykb9XdXeel7eqlmPsMaSP4B7C34SWq/65vnM8/KsDZ6FML+Acdf07PMSfcg2crd69fUIZxLmFzDump55XjLkZv24Y736eoQzCfMLGHdNzzwvfdC1sna3evX1CGcS5hcw7pqeeV5mnx/Hs43sXK++HuFMwvwCxl2TeflQhuCsb7vXq69HOJMwv4Bx12RevpchOOvXHerV1yOcSZhfwLhrMi/fir5kG7lLvfp6hDMJ8wsYd03m5fEgvEO9+nqEMwnzCxh3Tc8+Lxlys77crV59PcKZhPkFjLumZ56XDLlZP+5Yr74e4UzC/ALGXdMzz0sfdK2s3a1efT3CmYT5BYy7pmeel9nnx/FsIzvXq69HOJMwv4Bx12RePpQhOOvb7vXq6xHOJMwvYNw1mZfvZQjO+nWHevX1CGcS5hcw7prMy7eiL9lG7lKvvh7hTML8AsZdk3l5PAjvUK++HuFMwvwCxl3Ts89LhtysL3erV1+PcCZhfgHjrumZ5yVDbtaPO9arr0c4kzC/gHHX9Mzz0gddK2t3q1dfj3AmYX4B467pmedl9vlxPNvIzvXq6xHOJMwvYNw1mZcPZQjO+rZ7vfp6hDMJ8wsYd03m5XsZgrN+3aFefT3CmYT5BYy7JvPyrehLtpG71KuvRziTML+AcddkXh4PwjvUq69HOJMwv4Bx1/Ts85IhN+vL3erV1yOcSZhfwLhreuZ5yZCb9eOO9errEc4kzC9g3DU987z0QdfK2t3q1dcjnEmYX8C4a3rmeZl9fhzPNrJzvfp6hDMJ8wsYd03m5UMZgrO+7V6vvh7hTJeG+aef/+aDB067d4v5ruxZ1+Mo1Nr6yB3qwpxn4ifzCxh3TeblW9GXbCN3qVdfj3AmYX4B467JvDwehHeoV1+PcCZhfgHjrunZ5yVDbtaXu9Wrr0c4kzC/gHHX9MzzkiE368cd69XXI5xJmF/AuGt65nnpg66VtbvVq69HOJMwv4Bx1/TM8zL7/DiebWTnevX1CGcS5hcw7prMy4cyBGd9271efT3CmYT5BYy7JvPyvQzBWb/uUK++HuFMwvwCxl2TeflW9CXbyF3q1dcjnEmYX8C4azIvjwfhHerV1yOcSZhfwLhrevZ5yZCb9eVu9errEc4kzC9g3DU987xkyM36ccd69fUIZxLmFzDump55Xvqga2XtbvXq6xHOJMwvYNw1PfO8zD4/jmcb2blefT3CmYT5BYy7JvPyoQzBWd92r1dfj3AmYX4B467JvHwvQ3DWrzvUq69HOJMwv4Bx12RevhV9yTZyl3r19QhnEuYXMO6azMvjQXiHevX1CGcS5hcw7pqefV4y5GZ9uVu9+nqEMwnzCxh3Tc88Lxlys37csV59PcKZhPkFjLumZ56XPuhaWbtbvfp6hDMJ8wsYd03PPC+zz4/j2UZ2rldfj3AmYX4B467JvHwoQ3DWt93r1dcjnEmYX8C4azIv38sQnPXrDvXq6xHOJMwvYNw1mZdvRV+yjdylXn09wpmE+QWMuybz8ngQ3qFefT3CmYT5BYy7pmeflwy5WV/uVq++HuFMwvwCxl3TM89LhtysH3esV1+PcCZhfgHjrumZ56UPulbW7lavvh7hTML8AsZd0zPPy+zz43i2kZ3r1dcjnEmYX8C4a3rmeXnWBs/i8jB/q/bp578ZHr97+3v/8r8Nj69qlY36u6pZj2/T4FlcGuYAwPWEOQBsTpgDwOaEOQBsTpgDwOaEOQBsTpgDwOaEOQBsTpjzJv7Rv/nPw/+Tj5danAPADwlz3sQ//Ff/6d0f/+v//t3/r/ZrLd4b5wDwQ8KcNyHMAc4jzHkTwhzgPMKcNyHMAc4jzHkTwhzgPMKcNyHMAc4jzHkTwhzgPMKcNyHMAc4jzHkTwhzgPMKcNyHMAc4jzHkTwhzu6auvvnr30UcfvfvFL37x/giP+OSTT75pRwlz3oQwh3W+/vrrd5999tm7jz/++JugjRZfx7EI3zNlmH/xxRfvj1zvJz/5yXfjihavf/azn30z7l0Ic7YkzGGNL7/88rtw++1vf/v+6Ltvvo7AjVA/01uEef95MbYYV4z797///fujtQlztiTM4XoRahF08RP42SIoR+FTIcxDfBMTx3/1q1+9P1KbMGdLwhyuF+Fw1U+nEZSVw/wt+vGHEOZsSZjDteL3xRFmP/an8gj+9vfr8c1AvM5vCPIn3r5FeIY2RKPF+fE6gqr9z/wpjsWvAPI6P/3pT3/w03ReM47HdfJ6KV73oR1/gJfn9OK97d8PvPSZOa6U122Px/XiWNzzdiztfWu1nx//5riEOdsR5nCtDKMf+1flEUYRNhlCeZ3+m4I4NgqffH+0vE6EXIRWtFYEef/NwiiE85r53tD+cVt+Vor3x3sjpHtxftTy+vG5cWz2mfFvK4O7PZ7HYnzxzU7I8/v7lu/NeYn3xXnRJ2HOdoQ5XCuCaRRGcaxto8DrRchE2LTi3JfC/Oc///n7I98a/UQb3zj0AR+iT+3xvOYs7KI2av03MnmdDNzW7DPb/oaXwrz9ZiDkT+mt9huSlN/UCHO2I8zhWhlGL/1kHuHRh83I6H3x+qUwj4BrjcIxXvfBFjIc0+yaqa/FT9v5zUN7/bzu6H+y1tdG/Q35vvb46FjI4ymvOZqTuJfCnO0Ic7hW/iV7/xNyaxTSEWYRgPFTatTa1orXZ4T5rLX/JWB2zTSrxTiilgHdh2sra9m/UX9D/74wOhb6z5tdMwhztiTM4Xr5u9j8fXSvD/N4X7w//pNz+8dqo9CP12eE+egn897smmlW60M2X4/uR18b9Tf01wyjYyGPp7ymn8zZyu/+1/9+9x9//T+G7Y//6Zc/OszjnNG1osVnAR/K35vPArMP6Qyb/ne/ozCfhU9eI4KslcfbwOt/Tz0zu2aa1fqfzPMv8Ue/M49+tH8/kJ/ZB2/+Hrwdx6NhHt8oxOt+PvzOnNL+31//9bt/8u//67u//Wf/4d3f+Re/fvfp5x+2f/Bv/+cwuEct3tufH9f8W39z7X/8y//yzWcBP5QBFiHU/rQdgR0B1oZphF6+N4InWgZSG0oh3hMBFOfke8MsePN4G3h5LMItAzf+jXPj+ml2zTSq5e/M+18zRGBHv7Mf0e8M/bZvIe9PjjHeF+f278171J+fx1vRnzjW/tV7XFOYU1oG+t//53/xN6H8lz8I6ePtL9/93X/2F4IcHhCB0QZRtAi1CJYM0RQhH7V4T7w/zov3xdet+MagfV9+oxCfFcf6n2jzeB948Tp/2o0W4Rmfl98chNk1UzuubNG30U/gGcrxOfne/hudFMfyv0rEZ0S/8r92tOPI0O6vMQrzkPczatHPvAfCnNLOD3RBDtAS5ixxXqALcoCeMGeZPzzQBTnAiDBnqeOBLsgBZoQ5y/34QBfkAC8R5ryJxwNdkAO8RpjzZl4PdEEO8AhhzpuaB7ogB3iUMOfN/TDQBTnAjyHMKaENdEEO8OMIc8rIQP+zf/drQQ7wIwhzSokQ/6v/83/fvwLgEcIcADYnzAFgc8IcADYnzAFgc8IcADYnzAFgc8IcADYnzAFgc8IcADYnzAFgc8IcADYnzAFgc8IcADYnzAv7oz/9c+3JGsARwrywdnP/k1/+7rs2or5/XZgDRwnzwnJzfyQI1PevC3PgKGFeWGzujwaB+v51YQ4cJcwLa8N8pA2CEfW96sIcOEqYF5ZhPtIHQU99v7owB44S5oXNNvdRELTU96wLc+AoYV7YaHOfBUFS37cuzIGjhHlh/eb+UhAE9b3rwhw4SpgX1m7urwWB+v51YQ4cJcwLy839kSBQ378uzIGjhHlhsbk/GgTq+9eFOXCUMC+sDfORNghG1PeqC3PgKGFeWIb5SB8EPfX96sIcOEqYFzbb3EdB0FLfsy7MgaOEeWGjzX0WBEl937owB44S5oX1m/tLQRDU964Lc+AoYV5Yu7m/FgTq+9eFOXCUMC8sN/dHgkB9/7owB44S5oXF5v5oEKjvXxfmwFHCvLA2zEfaIBhR36suzIGjhHlhGeYjfRD01PerC3PgKGFe2GxzHwVBS33PujAHjhLmhY0291kQJPV968IcOEqYF9Zv7i8FQVDfuy7MgaOEeWHt5v5aEKjvXxfmwFHCvLDc3B8JAvX968IcOEqYFxab+6NBoL5/XZgDRwnzwtowH2mDYER9r7owB44S5oVlmI/0QdBT368uzIGjhHlhs819FAQt9T3rwhw4SpgXNtrcZ0GQ1PetC3PgKGFeWL+5vxQEQX3vujAHjhLmhbWb+2tBoL5/XZgDRwnzwnJzfyQI1PevC3PgKGFeWGzujwaB+v51YQ4cJcwLa8N8pA2CEfW96sIcOEqYF5ZhPtIHQU99v7owB44S5oXNNvdRELTU96wLc+AoYV7YaHOfBUFS37cuzIGjhHlh/eb+UhAE9b3rwhw4SpgX1m7urwWB+v51YQ4cJcwLy839kSBQ378uzIGjhHlhsbk/GgTq+9eFOXCUMC+sDfORNghG1PeqC3PgKGFeWIb5SB8EPfX96sIcOEqYFzbb3EdB0FLfsy7MgaOEeWGjzX0WBEl937owB44S5oX1m/tLQRDU964Lc+AoYV5Yu7m/FgTq+9eFOXCUMC8sN/dHgkB9/7owB44S5oXF5v5oEKjvXxfmwFHCvLA2zEfaIBhR36suzIGjhHlhGeYjfRD01PerC3PgKGFe2GxzHwVBS33PujAHjhLmhY0291kQJPV968IcOEqYF9Zv7i8FQVDfuy7MgaOEeWHt5v5aEKjvXxfmwFHCvLDc3B8JAvX968IcOEqYFxab+6NBoL5/XZgDRwnzwtowH2mDYER9r7owB44S5oVlmI/0QdBT368uzIGjhHlhs819FAQt9T3rwhw4SpgXNtrcZ0GQ1PetC3PgKGFeWL+5vxQEQX3vujAHjhLmhbWb+2tBoL5/XZgDRwnzwnJzfyQI1PevC3PgKGFeWGzujwaB+v51YQ4cJcwLa8N8pA2CEfW96sIcOEqYF5ZhPtIHQU99v7owB44S5oXNNvdRELTU96wLc+AoYV7YaHOfBUFS37cuzIGjhHlh/eb+UhAE9b3rwhw4SpgX1m7urwWB+v51YQ4cJcwLy839kSBQ378uzIGjhHlhsbk/GgTq+9eFOXCUMC+sDfORNghG1PeqC3PgKGFeWIb5SB8EPfX96sIcOEqYFzbb3EdB0FLfsy7MgaOEeWGjzX0WBEl937owB44S5oX1m/tLQRDU964Lc+AoYV5Yu7m/FgTq+9eFOXCUMC8sN/dHgkB9/7owB44S5oXF5v5oEKjvXxfmwFHCvLA2zEfaIBhR36suzIGjhHlhGeYjfRD01PerC3PgKGFe2GxzHwVBS33PujAHjhLmhY0291kQJPV968IcOEqYF9Zv7i8FQVDfuy7MgaOEeWHt5v5aEKjvXxfmwFHCvLDc3B8JAvX968IcOEqYFxab+6NBoL5/XZgDRwnzwtowH2mDYER9r7owB44S5oVlmI/0QdBT368uzIGjhHlhs819FAQt9T3rwhw4SpgXNtrcZ0GQ1PetC3PgKGFeWL+5vxQEQX3vujAHjhLmhbWb+2tBoL5/XZgDRwnzwnJzfyQI1PevC3PgKGFeWGzujwaB+v51YQ4cJcwLa8N8pA2CEfW96sIcOEqYF5ZhPtIHQU99v7owB44S5oXNNvdRELTU96wLc+AoYV7YaHOfBUFS37cuzIGjhHlh/eb+UhAE9b3rwhw4SpgX1m7urwWB+v51YQ4cJcwLy839kSBQ378uzIGjhHlhsbk/GgTq+9eFOXCUMC+sDfORNghG1PeqC3PgKGFeWIb5SB8EPfX96sIcOEqYFzbb3EdB0FLfsy7MgaOEeWGjzX0WBEl937owB44S5oX1m/tLQRDU964Lc+AoYV5Yu7m/FgTq+9eFOXCUMC8sN/dHgkB9/7owB44S5oXF5v5oEKjvXxfmwFHCvLA2zEfaIBhR36suzIGjhHlhGeYjfRD01PerC3PgKGFe2GxzHwVBS33PujAHjhLmhY0291kQJPV968IcOEqYF9Zv7i8FQVDfuy7MgaOEeWHt5v5aEKjvXxfmwFHCvLDc3B8JAvX968IcOEqYFxab+6NBoL5/XZgDRwnzwmJz156rARwhzAsbbfbavRvAEcIcADYnzAFgc8IcADYnzAFgc8IcADYnzAFgc8IcADYnzAFgc8IcADYnzAFgc8IcADYnzAFgc8IcADYnzAFgc8IcADYnzAFga+/e/X/BPFJN/qVwoAAAAABJRU5ErkJggg==" width=499 height=358 class=img_DHp8></p>
<h2 class="anchor anchorWithStickyNavbar_csPL" id=inferbound-与-compute_at>InferBound 与 compute_at<a href=#inferbound-与-compute_at class=hash-link aria-label="InferBound 与 compute_at的直接链接" title="InferBound 与 compute_at的直接链接">​</a></h2>
<p>若 schedule 包含 compute_at，则 InferRootBound 的阶段 1-2 会变得更加复杂。</p>
<h3 class="anchor anchorWithStickyNavbar_csPL" id=动机>动机<a href=#动机 class=hash-link aria-label=动机的直接链接 title=动机的直接链接>​</a></h3>
<p><strong>例 1</strong></p>
<p>考虑以下 TVM 程序片段：</p>
<div class="language-python codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-python codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token plain">C </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> tvm</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">compute</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>(</span><span class="token number" style=color:#36acaa>5</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token number" style=color:#36acaa>16</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>lambda</span><span class="token plain"> i</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> j </span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> tvm</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">const</span><span class="token punctuation" style=color:#393A34>(</span><span class="token number" style=color:#36acaa>5</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"int32"</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> name</span><span class="token operator" style=color:#393A34>=</span><span class="token string" style=color:#e3116c>'C'</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">D </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> tvm</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">compute</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>(</span><span class="token number" style=color:#36acaa>5</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token number" style=color:#36acaa>16</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>lambda</span><span class="token plain"> i</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> j </span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> C</span><span class="token punctuation" style=color:#393A34>[</span><span class="token plain">i</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> j</span><span class="token punctuation" style=color:#393A34>]</span><span class="token operator" style=color:#393A34>*</span><span class="token number" style=color:#36acaa>2</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> name</span><span class="token operator" style=color:#393A34>=</span><span class="token string" style=color:#e3116c>'D'</span><span class="token punctuation" style=color:#393A34>)</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>会产生以下结果（简化的 IR）：</p>
<div class="language-c++ codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-c++ codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token plain">for i 0, 5</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    for j 0, 16</span><br></span><span class=token-line style=color:#393A34><span class="token plain">        C[i, j] = 5</span><br></span><span class=token-line style=color:#393A34><span class="token plain">for i 0, 5</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    for j 0, 16</span><br></span><span class=token-line style=color:#393A34><span class="token plain">        D[i, j] = C[i, j]*2</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>可以看出，stage D 需要计算 C 的所有（5,16）元素。</p>
<p><strong>例 2</strong></p>
<p>然而，假设 C 在 D 的轴 j 处计算：</p>
<div class="language-python codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-python codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token plain">s </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> tvm</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">create_schedule</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">D</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">op</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">s</span><span class="token punctuation" style=color:#393A34>[</span><span class="token plain">C</span><span class="token punctuation" style=color:#393A34>]</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">compute_at</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">s</span><span class="token punctuation" style=color:#393A34>[</span><span class="token plain">D</span><span class="token punctuation" style=color:#393A34>]</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> D</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">op</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">axis</span><span class="token punctuation" style=color:#393A34>[</span><span class="token number" style=color:#36acaa>1</span><span class="token punctuation" style=color:#393A34>]</span><span class="token punctuation" style=color:#393A34>)</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>那么一次只需要一个 C 元素：</p>
<div class="language-c++ codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-c++ codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token plain">for i 0, 5</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    for j 0, 16</span><br></span><span class=token-line style=color:#393A34><span class="token plain">        C[0] = 5</span><br></span><span class=token-line style=color:#393A34><span class="token plain">        D[i, j] = C[0]*2</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p><strong>例 3</strong></p>
<p>类似地，如果在 D 的 i 轴计算 C，则一次只需要一个包含 C 的 16 个元素的向量：</p>
<div class="language-c++ codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-c++ codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token plain">for i 0, 5</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    for j 0, 16</span><br></span><span class=token-line style=color:#393A34><span class="token plain">        C[j] = 5</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    for j 0, 16</span><br></span><span class=token-line style=color:#393A34><span class="token plain">        D[i, j] = C[j]*2</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>基于上述示例，很明显，InferBound 应该为 stage C 给出不同的答案，具体取决于它在其 consumer D 中「附加」的位置。</p>
<h3 class="anchor anchorWithStickyNavbar_csPL" id=附加路径>附加路径<a href=#附加路径 class=hash-link aria-label=附加路径的直接链接 title=附加路径的直接链接>​</a></h3>
<p>若 stage C 在 stage D 的 j 轴上计算，我们说 C <em>附加</em>到 stage D 的轴 j。这通过设置以下三个成员变量反映在 Stage 对象中：</p>
<div class="language-c++ codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-c++ codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token plain">class StageNode : public Node {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">public:</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    // 省略</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    // 对于compute_at，attach_type = kScope</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    AttachType attach_type;</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    // 对于 compute_at，这是轴</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    // 传递给 compute_at，例如 D.op.axis[1]</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    IterVar attach_ivar;</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    // 传递给 compute_at 的阶段，例如 D</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    Stage attach_stage;</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    // 省略</span><br></span><span class=token-line style=color:#393A34><span class="token plain">};</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>再次考虑上面的例子。为了让 InferBound 确定必须计算 C 的多少元素，重要的是，要知道 C 的计算是发生在 D 的叶变量的范围内，还是在该范围之上。在例 1 中，C 的计算发生在 D 的所有叶变量的范围<em>之上</em>。在例 2，C 的计算发生在 D 的所有叶变量的范围<em>内</em>。在例 3，C 出现在D 的 i 维度的范围内，但在 D 的 j 维度的范围之上。</p>
<p>CreateAttachPath 负责确定哪些作用域包含 stage C。这些作用域按从最内层到最外层的顺序排列。因此，对于每个 stage，CreateAttachPath 都会生成一个「附加路径」，其中列出了包含该 stage 从最里面到最外面的范围，在例 1，C 的附加路径为空。在例 2，C 的附加路径包含 <code>{j，i}</code>。在例 3，C 的附加路径是 <code>{i}</code>。</p>
<p>以下示例阐明了附加路径的概念，适用于更复杂的情况。</p>
<p><strong>例 4</strong></p>
<div class="language-python codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-python codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token plain">C </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> tvm</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">compute</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>(</span><span class="token number" style=color:#36acaa>5</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token number" style=color:#36acaa>16</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>lambda</span><span class="token plain"> i</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> j </span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> tvm</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">const</span><span class="token punctuation" style=color:#393A34>(</span><span class="token number" style=color:#36acaa>5</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"int32"</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> name</span><span class="token operator" style=color:#393A34>=</span><span class="token string" style=color:#e3116c>'C'</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">D </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> tvm</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">compute</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>(</span><span class="token number" style=color:#36acaa>4</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token number" style=color:#36acaa>5</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token number" style=color:#36acaa>16</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>lambda</span><span class="token plain"> di</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> dj</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> dk </span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> C</span><span class="token punctuation" style=color:#393A34>[</span><span class="token plain">dj</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> dk</span><span class="token punctuation" style=color:#393A34>]</span><span class="token operator" style=color:#393A34>*</span><span class="token number" style=color:#36acaa>2</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> name</span><span class="token operator" style=color:#393A34>=</span><span class="token string" style=color:#e3116c>'D'</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">s </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> tvm</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">create_schedule</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">D</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">op</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">s</span><span class="token punctuation" style=color:#393A34>[</span><span class="token plain">C</span><span class="token punctuation" style=color:#393A34>]</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">compute_at</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">s</span><span class="token punctuation" style=color:#393A34>[</span><span class="token plain">D</span><span class="token punctuation" style=color:#393A34>]</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> D</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">op</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">axis</span><span class="token punctuation" style=color:#393A34>[</span><span class="token number" style=color:#36acaa>2</span><span class="token punctuation" style=color:#393A34>]</span><span class="token punctuation" style=color:#393A34>)</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>这是 ScheduleOps 之后的 IR（注意，使用 ScheduleOps 的 <code>debug_keep_trivial_loop</code> 参数保留了范围为 1 的循环）：</p>
<div class="language-c++ codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-c++ codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token plain">realize D([0, 4], [0, 5], [0, 16]) {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  produce D {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    for (di, 0, 4) {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">      for (dj, 0, 5) {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">        for (dk, 0, 16) {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">          realize C([dj, 1], [dk, 1]) {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">            produce C {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">              for (i, 0, 1) {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">                for (j, 0, 1) {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">                  C((i + dj), (j + dk)) =5</span><br></span><span class=token-line style=color:#393A34><span class="token plain">                }</span><br></span><span class=token-line style=color:#393A34><span class="token plain">              }</span><br></span><span class=token-line style=color:#393A34><span class="token plain">            }</span><br></span><span class=token-line style=color:#393A34><span class="token plain">            D(di, dj, dk) =(C(dj, dk)*2)</span><br></span><span class=token-line style=color:#393A34><span class="token plain">          }</span><br></span><span class=token-line style=color:#393A34><span class="token plain">        }</span><br></span><span class=token-line style=color:#393A34><span class="token plain">      }</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    }</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  }</span><br></span><span class=token-line style=color:#393A34><span class="token plain">}</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>在这种情况下，C 的附加路径是 <code>{dk, dj, di}</code>。注意 C 没有使用 di，但 di 仍然出现在 C 的附加路径中。</p>
<p><strong>例 5</strong></p>
<p>根据上述定义，可以很自然地在拆分后应用 Compute_at。下面例子中，C 的附着点是 D 的 j_inner。C 的附着路径是 <code>{j_inner, j_outer, i}</code>。</p>
<div class="language-python codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-python codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token plain">C </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> tvm</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">compute</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>(</span><span class="token number" style=color:#36acaa>5</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token number" style=color:#36acaa>16</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>lambda</span><span class="token plain"> i</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> j </span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> tvm</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">const</span><span class="token punctuation" style=color:#393A34>(</span><span class="token number" style=color:#36acaa>5</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"int32"</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> name</span><span class="token operator" style=color:#393A34>=</span><span class="token string" style=color:#e3116c>'C'</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">D </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> tvm</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">compute</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>(</span><span class="token number" style=color:#36acaa>5</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token number" style=color:#36acaa>16</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>lambda</span><span class="token plain"> i</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> j </span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> C</span><span class="token punctuation" style=color:#393A34>[</span><span class="token plain">i</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> j</span><span class="token punctuation" style=color:#393A34>]</span><span class="token operator" style=color:#393A34>*</span><span class="token number" style=color:#36acaa>2</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> name</span><span class="token operator" style=color:#393A34>=</span><span class="token string" style=color:#e3116c>'D'</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">s </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> tvm</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">create_schedule</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">D</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">op</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">d_o</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> d_i </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> s</span><span class="token punctuation" style=color:#393A34>[</span><span class="token plain">D</span><span class="token punctuation" style=color:#393A34>]</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">split</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">D</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">op</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">axis</span><span class="token punctuation" style=color:#393A34>[</span><span class="token number" style=color:#36acaa>1</span><span class="token punctuation" style=color:#393A34>]</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> factor</span><span class="token operator" style=color:#393A34>=</span><span class="token number" style=color:#36acaa>8</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">s</span><span class="token punctuation" style=color:#393A34>[</span><span class="token plain">C</span><span class="token punctuation" style=color:#393A34>]</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">compute_at</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">s</span><span class="token punctuation" style=color:#393A34>[</span><span class="token plain">D</span><span class="token punctuation" style=color:#393A34>]</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> d_i</span><span class="token punctuation" style=color:#393A34>)</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>这个案例的 IR 如下所示：</p>
<div class="language-c++ codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-c++ codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token plain">for i 0, 5</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    for j_outer 0, 2</span><br></span><span class=token-line style=color:#393A34><span class="token plain">        for j_inner 0, 8</span><br></span><span class=token-line style=color:#393A34><span class="token plain">            C[0] = 5</span><br></span><span class=token-line style=color:#393A34><span class="token plain">            D[i, j_outer*8 + j_inner] = C[0]*2</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_csPL" id=构建附加路径>构建附加路径<a href=#构建附加路径 class=hash-link aria-label=构建附加路径的直接链接 title=构建附加路径的直接链接>​</a></h3>
<p>继续参考上一节中介绍的 stage C 和 D。CreateAttachPath 算法按照如下方式构建 stage C 的附加路径。若 C 没有 attach_type <code>kScope</code>，则 C 没有附加内容，C 的附加路径为空；否则，在 attach_stage=D 处附加 C。</p>
<p>以自上而下的顺序遍历 D 的 leaf 变量。所有从 C.attach_ivar 或是更低位置开始的 leaf 变量都添加到 C 的附加路径中。然后，若 D 也附加到某个地方，例如 stage E ，则对 E 的 leaf 重复该过程。因此 CreateAttachPath 继续向 C 的附加路径添加变量，直到遇到没有附加的 stage。</p>
<p>在下面的示例中，C 附加到 D，D 附加到 E。</p>
<div class="language-python codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-python codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token plain">C </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> tvm</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">compute</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>(</span><span class="token number" style=color:#36acaa>5</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token number" style=color:#36acaa>16</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>lambda</span><span class="token plain"> ci</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> cj </span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> tvm</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">const</span><span class="token punctuation" style=color:#393A34>(</span><span class="token number" style=color:#36acaa>5</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"int32"</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> name</span><span class="token operator" style=color:#393A34>=</span><span class="token string" style=color:#e3116c>'C'</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">D </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> tvm</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">compute</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>(</span><span class="token number" style=color:#36acaa>5</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token number" style=color:#36acaa>16</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>lambda</span><span class="token plain"> di</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> dj </span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> C</span><span class="token punctuation" style=color:#393A34>[</span><span class="token plain">di</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> dj</span><span class="token punctuation" style=color:#393A34>]</span><span class="token operator" style=color:#393A34>*</span><span class="token number" style=color:#36acaa>2</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> name</span><span class="token operator" style=color:#393A34>=</span><span class="token string" style=color:#e3116c>'D'</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">E </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> tvm</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">compute</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>(</span><span class="token number" style=color:#36acaa>5</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token number" style=color:#36acaa>16</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>lambda</span><span class="token plain"> ei</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> ej </span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> D</span><span class="token punctuation" style=color:#393A34>[</span><span class="token plain">ei</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> ej</span><span class="token punctuation" style=color:#393A34>]</span><span class="token operator" style=color:#393A34>*</span><span class="token number" style=color:#36acaa>4</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> name</span><span class="token operator" style=color:#393A34>=</span><span class="token string" style=color:#e3116c>'E'</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">s </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> tvm</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">create_schedule</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">E</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">op</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">s</span><span class="token punctuation" style=color:#393A34>[</span><span class="token plain">C</span><span class="token punctuation" style=color:#393A34>]</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">compute_at</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">s</span><span class="token punctuation" style=color:#393A34>[</span><span class="token plain">D</span><span class="token punctuation" style=color:#393A34>]</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> D</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">op</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">axis</span><span class="token punctuation" style=color:#393A34>[</span><span class="token number" style=color:#36acaa>1</span><span class="token punctuation" style=color:#393A34>]</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">s</span><span class="token punctuation" style=color:#393A34>[</span><span class="token plain">D</span><span class="token punctuation" style=color:#393A34>]</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">compute_at</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">s</span><span class="token punctuation" style=color:#393A34>[</span><span class="token plain">E</span><span class="token punctuation" style=color:#393A34>]</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> E</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">op</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">axis</span><span class="token punctuation" style=color:#393A34>[</span><span class="token number" style=color:#36acaa>1</span><span class="token punctuation" style=color:#393A34>]</span><span class="token punctuation" style=color:#393A34>)</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>当 <code>debug_keep_trivial_loop=True</code> 时，C 的附加路径为 <code>{dj,di,ej,ei}</code>，D 的附加路径为 <code>{ej,ei}</code>：</p>
<div class="language-c++ codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-c++ codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token plain">// attr [D] storage_scope = "global"</span><br></span><span class=token-line style=color:#393A34><span class="token plain">allocate D[int32 * 1]</span><br></span><span class=token-line style=color:#393A34><span class="token plain">// attr [C] storage_scope = "global"</span><br></span><span class=token-line style=color:#393A34><span class="token plain">allocate C[int32 * 1]</span><br></span><span class=token-line style=color:#393A34><span class="token plain">produce E {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  for (ei, 0, 5) {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    for (ej, 0, 16) {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">      produce D {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">        for (di, 0, 1) {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">          for (dj, 0, 1) {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">            produce C {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">              for (ci, 0, 1) {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">                for (cj, 0, 1) {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">                  C[(ci + cj)] = 5</span><br></span><span class=token-line style=color:#393A34><span class="token plain">                }</span><br></span><span class=token-line style=color:#393A34><span class="token plain">              }</span><br></span><span class=token-line style=color:#393A34><span class="token plain">            }</span><br></span><span class=token-line style=color:#393A34><span class="token plain">            D[(di + dj)] = (C[(di + dj)]*2)</span><br></span><span class=token-line style=color:#393A34><span class="token plain">          }</span><br></span><span class=token-line style=color:#393A34><span class="token plain">        }</span><br></span><span class=token-line style=color:#393A34><span class="token plain">      }</span><br></span><span class=token-line style=color:#393A34><span class="token plain">      E[((ei*16) + ej)] = (D[0]*4)</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    }</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  }</span><br></span><span class=token-line style=color:#393A34><span class="token plain">}</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_csPL" id=inferbound-与-compute_at-1>InferBound 与 compute_at<a href=#inferbound-与-compute_at-1 class=hash-link aria-label="InferBound 与 compute_at的直接链接" title="InferBound 与 compute_at的直接链接">​</a></h3>
<p>前面已经介绍了附加路径的概念，现在来看，若 schedule 包含 compute_at 时，InferBound 的不同之处。唯一的区别在于 InferRootBound，<a href=#phase1>阶段 1：为 consumer 的 leaf_iter_vars 初始化 IntSet </a>和 <a href=#phase2>阶段 2：将 IntSet 从 consumer 的 leaf 传到 consumer 的 root</a>。</p>
<p>在 InferRootBound 中，目标是确定特定 stage C 的 root_iter_vars 的 Range。InferRootBound 的阶段 1-2 将 IntSet 分配给 C consumer 的 leaf IterVar，然后将这些 IntSet 传到 consumer 的 root_iter_vars。</p>
<p>若没有附加，则已经为 consumer 变量计算的 Range 定义了 consumer 需要多少 C。但是，若 stage 实际上在 consumer 变量 j 的一个范围内，那么一次只需要 j 的范围内的一个点。</p>
<h3 class="anchor anchorWithStickyNavbar_csPL" id=阶段-1为-consumer-的-leaf_iter_vars-初始化-intset-1>阶段 1：为 consumer 的 leaf_iter_vars 初始化 IntSet<a href=#阶段-1为-consumer-的-leaf_iter_vars-初始化-intset-1 class=hash-link aria-label="阶段 1：为 consumer 的 leaf_iter_vars 初始化 IntSet的直接链接" title="阶段 1：为 consumer 的 leaf_iter_vars 初始化 IntSet的直接链接">​</a></h3>
<div class="language-c++ codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-c++ codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token plain">/*</span><br></span><span class=token-line style=color:#393A34><span class="token plain"> * 输入：Map&lt;IterVar, Range> rmap: contains the Range for each IterVar of the consumer stage</span><br></span><span class=token-line style=color:#393A34><span class="token plain"> * 输出：Map&lt;IterVar, IntSet> up_state: contains an IntSet for each leaf_iter_var of the consumer</span><br></span><span class=token-line style=color:#393A34><span class="token plain"> */</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>阶段 1，根据 rmap 中的 leaf_iter_vars 的 Range 创建每个 consumer 的 leaf_iter_vars 的 IntSet。consumer 已经被 InferBound 访问过，所以它的所有 IterVar 都知道 rmap 中的 Range。</p>
<p>有以下三种案例：</p>
<ul>
<li>案例 1：leaf var 的 Range 范围为 1。这种情况下，leaf 的 up_state 只是一个点，等于 Range 的最小值。</li>
<li>案例 2：不需要释放。这种情况下，leaf 的 up_state 只是一个点，由 leaf var 本身定义。</li>
<li>案例 3：需要释放。这种情况下，leaf 的 Range 被简单地转换为 IntSet。
若在 consumer 中遇到 stage C 的附着点，就会发生案例 2。对于此 attach_ivar，以及 consumer 的所有更高叶变量，将应用案例 2。若 C 在叶变量的 Range 内，这将确保仅请求叶变量范围内的单个点。</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_csPL" id=阶段-2将-intset-从-consumer-的-leaf-传到-consumer-的-root-1>阶段 2：将 IntSet 从 consumer 的 leaf 传到 consumer 的 root<a href=#阶段-2将-intset-从-consumer-的-leaf-传到-consumer-的-root-1 class=hash-link aria-label="阶段 2：将 IntSet 从 consumer 的 leaf 传到 consumer 的 root的直接链接" title="阶段 2：将 IntSet 从 consumer 的 leaf 传到 consumer 的 root的直接链接">​</a></h3>
<div class="language-c++ codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-c++ codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token plain">/*</span><br></span><span class=token-line style=color:#393A34><span class="token plain"> * Input: Map&lt;IterVar, IntSet> up_state: consumer leaf -> IntSet</span><br></span><span class=token-line style=color:#393A34><span class="token plain"> * Output: Map&lt;IterVar, IntSet> dom_map: consumer root -> IntSet</span><br></span><span class=token-line style=color:#393A34><span class="token plain"> */</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>阶段 2 首先调用 PassUpDomain，它访问 consumer stage 的 IterVarRelations。在 Split 关系的情况下，PassUpDomain 根据内部和外部 IntSet 设置父级 IterVar 的 up_state，如下所示：</p>
<ul>
<li>案例 1：外部和内部 IterVar 的 Range 匹配它们的 <code>up_state</code> 域。在这种情况下，只需将父级的 Range 转换为 IntSet 即可设置父级的 <code>up_state</code>。</li>
<li>案例 2：否则，父级的 <code>up_state</code> 是通过评估 <code>outer*f + inner + rmap[parent]->min</code> 来定义的，相对于外部和内部的 <code>up_state</code>。在这里，TVM 没有使用 split 关系的因子，而是使用* <code>f = rmap[inner]->extent</code>。</li>
</ul>
<p>由于 schedule 包含 compute_at，因此可以应用案例 2。这是因为 leaf IntSet 现在可能会被初始化为其 Range 内的单个点（<a href=#phase1ca>阶段 1 的案例 2：为 consumer 的 leaf_iter_vars 初始化 IntSet</a>），因此 IntSet 无法总是与 Range 匹配。</p>
<p>PassUpDomain 将 up_state 向 consumer 传给所有 IterVars 后，将创建一个从 root_iter_vars 到 IntSet 的新映射。若 stage 没有附加到当前 consumer，那么对于 consumer 的 attach_path 中的每个变量 iv，将 iv 的 Range 添加到一个 <code>relax_set</code>。stage 的 root 变量是根据这个 <code>relax_set</code> 进行评估的。</p>
<p>这是为了处理类似以下示例的情况，其中 C 没有附加到任何地方，但它的 consumer D 在 stage E 中附加。这种情况下，在确定 C 有多少需要计算时，必须考虑 D 的 attach_path，<code>{ej，ei}</code>。</p>
<div class="language-python codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-python codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token plain">C </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> tvm</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">compute</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>(</span><span class="token number" style=color:#36acaa>5</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token number" style=color:#36acaa>16</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>lambda</span><span class="token plain"> ci</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> cj </span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> tvm</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">const</span><span class="token punctuation" style=color:#393A34>(</span><span class="token number" style=color:#36acaa>5</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"int32"</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> name</span><span class="token operator" style=color:#393A34>=</span><span class="token string" style=color:#e3116c>'C'</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">D </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> tvm</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">compute</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>(</span><span class="token number" style=color:#36acaa>5</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token number" style=color:#36acaa>16</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>lambda</span><span class="token plain"> di</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> dj </span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> C</span><span class="token punctuation" style=color:#393A34>[</span><span class="token plain">di</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> dj</span><span class="token punctuation" style=color:#393A34>]</span><span class="token operator" style=color:#393A34>*</span><span class="token number" style=color:#36acaa>2</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> name</span><span class="token operator" style=color:#393A34>=</span><span class="token string" style=color:#e3116c>'D'</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">E </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> tvm</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">compute</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>(</span><span class="token number" style=color:#36acaa>5</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token number" style=color:#36acaa>16</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>lambda</span><span class="token plain"> ei</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> ej </span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> D</span><span class="token punctuation" style=color:#393A34>[</span><span class="token plain">ei</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> ej</span><span class="token punctuation" style=color:#393A34>]</span><span class="token operator" style=color:#393A34>*</span><span class="token number" style=color:#36acaa>4</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> name</span><span class="token operator" style=color:#393A34>=</span><span class="token string" style=color:#e3116c>'E'</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">s </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> tvm</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">create_schedule</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">E</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">op</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">s</span><span class="token punctuation" style=color:#393A34>[</span><span class="token plain">D</span><span class="token punctuation" style=color:#393A34>]</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">compute_at</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">s</span><span class="token punctuation" style=color:#393A34>[</span><span class="token plain">E</span><span class="token punctuation" style=color:#393A34>]</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> E</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">op</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">axis</span><span class="token punctuation" style=color:#393A34>[</span><span class="token number" style=color:#36acaa>1</span><span class="token punctuation" style=color:#393A34>]</span><span class="token punctuation" style=color:#393A34>)</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<div class="language-c++ codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-c++ codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token plain">for ci 0, 5</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    for cj 0, 16</span><br></span><span class=token-line style=color:#393A34><span class="token plain">        C[ci, cj] = 5</span><br></span><span class=token-line style=color:#393A34><span class="token plain">for ei 0, 5</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    for ej 0, 16</span><br></span><span class=token-line style=color:#393A34><span class="token plain">        D[0] = C[ei, ej]*2</span><br></span><span class=token-line style=color:#393A34><span class="token plain">        E[ei, ej] = D[0]*4</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_csPL" id=passupdomain-的限制>PassUpDomain 的限制<a href=#passupdomain-的限制 class=hash-link aria-label="PassUpDomain 的限制的直接链接" title="PassUpDomain 的限制的直接链接">​</a></h3>
<p>本节介绍 PassUpDomain 的已知限制。这些限制会影响 InferBound 生成的 Range，以及 PassUpDomain 的其他用户（例如 <code>tensorize</code>）。</p>
<p><strong>例 6</strong></p>
<p>上面仅讨论了 PassUpDomain 在 Split 关系上的行为。在以下示例中，schedule 除了 <code>split</code> 之外还包含 <code>fuse</code>。以下 TVM 程序中，operation C 有两个轴被融合，然后融合的轴被拆分。注意，所有张量最初的 shape 都是 <code>(4, 4)</code>，并且融合轴也被因子 <code>4</code> 分割。假设 fuse 的效果只是被 split 所抵消。然而，在 TVM 中并非如此，如下所述。</p>
<div class="language-python codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-python codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token keyword" style=color:#00009f>import</span><span class="token plain"> tvm</span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>from</span><span class="token plain"> tvm </span><span class="token keyword" style=color:#00009f>import</span><span class="token plain"> te</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">n </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token number" style=color:#36acaa>4</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">m </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token number" style=color:#36acaa>4</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">A </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> te</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">placeholder</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">n</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> m</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> name</span><span class="token operator" style=color:#393A34>=</span><span class="token string" style=color:#e3116c>'A'</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">B </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> te</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">compute</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">n</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> m</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>lambda</span><span class="token plain"> bi</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> bj</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> A</span><span class="token punctuation" style=color:#393A34>[</span><span class="token plain">bi</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> bj</span><span class="token punctuation" style=color:#393A34>]</span><span class="token operator" style=color:#393A34>+</span><span class="token number" style=color:#36acaa>2</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> name</span><span class="token operator" style=color:#393A34>=</span><span class="token string" style=color:#e3116c>'B'</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">C </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> te</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">compute</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">n</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> m</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>lambda</span><span class="token plain"> ci</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> cj</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> B</span><span class="token punctuation" style=color:#393A34>[</span><span class="token plain">ci</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> cj</span><span class="token punctuation" style=color:#393A34>]</span><span class="token operator" style=color:#393A34>*</span><span class="token number" style=color:#36acaa>3</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> name</span><span class="token operator" style=color:#393A34>=</span><span class="token string" style=color:#e3116c>'C'</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">s </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> te</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">create_schedule</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">C</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">op</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">fused_axes </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> s</span><span class="token punctuation" style=color:#393A34>[</span><span class="token plain">C</span><span class="token punctuation" style=color:#393A34>]</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">fuse</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">C</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">op</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">axis</span><span class="token punctuation" style=color:#393A34>[</span><span class="token number" style=color:#36acaa>0</span><span class="token punctuation" style=color:#393A34>]</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> C</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">op</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">axis</span><span class="token punctuation" style=color:#393A34>[</span><span class="token number" style=color:#36acaa>1</span><span class="token punctuation" style=color:#393A34>]</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">xo</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> xi </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> s</span><span class="token punctuation" style=color:#393A34>[</span><span class="token plain">C</span><span class="token punctuation" style=color:#393A34>]</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">split</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">fused_axes</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token number" style=color:#36acaa>4</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">s</span><span class="token punctuation" style=color:#393A34>[</span><span class="token plain">B</span><span class="token punctuation" style=color:#393A34>]</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">compute_at</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">s</span><span class="token punctuation" style=color:#393A34>[</span><span class="token plain">C</span><span class="token punctuation" style=color:#393A34>]</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> xo</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>print</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">tvm</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">lower</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">s</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>[</span><span class="token plain">A</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> C</span><span class="token punctuation" style=color:#393A34>]</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> simple_mode</span><span class="token operator" style=color:#393A34>=</span><span class="token boolean" style=color:#36acaa>True</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>)</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>该程序的输出如下所示。注意，每次通过外循环计算 B 的所有 16 个元素，即使 C 只使用其中的 4 个。</p>
<div class="language-c++ codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-c++ codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token plain">// attr [B] storage_scope = "global"</span><br></span><span class=token-line style=color:#393A34><span class="token plain">allocate B[float32 * 16]</span><br></span><span class=token-line style=color:#393A34><span class="token plain">produce C {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  for (ci.cj.fused.outer, 0, 4) {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    produce B {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">      for (bi, 0, 4) {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">        for (bj, 0, 4) {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">          B[((bi*4) + bj)] = (A[((bi*4) + bj)] + 2.000000f)</span><br></span><span class=token-line style=color:#393A34><span class="token plain">        }</span><br></span><span class=token-line style=color:#393A34><span class="token plain">      }</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    }</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    for (ci.cj.fused.inner, 0, 4) {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">      C[((ci.cj.fused.outer*4) + ci.cj.fused.inner)] = (B[((ci.cj.fused.outer*4) + ci.cj.fused.inner)]*3.000000f)</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    }</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  }</span><br></span><span class=token-line style=color:#393A34><span class="token plain">}</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>这与下面的 IR 形成对比，后者是通过删除 fuse 和 split 修改上述程序，并将 compute_at 替换为 <code>s[B].compute_at(s[C], C.op.axis[0])</code> ，注意，在下面的 IR 中，根据需要一次只计算 B 的 4 个元素。缓冲区 B 也更小。</p>
<div class="language-c++ codeBlockContainer_MndA theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_WK21><pre tabindex=0 class="prism-code language-c++ codeBlock_Eu_S thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_OAXn><span class=token-line style=color:#393A34><span class="token plain">// attr [B] storage_scope = "global"</span><br></span><span class=token-line style=color:#393A34><span class="token plain">allocate B[float32 * 4]</span><br></span><span class=token-line style=color:#393A34><span class="token plain">produce C {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  for (ci, 0, 4) {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    produce B {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">      for (bj, 0, 4) {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">        B[bj] = (A[((ci*4) + bj)] + 2.000000f)</span><br></span><span class=token-line style=color:#393A34><span class="token plain">      }</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    }</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    for (cj, 0, 4) {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">      C[((ci*4) + cj)] = (B[cj]*3.000000f)</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    }</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  }</span><br></span><span class=token-line style=color:#393A34><span class="token plain">}</span><br></span></code></pre><div class=buttonGroup_zuHS><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_x9oo aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_K8Fc><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_AKIi><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>这个例子表明，与预期相反，split 并非只是抵消 fuse。那么造成这种差异的原因是什么？当一次实际上只需要一行时，为什么要重新计算整个张量 B 4 次？</p>
<p>InferBound 的任务是确定必须计算的 B 的数量。但是，在这种情况下，InferBound 为 B 的 root_iter_vars 返回的范围太大：对于 <code>bi</code> 和 <code>bj</code> 都是 <code>[0, 4]</code>。这是因为 PassUpDomain 对 Fuse 关系的限制，后续将进行详细解释。</p>
<p>当 InferRootBound 在 stage B 工作时，它会访问 B 的 consumer stage C，以了解 C 请求了多少 B。C 有 root_iter_vars ci 和 cj，已经融合并进行了分割。这导致了 stage C 的以下 <a href=https://tvm.apache.org/docs/arch/inferbound.html#itervarhypergraph target=_blank rel="noopener noreferrer">IterVar Hyper-graph</a>。</p>
<p><img decoding=async loading=lazy alt=图片 src=/docs/tvm-cn/assets/images/passupdomain_problem-4c0291fe8c0290694118945b20e06fce.png width=822 height=357 class=img_DHp8></p>
<p>在 stage B 上跟踪 InferRootBound 的执行。<a href=#phase1ca>阶段 1：为 InferRootBound 的 consumer leaf_iter_vars 初始化 IntSet</a> 涉及为 B 的 consumer stage C 的所有 leaf_iter_vars 设置 IntSet。在这种情况下，C 的 leaf_iter_vars 是 <code>ci.cj.fused.outer</code> 和 <code>ci.cj.fused.inner</code>。由于 B 附加在 <code>ci.cj.fused.outer</code> 处，因此 <code>ci.cj.fused.inner</code> 必须释放，但 <code>ci.cj.fused.outer</code> 是单点。 C 的 leaf_iter_vars 的 IntSet，在 <a href=#phase1ca>阶段 1：为 consumer leaf_iter_vars 初始化 IntSet</a> 之后，如下表所示。</p>
<table><thead><tr><th style=text-align:left><strong>IterVar</strong><th style=text-align:left><strong>IntSet****after Phase 1</strong><tbody><tr><td style=text-align:left>ci.cj.fused.inner<td style=text-align:left>[0, (min(4, (16 - (ci.cj.fused.outer*4))) - 1)]<tr><td style=text-align:left>ci.cj.fused.outer<td style=text-align:left>[ci.cj.fused.outer, ci.cj.fused.outer]</table>
<p>在 InferRootBound 的 <a href=#phase2ca>阶段 2：将 IntSet 从 consumer leaf 传到 consumer root</a> 中，以自下而上的顺序在所有 C 的 IterVarRelations 上调用 PassUpDomain。</p>
<p>PassUpDomain 首先在 C 的 Split 节点上调用。PassUpDomain 的案例 2 适用，因为 <code>ci.cj.fused.outer</code> 的 IntSet 只是一个点，并且不等于它的 Range（如先前在 stage C 上由 InferBound 计算的那样）。因此，PassUpDomain 根据 <code>ci.cj.fused.inner</code> 和 <code>ci.cj.fused.outer</code> 的 IntSet 设置 <code>ci.cj.fused</code> 的 IntSet，如下表第 3 行所示。</p>
<table><thead><tr><th style=text-align:left><strong>IterVar</strong><th style=text-align:left><strong>IntSet****after PassUpDomain on SplitNode</strong><tbody><tr><td style=text-align:left>ci.cj.fused.inner<td style=text-align:left>[0, (min(4, (16 - (ci.cj.fused.outer*4))) - 1)]<tr><td style=text-align:left>ci.cj.fused.outer<td style=text-align:left>[ci.cj.fused.outer, ci.cj.fused.outer]<tr><td style=text-align:left>ci.cj.fused<td style=text-align:left>[(ci.cj.fused.outer<em>4), ((ci.cj.fused.outer</em>4) + (min(4, (16 - (ci.cj.fused.outer*4))) - 1))]</table>
<p>在 Split 节点调用 PassUpDomain 后，在 Fuse 节点也进行调用。</p>
<ul>
<li>案例 1：IterVar<code>fused</code> 的 Range（如先前由 InferBound 计算的那样）等于其 IntSet</li>
<li>案例2：IterVar <code>fused</code> 的 IntSet 是单点</li>
<li>案例3：其他情况</li>
</ul>
<p>示例中，<code>ci.cj.fused</code> 的 Range 是 [0, 16)。不同于 <code>ci.cj.fused</code> 的 IntSet，其范围最多为 4（见上表第 3 行）。因此案例 1 不适用。案例 2 也不适用，因为 <code>ci.cj.fused</code> 的 IntSet 不是单点。因此，仅适用于默认案例 3。</p>
<p>在案例 3 中，PassUpDomain 保守地应用了「回退（fallback）推理规则」，即它只返回等于 <code>ci</code> 和 <code>cj</code> 的 Range 的 IntSet。由于 C 是 schedule 的输出 stage，InferBound 会将 C 的 root_iter_vars（即 <code>ci</code> 和 <code>cj</code>）的 Range 设置为它们的原始维度（即它们的 IterVars 的 <code>dom</code> 值）。<code>ci</code> 和 <code>cj</code> 的 PassUpDomain 的结果输出显示在下表的最后两行中。</p>
<table><thead><tr><th style=text-align:left><strong>IterVar</strong><th style=text-align:left><strong>IntSet****after PassUpDomain on FuseNode</strong><tbody><tr><td style=text-align:left>ci.cj.fused.inner<td style=text-align:left>[0, (min(4, (16 - (ci.cj.fused.outer*4))) - 1)]<tr><td style=text-align:left>ci.cj.fused.outer<td style=text-align:left>[ci.cj.fused.outer, ci.cj.fused.outer]<tr><td style=text-align:left>ci.cj.fused<td style=text-align:left>[(ci.cj.fused.outer<em>4), ((ci.cj.fused.outer</em>4) + (min(4, (16 - (ci.cj.fused.outer*4))) - 1))]<tr><td style=text-align:left>ci<td style=text-align:left>[0, 4]<tr><td style=text-align:left>cj<td style=text-align:left>[0, 4]</table>
<p>这足以保证 consumer C 请求 B 的<em>所有</em>元素：<code>ci</code> 和 <code>cj</code> 的 IntSet 成为 consumer C 对 stage B 输出张量的请求（通过 <a href=https://tvm.apache.org/docs/arch/inferbound.html#phase3 target=_blank rel="noopener noreferrer">阶段 3：将 IntSet 传到 consumer 的输入张量</a> 中的 PropBoundToInputs 和 <a href=https://tvm.apache.org/docs/arch/inferbound.html#phase4 target=_blank rel="noopener noreferrer">阶段 4：整合所有 consumer</a> 中的 GatherBound）。</p>
<p>此示例表明，包含融合轴拆分的 schedule 很难在 TVM 中处理。难度源自 GatherBound 的限制。consumer C 请求的张量 B 的区域必须是 B 的单个矩形区域。或者，若 B 有两个以上的维度，则 B 区域必须可表示为每个轴的独立 Range。</p>
<p>若 split 因子为 4 或 8，以上示例中，外循环每次迭代所需的 B 区域是矩形的。</p>
<p><img decoding=async loading=lazy alt=图片 src="data:image/png;base64,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" width=457 height=430 class=img_DHp8></p>
<p>但是，若上例中的拆分因子从 4 变为 3，则很容易看出，C 所需要的 B 区域无法继续通过其每个轴的独立 Range 来描述了。</p>
<p><img decoding=async loading=lazy alt=图片 src=/docs/tvm-cn/assets/images/passupdomain_nodiv-1ec93ad8efe97dca6a6f7ec23294785f.png width=438 height=404 class=img_DHp8></p>
<p>下图显示了矩形区域所能达到的最佳效果。橙色区域是在外循环的每次迭代中覆盖需要计算的 B 区域的最小矩形区域。</p>
<p><img decoding=async loading=lazy alt=图片 src=/docs/tvm-cn/assets/images/passupdomain_min-6dfebacc440ce95c0b4551c2a3b5632a.png width=438 height=425 class=img_DHp8></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class=col><a href=https://github.com/hyperai/tvm-cn/edit/master/docs/arch/arch/07-inferbound.md target=_blank rel="noopener noreferrer" class=theme-edit-this-page><svg fill=currentColor height=20 width=20 viewBox="0 0 40 40" class=iconEdit_OUzX aria-hidden=true><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"/></g></svg>编辑此页</a></div><div class="col lastUpdated_ccpN"><span class=theme-last-updated>最后<!-- -->由 <b>sparanoid</b> <!-- -->于 <b><time datetime=2025-04-15T11:50:10.000Z itemprop=dateModified>2025年4月15日</time></b> <!-- -->更新</span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label=文件选项卡><a class="pagination-nav__link pagination-nav__link--prev" href=/docs/tvm-cn/docs/arch/arch/pass_infra><div class=pagination-nav__sublabel>上一页</div><div class=pagination-nav__label>Pass Infrastructure</div></a><a class="pagination-nav__link pagination-nav__link--next" href=/docs/tvm-cn/docs/arch/arch/hybrid_script><div class=pagination-nav__sublabel>下一页</div><div class=pagination-nav__label>混合前端开发者指南</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_cD69 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href=#itervar-hyper-graph class="table-of-contents__link toc-highlight">IterVar Hyper-graph</a><li><a href=#passdowndomain class="table-of-contents__link toc-highlight">PassDownDomain</a><li><a href=#inferrootbound class="table-of-contents__link toc-highlight">InferRootBound</a><ul><li><a href=#intset class="table-of-contents__link toc-highlight">IntSet</a><li><a href=#阶段-1为-consumer-的-leaf_iter_vars-初始化-intset class="table-of-contents__link toc-highlight">阶段 1：为 consumer 的 leaf_iter_vars 初始化 IntSet</a><li><a href=#阶段-2将-intset-从-consumer-的-leaf-传到-consumer-的-root class="table-of-contents__link toc-highlight">阶段 2：将 IntSet 从 consumer 的 leaf 传到 consumer 的 root</a><li><a href=#阶段-3将-intset-传到-consumer-的输入张量 class="table-of-contents__link toc-highlight">阶段 3：将 IntSet 传到 consumer 的输入张量</a><li><a href=#阶段-4整合所有-consumer class="table-of-contents__link toc-highlight">阶段 4：整合所有 consumer</a></ul><li><a href=#inferbound-与-compute_at class="table-of-contents__link toc-highlight">InferBound 与 compute_at</a><ul><li><a href=#动机 class="table-of-contents__link toc-highlight">动机</a><li><a href=#附加路径 class="table-of-contents__link toc-highlight">附加路径</a><li><a href=#构建附加路径 class="table-of-contents__link toc-highlight">构建附加路径</a><li><a href=#inferbound-与-compute_at-1 class="table-of-contents__link toc-highlight">InferBound 与 compute_at</a><li><a href=#阶段-1为-consumer-的-leaf_iter_vars-初始化-intset-1 class="table-of-contents__link toc-highlight">阶段 1：为 consumer 的 leaf_iter_vars 初始化 IntSet</a><li><a href=#阶段-2将-intset-从-consumer-的-leaf-传到-consumer-的-root-1 class="table-of-contents__link toc-highlight">阶段 2：将 IntSet 从 consumer 的 leaf 传到 consumer 的 root</a><li><a href=#passupdomain-的限制 class="table-of-contents__link toc-highlight">PassUpDomain 的限制</a></ul></ul></div></div></div></div></main></div></div></div><footer class=footer><div class="container container-fluid"><div class="footer__bottom text--center"><div class=footer__copyright>© 2025 Apache Software Foundation and Hyper.AI for Chinese Simplified mirror</div></div></div></footer></div>