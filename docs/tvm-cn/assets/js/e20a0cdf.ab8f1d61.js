"use strict";(self.webpackChunktvm_cn=self.webpackChunktvm_cn||[]).push([["2901"],{68498:function(e,l,o){o.r(l),o.d(l,{default:()=>n,frontMatter:()=>d,metadata:()=>r,assets:()=>p,toc:()=>a,contentTitle:()=>_});var r=JSON.parse('{"id":"how_to/autoscheduler/autoschedule_custom","title":"\u4F7F\u7528\u81EA\u5B9A\u4E49\u8C03\u5EA6\u89C4\u5219\uFF08Sketch Rule\uFF09\u5728 CPU \u4E0A\u81EA\u52A8\u8C03\u5EA6\u7A00\u758F\u77E9\u9635\u4E58\u6CD5","description":"\u5355\u51FB \u6B64\u5904 \u4E0B\u8F7D\u5B8C\u6574\u7684\u793A\u4F8B\u4EE3\u7801","source":"@site/versioned_docs/version-0.12.0/how_to/autoscheduler/06-autoschedule_custom.md","sourceDirName":"how_to/autoscheduler","slug":"/how_to/autoscheduler/autoschedule_custom","permalink":"/docs/tvm-cn/docs/0.12.0/how_to/autoscheduler/autoschedule_custom","draft":false,"unlisted":false,"editUrl":"https://github.com/hyperai/tvm-cn/edit/master/versioned_docs/version-0.12.0/how_to/autoscheduler/06-autoschedule_custom.md","tags":[],"version":"0.12.0","lastUpdatedBy":"sparanoid","lastUpdatedAt":1744717810000,"sidebarPosition":6,"frontMatter":{"title":"\u4F7F\u7528\u81EA\u5B9A\u4E49\u8C03\u5EA6\u89C4\u5219\uFF08Sketch Rule\uFF09\u5728 CPU \u4E0A\u81EA\u52A8\u8C03\u5EA6\u7A00\u758F\u77E9\u9635\u4E58\u6CD5"},"sidebar":"tutorialSidebar","previous":{"title":"\u4E3A Mali GPU \u81EA\u52A8\u8C03\u5EA6\u795E\u7ECF\u7F51\u7EDC","permalink":"/docs/tvm-cn/docs/0.12.0/how_to/autoscheduler/autoschedule_mali"},"next":{"title":"\u4F7F\u7528 microTVM","permalink":"/docs/tvm-cn/docs/0.12.0/how_to/microtvm/"}}'),t=o("74132"),i=o("21494");let d={title:"\u4F7F\u7528\u81EA\u5B9A\u4E49\u8C03\u5EA6\u89C4\u5219\uFF08Sketch Rule\uFF09\u5728 CPU \u4E0A\u81EA\u52A8\u8C03\u5EA6\u7A00\u758F\u77E9\u9635\u4E58\u6CD5"},_="\u4F7F\u7528\u81EA\u5B9A\u4E49\u8C03\u5EA6\u89C4\u5219\uFF08Sketch Rule\uFF09\u5728 CPU \u4E0A\u81EA\u52A8\u8C03\u5EA6\u7A00\u758F\u77E9\u9635\u4E58\u6CD5",p={},a=[{value:"\u5B9A\u4E49\u8BA1\u7B97",id:"\u5B9A\u4E49\u8BA1\u7B97",level:2},{value:"\u7A00\u758F\u5DE5\u4F5C\u8D1F\u8F7D\uFF08sparse workload\uFF09\u7684\u7279\u6B8A\u6B65\u9AA4",id:"\u7A00\u758F\u5DE5\u4F5C\u8D1F\u8F7Dsparse-workload\u7684\u7279\u6B8A\u6B65\u9AA4",level:2},{value:"\u521B\u5EFA\u641C\u7D22\u4EFB\u52A1",id:"\u521B\u5EFA\u641C\u7D22\u4EFB\u52A1",level:2},{value:"\u4E3A\u7A00\u758F\u5BC6\u96C6\u7B97\u5B50\uFF08sparse dense op\uFF09\u7F16\u5199\u81EA\u5B9A\u4E49\u8349\u56FE\uFF08sketch\uFF09",id:"\u4E3A\u7A00\u758F\u5BC6\u96C6\u7B97\u5B50sparse-dense-op\u7F16\u5199\u81EA\u5B9A\u4E49\u8349\u56FEsketch",level:2},{value:"\u8FD0\u884C\u641C\u7D22",id:"\u8FD0\u884C\u641C\u7D22",level:2},{value:"\u68C0\u67E5\u6B63\u786E\u6027\u5E76\u8BC4\u4F30\u6027\u80FD",id:"\u68C0\u67E5\u6B63\u786E\u6027\u5E76\u8BC4\u4F30\u6027\u80FD",level:2}];function c(e){let l={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.a)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(l.header,{children:(0,t.jsx)(l.h1,{id:"\u4F7F\u7528\u81EA\u5B9A\u4E49\u8C03\u5EA6\u89C4\u5219sketch-rule\u5728-cpu-\u4E0A\u81EA\u52A8\u8C03\u5EA6\u7A00\u758F\u77E9\u9635\u4E58\u6CD5",children:"\u4F7F\u7528\u81EA\u5B9A\u4E49\u8C03\u5EA6\u89C4\u5219\uFF08Sketch Rule\uFF09\u5728 CPU \u4E0A\u81EA\u52A8\u8C03\u5EA6\u7A00\u758F\u77E9\u9635\u4E58\u6CD5"})}),"\n",(0,t.jsx)(l.admonition,{type:"note",children:(0,t.jsxs)(l.p,{children:["\u5355\u51FB ",(0,t.jsx)(l.a,{href:"https://tvm.apache.org/docs/how_to/tune_with_autoscheduler/tune_sparse_x86.html#sphx-glr-download-how-to-tune-with-autoscheduler-tune-sparse-x86-py",children:"\u6B64\u5904"})," \u4E0B\u8F7D\u5B8C\u6574\u7684\u793A\u4F8B\u4EE3\u7801"]})}),"\n",(0,t.jsxs)(l.p,{children:[(0,t.jsx)(l.strong,{children:"\u4F5C\u8005"}),"\uFF1A",(0,t.jsx)(l.a,{href:"https://github.com/jcf94/",children:"Chengfan Jia"})]}),"\n",(0,t.jsx)(l.p,{children:"\u672C\u6587\u4ECB\u7ECD\u5982\u4F55\u7528 auto-scheduler \u6765\u8C03\u4F18 CPU \u7684\u7A00\u758F\u77E9\u9635\u4E58\u6CD5\u3002"}),"\n",(0,t.jsx)(l.p,{children:"auto-scheduler \u65E8\u5728\u81EA\u52A8\u63A2\u7D22\u7ED9\u5B9A\u8BA1\u7B97\u58F0\u660E\u7684\u6700\u4F73\u6027\u80FD\u8C03\u5EA6\u3002\u6709\u65F6\u9700\u8981\u5C1D\u8BD5\u4E00\u4E9B\u7279\u6B8A\u7684\u64CD\u4F5C\uFF0Cauto-scheduler \u7684\u9ED8\u8BA4\u8C03\u5EA6\u89C4\u5219\uFF08Sketch Rule\uFF09\u53EF\u80FD\u4E0D\u80FD\u5F88\u597D\u7684\u652F\u6301\u8FD9\u4E9B\u64CD\u4F5C\uFF0C\u4F1A\u5BFC\u81F4\u6027\u80FD\u4E0D\u4F73\u3002auto-scheduler \u76EE\u524D\u5141\u8BB8\u7528\u6237\u63D0\u4F9B\u4E00\u4E2A CustomSketch \u6765\u8986\u76D6\u8FD9\u4E9B\u60C5\u51B5\u3002"}),"\n",(0,t.jsx)(l.p,{children:"\u672C\u6559\u7A0B\u4F7F\u7528\u7A00\u758F\u77E9\u9635\u4E58\u6CD5\u4F5C\u4E3A\u793A\u4F8B\uFF0C\u6F14\u793A\u5982\u4F55\u5B9E\u73B0\u81EA\u5B9A\u4E49\u8C03\u5EA6\u89C4\u5219\uFF0C\u5E76\u5C06\u5176\u63D2\u5165 auto-scheduler \u7684\u641C\u7D22\u7B56\u7565\u3002"}),"\n",(0,t.jsxs)(l.p,{children:["\u6CE8\u610F\uFF0C\u672C\u6559\u7A0B\u65E0\u6CD5\u5728 Windows \u6216\u6700\u65B0\u7248\u672C\u7684 macOS \u4E0A\u8FD0\u884C\u3002\u5982\u9700\u8FD0\u884C\uFF0C\u8BF7\u5C06\u672C\u6559\u7A0B\u7684\u4E3B\u4F53\u653E\u5728 ",(0,t.jsx)(l.code,{children:'if __name__ == "__main__":'})," \u4EE3\u7801\u5757\u4E2D\u3002"]}),"\n",(0,t.jsx)(l.pre,{children:(0,t.jsx)(l.code,{className:"language-python",children:"import os\nimport numpy as np\n\nimport tvm\nimport tvm.testing\nfrom tvm import te, auto_scheduler, runtime, topi\nfrom tvm.auto_scheduler import _ffi_api\nfrom tvm.topi.utils import get_const_tuple\nfrom tvm.topi.sparse.utils import random_bsr_matrix\n"})}),"\n",(0,t.jsx)(l.h2,{id:"\u5B9A\u4E49\u8BA1\u7B97",children:"\u5B9A\u4E49\u8BA1\u7B97"}),"\n",(0,t.jsx)(l.p,{children:"\u9996\u5148\u7528\u51E0\u4E2A relu \u548C bias \u76F8\u52A0\u6765\u5B9A\u4E49\u4E00\u4E2A\u7A00\u758F matmul \u7684\u8BA1\u7B97\uFF0C\u8BE5\u51FD\u6570\u8FD4\u56DE\u8F93\u5165/\u8F93\u51FA\u5F20\u91CF\u5217\u8868\uFF0Cauto-scheduler \u53EF\u4EE5\u4ECE\u8FD9\u4E9B\u5F20\u91CF\u4E2D\u5F97\u5230\u6574\u4E2A\u8BA1\u7B97\u56FE\u3002"}),"\n",(0,t.jsx)(l.pre,{children:(0,t.jsx)(l.code,{className:"language-python",children:'@auto_scheduler.register_workload\ndef sparse_dense(M, N, K, w_data_shape, w_indices_shape, w_indptr_shape, dtype):\n    X = te.placeholder(shape=(M, K), dtype=dtype)\n    W_data = te.placeholder(shape=w_data_shape, dtype=dtype)\n    W_indices = te.placeholder(shape=w_indices_shape, dtype="int32")\n    W_indptr = te.placeholder(shape=w_indptr_shape, dtype="int32")\n    B = te.placeholder(shape=(M, N), dtype=dtype)\n\n    out = topi.nn.sparse_dense(topi.nn.relu(X), W_data, W_indices, W_indptr)\n    out = te.compute((M, N), lambda i, j: out[i, j] + B[i, j], name="BiasAdd")\n    out = topi.nn.relu(out)\n\n    return [X, W_data, W_indices, W_indptr, B, out]\n'})}),"\n",(0,t.jsx)(l.h2,{id:"\u7A00\u758F\u5DE5\u4F5C\u8D1F\u8F7Dsparse-workload\u7684\u7279\u6B8A\u6B65\u9AA4",children:"\u7A00\u758F\u5DE5\u4F5C\u8D1F\u8F7D\uFF08sparse workload\uFF09\u7684\u7279\u6B8A\u6B65\u9AA4"}),"\n",(0,t.jsx)(l.p,{children:"\u5728\u8C03\u5EA6\u8C03\u4F18\u671F\u95F4\uFF0Cauto-scheduler \u4F7F\u7528\u968F\u673A\u8F93\u5165\u6765\u6D4B\u8BD5\u751F\u6210\u7684\u8C03\u5EA6\u7684\u6027\u80FD\u3002\u867D\u7136\u4E0D\u80FD\u76F4\u63A5\u4F7F\u7528\u968F\u673A\u6570\u7EC4\u4F5C\u4E3A\u7A00\u758F\u8FD0\u7B97\u7684\u8F93\u5165\uFF0C\u4F46\u300Cindices\u300D\u548C\u300Cindptr\u300D\u6570\u7EC4\u5BF9\u4E8E\u8BA1\u7B97\u5F88\u6709\u7528\u3002"}),"\n",(0,t.jsxs)(l.p,{children:["\u4E3A\u89E3\u51B3\u8FD9\u4E2A\u95EE\u9898\uFF0C\u5C06\u5B83\u4EEC\u6CE8\u518C\u4E3A\u7279\u6B8A\u7684 buffer\uFF0C\u7136\u540E\u5728\u6D4B\u8BD5\u7A0B\u5E8F\u65F6\u52A0\u8F7D\u3002\u66F4\u591A\u8BE6\u7EC6\u4FE1\u606F\uFF0C\u53C2\u9605 ",(0,t.jsx)(l.em,{children:"tvm.auto_scheduler.measure.py"})," \u3002"]}),"\n",(0,t.jsx)(l.pre,{children:(0,t.jsx)(l.code,{className:"language-python",children:'# \u5B9A\u4E49\u7A00\u758F\u8BA1\u7B97\u7684\u57FA\u672C shape\nM = 128\nK = 256\nN = 512\nBS_R = 16\nBS_C = 1\ndensity = 0.6\n\n# \u7528 numpy \u751F\u6210\u6D4B\u8BD5\u6570\u636E\nX_np = np.random.randn(M, K).astype("float32")\nX_np = np.maximum(np.zeros((M, K), dtype="float32"), X_np)  # Relu\nW_sp_np = random_bsr_matrix(N, K, BS_R, BS_C, density=density, dtype="float32")\nW_np = W_sp_np.todense()\nY_np = X_np @ W_np.T  # \u5904\u7406\u77E9\u9635\u4E58\u6CD5\nB_np = np.random.randn(M, N).astype("float32")\nY_np = Y_np + B_np  # Bias add\nY_np = np.maximum(np.zeros((M, N), dtype="float32"), Y_np)  # Relu\n'})}),"\n",(0,t.jsx)(l.h2,{id:"\u521B\u5EFA\u641C\u7D22\u4EFB\u52A1",children:"\u521B\u5EFA\u641C\u7D22\u4EFB\u52A1"}),"\n",(0,t.jsx)(l.p,{children:"\u63A5\u4E0B\u6765\u521B\u5EFA\u4E00\u4E2A\u641C\u7D22\u4EFB\u52A1 M=N=K=512\uFF0Cdtype=\u300Cfloat32\u300D\u3002\u5982\u679C\u4F60\u7684\u673A\u5668\u652F\u6301 avx \u6307\u4EE4\uFF0C\u4F60\u53EF\u4EE5\uFF1A"}),"\n",(0,t.jsxs)(l.ul,{children:["\n",(0,t.jsx)(l.li,{children:"\u5C06\u4E0B\u9762\u7684\u300Cllvm\u300D\u66FF\u6362\u4E3A\u300Cllvm -mcpu=core-avx2\u300D\u6765\u542F\u7528 AVX2"}),"\n",(0,t.jsx)(l.li,{children:"\u5C06\u4E0B\u9762\u7684\u300Cllvm\u300D\u66FF\u6362\u4E3A\u300Cllvm -mcpu=skylake-avx512\u300D\u6765\u542F\u7528 AVX-512"}),"\n"]}),"\n",(0,t.jsx)(l.pre,{children:(0,t.jsx)(l.code,{className:"language-python",children:'target = tvm.target.Target("llvm")\n\n# \u5C06\u7A00\u758F\u6570\u636E\u6CE8\u518C\u5230\u4EFB\u52A1\u8F93\u5165\nprefix = "sparse_dense_bsr_%d_%d_%d_%d_%d_%d_" % (\n    N,\n    K,\n    BS_R,\n    BS_C,\n    W_sp_np.indices.shape[0],\n    W_sp_np.indptr.shape[0],\n)\ntask = tvm.auto_scheduler.SearchTask(\n    func=sparse_dense,\n    args=(M, N, K, W_sp_np.data.shape, W_sp_np.indices.shape, W_sp_np.indptr.shape, "float32"),\n    target=target,\n    task_inputs={\n        prefix + "W_data": runtime.ndarray.array(W_sp_np.data),\n        prefix + "W_indices": runtime.ndarray.array(W_sp_np.indices),\n        prefix + "W_indptr": runtime.ndarray.array(W_sp_np.indptr),\n    },\n    task_inputs_save_to_file=True,\n)\n\n# \u68C0\u67E5\u8BA1\u7B97\u56FE\nprint("Computational DAG:")\nprint(task.compute_dag)\n'})}),"\n",(0,t.jsx)(l.p,{children:"\u8F93\u51FA\u7ED3\u679C\uFF1A"}),"\n",(0,t.jsx)(l.pre,{children:(0,t.jsx)(l.code,{className:"language-bash",children:"Computational DAG:\nplaceholder = PLACEHOLDER [33]\nplaceholder = PLACEHOLDER [4916, 16, 1]\nplaceholder = PLACEHOLDER [4916]\nplaceholder = PLACEHOLDER [128, 256]\ncompute(i0, i1) = max(placeholder[i0, i1], 0f)\ncompute(i, nb_j, j) += (placeholder[(placeholder[nb_j] + elem_idx), j, c]*compute[i, (placeholder[(placeholder[nb_j] + elem_idx)] + c)])\ncompute(m, n) = compute[m, floordiv(n, 16), floormod(n, 16)]\nplaceholder = PLACEHOLDER [128, 512]\nBiasAdd(i, j) = (compute[i, j] + placeholder[i, j])\ncompute(i0, i1) = max(BiasAdd[i0, i1], 0f)\n"})}),"\n",(0,t.jsx)(l.h2,{id:"\u4E3A\u7A00\u758F\u5BC6\u96C6\u7B97\u5B50sparse-dense-op\u7F16\u5199\u81EA\u5B9A\u4E49\u8349\u56FEsketch",children:"\u4E3A\u7A00\u758F\u5BC6\u96C6\u7B97\u5B50\uFF08sparse dense op\uFF09\u7F16\u5199\u81EA\u5B9A\u4E49\u8349\u56FE\uFF08sketch\uFF09"}),"\n",(0,t.jsx)(l.p,{children:"\u5728\u8C03\u4F18\u4E4B\u524D\uFF0C\u9700\u8981\u4E3A\u7A00\u758F\u5BC6\u96C6\u64CD\u4F5C\u5B9A\u4E49 CustomSketchRule\u3002"}),"\n",(0,t.jsx)(l.p,{children:"CustomSketchRule \u7531\u4E24\u90E8\u5206\u7EC4\u6210\uFF1A\u6761\u4EF6\u51FD\u6570\u548C\u5E94\u7528\u51FD\u6570\u3002"}),"\n",(0,t.jsxs)(l.ul,{children:["\n",(0,t.jsx)(l.li,{children:"\u6761\u4EF6\u51FD\u6570\uFF1A\u63CF\u8FF0\u5E94\u7528\u6B64\u8C03\u5EA6\u89C4\u5219\u7684\u65F6\u95F4\u3002\u4F8B\u5982\uFF0C\u901A\u8FC7\u5339\u914D\u540D\u79F0\u548C\u6807\u7B7E\u5C06\u89C4\u5219\u5E94\u7528\u4E8E\u7A00\u758F\u64CD\u4F5C\u3002"}),"\n",(0,t.jsx)(l.li,{children:"\u5E94\u7528\u51FD\u6570\uFF1A\u63CF\u8FF0\u751F\u6210\u521D\u59CB\u8349\u56FE\u7684\u65B9\u5F0F\u3002\u53EF\u4EE5\u7528 auto-scheduler \u63D0\u4F9B\u7684\u5FAA\u73AF\u72B6\u6001 API \u6765\u5B9E\u73B0\u3002"}),"\n"]}),"\n",(0,t.jsx)(l.pre,{children:(0,t.jsx)(l.code,{className:"language-python",children:'def meet_condition_func(search_policy, state, stage_id):\n    state = auto_scheduler.loop_state.State(state, search_policy.search_task.compute_dag)\n    if state.stages[stage_id].op.tag in [\n        "sparse_dense_sp_rhs_bsrmm",\n        "sparse_dense_sp_rhs_bsrmm_block",\n    ]:\n        return auto_scheduler.PreloadCustomSketchRule.APPLY_AND_SKIP_REST\n    else:\n        return auto_scheduler.PreloadCustomSketchRule.PASS\n\ndef apply_func(search_policy, state, stage_id):\n    ret = []\n    s0 = auto_scheduler.loop_state.State(state, search_policy.search_task.compute_dag)\n    if s0.stages[stage_id].op.tag == "sparse_dense_sp_rhs_bsrmm_block":\n        return [s0.state_object, stage_id - 1]\n\n    sparse_dense = s0.stages[stage_id].op\n    sparse_dense_block = s0.stages[stage_id - 1].op\n    assert sparse_dense.tag == "sparse_dense_sp_rhs_bsrmm"\n    assert sparse_dense_block.tag == "sparse_dense_sp_rhs_bsrmm_block"\n\n    # \u8BBE\u7F6E\u8BA1\u7B97\u5757\u7684\u9ED8\u8BA4\u6D88\u8D39\u8005\n    consumer = sparse_dense\n\n    # \u82E5\u7A00\u758F\u5BC6\u96C6\u6709\u5355\u4E2A\u5143\u7D20\u6D88\u8D39\u8005\n    # \u53EF\u4EE5\u8BA1\u7B97\u5185\u8054\u7A00\u758F\u5BC6\u96C6\u8F93\u51FA\u9636\u6BB5\n    consumers = _ffi_api.SearchPolicyUtilsGetConsumers(\n        search_policy.search_task, s0.state_object, stage_id\n    )\n    if len(consumers) == 1:\n        consumer_id = int(consumers.items()[0][0])\n        if _ffi_api.SearchPolicyUtilsIsElementwiseMatch(\n            search_policy.search_task, s0.state_object, stage_id, consumer_id\n        ):\n            consumer = s0.stages[consumer_id].op\n            s0.compute_inline(sparse_dense)\n\n    i, nb_j, j, row_offset, c = s0[sparse_dense_block].iters\n    m, n = s0[consumer].iters\n    i0, i1, i2 = s0.split(sparse_dense_block, i, [None, None])\n    m0, m1 = s0.follow_split(consumer, m, len(s0.transform_steps) - 1, 1)\n    j0, j1 = s0.split(sparse_dense_block, nb_j, [None])\n    n0, n1 = s0.follow_split(consumer, n, len(s0.transform_steps) - 1, 1)\n    s0.reorder(sparse_dense_block, [i0, j0, i1, j1, row_offset, i2, j, c])\n    s0.reorder(consumer, [m0, n0, m1, n1])\n    s0.compute_at(sparse_dense_block, consumer, n0)\n\n    ret.append([s0.state_object, stage_id - 2])\n\n    return ret\n'})}),"\n",(0,t.jsx)(l.p,{children:"\u63A5\u4E0B\u6765\uFF0C\u4E3A\u63D2\u5165\u81EA\u5B9A\u4E49\u8349\u56FE\u7684 auto-scheduler \u8BBE\u7F6E\u53C2\u6570\u3002"}),"\n",(0,t.jsxs)(l.ul,{children:["\n",(0,t.jsxs)(l.li,{children:[(0,t.jsx)(l.code,{children:"num_measure_trials"})," \u662F\u641C\u7D22\u8FC7\u7A0B\u4E2D\u53EF\u4EE5\u4F7F\u7528\u7684\u6D4B\u8BD5\u6B21\u6570\uFF08\u6839\u636E\u81EA\u5DF1\u7684\u65F6\u95F4\u9884\u7B97\u8C03\u6574\u8FD9\u4E2A\u53C2\u6570\uFF09\uFF0C\u4E3A\u5FEB\u901F\u6F14\u793A\uFF0C\u672C\u6559\u7A0B\u53EA\u8FDB\u884C\u4E86 10 \u6B21\u8BD5\u9A8C\u3002\u5728\u5B9E\u8DF5\u4E2D\uFF0C\u63A8\u8350\u4F7F\u7528 1000 \u4EE5\u5F97\u5230\u6536\u655B\u7ED3\u679C\u3002"]}),"\n",(0,t.jsxs)(l.li,{children:["\u6B64\u5916\uFF0C\u4F7F\u7528 ",(0,t.jsx)(l.code,{children:"RecordToFile"})," \u5C06\u6D4B\u8BD5\u8BB0\u5F55\u8F6C\u50A8\u5230 ",(0,t.jsx)(l.em,{children:"sparse_dense.json"})," \u6587\u4EF6\u4E2D\uFF0C\u6D4B\u8BD5\u8BB0\u5F55\u53EF\u7528\u4E8E\u67E5\u8BE2\u5386\u53F2\u6700\u4F73\u3001\u6062\u590D\u641C\u7D22\u4EE5\u53CA\u4EE5\u540E\u8FDB\u884C\u66F4\u591A\u5206\u6790\u3002"]}),"\n",(0,t.jsxs)(l.li,{children:["\u6709\u5173\u66F4\u591A\u53C2\u6570\uFF0C\u53C2\u89C1 ",(0,t.jsx)(l.code,{children:"auto_scheduler.TuningOptions"})]}),"\n",(0,t.jsxs)(l.li,{children:["\u63A5\u4E0B\u6765\u521B\u5EFA\u4E00\u4E2A ",(0,t.jsx)(l.code,{children:"auto_scheduler.SketchPolicy"})," \u5BF9\u8C61\uFF0C\u5E76\u5C06\u81EA\u5B9A\u4E49\u8C03\u5EA6\u89C4\u5219\u6DFB\u52A0\u4E3A ",(0,t.jsx)(l.em,{children:"init_search_callbacks"}),"\u3002"]}),"\n"]}),"\n",(0,t.jsx)(l.pre,{children:(0,t.jsx)(l.code,{className:"language-python",children:'log_file = "sparse_dense.json"\ntune_option = auto_scheduler.TuningOptions(\n    num_measure_trials=10,\n    measure_callbacks=[auto_scheduler.RecordToFile(log_file)],\n    verbose=2,\n)\n\nsearch_policy = auto_scheduler.SketchPolicy(\n    task,\n    program_cost_model=auto_scheduler.XGBModel(),\n    init_search_callbacks=[\n        auto_scheduler.PreloadCustomSketchRule(meet_condition_func, apply_func, "SparseDense")\n    ],\n)\n'})}),"\n",(0,t.jsx)(l.h2,{id:"\u8FD0\u884C\u641C\u7D22",children:"\u8FD0\u884C\u641C\u7D22"}),"\n",(0,t.jsx)(l.p,{children:"\u73B0\u5728\u5DF2\u7ECF\u51C6\u5907\u597D\u6240\u6709\u7684\u8F93\u5165\u3002\u63A5\u4E0B\u6765\u5F00\u59CB\u641C\u7D22\uFF0C\u7ECF\u8FC7\u4E00\u4E9B\u6D4B\u8BD5\u540E\uFF0C\u53EF\u4EE5\u4ECE\u65E5\u5FD7\u6587\u4EF6\u4E2D\u52A0\u8F7D\u6700\u4F73\u8C03\u5EA6\u5E76\u5E94\u7528\u3002"}),"\n",(0,t.jsx)(l.pre,{children:(0,t.jsx)(l.code,{className:"language-python",children:"# \u8FD0\u884C\u81EA\u52A8\u8C03\u4F18\uFF08\u641C\u7D22\uFF09\n# \u6CE8\u610F\uFF1A\u4E0D\u5728\u7F51\u9875\u670D\u52A1\u5668\u4E2D\u8FD0\u884C\u8C03\u4F18\uFF0C\u56E0\u4E3A\u5B83\u9700\u8981\u7684\u65F6\u95F4\u592A\u957F\u3002\n# \u53D6\u6D88\u4EE5\u4E0B\u884C\u7684\u6CE8\u91CA\uFF0C\u6765\u8FD0\u884C\u5B83\u3002\ntask.tune(tune_option, search_policy)\n\n# \u5E94\u7528\u6700\u4F73 schedule\nsch, args = task.apply_best(log_file)\n"})}),"\n",(0,t.jsx)(l.p,{children:"\u8F93\u51FA\u7ED3\u679C\uFF1A"}),"\n",(0,t.jsx)(l.pre,{children:(0,t.jsx)(l.code,{className:"language-bash",children:"/usr/local/lib/python3.7/dist-packages/numpy/core/_methods.py:43: RuntimeWarning: invalid value encountered in reduce\n  return umr_minimum(a, axis, None, out, keepdims, initial, where)\n/usr/local/lib/python3.7/dist-packages/numpy/core/_methods.py:39: RuntimeWarning: invalid value encountered in reduce\n  return umr_maximum(a, axis, None, out, keepdims, initial, where)\n"})}),"\n",(0,t.jsx)(l.p,{children:"\u81EA\u52A8\u8C03\u5EA6\u540E\u5BF9 schedule \u964D\u7EA7\uFF0C\u6765\u67E5\u770B IR\u3002auto-scheduler \u6B63\u786E\u6267\u884C\u4F18\u5316\uFF0C\u5305\u62EC\u591A\u7EA7\u5E73\u94FA\u3001\u5E03\u5C40\u8F6C\u6362\u3001\u5E76\u884C\u5316\u3001\u5411\u91CF\u5316\u3001\u5C55\u5F00\u548C\u7B97\u5B50\u878D\u5408\u3002"}),"\n",(0,t.jsx)(l.pre,{children:(0,t.jsx)(l.code,{className:"language-python",children:'print("Lowered TIR:")\nprint(tvm.lower(sch, args, simple_mode=True))\n'})}),"\n",(0,t.jsx)(l.p,{children:"\u8F93\u51FA\u7ED3\u679C\uFF1A"}),"\n",(0,t.jsx)(l.pre,{children:(0,t.jsx)(l.code,{className:"language-bash",children:'Lowered TIR:\n@main = primfn(placeholder_5: handle, placeholder_6: handle, placeholder_7: handle, placeholder_8: handle, placeholder_9: handle, compute_1: handle) -> ()\n  attr = {"from_legacy_te_schedule": True, "global_symbol": "main", "tir.noalias": True}\n  buffers = {placeholder: Buffer(placeholder_10: Pointer(float32), float32, [32768], []),\n             placeholder_1: Buffer(placeholder_11: Pointer(float32), float32, [78656], []),\n             placeholder_2: Buffer(placeholder_12: Pointer(int32), int32, [4916], []),\n             placeholder_3: Buffer(placeholder_13: Pointer(int32), int32, [33], []),\n             placeholder_4: Buffer(placeholder_14: Pointer(float32), float32, [65536], []),\n             compute: Buffer(compute_2: Pointer(float32), float32, [65536], [])}\n  buffer_map = {placeholder_5: placeholder, placeholder_6: placeholder_1, placeholder_7: placeholder_2, placeholder_8: placeholder_3, placeholder_9: placeholder_4, compute_1: compute}\n  preflattened_buffer_map = {placeholder_5: placeholder_15: Buffer(placeholder_10, float32, [128, 256], []), compute_1: compute_3: Buffer(compute_2, float32, [128, 512], []), placeholder_9: placeholder_16: Buffer(placeholder_14, float32, [128, 512], []), placeholder_7: placeholder_17: Buffer(placeholder_12, int32, [4916], []), placeholder_6: placeholder_18: Buffer(placeholder_11, float32, [4916, 16, 1], []), placeholder_8: placeholder_19: Buffer(placeholder_13, int32, [33], [])} {\n  for (i0.outer: int32, 0, 32) "parallel" {\n    allocate(compute_4: Pointer(global float32), float32, [64]), storage_scope = global;\n    for (i1.outer: int32, 0, 32) {\n      compute_5: Buffer(compute_4, float32, [64], [])[0] = 0f32\n      compute_5[1] = 0f32\n      compute_5[2] = 0f32\n      compute_5[3] = 0f32\n      compute_5[4] = 0f32\n      compute_5[5] = 0f32\n      compute_5[6] = 0f32\n      compute_5[7] = 0f32\n      compute_5[8] = 0f32\n      compute_5[9] = 0f32\n      compute_5[10] = 0f32\n      compute_5[11] = 0f32\n      compute_5[12] = 0f32\n      compute_5[13] = 0f32\n      compute_5[14] = 0f32\n      compute_5[15] = 0f32\n      compute_5[16] = 0f32\n      compute_5[17] = 0f32\n      compute_5[18] = 0f32\n      compute_5[19] = 0f32\n      compute_5[20] = 0f32\n      compute_5[21] = 0f32\n      compute_5[22] = 0f32\n      compute_5[23] = 0f32\n      compute_5[24] = 0f32\n      compute_5[25] = 0f32\n      compute_5[26] = 0f32\n      compute_5[27] = 0f32\n      compute_5[28] = 0f32\n      compute_5[29] = 0f32\n      compute_5[30] = 0f32\n      compute_5[31] = 0f32\n      compute_5[32] = 0f32\n      compute_5[33] = 0f32\n      compute_5[34] = 0f32\n      compute_5[35] = 0f32\n      compute_5[36] = 0f32\n      compute_5[37] = 0f32\n      compute_5[38] = 0f32\n      compute_5[39] = 0f32\n      compute_5[40] = 0f32\n      compute_5[41] = 0f32\n      compute_5[42] = 0f32\n      compute_5[43] = 0f32\n      compute_5[44] = 0f32\n      compute_5[45] = 0f32\n      compute_5[46] = 0f32\n      compute_5[47] = 0f32\n      compute_5[48] = 0f32\n      compute_5[49] = 0f32\n      compute_5[50] = 0f32\n      compute_5[51] = 0f32\n      compute_5[52] = 0f32\n      compute_5[53] = 0f32\n      compute_5[54] = 0f32\n      compute_5[55] = 0f32\n      compute_5[56] = 0f32\n      compute_5[57] = 0f32\n      compute_5[58] = 0f32\n      compute_5[59] = 0f32\n      compute_5[60] = 0f32\n      compute_5[61] = 0f32\n      compute_5[62] = 0f32\n      compute_5[63] = 0f32\n      for (elem_idx: int32, 0, (placeholder_3[(i1.outer + 1)] - placeholder_3[i1.outer])) {\n        if @tir.likely((elem_idx < (placeholder_3[(i1.outer + 1)] - placeholder_3[i1.outer])), dtype=bool) {\n          compute_5[0] = (compute_5[0] + (placeholder_1[((placeholder_3[i1.outer]*16) + (elem_idx*16))]*max(placeholder[((i0.outer*1024) + placeholder_2[(placeholder_3[i1.outer] + elem_idx)])], 0f32)))\n        }\n        if @tir.likely((elem_idx < (placeholder_3[(i1.outer + 1)] - placeholder_3[i1.outer])), dtype=bool) {\n          compute_5[1] = (compute_5[1] + (placeholder_1[(((placeholder_3[i1.outer]*16) + (elem_idx*16)) + 1)]*max(placeholder[((i0.outer*1024) + placeholder_2[(placeholder_3[i1.outer] + elem_idx)])], 0f32)))\n        }\n        if @tir.likely((elem_idx < (placeholder_3[(i1.outer + 1)] - placeholder_3[i1.outer])), dtype=bool) {\n          compute_5[2] = (compute_5[2] + (placeholder_1[(((placeholder_3[i1.outer]*16) + (elem_idx*16)) + 2)]*max(placeholder[((i0.outer*1024) + placeholder_2[(placeholder_3[i1.outer] + elem_idx)])], 0f32)))\n        }\n        if @tir.likely((elem_idx < (placeholder_3[(i1.outer + 1)] - placeholder_3[i1.outer])), dtype=bool) {\n          compute_5[3] = (compute_5[3] + (placeholder_1[(((placeholder_3[i1.outer]*16) + (elem_idx*16)) + 3)]*max(placeholder[((i0.outer*1024) + placeholder_2[(placeholder_3[i1.outer] + elem_idx)])], 0f32)))\n        }\n        if @tir.likely((elem_idx < (placeholder_3[(i1.outer + 1)] - placeholder_3[i1.outer])), dtype=bool) {\n          compute_5[4] = (compute_5[4] + (placeholder_1[(((placeholder_3[i1.outer]*16) + (elem_idx*16)) + 4)]*max(placeholder[((i0.outer*1024) + placeholder_2[(placeholder_3[i1.outer] + elem_idx)])], 0f32)))\n        }\n        if @tir.likely((elem_idx < (placeholder_3[(i1.outer + 1)] - placeholder_3[i1.outer])), dtype=bool) {\n          compute_5[5] = (compute_5[5] + (placeholder_1[(((placeholder_3[i1.outer]*16) + (elem_idx*16)) + 5)]*max(placeholder[((i0.outer*1024) + placeholder_2[(placeholder_3[i1.outer] + elem_idx)])], 0f32)))\n        }\n        if @tir.likely((elem_idx < (placeholder_3[(i1.outer + 1)] - placeholder_3[i1.outer])), dtype=bool) {\n          compute_5[6] = (compute_5[6] + (placeholder_1[(((placeholder_3[i1.outer]*16) + (elem_idx*16)) + 6)]*max(placeholder[((i0.outer*1024) + placeholder_2[(placeholder_3[i1.outer] + elem_idx)])], 0f32)))\n        }\n        if @tir.likely((elem_idx < (placeholder_3[(i1.outer + 1)] - placeholder_3[i1.outer])), dtype=bool) {\n          compute_5[7] = (compute_5[7] + (placeholder_1[(((placeholder_3[i1.outer]*16) + (elem_idx*16)) + 7)]*max(placeholder[((i0.outer*1024) + placeholder_2[(placeholder_3[i1.outer] + elem_idx)])], 0f32)))\n        }\n        if @tir.likely((elem_idx < (placeholder_3[(i1.outer + 1)] - placeholder_3[i1.outer])), dtype=bool) {\n          compute_5[8] = (compute_5[8] + (placeholder_1[(((placeholder_3[i1.outer]*16) + (elem_idx*16)) + 8)]*max(placeholder[((i0.outer*1024) + placeholder_2[(placeholder_3[i1.outer] + elem_idx)])], 0f32)))\n        }\n        if @tir.likely((elem_idx < (placeholder_3[(i1.outer + 1)] - placeholder_3[i1.outer])), dtype=bool) {\n          compute_5[9] = (compute_5[9] + (placeholder_1[(((placeholder_3[i1.outer]*16) + (elem_idx*16)) + 9)]*max(placeholder[((i0.outer*1024) + placeholder_2[(placeholder_3[i1.outer] + elem_idx)])], 0f32)))\n        }\n        if @tir.likely((elem_idx < (placeholder_3[(i1.outer + 1)] - placeholder_3[i1.outer])), dtype=bool) {\n          compute_5[10] = (compute_5[10] + (placeholder_1[(((placeholder_3[i1.outer]*16) + (elem_idx*16)) + 10)]*max(placeholder[((i0.outer*1024) + placeholder_2[(placeholder_3[i1.outer] + elem_idx)])], 0f32)))\n        }\n        if @tir.likely((elem_idx < (placeholder_3[(i1.outer + 1)] - placeholder_3[i1.outer])), dtype=bool) {\n          compute_5[11] = (compute_5[11] + (placeholder_1[(((placeholder_3[i1.outer]*16) + (elem_idx*16)) + 11)]*max(placeholder[((i0.outer*1024) + placeholder_2[(placeholder_3[i1.outer] + elem_idx)])], 0f32)))\n        }\n        if @tir.likely((elem_idx < (placeholder_3[(i1.outer + 1)] - placeholder_3[i1.outer])), dtype=bool) {\n          compute_5[12] = (compute_5[12] + (placeholder_1[(((placeholder_3[i1.outer]*16) + (elem_idx*16)) + 12)]*max(placeholder[((i0.outer*1024) + placeholder_2[(placeholder_3[i1.outer] + elem_idx)])], 0f32)))\n        }\n        if @tir.likely((elem_idx < (placeholder_3[(i1.outer + 1)] - placeholder_3[i1.outer])), dtype=bool) {\n          compute_5[13] = (compute_5[13] + (placeholder_1[(((placeholder_3[i1.outer]*16) + (elem_idx*16)) + 13)]*max(placeholder[((i0.outer*1024) + placeholder_2[(placeholder_3[i1.outer] + elem_idx)])], 0f32)))\n        }\n        if @tir.likely((elem_idx < (placeholder_3[(i1.outer + 1)] - placeholder_3[i1.outer])), dtype=bool) {\n          compute_5[14] = (compute_5[14] + (placeholder_1[(((placeholder_3[i1.outer]*16) + (elem_idx*16)) + 14)]*max(placeholder[((i0.outer*1024) + placeholder_2[(placeholder_3[i1.outer] + elem_idx)])], 0f32)))\n        }\n        if @tir.likely((elem_idx < (placeholder_3[(i1.outer + 1)] - placeholder_3[i1.outer])), dtype=bool) {\n          compute_5[15] = (compute_5[15] + (placeholder_1[(((placeholder_3[i1.outer]*16) + (elem_idx*16)) + 15)]*max(placeholder[((i0.outer*1024) + placeholder_2[(placeholder_3[i1.outer] + elem_idx)])], 0f32)))\n        }\n        if @tir.likely((elem_idx < (placeholder_3[(i1.outer + 1)] - placeholder_3[i1.outer])), dtype=bool) {\n          compute_5[16] = (compute_5[16] + (placeholder_1[((placeholder_3[i1.outer]*16) + (elem_idx*16))]*max(placeholder[(((i0.outer*1024) + placeholder_2[(placeholder_3[i1.outer] + elem_idx)]) + 256)], 0f32)))\n        }\n        if @tir.likely((elem_idx < (placeholder_3[(i1.outer + 1)] - placeholder_3[i1.outer])), dtype=bool) {\n          compute_5[17] = (compute_5[17] + (placeholder_1[(((placeholder_3[i1.outer]*16) + (elem_idx*16)) + 1)]*max(placeholder[(((i0.outer*1024) + placeholder_2[(placeholder_3[i1.outer] + elem_idx)]) + 256)], 0f32)))\n        }\n        if @tir.likely((elem_idx < (placeholder_3[(i1.outer + 1)] - placeholder_3[i1.outer])), dtype=bool) {\n          compute_5[18] = (compute_5[18] + (placeholder_1[(((placeholder_3[i1.outer]*16) + (elem_idx*16)) + 2)]*max(placeholder[(((i0.outer*1024) + placeholder_2[(placeholder_3[i1.outer] + elem_idx)]) + 256)], 0f32)))\n        }\n        if @tir.likely((elem_idx < (placeholder_3[(i1.outer + 1)] - placeholder_3[i1.outer])), dtype=bool) {\n          compute_5[19] = (compute_5[19] + (placeholder_1[(((placeholder_3[i1.outer]*16) + (elem_idx*16)) + 3)]*max(placeholder[(((i0.outer*1024) + placeholder_2[(placeholder_3[i1.outer] + elem_idx)]) + 256)], 0f32)))\n        }\n        if @tir.likely((elem_idx < (placeholder_3[(i1.outer + 1)] - placeholder_3[i1.outer])), dtype=bool) {\n          compute_5[20] = (compute_5[20] + (placeholder_1[(((placeholder_3[i1.outer]*16) + (elem_idx*16)) + 4)]*max(placeholder[(((i0.outer*1024) + placeholder_2[(placeholder_3[i1.outer] + elem_idx)]) + 256)], 0f32)))\n        }\n        if @tir.likely((elem_idx < (placeholder_3[(i1.outer + 1)] - placeholder_3[i1.outer])), dtype=bool) {\n          compute_5[21] = (compute_5[21] + (placeholder_1[(((placeholder_3[i1.outer]*16) + (elem_idx*16)) + 5)]*max(placeholder[(((i0.outer*1024) + placeholder_2[(placeholder_3[i1.outer] + elem_idx)]) + 256)], 0f32)))\n        }\n        if @tir.likely((elem_idx < (placeholder_3[(i1.outer + 1)] - placeholder_3[i1.outer])), dtype=bool) {\n          compute_5[22] = (compute_5[22] + (placeholder_1[(((placeholder_3[i1.outer]*16) + (elem_idx*16)) + 6)]*max(placeholder[(((i0.outer*1024) + placeholder_2[(placeholder_3[i1.outer] + elem_idx)]) + 256)], 0f32)))\n        }\n        if @tir.likely((elem_idx < (placeholder_3[(i1.outer + 1)] - placeholder_3[i1.outer])), dtype=bool) {\n          compute_5[23] = (compute_5[23] + (placeholder_1[(((placeholder_3[i1.outer]*16) + (elem_idx*16)) + 7)]*max(placeholder[(((i0.outer*1024) + placeholder_2[(placeholder_3[i1.outer] + elem_idx)]) + 256)], 0f32)))\n        }\n        if @tir.likely((elem_idx < (placeholder_3[(i1.outer + 1)] - placeholder_3[i1.outer])), dtype=bool) {\n          compute_5[24] = (compute_5[24] + (placeholder_1[(((placeholder_3[i1.outer]*16) + (elem_idx*16)) + 8)]*max(placeholder[(((i0.outer*1024) + placeholder_2[(placeholder_3[i1.outer] + elem_idx)]) + 256)], 0f32)))\n        }\n        if @tir.likely((elem_idx < (placeholder_3[(i1.outer + 1)] - placeholder_3[i1.outer])), dtype=bool) {\n          compute_5[25] = (compute_5[25] + (placeholder_1[(((placeholder_3[i1.outer]*16) + (elem_idx*16)) + 9)]*max(placeholder[(((i0.outer*1024) + placeholder_2[(placeholder_3[i1.outer] + elem_idx)]) + 256)], 0f32)))\n        }\n        if @tir.likely((elem_idx < (placeholder_3[(i1.outer + 1)] - placeholder_3[i1.outer])), dtype=bool) {\n          compute_5[26] = (compute_5[26] + (placeholder_1[(((placeholder_3[i1.outer]*16) + (elem_idx*16)) + 10)]*max(placeholder[(((i0.outer*1024) + placeholder_2[(placeholder_3[i1.outer] + elem_idx)]) + 256)], 0f32)))\n        }\n        if @tir.likely((elem_idx < (placeholder_3[(i1.outer + 1)] - placeholder_3[i1.outer])), dtype=bool) {\n          compute_5[27] = (compute_5[27] + (placeholder_1[(((placeholder_3[i1.outer]*16) + (elem_idx*16)) + 11)]*max(placeholder[(((i0.outer*1024) + placeholder_2[(placeholder_3[i1.outer] + elem_idx)]) + 256)], 0f32)))\n        }\n        if @tir.likely((elem_idx < (placeholder_3[(i1.outer + 1)] - placeholder_3[i1.outer])), dtype=bool) {\n          compute_5[28] = (compute_5[28] + (placeholder_1[(((placeholder_3[i1.outer]*16) + (elem_idx*16)) + 12)]*max(placeholder[(((i0.outer*1024) + placeholder_2[(placeholder_3[i1.outer] + elem_idx)]) + 256)], 0f32)))\n        }\n        if @tir.likely((elem_idx < (placeholder_3[(i1.outer + 1)] - placeholder_3[i1.outer])), dtype=bool) {\n          compute_5[29] = (compute_5[29] + (placeholder_1[(((placeholder_3[i1.outer]*16) + (elem_idx*16)) + 13)]*max(placeholder[(((i0.outer*1024) + placeholder_2[(placeholder_3[i1.outer] + elem_idx)]) + 256)], 0f32)))\n        }\n        if @tir.likely((elem_idx < (placeholder_3[(i1.outer + 1)] - placeholder_3[i1.outer])), dtype=bool) {\n          compute_5[30] = (compute_5[30] + (placeholder_1[(((placeholder_3[i1.outer]*16) + (elem_idx*16)) + 14)]*max(placeholder[(((i0.outer*1024) + placeholder_2[(placeholder_3[i1.outer] + elem_idx)]) + 256)], 0f32)))\n        }\n        if @tir.likely((elem_idx < (placeholder_3[(i1.outer + 1)] - placeholder_3[i1.outer])), dtype=bool) {\n          compute_5[31] = (compute_5[31] + (placeholder_1[(((placeholder_3[i1.outer]*16) + (elem_idx*16)) + 15)]*max(placeholder[(((i0.outer*1024) + placeholder_2[(placeholder_3[i1.outer] + elem_idx)]) + 256)], 0f32)))\n        }\n        if @tir.likely((elem_idx < (placeholder_3[(i1.outer + 1)] - placeholder_3[i1.outer])), dtype=bool) {\n          compute_5[32] = (compute_5[32] + (placeholder_1[((placeholder_3[i1.outer]*16) + (elem_idx*16))]*max(placeholder[(((i0.outer*1024) + placeholder_2[(placeholder_3[i1.outer] + elem_idx)]) + 512)], 0f32)))\n        }\n        if @tir.likely((elem_idx < (placeholder_3[(i1.outer + 1)] - placeholder_3[i1.outer])), dtype=bool) {\n          compute_5[33] = (compute_5[33] + (placeholder_1[(((placeholder_3[i1.outer]*16) + (elem_idx*16)) + 1)]*max(placeholder[(((i0.outer*1024) + placeholder_2[(placeholder_3[i1.outer] + elem_idx)]) + 512)], 0f32)))\n        }\n        if @tir.likely((elem_idx < (placeholder_3[(i1.outer + 1)] - placeholder_3[i1.outer])), dtype=bool) {\n          compute_5[34] = (compute_5[34] + (placeholder_1[(((placeholder_3[i1.outer]*16) + (elem_idx*16)) + 2)]*max(placeholder[(((i0.outer*1024) + placeholder_2[(placeholder_3[i1.outer] + elem_idx)]) + 512)], 0f32)))\n        }\n        if @tir.likely((elem_idx < (placeholder_3[(i1.outer + 1)] - placeholder_3[i1.outer])), dtype=bool) {\n          compute_5[35] = (compute_5[35] + (placeholder_1[(((placeholder_3[i1.outer]*16) + (elem_idx*16)) + 3)]*max(placeholder[(((i0.outer*1024) + placeholder_2[(placeholder_3[i1.outer] + elem_idx)]) + 512)], 0f32)))\n        }\n        if @tir.likely((elem_idx < (placeholder_3[(i1.outer + 1)] - placeholder_3[i1.outer])), dtype=bool) {\n          compute_5[36] = (compute_5[36] + (placeholder_1[(((placeholder_3[i1.outer]*16) + (elem_idx*16)) + 4)]*max(placeholder[(((i0.outer*1024) + placeholder_2[(placeholder_3[i1.outer] + elem_idx)]) + 512)], 0f32)))\n        }\n        if @tir.likely((elem_idx < (placeholder_3[(i1.outer + 1)] - placeholder_3[i1.outer])), dtype=bool) {\n          compute_5[37] = (compute_5[37] + (placeholder_1[(((placeholder_3[i1.outer]*16) + (elem_idx*16)) + 5)]*max(placeholder[(((i0.outer*1024) + placeholder_2[(placeholder_3[i1.outer] + elem_idx)]) + 512)], 0f32)))\n        }\n        if @tir.likely((elem_idx < (placeholder_3[(i1.outer + 1)] - placeholder_3[i1.outer])), dtype=bool) {\n          compute_5[38] = (compute_5[38] + (placeholder_1[(((placeholder_3[i1.outer]*16) + (elem_idx*16)) + 6)]*max(placeholder[(((i0.outer*1024) + placeholder_2[(placeholder_3[i1.outer] + elem_idx)]) + 512)], 0f32)))\n        }\n        if @tir.likely((elem_idx < (placeholder_3[(i1.outer + 1)] - placeholder_3[i1.outer])), dtype=bool) {\n          compute_5[39] = (compute_5[39] + (placeholder_1[(((placeholder_3[i1.outer]*16) + (elem_idx*16)) + 7)]*max(placeholder[(((i0.outer*1024) + placeholder_2[(placeholder_3[i1.outer] + elem_idx)]) + 512)], 0f32)))\n        }\n        if @tir.likely((elem_idx < (placeholder_3[(i1.outer + 1)] - placeholder_3[i1.outer])), dtype=bool) {\n          compute_5[40] = (compute_5[40] + (placeholder_1[(((placeholder_3[i1.outer]*16) + (elem_idx*16)) + 8)]*max(placeholder[(((i0.outer*1024) + placeholder_2[(placeholder_3[i1.outer] + elem_idx)]) + 512)], 0f32)))\n        }\n        if @tir.likely((elem_idx < (placeholder_3[(i1.outer + 1)] - placeholder_3[i1.outer])), dtype=bool) {\n          compute_5[41] = (compute_5[41] + (placeholder_1[(((placeholder_3[i1.outer]*16) + (elem_idx*16)) + 9)]*max(placeholder[(((i0.outer*1024) + placeholder_2[(placeholder_3[i1.outer] + elem_idx)]) + 512)], 0f32)))\n        }\n        if @tir.likely((elem_idx < (placeholder_3[(i1.outer + 1)] - placeholder_3[i1.outer])), dtype=bool) {\n          compute_5[42] = (compute_5[42] + (placeholder_1[(((placeholder_3[i1.outer]*16) + (elem_idx*16)) + 10)]*max(placeholder[(((i0.outer*1024) + placeholder_2[(placeholder_3[i1.outer] + elem_idx)]) + 512)], 0f32)))\n        }\n        if @tir.likely((elem_idx < (placeholder_3[(i1.outer + 1)] - placeholder_3[i1.outer])), dtype=bool) {\n          compute_5[43] = (compute_5[43] + (placeholder_1[(((placeholder_3[i1.outer]*16) + (elem_idx*16)) + 11)]*max(placeholder[(((i0.outer*1024) + placeholder_2[(placeholder_3[i1.outer] + elem_idx)]) + 512)], 0f32)))\n        }\n        if @tir.likely((elem_idx < (placeholder_3[(i1.outer + 1)] - placeholder_3[i1.outer])), dtype=bool) {\n          compute_5[44] = (compute_5[44] + (placeholder_1[(((placeholder_3[i1.outer]*16) + (elem_idx*16)) + 12)]*max(placeholder[(((i0.outer*1024) + placeholder_2[(placeholder_3[i1.outer] + elem_idx)]) + 512)], 0f32)))\n        }\n        if @tir.likely((elem_idx < (placeholder_3[(i1.outer + 1)] - placeholder_3[i1.outer])), dtype=bool) {\n          compute_5[45] = (compute_5[45] + (placeholder_1[(((placeholder_3[i1.outer]*16) + (elem_idx*16)) + 13)]*max(placeholder[(((i0.outer*1024) + placeholder_2[(placeholder_3[i1.outer] + elem_idx)]) + 512)], 0f32)))\n        }\n        if @tir.likely((elem_idx < (placeholder_3[(i1.outer + 1)] - placeholder_3[i1.outer])), dtype=bool) {\n          compute_5[46] = (compute_5[46] + (placeholder_1[(((placeholder_3[i1.outer]*16) + (elem_idx*16)) + 14)]*max(placeholder[(((i0.outer*1024) + placeholder_2[(placeholder_3[i1.outer] + elem_idx)]) + 512)], 0f32)))\n        }\n        if @tir.likely((elem_idx < (placeholder_3[(i1.outer + 1)] - placeholder_3[i1.outer])), dtype=bool) {\n          compute_5[47] = (compute_5[47] + (placeholder_1[(((placeholder_3[i1.outer]*16) + (elem_idx*16)) + 15)]*max(placeholder[(((i0.outer*1024) + placeholder_2[(placeholder_3[i1.outer] + elem_idx)]) + 512)], 0f32)))\n        }\n        if @tir.likely((elem_idx < (placeholder_3[(i1.outer + 1)] - placeholder_3[i1.outer])), dtype=bool) {\n          compute_5[48] = (compute_5[48] + (placeholder_1[((placeholder_3[i1.outer]*16) + (elem_idx*16))]*max(placeholder[(((i0.outer*1024) + placeholder_2[(placeholder_3[i1.outer] + elem_idx)]) + 768)], 0f32)))\n        }\n        if @tir.likely((elem_idx < (placeholder_3[(i1.outer + 1)] - placeholder_3[i1.outer])), dtype=bool) {\n          compute_5[49] = (compute_5[49] + (placeholder_1[(((placeholder_3[i1.outer]*16) + (elem_idx*16)) + 1)]*max(placeholder[(((i0.outer*1024) + placeholder_2[(placeholder_3[i1.outer] + elem_idx)]) + 768)], 0f32)))\n        }\n        if @tir.likely((elem_idx < (placeholder_3[(i1.outer + 1)] - placeholder_3[i1.outer])), dtype=bool) {\n          compute_5[50] = (compute_5[50] + (placeholder_1[(((placeholder_3[i1.outer]*16) + (elem_idx*16)) + 2)]*max(placeholder[(((i0.outer*1024) + placeholder_2[(placeholder_3[i1.outer] + elem_idx)]) + 768)], 0f32)))\n        }\n        if @tir.likely((elem_idx < (placeholder_3[(i1.outer + 1)] - placeholder_3[i1.outer])), dtype=bool) {\n          compute_5[51] = (compute_5[51] + (placeholder_1[(((placeholder_3[i1.outer]*16) + (elem_idx*16)) + 3)]*max(placeholder[(((i0.outer*1024) + placeholder_2[(placeholder_3[i1.outer] + elem_idx)]) + 768)], 0f32)))\n        }\n        if @tir.likely((elem_idx < (placeholder_3[(i1.outer + 1)] - placeholder_3[i1.outer])), dtype=bool) {\n          compute_5[52] = (compute_5[52] + (placeholder_1[(((placeholder_3[i1.outer]*16) + (elem_idx*16)) + 4)]*max(placeholder[(((i0.outer*1024) + placeholder_2[(placeholder_3[i1.outer] + elem_idx)]) + 768)], 0f32)))\n        }\n        if @tir.likely((elem_idx < (placeholder_3[(i1.outer + 1)] - placeholder_3[i1.outer])), dtype=bool) {\n          compute_5[53] = (compute_5[53] + (placeholder_1[(((placeholder_3[i1.outer]*16) + (elem_idx*16)) + 5)]*max(placeholder[(((i0.outer*1024) + placeholder_2[(placeholder_3[i1.outer] + elem_idx)]) + 768)], 0f32)))\n        }\n        if @tir.likely((elem_idx < (placeholder_3[(i1.outer + 1)] - placeholder_3[i1.outer])), dtype=bool) {\n          compute_5[54] = (compute_5[54] + (placeholder_1[(((placeholder_3[i1.outer]*16) + (elem_idx*16)) + 6)]*max(placeholder[(((i0.outer*1024) + placeholder_2[(placeholder_3[i1.outer] + elem_idx)]) + 768)], 0f32)))\n        }\n        if @tir.likely((elem_idx < (placeholder_3[(i1.outer + 1)] - placeholder_3[i1.outer])), dtype=bool) {\n          compute_5[55] = (compute_5[55] + (placeholder_1[(((placeholder_3[i1.outer]*16) + (elem_idx*16)) + 7)]*max(placeholder[(((i0.outer*1024) + placeholder_2[(placeholder_3[i1.outer] + elem_idx)]) + 768)], 0f32)))\n        }\n        if @tir.likely((elem_idx < (placeholder_3[(i1.outer + 1)] - placeholder_3[i1.outer])), dtype=bool) {\n          compute_5[56] = (compute_5[56] + (placeholder_1[(((placeholder_3[i1.outer]*16) + (elem_idx*16)) + 8)]*max(placeholder[(((i0.outer*1024) + placeholder_2[(placeholder_3[i1.outer] + elem_idx)]) + 768)], 0f32)))\n        }\n        if @tir.likely((elem_idx < (placeholder_3[(i1.outer + 1)] - placeholder_3[i1.outer])), dtype=bool) {\n          compute_5[57] = (compute_5[57] + (placeholder_1[(((placeholder_3[i1.outer]*16) + (elem_idx*16)) + 9)]*max(placeholder[(((i0.outer*1024) + placeholder_2[(placeholder_3[i1.outer] + elem_idx)]) + 768)], 0f32)))\n        }\n        if @tir.likely((elem_idx < (placeholder_3[(i1.outer + 1)] - placeholder_3[i1.outer])), dtype=bool) {\n          compute_5[58] = (compute_5[58] + (placeholder_1[(((placeholder_3[i1.outer]*16) + (elem_idx*16)) + 10)]*max(placeholder[(((i0.outer*1024) + placeholder_2[(placeholder_3[i1.outer] + elem_idx)]) + 768)], 0f32)))\n        }\n        if @tir.likely((elem_idx < (placeholder_3[(i1.outer + 1)] - placeholder_3[i1.outer])), dtype=bool) {\n          compute_5[59] = (compute_5[59] + (placeholder_1[(((placeholder_3[i1.outer]*16) + (elem_idx*16)) + 11)]*max(placeholder[(((i0.outer*1024) + placeholder_2[(placeholder_3[i1.outer] + elem_idx)]) + 768)], 0f32)))\n        }\n        if @tir.likely((elem_idx < (placeholder_3[(i1.outer + 1)] - placeholder_3[i1.outer])), dtype=bool) {\n          compute_5[60] = (compute_5[60] + (placeholder_1[(((placeholder_3[i1.outer]*16) + (elem_idx*16)) + 12)]*max(placeholder[(((i0.outer*1024) + placeholder_2[(placeholder_3[i1.outer] + elem_idx)]) + 768)], 0f32)))\n        }\n        if @tir.likely((elem_idx < (placeholder_3[(i1.outer + 1)] - placeholder_3[i1.outer])), dtype=bool) {\n          compute_5[61] = (compute_5[61] + (placeholder_1[(((placeholder_3[i1.outer]*16) + (elem_idx*16)) + 13)]*max(placeholder[(((i0.outer*1024) + placeholder_2[(placeholder_3[i1.outer] + elem_idx)]) + 768)], 0f32)))\n        }\n        if @tir.likely((elem_idx < (placeholder_3[(i1.outer + 1)] - placeholder_3[i1.outer])), dtype=bool) {\n          compute_5[62] = (compute_5[62] + (placeholder_1[(((placeholder_3[i1.outer]*16) + (elem_idx*16)) + 14)]*max(placeholder[(((i0.outer*1024) + placeholder_2[(placeholder_3[i1.outer] + elem_idx)]) + 768)], 0f32)))\n        }\n        if @tir.likely((elem_idx < (placeholder_3[(i1.outer + 1)] - placeholder_3[i1.outer])), dtype=bool) {\n          compute_5[63] = (compute_5[63] + (placeholder_1[(((placeholder_3[i1.outer]*16) + (elem_idx*16)) + 15)]*max(placeholder[(((i0.outer*1024) + placeholder_2[(placeholder_3[i1.outer] + elem_idx)]) + 768)], 0f32)))\n        }\n      }\n      for (i0.inner: int32, 0, 4) {\n        let cse_var_1: int32 = (((i0.outer*2048) + (i0.inner*512)) + (i1.outer*16))\n        compute[ramp(cse_var_1, 1, 16)] = max((compute_5[ramp((i0.inner*16), 1, 16)] + placeholder_4[ramp(cse_var_1, 1, 16)]), broadcast(0f32, 16))\n      }\n    }\n  }\n}\n'})}),"\n",(0,t.jsx)(l.h2,{id:"\u68C0\u67E5\u6B63\u786E\u6027\u5E76\u8BC4\u4F30\u6027\u80FD",children:"\u68C0\u67E5\u6B63\u786E\u6027\u5E76\u8BC4\u4F30\u6027\u80FD"}),"\n",(0,t.jsx)(l.p,{children:"\u6784\u5EFA\u4E8C\u8FDB\u5236\u6587\u4EF6\uFF0C\u5E76\u68C0\u67E5\u5176\u6B63\u786E\u6027\u548C\u6027\u80FD\u3002"}),"\n",(0,t.jsx)(l.pre,{children:(0,t.jsx)(l.code,{className:"language-python",children:'func = tvm.build(sch, args, target)\n\ndev = tvm.cpu()\n\nX_tvm = tvm.nd.array(X_np, device=dev)\nW_data_tvm = tvm.nd.array(W_sp_np.data, device=dev)\nW_indices_tvm = tvm.nd.array(W_sp_np.indices, device=dev)\nW_indptr_tvm = tvm.nd.array(W_sp_np.indptr, device=dev)\nB_tvm = tvm.nd.array(B_np, device=dev)\nY_tvm = tvm.nd.empty(Y_np.shape, device=dev)\n\nfunc(X_tvm, W_data_tvm, W_indices_tvm, W_indptr_tvm, B_tvm, Y_tvm)\n\n# \u68C0\u67E5\u7ED3\u679C\ntvm.testing.assert_allclose(Y_np, Y_tvm.numpy(), atol=1e-4, rtol=1e-4)\n\n# \u8BC4\u4F30\u6267\u884C\u65F6\u95F4\u3002\nevaluator = func.time_evaluator(func.entry_name, dev, min_repeat_ms=500)\nprint(\n    "Execution time of this operator: %.3f ms"\n    % (\n        np.median(evaluator(X_tvm, W_data_tvm, W_indices_tvm, W_indptr_tvm, B_tvm, Y_tvm).results)\n        * 1000\n    )\n)\n'})}),"\n",(0,t.jsx)(l.p,{children:"\u8F93\u51FA\u7ED3\u679C\uFF1A"}),"\n",(0,t.jsx)(l.pre,{children:(0,t.jsx)(l.code,{className:"language-bash",children:"Execution time of this operator: 2.616 ms\n"})}),"\n",(0,t.jsxs)(l.admonition,{type:"note",children:[(0,t.jsx)(l.p,{children:"\u8C03\u4F18\u7ED3\u679C\u793A\u4F8B"}),(0,t.jsx)(l.pre,{children:(0,t.jsx)(l.code,{className:"language-bash",children:'----------------------------------------------------------------------\nLowered TIR:\nprimfn(placeholder_5: handle, placeholder_6: handle, placeholder_7: handle, placeholder_8: handle, placeholder_9: handle, compute_1: handle) -> ()\n  attr = {"global_symbol": "main", "tir.noalias": True}\n  buffers = {placeholder_2: Buffer(placeholder_10: Pointer(float32), float32, [9831, 16, 1], []),\n             placeholder_4: Buffer(placeholder_11: Pointer(int32), int32, [33], []),\n             placeholder_3: Buffer(placeholder_12: Pointer(float32), float32, [512, 512], []),\n             compute: Buffer(compute_2: Pointer(float32), float32, [512, 512], []),\n             placeholder_1: Buffer(placeholder_13: Pointer(float32), float32, [512, 512], []),\n             placeholder: Buffer(placeholder_14: Pointer(int32), int32, [9831], [])}\n  buffer_map = {placeholder_7: placeholder, placeholder_9: placeholder_1, placeholder_6: placeholder_2, compute_1: compute, placeholder_5: placeholder_3, placeholder_8: placeholder_4} {\n  for (i0.outer.i1.outer.fused: int32, 0, 1024) "parallel" {\n    attr [compute_3: Pointer(float32)] "storage_scope" = "global";\n    allocate(compute_3, float32, [256]) {\n      for (nb_j.inner: int32, 0, 2) {\n        for (i.inner.init: int32, 0, 8) {\n          for (j.init: int32, 0, 16) {\n            compute_3[(((i.inner.init*32) + (nb_j.inner*16)) + j.init)] = 0f32\n          }\n        }\n        for (elem_idx: int32, 0, ((int32*)placeholder_11[(((floormod(i0.outer.i1.outer.fused, 16)*2) + nb_j.inner) + 1)] - (int32*)placeholder_11[((floormod(i0.outer.i1.outer.fused, 16)*2) + nb_j.inner)])) {\n          for (i.inner: int32, 0, 8) {\n            for (j: int32, 0, 16) {\n              compute_3[(((i.inner*32) + (nb_j.inner*16)) + j)] = ((float32*)compute_3[(((i.inner*32) + (nb_j.inner*16)) + j)] + ((float32*)placeholder_10[((((int32*)placeholder_11[((floormod(i0.outer.i1.outer.fused, 16)*2) + nb_j.inner)]*16) + (elem_idx*16)) + j)]*max((float32*)placeholder_12[(((floordiv(i0.outer.i1.outer.fused, 16)*4096) + (i.inner*512)) + (int32*)placeholder_14[((int32*)placeholder_11[((floormod(i0.outer.i1.outer.fused, 16)*2) + nb_j.inner)] + elem_idx)])], 0f32)))\n            }\n          }\n        }\n      }\n      for (i0.inner: int32, 0, 8) {\n        compute_2[ramp((((floordiv(i0.outer.i1.outer.fused, 16)*4096) + (i0.inner*512)) + (floormod(i0.outer.i1.outer.fused, 16)*32)), 1, 32)] = max(((float32x32*)compute_3[ramp((i0.inner*32), 1, 32)] + (float32x32*)placeholder_13[ramp((((floordiv(i0.outer.i1.outer.fused, 16)*4096) + (i0.inner*512)) + (floormod(i0.outer.i1.outer.fused, 16)*32)), 1, 32)]), broadcast(0f32, 32))\n      }\n    }\n  }\n}\n'})}),(0,t.jsx)(l.p,{children:(0,t.jsx)(l.a,{href:"https://tvm.apache.org/docs/_downloads/07733b6b2cc4df026fce525285e8f538/tune_sparse_x86.py",children:"\u4E0B\u8F7D Python \u6E90\u4EE3\u7801\uFF1Atune_sparse_x86.py"})}),(0,t.jsx)(l.p,{children:(0,t.jsx)(l.a,{href:"https://tvm.apache.org/docs/_downloads/293f8d0753933b706a0b588f909fe38a/tune_sparse_x86.ipynb",children:"\u4E0B\u8F7D Jupyter Notebook\uFF1Atune_sparse_x86.ipynb"})})]})]})}function n(e={}){let{wrapper:l}={...(0,i.a)(),...e.components};return l?(0,t.jsx)(l,{...e,children:(0,t.jsx)(c,{...e})}):c(e)}},21494:function(e,l,o){o.d(l,{Z:function(){return _},a:function(){return d}});var r=o(39546);let t={},i=r.createContext(t);function d(e){let l=r.useContext(i);return r.useMemo(function(){return"function"==typeof e?e(l):{...l,...e}},[l,e])}function _(e){let l;return l=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:d(e.components),r.createElement(i.Provider,{value:l},e.children)}}}]);