"use strict";(self.webpackChunktvm_cn=self.webpackChunktvm_cn||[]).push([["2917"],{79585:function(e,n,a){a.r(n),a.d(n,{default:()=>h,frontMatter:()=>t,metadata:()=>r,assets:()=>s,toc:()=>d,contentTitle:()=>i});var r=JSON.parse('{"id":"tutorial/uma","title":"\u5229\u7528 UMA \u4F7F\u786C\u4EF6\u52A0\u901F\u5668\u53EF\u76F4\u63A5\u7528\u4E8E TVM","description":"\u5355\u51FB \u6B64\u5904 \u4E0B\u8F7D\u5B8C\u6574\u7684\u793A\u4F8B\u4EE3\u7801","source":"@site/docs/tutorial/12-uma.md","sourceDirName":"tutorial","slug":"/tutorial/uma","permalink":"/docs/tvm-cn/docs/tutorial/uma","draft":false,"unlisted":false,"editUrl":"https://github.com/hyperai/tvm-cn/edit/master/docs/tutorial/12-uma.md","tags":[],"version":"current","lastUpdatedBy":"sparanoid","lastUpdatedAt":1744717810000,"sidebarPosition":12,"frontMatter":{"title":"\u5229\u7528 UMA \u4F7F\u786C\u4EF6\u52A0\u901F\u5668\u53EF\u76F4\u63A5\u7528\u4E8E TVM"},"sidebar":"tutorialSidebar","previous":{"title":"\u5FEB\u901F\u5165\u95E8\uFF1A\u7F16\u8BD1\u6DF1\u5EA6\u5B66\u4E60\u6A21\u578B","permalink":"/docs/tvm-cn/docs/tutorial/quick_start"},"next":{"title":"TOPI \u7B80\u4ECB","permalink":"/docs/tvm-cn/docs/tutorial/TOPI"}}'),l=a("74132"),c=a("21494");let t={title:"\u5229\u7528 UMA \u4F7F\u786C\u4EF6\u52A0\u901F\u5668\u53EF\u76F4\u63A5\u7528\u4E8E TVM"},i="\u5229\u7528 UMA \u4F7F\u786C\u4EF6\u52A0\u901F\u5668\u53EF\u76F4\u63A5\u7528\u4E8E TVM",s={},d=[{value:"Vanilla",id:"vanilla",level:2},{value:"Strawberry",id:"strawberry",level:2},{value:"Chocolate",id:"chocolate",level:2},{value:"\u5F81\u6C42\u793E\u533A\u610F\u89C1",id:"\u5F81\u6C42\u793E\u533A\u610F\u89C1",level:2},{value:"\u53C2\u8003",id:"\u53C2\u8003",level:2}];function o(e){let n={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",header:"header",p:"p",pre:"pre",strong:"strong",...(0,c.a)(),...e.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(n.header,{children:(0,l.jsx)(n.h1,{id:"\u5229\u7528-uma-\u4F7F\u786C\u4EF6\u52A0\u901F\u5668\u53EF\u76F4\u63A5\u7528\u4E8E-tvm",children:"\u5229\u7528 UMA \u4F7F\u786C\u4EF6\u52A0\u901F\u5668\u53EF\u76F4\u63A5\u7528\u4E8E TVM"})}),"\n",(0,l.jsx)(n.admonition,{type:"note",children:(0,l.jsxs)(n.p,{children:["\u5355\u51FB ",(0,l.jsx)(n.a,{href:"https://tvm.apache.org/docs/tutorial/uma.html#sphx-glr-download-tutorial-uma-py",children:"\u6B64\u5904"})," \u4E0B\u8F7D\u5B8C\u6574\u7684\u793A\u4F8B\u4EE3\u7801"]})}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"\u4F5C\u8005"}),"\uFF1A",(0,l.jsx)(n.a,{href:"https://github.com/MichaelJKlaiber",children:"Michael J. Klaiber"}),"\uFF0C",(0,l.jsx)(n.a,{href:"https://github.com/cgerum",children:"Christoph Gerum"}),"\uFF0C",(0,l.jsx)(n.a,{href:"https://github.com/PaulPalomeroBernardo/",children:"Paul Palomero Bernardo"})]}),"\n",(0,l.jsxs)(n.p,{children:["\u672C\u8282\u4ECB\u7ECD",(0,l.jsx)(n.strong,{children:"\u901A\u7528\u6A21\u5757\u5316\u52A0\u901F\u5668\u63A5\u53E3"}),"\uFF08UMA\uFF09\u3002UMA \u63D0\u4F9B\u4E86\u4E00\u4E2A\u6613\u7528\u7684 API \u6765\u5C06\u65B0\u7684\u786C\u4EF6\u52A0\u901F\u5668\u96C6\u6210\u5230 TVM \u4E2D\u3002"]}),"\n",(0,l.jsx)(n.p,{children:"\u672C\u6559\u7A0B\u8BE6\u7EC6\u4ECB\u7ECD\u4E86\u5982\u4F55\u5229\u7528 UMA \u4F7F\u5F97\u4F60\u7684\u786C\u4EF6\u52A0\u901F\u5668\u53EF\u76F4\u63A5\u7528\u4E8E TVM\u3002\u867D\u7136\u8FD9\u4E2A\u95EE\u9898\u6CA1\u6709\u4E07\u80FD\u7684\u89E3\u51B3\u65B9\u6848\uFF0C\u4F46 UMA \u65E8\u5728\u63D0\u4F9B\u4E00\u4E2A\u7A33\u5B9A\u7684\u7EAF Python API\uFF0C\u4ECE\u800C\u5C06\u8BB8\u591A\u79CD\u7C7B\u7684\u786C\u4EF6\u52A0\u901F\u5668\u96C6\u6210\u5230 TVM \u4E2D\u3002"}),"\n",(0,l.jsxs)(n.p,{children:["\u672C\u6559\u7A0B\u5C06\u901A\u8FC7\u4E09\u4E2A\u9010\u6E10\u590D\u6742\u7684\u7528\u4F8B\u6765\u4ECB\u7ECD UMA API\u3002\u8FD9\u4E9B\u7528\u4F8B\u5F15\u5165\u4E86\u4E09\u4E2A\u6A21\u62DF\u52A0\u901F\u5668 ",(0,l.jsx)(n.strong,{children:"Vanilla"}),"\u3001",(0,l.jsx)(n.strong,{children:"Strawberry"})," \u548C ",(0,l.jsx)(n.strong,{children:"Chocolate"}),"\uFF0C\u5E76\u7528 UMA \u5C06\u5B83\u4EEC\u96C6\u6210\u5230 TVM \u4E2D\u3002"]}),"\n",(0,l.jsx)(n.h2,{id:"vanilla",children:"Vanilla"}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"Vanilla"})," \u662F\u4E00\u4E2A\u7531 MAC \u6570\u7EC4\u7EC4\u6210\u7684\u7B80\u5355\u52A0\u901F\u5668\uFF0C\u6CA1\u6709\u5185\u90E8\u5B58\u50A8\u5668\u3002\u5B83\u53EA\u80FD\u5904\u7406 Conv2D \u5C42\uFF0C\u6240\u6709\u5176\u4ED6\u5C42\u90FD\u5728 CPU \u4E0A\u6267\u884C\uFF0C\u540C\u65F6\u4E5F\u534F\u8C03 ",(0,l.jsx)(n.strong,{children:"Vanilla"}),"\u3002 CPU \u548C Vanilla \u5171\u4EAB\u5185\u5B58\u3002"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"Vanilla"})," \u7684 C \u63A5\u53E3 ",(0,l.jsx)(n.code,{children:"vanilla_conv2dnchw(...)"})," \u7528\u4E8E\u6267\u884C Conv2D \u64CD\u4F5C\uFF08\u5305\u62EC same-padding\uFF09\uFF0C\u5B83\u63A5\u6536\u6307\u5411\u8F93\u5165\u7279\u5F81\u56FE\u3001\u6743\u91CD\u548C\u7ED3\u679C\u7684\u6307\u9488\uFF0C\u4EE5\u53CA Conv2D \u7684\u7EF4\u5EA6\uFF1A",(0,l.jsx)(n.em,{children:"oc"}),"\u3001",(0,l.jsx)(n.em,{children:"iw"}),"\u3001",(0,l.jsx)(n.em,{children:"ih"}),"\u3001",(0,l.jsx)(n.em,{children:"ic"}),"\u3001",(0,l.jsx)(n.em,{children:"kh"})," \u548C ",(0,l.jsx)(n.em,{children:"kw"}),"\u3002"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-cpp",children:"int vanilla_conv2dnchw(float* ifmap, float*  weights, float*  result, int oc, int iw, int ih, int ic, int kh, int kw);\n"})}),"\n",(0,l.jsxs)(n.p,{children:["\u811A\u672C ",(0,l.jsx)(n.em,{children:"uma_cli"})," \u4E3A\u65B0\u7684\u52A0\u901F\u5668\u521B\u5EFA\u5E26\u6709 API\uFF08UMA-API\uFF09\u8C03\u7528\u7684\u4EE3\u7801\u9AA8\u67B6\u3002"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"Vanilla"})," \u7684\u4F7F\u7528\u65B9\u5F0F\u5982\u4E0B\uFF1A\uFF08",(0,l.jsx)(n.code,{children:"--tutorial vanilla"})," \u6DFB\u52A0\u4E86\u672C\u90E8\u5206\u6559\u7A0B\u6240\u9700\u7684\u6240\u6709\u9644\u52A0\u6587\u4EF6\uFF09"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"pip install inflection\ncd $TVM_HOME/apps/uma\npython uma_cli.py --add_hardware vanilla_accelerator --tutorial vanilla\n"})}),"\n",(0,l.jsxs)(n.p,{children:["uma_cli.py \u5728 ",(0,l.jsx)(n.code,{children:"vanilla_accelerator"})," \u76EE\u5F55\u4E2D\u751F\u6210\u8FD9\u4E9B\u6587\u4EF6\u3002"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"backend.py\ncodegen.py\nconv2dnchw.cc\npasses.py\npatterns.py\nrun.py\nstrategies.py\n"})}),"\n",(0,l.jsx)(n.p,{children:"Vanilla \u540E\u7AEF"}),"\n",(0,l.jsxs)(n.p,{children:["vanilla \u751F\u6210\u7684\u540E\u7AEF\u4F4D\u4E8E ",(0,l.jsx)(n.em,{children:"vanilla_accelerator/backend.py"})," \u4E2D\uFF1A"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-python",children:'class VanillaAcceleratorBackend(UMABackend):\n    """VanillaAccelerator \u7684 UMA \u540E\u7AEF\u3002"""\n\n    def __init__(self):\n        super().__init__()\n\n        self._register_pattern("conv2d", conv2d_pattern())\n        self._register_tir_pass(PassPhase.TIR_PHASE_0, VanillaAcceleratorConv2DPass())\n        self._register_codegen(fmt="c", includes=gen_includes)\n\n    @property\n    def target_name(self):\n        return "vanilla_accelerator"\n'})}),"\n",(0,l.jsx)(n.p,{children:"\u5B9A\u4E49\u8FC1\u79FB\u6A21\u5F0F"}),"\n",(0,l.jsxs)(n.p,{children:["\u4E3A\u4E86\u6307\u5B9A ",(0,l.jsx)(n.em,{children:"Conv2D"})," \u8FC1\u79FB\u5230 ",(0,l.jsx)(n.strong,{children:"Vanilla"}),"\uFF0C",(0,l.jsx)(n.em,{children:"vanilla_accelerator/patterns.py"})," \u4E2D\u5C06\u5176\u63CF\u8FF0\u4E3A Relay \u6570\u636E\u6D41\u6A21\u5F0F\uFF08",(0,l.jsx)(n.a,{href:"https://tvm.apache.org/docs/reference/langref/relay_pattern.html",children:"DFPattern"}),"\uFF09\u3002"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-python",children:'def conv2d_pattern():\n    pattern = is_op("nn.conv2d")(wildcard(), wildcard())\n    pattern = pattern.has_attr({"strides": [1, 1]})\n    return pattern\n'})}),"\n",(0,l.jsxs)(n.p,{children:["\u4E3A\u4E86\u5C06\u8F93\u5165\u8BA1\u7B97\u56FE\u7684 ",(0,l.jsx)(n.strong,{children:"Conv2D"})," \u7B97\u5B50\u6620\u5C04\u5230 ",(0,l.jsx)(n.strong,{children:"Vanilla"})," \u7684\u5E95\u5C42\u51FD\u6570\u8C03\u7528 ",(0,l.jsx)(n.code,{children:"vanilla_conv2dnchw(...)"}),"\uFF0C\u5728 VanillaAcceleratorBackend \u4E2D\u6CE8\u518C\u4E86 TIR pass ",(0,l.jsx)(n.em,{children:"VanillaAcceleratorConv2DPass"}),"\uFF08\u7A0D\u540E\u8BA8\u8BBA\uFF09\u3002"]}),"\n",(0,l.jsx)(n.p,{children:"Codegen"}),"\n",(0,l.jsxs)(n.p,{children:["\u6587\u4EF6 ",(0,l.jsx)(n.code,{children:"vanilla_accelerator/codegen.py"})," \u5B9A\u4E49\u4E86\u9759\u6001 C \u4EE3\u7801\uFF0C\u5B83\u88AB\u6DFB\u52A0\u5230\u751F\u6210\u7684\u7ED3\u679C C \u4EE3\u7801\uFF08\u7531 ",(0,l.jsx)(n.code,{children:"gen_includes"})," \u4E2D\u7684 TVM \u7684 C-Codegen \u751F\u6210\uFF09\u4E2D\uFF0C\u5176\u76EE\u7684\u662F\u5305\u542B ",(0,l.jsx)(n.strong,{children:"Vanilla"})," \u7684\u5E95\u5C42\u5E93 ",(0,l.jsx)(n.code,{children:"vanilla_conv2dnchw()"}),"\u3002"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-python",children:'def gen_includes() -> str:\n    topdir = pathlib.Path(__file__).parent.absolute()\n\n    includes = ""\n    includes += f\'#include "{topdir}/conv2dnchw.cc"\'\n    return includes\n'})}),"\n",(0,l.jsxs)(n.p,{children:["\u5982\u4E0A\u9762\u7684 ",(0,l.jsx)(n.em,{children:"VanillaAcceleratorBackend"})," \u6240\u793A\uFF0C\u7528 ",(0,l.jsx)(n.em,{children:"self._register_codegen"})," \u53EF\u5C06\u5176\u6CE8\u518C\u5230 UMA\u3002"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-python",children:'self._register_codegen(fmt="c", includes=gen_includes)\n'})}),"\n",(0,l.jsx)(n.p,{children:"\u6784\u5EFA\u795E\u7ECF\u7F51\u7EDC\u5E76\u5728 Vanilla \u4E0A\u8FD0\u884C"}),"\n",(0,l.jsxs)(n.p,{children:["\u4E3A\u4E86\u6F14\u793A UMA \u7684\u529F\u80FD\uFF0C\u5C06\u4E3A\u5355\u4E2A Conv2D \u5C42\u751F\u6210 C \u4EE3\u7801\uFF0C\u5E76\u5728 Vanilla \u52A0\u901F\u5668\u4E0A\u8FD0\u884C\u3002\u6587\u4EF6 ",(0,l.jsx)(n.code,{children:"vanilla_accelerator/run.py"})," \u63D0\u4F9B\u4E86\u4E00\u4E2A\u4F7F\u7528 Vanilla \u7684 C-API \u8FD0\u884C Conv2D \u5C42\u7684 demo\u3002"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-python",children:'def main():\n    mod, inputs, output_list, runner = create_conv2d()\n\n    uma_backend = VanillaAcceleratorBackend()\n    uma_backend.register()\n    mod = uma_backend.partition(mod)\n    target = tvm.target.Target("vanilla_accelerator", host=tvm.target.Target("c"))\n\n    export_directory = tvm.contrib.utils.tempdir(keep_for_debug=True).path\n    print(f"Generated files are in {export_directory}")\n    compile_and_run(\n        AOTModel(module=mod, inputs=inputs, outputs=output_list),\n        runner,\n        interface_api="c",\n        use_unpacked_api=True,\n        target=target,\n        test_dir=str(export_directory),\n    )\n\nmain()\n'})}),"\n",(0,l.jsxs)(n.p,{children:["\u8FD0\u884C ",(0,l.jsx)(n.code,{children:"vanilla_accelerator/run.py"}),"\uFF0C\u5C06\u4EE5\u6A21\u578B\u5E93\u683C\u5F0F\uFF08MLF\uFF09\u751F\u6210\u8F93\u51FA\u6587\u4EF6\u3002"]}),"\n",(0,l.jsx)(n.p,{children:"\u8F93\u51FA\u7ED3\u679C\uFF1A"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"Generated files are in /tmp/tvm-debug-mode-tempdirs/2022-07-13T13-26-22___x5u76h0p/00000\n"})}),"\n",(0,l.jsx)(n.p,{children:"\u67E5\u770B\u751F\u6210\u7684\u6587\u4EF6\uFF1A"}),"\n",(0,l.jsx)(n.p,{children:"\u8F93\u51FA\u7ED3\u679C\uFF1A"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"cd /tmp/tvm-debug-mode-tempdirs/2022-07-13T13-26-22___x5u76h0p/00000\ncd build/\nls -1\n\ncodegen\nlib.tar\nmetadata.json\nparameters\nruntime\nsrc\n"})}),"\n",(0,l.jsxs)(n.p,{children:["\u82E5\u8981\u8BC4\u4F30\u751F\u6210\u7684 C \u4EE3\u7801\uFF0C\u8BF7\u67E5\u770B ",(0,l.jsx)(n.code,{children:"codegen/host/src/default_lib2.c"}),"\u3002"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"cd codegen/host/src/\nls -1\n\ndefault_lib0.c\ndefault_lib1.c\ndefault_lib2.c\n"})}),"\n",(0,l.jsxs)(n.p,{children:["\u5728 ",(0,l.jsx)(n.em,{children:"default_lib2.c"})," \u4E2D\uFF0C\u53EF\u4EE5\u770B\u5230\u751F\u6210\u7684\u4EE3\u7801\u8C03\u7528\u4E86 Vanilla \u7684 C-API\uFF0C\u7136\u540E\u6267\u884C\u4E86\u4E00\u4E2A Conv2D \u5C42\uFF1A"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-cpp",children:"TVM_DLL int32_t tvmgen_default_vanilla_accelerator_main_0(float* placeholder, float* placeholder1, float* conv2d_nchw, uint8_t* global_workspace_1_var) {\n     vanilla_accelerator_conv2dnchw(placeholder, placeholder1, conv2d_nchw, 32, 14, 14, 32, 3, 3);\n     return 0;\n}\n"})}),"\n",(0,l.jsx)(n.h2,{id:"strawberry",children:"Strawberry"}),"\n",(0,l.jsx)(n.p,{children:"\u5373\u5C06\u4E0A\u7EBF"}),"\n",(0,l.jsx)(n.h2,{id:"chocolate",children:"Chocolate"}),"\n",(0,l.jsx)(n.p,{children:"\u5373\u5C06\u4E0A\u7EBF"}),"\n",(0,l.jsx)(n.h2,{id:"\u5F81\u6C42\u793E\u533A\u610F\u89C1",children:"\u5F81\u6C42\u793E\u533A\u610F\u89C1"}),"\n",(0,l.jsxs)(n.p,{children:["\u82E5\u672C\u6559\u7A0B",(0,l.jsx)(n.strong,{children:"\u4E0D"}),"\u9002\u5408\u4F60\u7684\u52A0\u901F\u5668\uFF0C\u8BF7\u5C06\u4F60\u7684\u9700\u6C42\u6DFB\u52A0\u5230 TVM \u8BBA\u575B\u4E2D\u7684 ",(0,l.jsx)(n.a,{href:"https://discuss.tvm.apache.org/t/rfc-uma-universal-modular-accelerator-interface/12039",children:"UMA \u5E16\u5B50"})," \u4E2D\u3002\u6211\u4EEC\u5F88\u4E50\u610F\u901A\u8FC7\u6269\u5C55\u672C\u6559\u7A0B\u6765\u63D0\u4F9B\u66F4\u591A\u6307\u5BFC\uFF0C\u4F8B\u5982\u5982\u4F55\u5229\u7528 UMA \u63A5\u53E3\u4F7F\u5F97\u66F4\u591A\u79CD\u7C7B\u7684 AI \u786C\u4EF6\u52A0\u901F\u5668\u53EF\u76F4\u63A5\u7528\u4E8E TVM\u3002"]}),"\n",(0,l.jsx)(n.h2,{id:"\u53C2\u8003",children:"\u53C2\u8003"}),"\n",(0,l.jsxs)(n.p,{children:["[UMA-RFC] ",(0,l.jsx)(n.a,{href:"https://github.com/apache/tvm-rfcs/blob/main/rfcs/0060_UMA_Unified_Modular_Accelerator_Interface.md",children:"UMA\uFF1A\u901A\u7528\u6A21\u5757\u5316\u52A0\u901F\u5668\u63A5\u53E3"}),"\uFF0CTVM RFC\uFF0C2022 \u5E74 6 \u6708\u3002"]}),"\n",(0,l.jsxs)(n.p,{children:["[DFPattern] ",(0,l.jsx)(n.a,{href:"https://tvm.apache.org/docs/reference/langref/relay_pattern.html",children:"Relay \u4E2D\u7684\u6A21\u5F0F\u5339\u914D"})]}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.a,{href:"https://tvm.apache.org/docs/_downloads/f9c6910c7b4a120c51a9bf48f34f3ad7/uma.py",children:"\u4E0B\u8F7D Python \u6E90\u4EE3\u7801\uFF1Auma.py"})}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.a,{href:"https://tvm.apache.org/docs/_downloads/6e0673ce1f08636c34d0b9a73ea114f7/uma.ipynb",children:"\u4E0B\u8F7D Jupyter Notebook\uFF1Auma.ipynb"})})]})}function h(e={}){let{wrapper:n}={...(0,c.a)(),...e.components};return n?(0,l.jsx)(n,{...e,children:(0,l.jsx)(o,{...e})}):o(e)}},21494:function(e,n,a){a.d(n,{Z:function(){return i},a:function(){return t}});var r=a(39546);let l={},c=r.createContext(l);function t(e){let n=r.useContext(c);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:t(e.components),r.createElement(c.Provider,{value:n},e.children)}}}]);