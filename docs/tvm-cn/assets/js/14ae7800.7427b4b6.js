"use strict";(self.webpackChunktvm_cn=self.webpackChunktvm_cn||[]).push([["77065"],{33138:function(e,n,t){t.r(n),t.d(n,{default:()=>_,frontMatter:()=>c,metadata:()=>i,assets:()=>o,toc:()=>d,contentTitle:()=>a});var i=JSON.parse('{"id":"topic/vta/tutorials/mat_mul","title":"\u7B80\u5355\u77E9\u9635\u4E58\u6CD5","description":"\u5355\u51FB \u6B64\u5904 \u4E0B\u8F7D\u5B8C\u6574\u7684\u793A\u4F8B\u4EE3\u7801","source":"@site/versioned_docs/version-0.12.0/topic/vta/tutorials/01-mat_mul.md","sourceDirName":"topic/vta/tutorials","slug":"/topic/vta/tutorials/mat_mul","permalink":"/docs/tvm-cn/docs/0.12.0/topic/vta/tutorials/mat_mul","draft":false,"unlisted":false,"editUrl":"https://github.com/hyperai/tvm-cn/edit/master/versioned_docs/version-0.12.0/topic/vta/tutorials/01-mat_mul.md","tags":[],"version":"0.12.0","lastUpdatedBy":"sparanoid","lastUpdatedAt":1744717810000,"sidebarPosition":1,"frontMatter":{"title":"\u7B80\u5355\u77E9\u9635\u4E58\u6CD5"},"sidebar":"tutorialSidebar","previous":{"title":"VTA \u6559\u7A0B","permalink":"/docs/tvm-cn/docs/0.12.0/topic/vta/tutorials/"},"next":{"title":"VTA \u5165\u95E8","permalink":"/docs/tvm-cn/docs/0.12.0/topic/vta/tutorials/start_vta"}}'),r=t("74132"),s=t("21494");let c={title:"\u7B80\u5355\u77E9\u9635\u4E58\u6CD5"},a="\u7B80\u5355\u77E9\u9635\u4E58\u6CD5",o={},d=[{value:"RPC \u8BBE\u7F6E",id:"rpc-\u8BBE\u7F6E",level:2},{value:"\u8BA1\u7B97\u58F0\u660E",id:"\u8BA1\u7B97\u58F0\u660E",level:2},{value:"\u6570\u636E\u5E03\u5C40",id:"\u6570\u636E\u5E03\u5C40",level:3},{value:"\u77E9\u9635\u4E58\u6CD5",id:"\u77E9\u9635\u4E58\u6CD5",level:3},{value:"\u8F6C\u6362\u7ED3\u679C",id:"\u8F6C\u6362\u7ED3\u679C",level:3},{value:"\u8C03\u5EA6\u8BA1\u7B97",id:"\u8C03\u5EA6\u8BA1\u7B97",level:2},{value:"\u9ED8\u8BA4 schedule",id:"\u9ED8\u8BA4-schedule",level:3},{value:"\u7F13\u51B2\u533A\u8303\u56F4",id:"\u7F13\u51B2\u533A\u8303\u56F4",level:3},{value:"DMA \u4F20\u8F93",id:"dma-\u4F20\u8F93",level:3},{value:"\u5F20\u91CF\u5316",id:"\u5F20\u91CF\u5316",level:3},{value:"TVM \u7F16\u8BD1",id:"tvm-\u7F16\u8BD1",level:2},{value:"\u8FD0\u884C\u51FD\u6570",id:"\u8FD0\u884C\u51FD\u6570",level:2},{value:"\u9A8C\u8BC1\u6B63\u786E\u6027",id:"\u9A8C\u8BC1\u6B63\u786E\u6027",level:2},{value:"\u603B\u7ED3",id:"\u603B\u7ED3",level:2}];function l(e){let n={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.a)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"\u7B80\u5355\u77E9\u9635\u4E58\u6CD5",children:"\u7B80\u5355\u77E9\u9635\u4E58\u6CD5"})}),"\n",(0,r.jsx)(n.admonition,{type:"note",children:(0,r.jsxs)(n.p,{children:["\u5355\u51FB ",(0,r.jsx)(n.a,{href:"https://tvm.apache.org/docs/topic/vta/tutorials/matrix_multiply.html#sphx-glr-download-topic-vta-tutorials-matrix-multiply-py",children:"\u6B64\u5904"})," \u4E0B\u8F7D\u5B8C\u6574\u7684\u793A\u4F8B\u4EE3\u7801"]})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"\u4F5C\u8005"}),"\uFF1A",(0,r.jsx)(n.a,{href:"https://homes.cs.washington.edu/~moreau/",children:"Thierry Moreau"})]}),"\n",(0,r.jsxs)(n.p,{children:["\u672C\u6559\u7A0B\u4EE5 ",(0,r.jsx)(n.a,{href:"start_vta",children:"VTA \u5165\u95E8"})," \u6559\u7A0B\u4E3A\u57FA\u7840\uFF0C\u5E76\u4ECB\u7ECD\u7528 TVM workflow \u5728 VTA \u4E0A\u5B9E\u73B0\u77E9\u9635\u4E58\u6CD5\u6240\u9700\u7684\u5176\u4ED6\u6982\u5FF5\u3002"]}),"\n",(0,r.jsx)(n.h2,{id:"rpc-\u8BBE\u7F6E",children:"RPC \u8BBE\u7F6E"}),"\n",(0,r.jsx)(n.p,{children:"\u9996\u5148\u5BF9 Pynq \u7684 FPGA \u8FDB\u884C\u7F16\u7A0B\uFF0C\u5E76\u6784\u5EFA\u5176 RPC runtime\uFF0C\u6B65\u9AA4\u4E0E VTA \u5165\u95E8\u6559\u7A0B\u7C7B\u4F3C\u3002"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'from __future__ import absolute_import, print_function\n\nimport os\nimport tvm\nfrom tvm import te\nimport vta\nimport numpy as np\nfrom tvm import rpc\nfrom tvm.contrib import utils\nfrom vta.testing import simulator\n\n# \u4ECE 3rdparty/vta-hw/config/vta_config.json \u6587\u4EF6\u52A0\u8F7D VTA \u53C2\u6570\nenv = vta.get_env()\n\n# \u4ECE OS \u73AF\u5883\u4E2D\u8BFB\u53D6 Pynq RPC \u4E3B\u673A IP \u5730\u5740\u548C\u7AEF\u53E3\u53F7\nhost = os.environ.get("VTA_RPC_HOST", "192.168.2.99")\nport = int(os.environ.get("VTA_RPC_PORT", "9091"))\n\n# \u5728 Pynq \u4E0A\u914D\u7F6E\u6BD4\u7279\u6D41\u548C runtime \u7CFB\u7EDF\n# \u5339\u914D vta_config.json \u6587\u4EF6\u6307\u5B9A\u7684 VTA \u914D\u7F6E\u3002\nif env.TARGET == "pynq" or env.TARGET == "de10nano":\n    # \u786E\u4FDD TVM \u662F\u4F7F\u7528 RPC=1 \u7F16\u8BD1\u7684\n    assert tvm.runtime.enabled("rpc")\n    remote = rpc.connect(host, port)\n\n    # \u91CD\u65B0\u914D\u7F6E JIT runtime\n    vta.reconfig_runtime(remote)\n\n    # \u4F7F\u7528\u9884\u7F16\u8BD1\u7684 VTA \u6BD4\u7279\u6D41\u5BF9 FPGA \u8FDB\u884C\u7F16\u7A0B\u3002\n    # \u53EF\u4EE5\u901A\u8FC7\u4F20\u9012\u6BD4\u7279\u6D41\u6587\u4EF6\u7684\u8DEF\u5F84\n    # \u4F7F\u7528\u81EA\u5B9A\u4E49\u6BD4\u7279\u6D41\u800C\u975E None\u5BF9 FPGA \u8FDB\u884C\u7F16\u7A0B\u3002\n    vta.program_fpga(remote, bitstream=None)\n\n# \u5728\u6A21\u62DF\u6A21\u5F0F\u4E0B\uFF0C\u672C\u5730\u6258\u7BA1 RPC \u670D\u52A1\u5668\u3002\nelif env.TARGET in ["sim", "tsim"]:\n    remote = rpc.LocalSession()\n'})}),"\n",(0,r.jsx)(n.h2,{id:"\u8BA1\u7B97\u58F0\u660E",children:"\u8BA1\u7B97\u58F0\u660E"}),"\n",(0,r.jsxs)(n.p,{children:["\u793A\u4F8B\u4E2D\u63CF\u8FF0\u4E86\u4E00\u4E2A\u7B80\u5355\u7684\u77E9\u9635\u4E58\u6CD5\u52A0\u6CD5\uFF0C\u5B83\u9700\u8981\u591A\u4E2A\u8BA1\u7B97\u9636\u6BB5\uFF0C\u5982\u4E0B\u9762\u7684\u6570\u636E\u6D41\u56FE\u6240\u793A\u3002\u9996\u5148\uFF0C\u63CF\u8FF0\u4E3B\u5B58\u50A8\u5668\u4E2D\u7684\u8F93\u5165\u5F20\u91CF ",(0,r.jsx)(n.code,{children:"A"})," \u548C ",(0,r.jsx)(n.code,{children:"B"}),"\u3002\u7136\u540E\uFF0C\u58F0\u660E VTA \u7684\u82AF\u7247\u4E0A\u7F13\u51B2\u533A\u7684\u4E2D\u95F4\u5F20\u91CF ",(0,r.jsx)(n.code,{children:"A_buf"})," \u548C ",(0,r.jsx)(n.code,{children:"B_buf"}),"\u3002\u8FD9\u4E2A\u989D\u5916\u7684\u8BA1\u7B97\u9636\u6BB5\u4F7F\u5F97\u80FD\u591F\u663E\u5F0F\u5730\u6682\u5B58\u7F13\u5B58\u7684\u8BFB\u548C\u5199\u3002\u7B2C\u4E09\uFF0C\u63CF\u8FF0\u5BF9 ",(0,r.jsx)(n.code,{children:"A_buf"})," \u548C ",(0,r.jsx)(n.code,{children:"B_buf"})," \u7684\u77E9\u9635\u4E58\u6CD5\u8BA1\u7B97\uFF0C\u4EA7\u751F\u4E58\u79EF\u77E9\u9635 ",(0,r.jsx)(n.code,{children:"C_buf"}),"\u3002\u6700\u540E\u4E00\u4E2A\u64CD\u4F5C\u662F\uFF0C\u5F3A\u5236\u8F6C\u6362\u5E76\u62F7\u8D1D\u56DE DRAM\uFF0C\u8FDB\u5165\u7ED3\u679C\u5F20\u91CF ",(0,r.jsx)(n.code,{children:"C"}),"\u3002"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"/img/docs/uwsampl/web-data/main/vta/tutorial/gemm_dataflow.png",src:t(54407).Z+"",width:"2592",height:"1204"})}),"\n",(0,r.jsx)(n.h3,{id:"\u6570\u636E\u5E03\u5C40",children:"\u6570\u636E\u5E03\u5C40"}),"\n",(0,r.jsxs)(n.p,{children:["\u4EE5\u5E73\u94FA\u6570\u636E\u683C\u5F0F\u63CF\u8FF0\u5360\u4F4D\u7B26\u5F20\u91CF ",(0,r.jsx)(n.code,{children:"A"})," \u548C ",(0,r.jsx)(n.code,{children:"B"}),"\uFF0C\u5339\u914D VTA \u5F20\u91CF core \u63D0\u51FA\u7684\u6570\u636E\u5E03\u5C40\u8981\u6C42\u3002"]}),"\n",(0,r.jsxs)(n.admonition,{type:"note",children:[(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"\u6570\u636E\u5E73\u94FA"})}),(0,r.jsxs)(n.p,{children:["\u76EE\u6807\u52A0\u901F\u5668\u4E4B\u6240\u4EE5\u590D\u6742\uFF0C\u4E00\u4E2A\u5F88\u91CD\u8981\u7684\u539F\u56E0\u5C31\u662F\u9700\u8981\u786E\u4FDD\u6570\u636E\u5E03\u5C40\u4E0E\u52A0\u901F\u5668\u8BBE\u8BA1\u8981\u6C42\u7684\u5E03\u5C40\u76F8\u5339\u914D\u3002VTA \u7684\u8BBE\u8BA1\u4EE5",(0,r.jsx)(n.em,{children:"\u5F20\u91CF core"}),"\u4E3A\u6838\u5FC3\uFF0C\u5B83\u5728\u6FC0\u6D3B\u77E9\u9635\u548C\u6743\u91CD\u77E9\u9635\u4E4B\u95F4\u6BCF\u4E2A\u5468\u671F\u6267\u884C\u4E00\u6B21\u77E9\u9635-\u77E9\u9635\u8FD0\u7B97\uFF0C\u5C06\u7ED3\u679C\u77E9\u9635\u6DFB\u52A0\u5230\u7D2F\u52A0\u5668\u77E9\u9635\uFF0C\u5982\u4E0B\u56FE\u6240\u793A\u3002"]}),(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"/img/docs/uwsampl/web-data/main/vta/tutorial/tensor_core.png",src:t(58664).Z+"",width:"1144",height:"708"})}),(0,r.jsxs)(n.p,{children:["\u5728 ",(0,r.jsx)(n.code,{children:"vta_config.json"})," \u914D\u7F6E\u6587\u4EF6\u4E2D\u6307\u5B9A\u8BE5\u77E9\u9635-\u77E9\u9635\u4E58\u6CD5\u7684\u7EF4\u5EA6\u3002\u6FC0\u6D3B\u77E9\u9635\u7684 shape \u4E3A ",(0,r.jsx)(n.code,{children:"(BATCH, BLOCK_IN)"}),"\uFF0C\u8F6C\u7F6E\u6743\u91CD\u77E9\u9635\u7684 shape \u4E3A ",(0,r.jsx)(n.code,{children:"(BLOCK_OUT, BLOCK_IN)"}),"\uFF0C\u56E0\u6B64\u63A8\u65AD\u751F\u6210\u7684\u8F93\u51FA\u77E9\u9635\u7684 shape \u4E3A ",(0,r.jsx)(n.code,{children:"(BATCH, BLOCK_OUT)"}),"\u3002\u56E0\u6B64\uFF0CVTA \u5904\u7406\u7684\u8F93\u5165\u548C\u8F93\u51FA\u5F20\u91CF\u8981\u6839\u636E\u4E0A\u8FF0\u7EF4\u5EA6\u8FDB\u884C\u5E73\u94FA\u3002"]}),(0,r.jsx)(n.p,{children:"\u4E0B\u56FE\u5C55\u793A\u4E86\u6570\u636E\u5E73\u94FA\u5BF9\u521D\u59CB shape \u4E3A (4, 8) \u7684\u77E9\u9635\u7684\u5F71\u54CD\u3002\u6309 (2, 2) shape \u8FDB\u884C\u5E73\u94FA\u53EF\u786E\u4FDD\u6BCF\u4E2A\u5E73\u94FA\u5185\u7684\u6570\u636E\u662F\u8FDE\u7EED\u7684\u3002\u751F\u6210\u7684\u5E73\u94FA\u5F20\u91CF\u7684 shape \u4E3A (2, 4, 2, 2)\u3002"}),(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"/img/docs/uwsampl/web-data/main/vta/tutorial/data_tiling.png",src:t(84267).Z+"",width:"1972",height:"748"})})]}),"\n",(0,r.jsxs)(n.p,{children:["\u9996\u5148\u5B9A\u4E49\u53D8\u91CF ",(0,r.jsx)(n.code,{children:"m"}),"\u3001",(0,r.jsx)(n.code,{children:"n"}),"\u3001",(0,r.jsx)(n.code,{children:"o"})," \u6765\u8868\u793A\u77E9\u9635\u4E58\u6CD5\u7684 shape\u3002\u8FD9\u4E9B\u53D8\u91CF\u5206\u522B\u662F ",(0,r.jsx)(n.code,{children:"BLOCK_OUT"}),"\u3001",(0,r.jsx)(n.code,{children:"BLOCK_IN"})," \u548C ",(0,r.jsx)(n.code,{children:"BATCH"})," \u5F20\u91CF\u7EF4\u5EA6\u7684\u4E58\u6CD5\u56E0\u5B50\u3002\u914D\u7F6E\u6587\u4EF6\u9ED8\u8BA4\u5C06 ",(0,r.jsx)(n.code,{children:"BATCH"}),"\u3001",(0,r.jsx)(n.code,{children:"BLOCK_IN"})," \u548C ",(0,r.jsx)(n.code,{children:"BLOCK_OUT"})," \u5206\u522B\u8BBE\u7F6E\u4E3A 1\u300116 \u548C 16\uFF08",(0,r.jsx)(n.code,{children:"BATCH"})," \u8BBE\u7F6E\u4E3A 1 \u610F\u5473\u7740\u8BA1\u7B97\u6784\u5EFA\u5757\u662F\u5411\u91CF\u77E9\u9635\u4E58\u6CD5\uFF09\u3002"]}),"\n",(0,r.jsxs)(n.admonition,{type:"note",children:[(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"\u6570\u636E\u7C7B\u578B"})}),(0,r.jsxs)(n.p,{children:["\u4E0D\u4EC5\u8981\u5339\u914D VTA \u5F20\u91CF core \u7684\u5185\u90E8\u5E73\u94FA\u7EF4\u5EA6\uFF0C\u8FD8\u8981\u5339\u914D VTA \u671F\u671B\u7684\u7279\u5B9A\u6570\u636E\u7C7B\u578B\u3002VTA \u76EE\u524D\u4EC5\u652F\u6301\u56FA\u5B9A\u6570\u636E\u7C7B\u578B\uFF0C\u6574\u6570\u5BBD\u5EA6\u5728 ",(0,r.jsx)(n.code,{children:"vta_config.json"})," \u6587\u4EF6\u4E2D\u6307\u5B9A\uFF0C",(0,r.jsx)(n.code,{children:"INP_WIDTH"})," \u548C ",(0,r.jsx)(n.code,{children:"WGT_WIDTH"})," \u5206\u522B\u6307\u5B9A\u6FC0\u6D3B\u548C\u6743\u91CD\u6570\u636E\u7C7B\u578B\u3002\u6B64\u5916\uFF0C\u7D2F\u52A0\u5668\u6570\u636E\u7C7B\u578B\u7684\u6574\u6570\u5BBD\u5EA6\u7531 ",(0,r.jsx)(n.code,{children:"ACC_WIDTH"})," \u6307\u5B9A\u3002"]})]}),"\n",(0,r.jsxs)(n.p,{children:["\u914D\u7F6E\u6587\u4EF6\u9ED8\u8BA4\u5C06 ",(0,r.jsx)(n.code,{children:"INP_WIDTH"})," \u548C ",(0,r.jsx)(n.code,{children:"WGT_WIDTH"})," \u8BBE\u7F6E\u4E3A 8\u3002\u5C06\u7D2F\u52A0\u5668\u5BBD\u5EA6 ",(0,r.jsx)(n.code,{children:"ACC_WIDTH"})," \u8BBE\u7F6E\u4E3A 32\uFF0C\u907F\u514D\u7D2F\u52A0\u65F6\u6EA2\u51FA\u3002\u56E0\u6B64\uFF0C",(0,r.jsx)(n.code,{children:"env.inp_dtype"})," \u548C ",(0,r.jsx)(n.code,{children:"env.wgt_dtype"})," \u90FD\u662F 8 \u4F4D\u7A84\u6574\u6570\uFF0C\u800C ",(0,r.jsx)(n.code,{children:"env.acc_dtype"})," \u662F\u6807\u51C6\u7684 32 \u4F4D\u6574\u6570\u3002"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'# \u8F93\u51FA\u901A\u9053\u56E0\u5B50 m - \u603B\u5171 16x16=256 \u8F93\u51FA\u901A\u9053\nm = 16\n# \u8F93\u5165\u901A\u9053\u56E0\u5B50 n - \u603B\u5171 16x16=256 \u8F93\u5165\u901A\u9053\nn = 16\n# Batch \u56E0\u5B50 o \uFF08\u6211\u4EEC\u4F7F\u7528\u5355\u4E00 batch \u63A8\u65AD\uFF09\no = 1\n# A \u5E73\u94FA\u6570\u636E\u683C\u5F0F\u7684\u5360\u4F4D\u7B26\u5F20\u91CF\nA = te.placeholder((o, n, env.BATCH, env.BLOCK_IN), name="A", dtype=env.inp_dtype))\n# B \u5E73\u94FA\u6570\u636E\u683C\u5F0F\u7684\u5360\u4F4D\u7B26\u5F20\u91CF\nB = te.placeholder((m, n, env.BLOCK_OUT, env.BLOCK_IN), name="B", dtype=env.wgt_dtype))\n# A \u590D\u5236\u7F13\u51B2\u533A\nA_buf = te.compute((o, n, env.BATCH, env.BLOCK_IN), lambda *i: A(*i), "A_buf"))\n# B \u590D\u5236\u7F13\u51B2\u533A\nB_buf = te.compute((m, n, env.BLOCK_OUT, env.BLOCK_IN), lambda *i: B(*i), "B_buf"))\n'})}),"\n",(0,r.jsx)(n.h3,{id:"\u77E9\u9635\u4E58\u6CD5",children:"\u77E9\u9635\u4E58\u6CD5"}),"\n",(0,r.jsxs)(n.p,{children:["\u7528\u53E6\u4E00\u4E2A\u8BA1\u7B97\u64CD\u4F5C\u6765\u63CF\u8FF0\u77E9\u9635\u4E58\u6CD5\u7ED3\u679C\u5F20\u91CF ",(0,r.jsx)(n.code,{children:"C"}),"\u3002\u8BA1\u7B97\u51FD\u6570\u91C7\u7528\u5F20\u91CF\u7684 shape\uFF0C\u4EE5\u53CA\u63CF\u8FF0\u5F20\u91CF\u6BCF\u4E2A\u4F4D\u7F6E\u7684\u8BA1\u7B97\u89C4\u5219\u7684 lambda \u51FD\u6570\u3002"]}),"\n",(0,r.jsxs)(n.p,{children:["\u4E3A\u5B9E\u73B0\u77E9\u9635\u4E58\u6CD5\uFF0Clambda \u51FD\u6570\u8981\u5728\u8F93\u5165\u901A\u9053\u7EF4\u5EA6\u8F74\u4E0A\u5305\u542B\u4E00\u4E2A\u5F52\u7EA6\u516C\u5F0F\u3002\u8981\u521B\u5EFA\u5F52\u7EA6\u516C\u5F0F\uFF0C\u53EF\u4EE5\u7528 ",(0,r.jsx)(n.code,{children:"te.reduce_axis"})," \u58F0\u660E\u5F52\u7EA6\u8F74\uFF0C\u5B83\u63A5\u6536\u5F52\u7EA6\u8303\u56F4\u3002",(0,r.jsx)(n.code,{children:"te.sum"})," \u63A5\u6536\u8981\u5F52\u7EA6\u7684\u8868\u8FBE\u5F0F\u4EE5\u53CA\u5F52\u7EA6\u8F74\uFF0C\u6765\u8BA1\u7B97\u58F0\u660E\u8303\u56F4\u5185\u6240\u6709 k \u503C\u7684\u603B\u548C\u3002"]}),"\n",(0,r.jsxs)(n.p,{children:["\u6CE8\u610F\uFF0C\u8981\u5BF9 32 \u4F4D ",(0,r.jsx)(n.code,{children:"env.acc_dtype"})," \u7D2F\u52A0\u5668\u6570\u636E\u7C7B\u578B\u6267\u884C\u5F52\u7EA6\u3002"]}),"\n",(0,r.jsx)(n.p,{children:"\u8FD9\u4E2A\u9636\u6BB5\u53EA\u58F0\u660E\u5982\u4F55\u8FDB\u884C\u8BA1\u7B97\uFF0C\u4E0D\u4F1A\u53D1\u751F\u4EFB\u4F55\u8BA1\u7B97\u3002"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'# \u5916\u90E8\u8F93\u5165\u7279\u5F81 reduction \u8F74\nko = te.reduce_axis((0, n), name="ko")\n# \u5185\u90E8\u8F93\u5165\u7279\u5F81 reduction \u8F74\nki = te.reduce_axis((0, env.BLOCK_IN), name="ki")\n# \u63CF\u8FF0 in-VTA \u77E9\u9635\u4E58\u6CD5\nC_buf = te.compute(\n    (o, m, env.BATCH, env.BLOCK_OUT),\n    lambda bo, co, bi, ci: te.sum(\n        A_buf[bo, ko, bi, ki].astype(env.acc_dtype) * B_buf[co, ko, ci, ki].astype(env.acc_dtype),\n        axis=[ko, ki],\n    ),\n    name="C_buf",\n)\n'})}),"\n",(0,r.jsx)(n.h3,{id:"\u8F6C\u6362\u7ED3\u679C",children:"\u8F6C\u6362\u7ED3\u679C"}),"\n",(0,r.jsx)(n.p,{children:"\u8BA1\u7B97\u5B8C\u6210\u540E\uFF0C\u5C06 VTA \u8BA1\u7B97\u7684\u7ED3\u679C\u9001\u56DE\u4E3B\u5B58\u3002"}),"\n",(0,r.jsxs)(n.admonition,{type:"note",children:[(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"\u5185\u5B58\u5B58\u50A8\u9650\u5236"})}),(0,r.jsxs)(n.p,{children:["VTA \u7684\u4E00\u4E2A\u7279\u70B9\u662F\u5B83\u53EA\u652F\u6301\u7A84\u7684 ",(0,r.jsx)(n.code,{children:"env.inp_dtype"})," \u6570\u636E\u7C7B\u578B\u683C\u5F0F\u7684 DRAM \u5B58\u50A8\u3002\u8FD9\u53EF\u4EE5\u51CF\u5C11\u5185\u5B58\u4F20\u8F93\u7684\u6570\u636E\u5360\u7528\u65F6\u95F4\uFF0C\u8FD8\u53EF\u4EE5\u5C06\u5BBD\u7D2F\u52A0\u5668\u6570\u636E\u7C7B\u578B\u91CF\u5316\u4E3A\u4E0E\u8F93\u5165\u6FC0\u6D3B\u6570\u636E\u7C7B\u578B\u5339\u914D\u7684\u6570\u636E\u683C\u5F0F\u3002\u8FD9\u610F\u5473\u7740\u5728\u795E\u7ECF\u7F51\u7EDC\u63A8\u7406\u7684\u4E0A\u4E0B\u6587\u4E2D\uFF0C\u6FC0\u6D3B\u540E\u7ED9\u5B9A\u5C42\u7684\u8F93\u51FA\u53EF\u4EE5\u76F4\u63A5\u88AB\u4E0B\u4E00\u5C42\u5229\u7528\u3002"]})]}),"\n",(0,r.jsx)(n.p,{children:"\u5BF9\u7A84\u7684\u8F93\u5165\u6FC0\u6D3B\u6570\u636E\u683C\u5F0F\u6267\u884C\u6700\u540E\u4E00\u4E2A\u7C7B\u578B\u8F6C\u6362\u64CD\u4F5C\u3002"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'# \u8F6C\u6362\u4E3A\u8F93\u51FA\u7C7B\u578B\uFF0C\u5E76\u9001\u5230\u4E3B\u5B58\nC = te.compute(\n    (o, m, env.BATCH, env.BLOCK_OUT), lambda *i: C_buf(*i).astype(env.inp_dtype), name="C"\n)\n'})}),"\n",(0,r.jsx)(n.p,{children:"\u672C\u6559\u7A0B\u7684\u8BA1\u7B97\u58F0\u660E\u90E8\u5206\u5230\u6B64\u7ED3\u675F\u3002"}),"\n",(0,r.jsx)(n.h2,{id:"\u8C03\u5EA6\u8BA1\u7B97",children:"\u8C03\u5EA6\u8BA1\u7B97"}),"\n",(0,r.jsxs)(n.p,{children:["\u867D\u7136\u4E0A\u9762\u63CF\u8FF0\u4E86\u8BA1\u7B97\u89C4\u5219\uFF0C\u4F46\u53EF\u4EE5\u901A\u8FC7\u591A\u79CD\u65B9\u5F0F\u83B7\u5F97 ",(0,r.jsx)(n.code,{children:"C"}),"\u3002 TVM \u8981\u6C42\u7528\u6237\u63D0\u4F9B\u540D\u4E3A ",(0,r.jsx)(n.em,{children:"schedule"})," \u7684\u8BA1\u7B97\u5B9E\u73B0\u3002"]}),"\n",(0,r.jsx)(n.p,{children:"schedule \u662F\u5BF9\u539F\u59CB\u8BA1\u7B97\u7684\u4E00\u7EC4\u8F6C\u6362\uFF0C\u5B83\u5728\u4E0D\u5F71\u54CD\u6B63\u786E\u6027\u7684\u60C5\u51B5\u4E0B\u8F6C\u6362\u8BA1\u7B97\u7684\u5B9E\u73B0\u3002\u8FD9\u4E2A\u7B80\u5355\u7684 VTA \u7F16\u7A0B\u6559\u7A0B\u65E8\u5728\u6F14\u793A\u5C06\u539F\u59CB schedule \u6620\u5C04\u5230 VTA \u786C\u4EF6\u539F\u8BED\u7684\u57FA\u672C schedule \u8F6C\u6362\u3002"}),"\n",(0,r.jsx)(n.h3,{id:"\u9ED8\u8BA4-schedule",children:"\u9ED8\u8BA4 schedule"}),"\n",(0,r.jsxs)(n.p,{children:["\u6784\u5EFA schedule \u540E\uFF0Cschedule \u9ED8\u8BA4\u4EE5\u4E0B\u9762\u7684\u65B9\u5F0F\u8BA1\u7B97 ",(0,r.jsx)(n.code,{children:"C"}),"\uFF1A"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:"# \u751F\u6210\u7684 schedule\ns = te.create_schedule(C.op)\nprint(tvm.lower(s, [A, B, C], simple_mode=True))\n"})}),"\n",(0,r.jsx)(n.p,{children:"\u8F93\u51FA\u7ED3\u679C\uFF1A"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'@main = primfn(A_1: handle, B_1: handle, C_1: handle) -> ()\n  attr = {"from_legacy_te_schedule": True, "global_symbol": "main", "tir.noalias": True}\n  buffers = {A: Buffer(A_2: Pointer(int8), int8, [256], []),\n             B: Buffer(B_2: Pointer(int8), int8, [65536], []),\n             C: Buffer(C_2: Pointer(int8), int8, [256], [])}\n  buffer_map = {A_1: A, B_1: B, C_1: C}\n  preflattened_buffer_map = {A_1: A_3: Buffer(A_2, int8, [1, 16, 1, 16], []), B_1: B_3: Buffer(B_2, int8, [16, 16, 16, 16], []), C_1: C_3: Buffer(C_2, int8, [1, 16, 1, 16], [])} {\n  allocate(A_buf: Pointer(global int8), int8, [256]), storage_scope = global;\n  allocate(B_buf: Pointer(global int8), int8, [65536]), storage_scope = global;\n  allocate(C_buf: Pointer(global int32), int32, [256]), storage_scope = global {\n    for (i1: int32, 0, 16) {\n      for (i3: int32, 0, 16) {\n        let cse_var_1: int32 = ((i1*16) + i3)\n        A_buf_1: Buffer(A_buf, int8, [256], [])[cse_var_1] = A[cse_var_1]\n      }\n    }\n    for (i0: int32, 0, 16) {\n      for (i1_1: int32, 0, 16) {\n        for (i2: int32, 0, 16) {\n          for (i3_1: int32, 0, 16) {\n            let cse_var_2: int32 = ((((i0*4096) + (i1_1*256)) + (i2*16)) + i3_1)\n            B_buf_1: Buffer(B_buf, int8, [65536], [])[cse_var_2] = B[cse_var_2]\n          }\n        }\n      }\n    }\n    for (co: int32, 0, 16) {\n      for (ci: int32, 0, 16) {\n        C_buf_1: Buffer(C_buf, int32, [256], [])[((co*16) + ci)] = 0\n        for (ko: int32, 0, 16) {\n          for (ki: int32, 0, 16) {\n            let cse_var_3: int32 = ((co*16) + ci)\n            C_buf_1[cse_var_3] = (C_buf_1[cse_var_3] + (cast(int32, A_buf_1[((ko*16) + ki)])*cast(int32, B_buf_1[((((co*4096) + (ko*256)) + (ci*16)) + ki)])))\n          }\n        }\n      }\n    }\n    for (i1_2: int32, 0, 16) {\n      for (i3_2: int32, 0, 16) {\n        let cse_var_4: int32 = ((i1_2*16) + i3_2)\n        C[cse_var_4] = cast(int8, C_buf_1[cse_var_4])\n      }\n    }\n  }\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:"\u5C3D\u7BA1\u8FD9\u4E2A schedule \u6709\u610F\u4E49\uFF0C\u4F46\u5B83\u4E0D\u80FD\u7F16\u8BD1\u4E3A VTA\u3002\u4E3A\u83B7\u5F97\u6B63\u786E\u7684\u4EE3\u7801\u751F\u6210\uFF0C\u8981\u5E94\u7528\u8C03\u5EA6\u539F\u8BED\u548C\u4EE3\u7801\u6CE8\u91CA\uFF0C\u5C06 schedule \u8F6C\u6362\u4E3A\u53EF\u4EE5\u76F4\u63A5\u964D\u7EA7\u5230 VTA \u786C\u4EF6\u5185\u8054\u51FD\u6570\u7684 schedule\u3002\u5305\u62EC\uFF1A"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"DMA \u590D\u5236\u64CD\u4F5C\u5C06\u91C7\u7528\u5168\u5C40\u8303\u56F4\u7684\u5F20\u91CF\uFF0C\u5E76\u5C06\u5176\u590D\u5236\u5230\u5C40\u90E8\u8303\u56F4\u7684\u5F20\u91CF\u4E2D\u3002"}),"\n",(0,r.jsx)(n.li,{children:"\u6267\u884C\u77E9\u9635\u4E58\u6CD5\u7684\u5F20\u91CF\u8FD0\u7B97\u3002"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"\u7F13\u51B2\u533A\u8303\u56F4",children:"\u7F13\u51B2\u533A\u8303\u56F4"}),"\n",(0,r.jsxs)(n.p,{children:["\u9996\u5148\uFF0C\u8BBE\u7F6E\u7F13\u51B2\u533A\u7684\u8303\u56F4\uFF0C\u544A\u8BC9 TVM \u8FD9\u4E9B\u7F13\u51B2\u533A\u5C06\u5B58\u5728\u4E8E VTA \u82AF\u7247\u4E0A\u7684 SRAM \u7F13\u5B58\u4E2D\u3002\u63A5\u4E0B\u6765\u544A\u8BC9 TVM\uFF0C",(0,r.jsx)(n.code,{children:"A_buf"}),"\u3001",(0,r.jsx)(n.code,{children:"B_buf"}),"\u3001",(0,r.jsx)(n.code,{children:"C_buf"})," \u5C06\u5206\u522B\u5B58\u5728\u4E8E VTA \u82AF\u7247\u4E0A\u8F93\u5165\u3001\u6743\u91CD\u548C\u7D2F\u52A0\u5668\u5185\u5B58\u4E2D\u3002"]}),"\n",(0,r.jsxs)(n.admonition,{type:"note",children:[(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"VTA \u82AF\u7247\u4E0A\u7684 SRAM"})}),(0,r.jsx)(n.p,{children:"VTA \u5177\u6709\u4E09\u4E2A\u4E0D\u540C\u7684\u5185\u5B58\u8303\u56F4\uFF0C\u6BCF\u4E2A\u8303\u56F4\u5BF9\u5E94\u4E8E\u4E0D\u540C\u82AF\u7247\u4E0A SRAM \u7F13\u51B2\u533A\u3002"}),(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"env.inp_scope"}),"\uFF1A\u8F93\u5165\u7F13\u51B2\u533A\uFF0C\u8FD9\u662F\u4E00\u4E2A\u53EA\u8BFB\u7684 SRAM \u7F13\u51B2\u533A\uFF0C\u7528\u4E8E\u5B58\u50A8 ",(0,r.jsx)(n.code,{children:"env.inp_dtype"})," \u7C7B\u578B\u7684 shape \u4E3A ",(0,r.jsx)(n.code,{children:"(env.BATCH\u3001env.BLOCK_IN)"})," \u7684\u8F93\u5165\u77E9\u9635\u3002\u8F93\u5165\u7F13\u51B2\u533A\u5305\u542B ",(0,r.jsx)(n.em,{children:"2 ^ LOG_INP_BUFF_SIZE"})," \u77E9\u9635\u5143\u7D20\uFF08\u5728 ",(0,r.jsx)(n.code,{children:"vta_config.json"})," \u6587\u4EF6\u4E2D\u6307\u5B9A\uFF09\u3002"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"env.wgt_scope"}),"\uFF1A\u6743\u91CD\u7F13\u51B2\u533A\uFF0C\u8FD9\u662F\u4E00\u4E2A\u53EA\u8BFB\u7684 SRAM \u7F13\u51B2\u533A\uFF0C\u7528\u4E8E\u5B58\u50A8 ",(0,r.jsx)(n.code,{children:"env.wgt_dtype"})," \u7C7B\u578B\u7684 shape \u4E3A ",(0,r.jsx)(n.code,{children:"(env.BLOCK_OUT\uFF0Cenv.BLOCK_IN)"})," \u7684\u6743\u91CD\u77E9\u9635\u3002\u6743\u91CD\u7F13\u51B2\u533A\u5305\u542B ",(0,r.jsx)(n.em,{children:"2 ^ LOG_WGT_BUFF_SIZE"})," \u77E9\u9635\u5143\u7D20\u3002"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"env.acc_scope"}),"\uFF1A\u7D2F\u52A0\u5668\u7F13\u51B2\u533A\uFF0C\u5B83\u662F\u4E00\u4E2A\u8BFB/\u5199 SRAM \u7F13\u51B2\u533A\uFF0C\u7528\u4E8E\u5B58\u50A8 ",(0,r.jsx)(n.code,{children:"env.acc_dtype"})," \u7C7B\u578B\u7684 shape \u4E3A ",(0,r.jsx)(n.code,{children:"(env.BATCH, env.BLOCK_OUT)"})," \u7684\u7D2F\u52A0\u5668\u77E9\u9635\u3002\u7D2F\u52A0\u5668\u7F13\u51B2\u533A\u662F VTA \u7684\u901A\u7528\u5BC4\u5B58\u5668\u6587\u4EF6\uFF1A\u5B83\u4FDD\u5B58\u5377\u79EF\u548C\u77E9\u9635\u4E58\u6CD5\u7684\u4E2D\u95F4\u7ED3\u679C\u4EE5\u53CA\u6C60\u5316\u3001\u6279\u91CF\u5F52\u4E00\u5316\u548C\u6FC0\u6D3B\u5C42\u7684\u4E2D\u95F4\u7ED3\u679C\u3002\u7D2F\u52A0\u5668\u7F13\u51B2\u533A\u5305\u542B ",(0,r.jsx)(n.em,{children:"2 ^ LOG_ACC_BUFF_SIZE"})," \u77E9\u9635\u5143\u7D20\u3002"]}),"\n"]})]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:"# \u5C06\u4E2D\u95F4\u5F20\u91CF\u7684\u8303\u56F4\u8BBE\u7F6E\u4E3A VTA \u7684\u82AF\u7247\u4E0A\u7F13\u51B2\u533A\ns[A_buf].set_scope(env.inp_scope)\ns[B_buf].set_scope(env.wgt_scope)\ns[C_buf].set_scope(env.acc_scope)\n"})}),"\n",(0,r.jsx)(n.p,{children:"\u8F93\u51FA\u7ED3\u679C\uFF1A"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"stage(C_buf, compute(C_buf, body=[reduce(combiner=comm_reducer(result=[(x + y)], lhs=[x], rhs=[y], identity_element=[0]), source=[(int32(A_buf[bo, ko, bi, ki])*int32(B_buf[co, ko, ci, ki]))], init=[], axis=[iter_var(ko, range(min=0, ext=16)), iter_var(ki, range(min=0, ext=16))], where=(bool)1, value_index=0)], axis=[iter_var(bo, range(min=0, ext=1)), iter_var(co, range(min=0, ext=16)), iter_var(bi, range(min=0, ext=1)), iter_var(ci, range(min=0, ext=16))], reduce_axis=[iter_var(ko, range(min=0, ext=16)), iter_var(ki, range(min=0, ext=16))], tag=, attrs={}))\n"})}),"\n",(0,r.jsx)(n.h3,{id:"dma-\u4F20\u8F93",children:"DMA \u4F20\u8F93"}),"\n",(0,r.jsxs)(n.p,{children:["\u8C03\u5EA6 DMA \u4F20\u8F93\uFF0C\u5C06 DRAM \u4E2D\u7684\u6570\u636E\u79FB\u5165\u548C\u79FB\u51FA VTA \u82AF\u7247\u4E0A\u7684\u7F13\u51B2\u533A\u3002\u53EF\u4EE5\u7528 ",(0,r.jsx)(n.code,{children:"compute_at"})," \u8C03\u5EA6\u539F\u8BED\u6765\u5B9E\u73B0\uFF0C\u8BE5\u539F\u8BED\u5C06\u7F13\u51B2\u533A\u7684\u590D\u5236\u5D4C\u5957\u5230\u6267\u884C\u77E9\u9635\u4E58\u6CD5\u7684\u8BA1\u7B97\u5FAA\u73AF\u4E2D\u3002"]}),"\n",(0,r.jsxs)(n.p,{children:["\u63D2\u5165 ",(0,r.jsx)(n.code,{children:"dma_copy"})," \u7F16\u8BD1\u6307\u793A\uFF0C\u5411\u7F16\u8BD1\u5668\u8868\u660E\u590D\u5236\u64CD\u4F5C\u5C06\u901A\u8FC7 DMA \u6279\u91CF\u6267\u884C\uFF0C\u8FD9\u5728\u786C\u4EF6\u52A0\u901F\u5668\u4E2D\u5F88\u5E38\u89C1\u3002\u6700\u540E\uFF0C\u6253\u5370\u4E34\u65F6 schedule\uFF0C\u89C2\u5BDF\u5C06\u590D\u5236\u64CD\u4F5C\u79FB\u52A8\u5230\u77E9\u9635\u4E58\u6CD5\u5FAA\u73AF\u4E2D\u7684\u6548\u679C\u3002"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:"# \u5C06\u7F13\u51B2\u533A\u526F\u672C\u79FB\u52A8\u5230\u77E9\u9635\u4E58\u6CD5\u5FAA\u73AF\u4E2D\ns[A_buf].compute_at(s[C_buf], ko)\ns[B_buf].compute_at(s[C_buf], ko)\n\n# \u4F7F\u7528 DMA pragma \u6807\u8BB0\u7F13\u51B2\u533A\u62F7\u8D1D\uFF0C\u63D2\u5165 DMA \u4F20\u8F93\ns[A_buf].pragma(s[A_buf].op.axis[0], env.dma_copy)\ns[B_buf].pragma(s[B_buf].op.axis[0], env.dma_copy)\ns[C].pragma(s[C].op.axis[0], env.dma_copy)\n\n# \u67E5\u770B\u8F6C\u6362\u540E\u7684 schedule\nprint(tvm.lower(s, [A, B, C], simple_mode=True))\n"})}),"\n",(0,r.jsx)(n.p,{children:"\u8F93\u51FA\u7ED3\u679C\uFF1A"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'@main = primfn(A_1: handle, B_1: handle, C_1: handle) -> ()\n  attr = {"from_legacy_te_schedule": True, "global_symbol": "main", "tir.noalias": True}\n  buffers = {A: Buffer(A_2: Pointer(int8), int8, [256], []),\n             B: Buffer(B_2: Pointer(int8), int8, [65536], []),\n             C: Buffer(C_2: Pointer(int8), int8, [256], [])}\n  buffer_map = {A_1: A, B_1: B, C_1: C}\n  preflattened_buffer_map = {A_1: A_3: Buffer(A_2, int8, [1, 16, 1, 16], []), B_1: B_3: Buffer(B_2, int8, [16, 16, 16, 16], []), C_1: C_3: Buffer(C_2, int8, [1, 16, 1, 16], [])} {\n  allocate(C_buf: Pointer(local.acc_buffer int32), int32, [256]), storage_scope = local.acc_buffer;\n  allocate(A_buf: Pointer(local.inp_buffer int8), int8, [16]), storage_scope = local.inp_buffer;\n  allocate(B_buf: Pointer(local.wgt_buffer int8), int8, [16]), storage_scope = local.wgt_buffer {\n    for (co: int32, 0, 16) {\n      for (ci: int32, 0, 16) {\n        C_buf_1: Buffer(C_buf, int32, [256], [], scope="local.acc_buffer", align=16)[((co*16) + ci)] = 0\n        for (ko: int32, 0, 16) {\n          attr [IterVar(i0: int32, (nullptr), "DataPar", "")] "pragma_dma_copy" = 1;\n          for (i3: int32, 0, 16) {\n            A_buf_1: Buffer(A_buf, int8, [16], [], scope="local.inp_buffer", align=16)[i3] = A[((ko*16) + i3)]\n          }\n          attr [IterVar(i0_1: int32, (nullptr), "DataPar", "")] "pragma_dma_copy" = 1;\n          for (i3_1: int32, 0, 16) {\n            B_buf_1: Buffer(B_buf, int8, [16], [], scope="local.wgt_buffer", align=256)[i3_1] = B[((((co*4096) + (ko*256)) + (ci*16)) + i3_1)]\n          }\n          for (ki: int32, 0, 16) {\n            let cse_var_1: int32 = ((co*16) + ci)\n            C_buf_1[cse_var_1] = (C_buf_1[cse_var_1] + (cast(int32, A_buf_1[ki])*cast(int32, B_buf_1[ki])))\n          }\n        }\n      }\n    }\n    attr [IterVar(i0_2: int32, (nullptr), "DataPar", "")] "pragma_dma_copy" = 1;\n    for (i1: int32, 0, 16) {\n      for (i3_2: int32, 0, 16) {\n        let cse_var_2: int32 = ((i1*16) + i3_2)\n        C[cse_var_2] = cast(int8, C_buf_1[cse_var_2])\n      }\n    }\n  }\n}\n'})}),"\n",(0,r.jsx)(n.h3,{id:"\u5F20\u91CF\u5316",children:"\u5F20\u91CF\u5316"}),"\n",(0,r.jsxs)(n.p,{children:["schedule \u8F6C\u6362\u7684\u6700\u540E\u4E00\u6B65\u662F\uFF0C\u5C06",(0,r.jsx)(n.em,{children:"\u5F20\u91CF\u5316"}),"\u5E94\u7528\u4E8E schedule\u3002\u5F20\u91CF\u5316\u7C7B\u4F3C\u4E8E\u5411\u91CF\u5316\uFF0C\u53EA\u4E0D\u8FC7\u5C06\u6982\u5FF5\u6269\u5C55\u5230\u66F4\u9AD8\u7EF4\u7684\u8BA1\u7B97\u5355\u5143\u3002\u56E0\u6B64\uFF0C\u5F20\u91CF\u5316\u4F1A\u5728\u58F0\u660E\u6570\u636E\u5E03\u5C40\u8F93\u5165\u5360\u4F4D\u7B26\u65F6\uFF0C\u89C4\u5B9A\u6570\u636E\u5E03\u5C40\u7EA6\u675F\uFF0C\u5982\u524D\u6240\u8FF0\u3002\u6211\u4EEC\u5DF2\u7ECF\u7528\u5E73\u94FA\u683C\u5F0F\u6392\u5217\u4E86\u5F20\u91CF\uFF0C\u56E0\u6B64\u63A5\u4E0B\u6765\u5BF9\u5FAA\u73AF\u91CD\u65B0\u6392\u5E8F\uFF0C\u4F7F\u5176\u9002\u5E94\u5F20\u91CF\u5316\u3002"]}),"\n",(0,r.jsxs)(n.p,{children:["\u6301\u7EED\u5C06\u6700\u5916\u9762\u7684 reduction \u8F74\u79FB\u51FA\u3002\u9996\u5148\u8981\u8FED\u4EE3\u8F93\u5165\u901A\u9053\uFF0C\u7136\u540E\u662F batch \u7EF4\u5EA6\uFF0C\u6700\u540E\u662F\u8F93\u51FA\u901A\u9053\u3002\u6700\u540E\uFF0C\u6CBF\u6700\u5185\u5C42\u77E9\u9635-\u77E9\u9635\u4E58\u6CD5\u5F20\u91CF\u5757\u7684\u5916\u8F74\u5E94\u7528\u5F20\u91CF\u8C03\u5EA6\u539F\u8BED ",(0,r.jsx)(n.code,{children:"tensorize"}),"\u3002\u6253\u5370\u6700\u7EC8\u7684 schedule\uFF08\u5373\u5C06\u7531 VTA runtime JIT \u7F16\u8BD1\u5668\u751F\u6210\u4EE3\u7801\uFF09\uFF1A"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:"s[C_buf].reorder(\n    ko, s[C_buf].op.axis[0], s[C_buf].op.axis[1], s[C_buf].op.axis[2], s[C_buf].op.axis[3], ki\n)\ns[C_buf].tensorize(s[C_buf].op.axis[2], env.gemm)\n\n# \u67E5\u770B\u6700\u7EC8\u786E\u5B9A\u7684 schedule\nprint(vta.lower(s, [A, B, C], simple_mode=True))\n"})}),"\n",(0,r.jsx)(n.p,{children:"\u8F93\u51FA\u7ED3\u679C\uFF1A"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'@main = primfn(A_1: handle, B_1: handle, C_1: handle) -> ()\n  attr = {"from_legacy_te_schedule": True, "global_symbol": "main", "tir.noalias": True}\n  buffers = {A: Buffer(A_2: Pointer(int8), int8, [256], []),\n             B: Buffer(B_2: Pointer(int8), int8, [65536], []),\n             C: Buffer(C_2: Pointer(int8), int8, [256], [])}\n  buffer_map = {A_1: A, B_1: B, C_1: C}\n  preflattened_buffer_map = {A_1: A_3: Buffer(A_2, int8, [1, 16, 1, 16], []), B_1: B_3: Buffer(B_2, int8, [16, 16, 16, 16], []), C_1: C_3: Buffer(C_2, int8, [1, 16, 1, 16], [])} {\n  attr [IterVar(vta: int32, (nullptr), "ThreadIndex", "vta")] "coproc_scope" = 2 {\n    attr [IterVar(vta, (nullptr), "ThreadIndex", "vta")] "coproc_uop_scope" = "VTAPushGEMMOp" {\n      @tir.call_extern("VTAUopLoopBegin", 16, 1, 0, 0, dtype=int32)\n      @tir.vta.uop_push(0, 1, 0, 0, 0, 0, 0, 0, dtype=int32)\n      @tir.call_extern("VTAUopLoopEnd", dtype=int32)\n    }\n    @tir.vta.coproc_dep_push(2, 1, dtype=int32)\n  }\n  for (ko: int32, 0, 16) {\n    attr [IterVar(vta, (nullptr), "ThreadIndex", "vta")] "coproc_scope" = 1 {\n      @tir.vta.coproc_dep_pop(2, 1, dtype=int32)\n      @tir.call_extern("VTALoadBuffer2D", @tir.tvm_thread_context(@tir.vta.command_handle(, dtype=handle), dtype=handle), A_2, ko, 1, 1, 1, 0, 0, 0, 0, 0, 2, dtype=int32)\n      @tir.call_extern("VTALoadBuffer2D", @tir.tvm_thread_context(@tir.vta.command_handle(, dtype=handle), dtype=handle), B_2, ko, 1, 16, 16, 0, 0, 0, 0, 0, 1, dtype=int32)\n      @tir.vta.coproc_dep_push(1, 2, dtype=int32)\n    }\n    attr [IterVar(vta, (nullptr), "ThreadIndex", "vta")] "coproc_scope" = 2 {\n      @tir.vta.coproc_dep_pop(1, 2, dtype=int32)\n      attr [IterVar(vta, (nullptr), "ThreadIndex", "vta")] "coproc_uop_scope" = "VTAPushGEMMOp" {\n        @tir.call_extern("VTAUopLoopBegin", 16, 1, 0, 1, dtype=int32)\n        @tir.vta.uop_push(0, 0, 0, 0, 0, 0, 0, 0, dtype=int32)\n        @tir.call_extern("VTAUopLoopEnd", dtype=int32)\n      }\n      @tir.vta.coproc_dep_push(2, 1, dtype=int32)\n    }\n  }\n  @tir.vta.coproc_dep_push(2, 3, dtype=int32)\n  @tir.vta.coproc_dep_pop(2, 1, dtype=int32)\n  attr [IterVar(vta, (nullptr), "ThreadIndex", "vta")] "coproc_scope" = 3 {\n    @tir.vta.coproc_dep_pop(2, 3, dtype=int32)\n    @tir.call_extern("VTAStoreBuffer2D", @tir.tvm_thread_context(@tir.vta.command_handle(, dtype=handle), dtype=handle), 0, 4, C_2, 0, 16, 1, 16, dtype=int32)\n  }\n  @tir.vta.coproc_sync(, dtype=int32)\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:"\u672C\u6559\u7A0B\u7684\u8C03\u5EA6\u90E8\u5206\u5230\u6B64\u7ED3\u675F\u3002"}),"\n",(0,r.jsx)(n.h2,{id:"tvm-\u7F16\u8BD1",children:"TVM \u7F16\u8BD1"}),"\n",(0,r.jsx)(n.p,{children:"\u5728\u5B8C\u6210\u6307\u5B9A schedule \u540E\uFF0C\u53EF\u5C06\u5176\u7F16\u8BD1\u4E3A TVM \u51FD\u6570\u3002"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'# \u6784\u5EFA GEMM VTA \u5185\u6838\nmy_gemm = vta.build(\n    s, [A, B, C], tvm.target.Target("ext_dev", host=env.target_host), name="my_gemm"\n)\n\n# \u5C06\u7F16\u8BD1\u540E\u7684\u6A21\u5757\u5199\u5165\u76EE\u6807\u6587\u4EF6\u3002\ntemp = utils.tempdir()\nmy_gemm.save(temp.relpath("gemm.o"))\n\n# \u901A\u8FC7 RPC \u53D1\u9001\u53EF\u6267\u884C\u6587\u4EF6\nremote.upload(temp.relpath("gemm.o"))\n\n# \u52A0\u8F7D\u7F16\u8BD1\u597D\u7684\u6A21\u5757\nf = remote.load_module("gemm.o")\n'})}),"\n",(0,r.jsx)(n.p,{children:"\u8F93\u51FA\u7ED3\u679C\uFF1A"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'/workspace/python/tvm/driver/build_module.py:267: UserWarning: target_host parameter is going to be deprecated. Please pass in tvm.target.Target(target, host=target_host) instead.\n  "target_host parameter is going to be deprecated. "\n'})}),"\n",(0,r.jsx)(n.h2,{id:"\u8FD0\u884C\u51FD\u6570",children:"\u8FD0\u884C\u51FD\u6570"}),"\n",(0,r.jsx)(n.p,{children:"\u7F16\u8BD1\u597D\u7684 TVM \u51FD\u6570\u4F7F\u7528\u7B80\u6D01\u7684 C API\uFF0C\u53EF\u4EE5\u4ECE\u4EE3\u7801\u8BED\u8A00\u4E2D\u8C03\u7528\u3002"}),"\n",(0,r.jsxs)(n.p,{children:["TVM \u5728 Python \u4E2D\u63D0\u4F9B\u4E86\u4E00\u4E2A\u57FA\u4E8E ",(0,r.jsx)(n.a,{href:"https://github.com/dmlc/dlpack",children:"DLPack"})," \u6807\u51C6\u7684\u6570\u7EC4 API\uFF0C\u5E2E\u52A9\u5FEB\u901F\u6D4B\u8BD5\u548C\u539F\u578B\u8BBE\u8BA1\u3002"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u9996\u5148\u521B\u5EFA\u4E00\u4E2A\u8FDC\u7A0B context\uFF08\u7528\u4E8E\u5728 Pynq \u4E0A\u8FDC\u7A0B\u6267\u884C\uFF09\u3002"}),"\n",(0,r.jsxs)(n.li,{children:["\u7136\u540E ",(0,r.jsx)(n.code,{children:"tvm.nd.array"})," \u76F8\u5E94\u5730\u683C\u5F0F\u5316\u6570\u636E\u3002"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"f()"})," \u8FD0\u884C\u5B9E\u9645\u8BA1\u7B97\u3002"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"numpy()"})," \u4EE5\u53EF\u89E3\u91CA\u7684\u683C\u5F0F\u590D\u5236\u7ED3\u679C\u6570\u7EC4\u3002"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'# \u83B7\u53D6\u8FDC\u7A0B\u8BBE\u5907\u4E0A\u4E0B\u6587\nctx = remote.ext_dev(0)\n\n# \u5728 (-128, 128] \u7684 int \u8303\u56F4\u5185\u968F\u673A\u521D\u59CB\u5316 A \u548C B \u6570\u7EC4\nA_orig = np.random.randint(-128, 128, size=(o * env.BATCH, n * env.BLOCK_IN)).astype(A.dtype)\nB_orig = np.random.randint(-128, 128, size=(m * env.BLOCK_OUT, n * env.BLOCK_IN)).astype(B.dtype)\n\n# \u5C06 A \u548C B \u6570\u7EC4\u4ECE 2D \u6253\u5305\u4E3A 4D \u6253\u5305\u5E03\u5C40\nA_packed = A_orig.reshape(o, env.BATCH, n, env.BLOCK_IN).transpose((0, 2, 1, 3))\nB_packed = B_orig.reshape(m, env.BLOCK_OUT, n, env.BLOCK_IN).transpose((0, 2, 1, 3))\n\n# \u7528 tvm.nd.array \u5C06\u8F93\u5165/\u8F93\u51FA\u6570\u7EC4\u683C\u5F0F\u5316\u4E3A DLPack \u6807\u51C6\nA_nd = tvm.nd.array(A_packed, ctx)\nB_nd = tvm.nd.array(B_packed, ctx)\nC_nd = tvm.nd.array(np.zeros((o, m, env.BATCH, env.BLOCK_OUT)).astype(C.dtype), ctx)\n\n# \u6E05\u9664\u7EDF\u8BA1\nif env.TARGET in ["sim", "tsim"]:\n    simulator.clear_stats()\n\n# \u8C03\u7528\u6A21\u5757\u8FDB\u884C\u8BA1\u7B97\nf(A_nd, B_nd, C_nd)\n'})}),"\n",(0,r.jsx)(n.h2,{id:"\u9A8C\u8BC1\u6B63\u786E\u6027",children:"\u9A8C\u8BC1\u6B63\u786E\u6027"}),"\n",(0,r.jsx)(n.p,{children:"\u7528 numpy \u8BA1\u7B97\u63A8\u7406\u7ED3\u679C\uFF0C\u5F97\u51FA\u7ED3\u8BBA\uFF1A\u77E9\u9635\u4E58\u6CD5\u7684\u8F93\u51FA\u662F\u6B63\u786E\u7684\u3002"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'# \u7528 numpy \u8BA1\u7B97\u53C2\u8003\u7ED3\u679C\nC_ref = np.dot(A_orig.astype(env.acc_dtype), B_orig.T.astype(env.acc_dtype)).astype(C.dtype)\nC_ref = C_ref.reshape(o, env.BATCH, m, env.BLOCK_OUT).transpose((0, 2, 1, 3))\nnp.testing.assert_equal(C_ref, C_nd.numpy())\n\n# \u6253\u5370 stats\nif env.TARGET in ["sim", "tsim"]:\n    sim_stats = simulator.stats()\n    print("Execution statistics:")\n    for k, v in sim_stats.items():\n        print("\\t{:<16}: {:>16}".format(k, v))\n\nprint("Successful matrix multiply test!")\n'})}),"\n",(0,r.jsx)(n.p,{children:"\u8F93\u51FA\u7ED3\u679C\uFF1A"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"Execution statistics:\n        inp_load_nbytes :              256\n        wgt_load_nbytes :            65536\n        acc_load_nbytes :                0\n        uop_load_nbytes :                8\n        out_store_nbytes:              256\n        gemm_counter    :              256\n        alu_counter     :                0\nSuccessful matrix multiply test!\n"})}),"\n",(0,r.jsx)(n.h2,{id:"\u603B\u7ED3",children:"\u603B\u7ED3"}),"\n",(0,r.jsx)(n.p,{children:"\u672C\u6559\u7A0B\u5C55\u793A\u4E86\u5728 VTA \u4E0A\u5B9E\u73B0\u7B80\u5355\u77E9\u9635\u4E58\u6CD5\u793A\u4F8B\u7684 TVM \u5DE5\u4F5C\u6D41\u7A0B\u3002\u4E00\u822C\u5DE5\u4F5C\u6D41\u7A0B\u5305\u62EC\uFF1A"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u901A\u8FC7 RPC \u4F7F\u7528 VTA \u6BD4\u7279\u6D41\u5BF9 FPGA \u8FDB\u884C\u7F16\u7A0B\u3002"}),"\n",(0,r.jsx)(n.li,{children:"\u901A\u8FC7\u4E00\u7CFB\u5217\u8BA1\u7B97\u63CF\u8FF0\u77E9\u9635\u4E58\u6CD5\u3002"}),"\n",(0,r.jsx)(n.li,{children:"\u63CF\u8FF0\u5E0C\u671B\u5982\u4F55\u7528\u8C03\u5EA6\u539F\u8BED\u6267\u884C\u8BA1\u7B97\u3002"}),"\n",(0,r.jsx)(n.li,{children:"\u5C06\u51FD\u6570\u7F16\u8BD1\u4E3A VTA target\u3002"}),"\n",(0,r.jsx)(n.li,{children:"\u8FD0\u884C\u7F16\u8BD1\u597D\u7684\u6A21\u5757\uFF0C\u5E76\u6839\u636E numpy \u5B9E\u73B0\u8FDB\u884C\u9A8C\u8BC1\u3002"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.a,{href:"https://tvm.apache.org/docs/_downloads/de1c160863e8a3826753e987a4138298/matrix_multiply.py",children:"\u4E0B\u8F7D Python \u6E90\u4EE3\u7801\uFF1Amatrix_multiply.py"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.a,{href:"https://tvm.apache.org/docs/_downloads/1ee0b869c5082223c5dfbb0fe4574252/matrix_multiply.ipynb",children:"\u4E0B\u8F7D Jupyter Notebook\uFF1Amatrix_multiply.ipynb"})})]})}function _(e={}){let{wrapper:n}={...(0,s.a)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(l,{...e})}):l(e)}},84267:function(e,n,t){t.d(n,{Z:function(){return i}});let i=t.p+"assets/images/data_tiling-600dc6bef2473ec08d2be56096aedc42.png"},54407:function(e,n,t){t.d(n,{Z:function(){return i}});let i=t.p+"assets/images/gemm_dataflow-f8e85bca952f98bece510e8e69544465.png"},58664:function(e,n,t){t.d(n,{Z:function(){return i}});let i=t.p+"assets/images/tensor_core-c7ed0ab8eb8e2a4db955013fd97c1916.png"},21494:function(e,n,t){t.d(n,{Z:function(){return a},a:function(){return c}});var i=t(39546);let r={},s=i.createContext(r);function c(e){let n=i.useContext(s);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:c(e.components),i.createElement(s.Provider,{value:n},e.children)}}}]);