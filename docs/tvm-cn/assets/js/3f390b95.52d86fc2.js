"use strict";(self.webpackChunktvm_cn=self.webpackChunktvm_cn||[]).push([["35143"],{46789:function(e,t,n){n.r(t),n.d(t,{default:()=>p,frontMatter:()=>a,metadata:()=>r,assets:()=>s,toc:()=>l,contentTitle:()=>c});var r=JSON.parse('{"id":"how_to/microtvm/aot","title":"3. microTVM AoT \u7F16\u8BD1","description":"\u5355\u51FB \u6B64\u5904 \u4E0B\u8F7D\u5B8C\u6574\u7684\u793A\u4F8B\u4EE3\u7801","source":"@site/docs/how_to/microtvm/01-aot.md","sourceDirName":"how_to/microtvm","slug":"/how_to/microtvm/aot","permalink":"/docs/tvm-cn/docs/how_to/microtvm/aot","draft":false,"unlisted":false,"editUrl":"https://github.com/hyperai/tvm-cn/edit/master/docs/how_to/microtvm/01-aot.md","tags":[],"version":"current","lastUpdatedBy":"sparanoid","lastUpdatedAt":1744717810000,"sidebarPosition":1,"frontMatter":{"title":"3. microTVM AoT \u7F16\u8BD1"},"sidebar":"tutorialSidebar","previous":{"title":"\u4F7F\u7528 microTVM","permalink":"/docs/tvm-cn/docs/how_to/microtvm/"},"next":{"title":"6. \u4F7F\u7528 microTVM \u8FDB\u884C\u6A21\u578B\u8C03\u4F18","permalink":"/docs/tvm-cn/docs/how_to/microtvm/autotune_microtvm"}}'),o=n("74132"),i=n("21494");let a={title:"3. microTVM AoT \u7F16\u8BD1"},c="3. microTVM AoT \u7F16\u8BD1",s={},l=[{value:"\u5B89\u88C5 microTVM Python \u4F9D\u8D56\u9879",id:"\u5B89\u88C5-microtvm-python-\u4F9D\u8D56\u9879",level:2},{value:"\u5B89\u88C5 Zephyr",id:"\u5B89\u88C5-zephyr",level:2},{value:"\u5BFC\u5165 Python \u4F9D\u8D56\u9879",id:"\u5BFC\u5165-python-\u4F9D\u8D56\u9879",level:2},{value:"\u5BFC\u5165 TFLite \u6A21\u578B",id:"\u5BFC\u5165-tflite-\u6A21\u578B",level:2},{value:"\u5B9A\u4E49 target",id:"\u5B9A\u4E49-target",level:2},{value:"\u7F16\u8BD1\u6A21\u578B",id:"\u7F16\u8BD1\u6A21\u578B",level:2},{value:"\u521B\u5EFA\u4E00\u4E2A microTVM \u9879\u76EE",id:"\u521B\u5EFA\u4E00\u4E2A-microtvm-\u9879\u76EE",level:2},{value:"\u6784\u5EFA\u3001\u70E7\u5F55\u548C\u6267\u884C\u6A21\u578B",id:"\u6784\u5EFA\u70E7\u5F55\u548C\u6267\u884C\u6A21\u578B",level:2}];function d(e){let t={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",header:"header",p:"p",pre:"pre",strong:"strong",...(0,i.a)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(t.header,{children:(0,o.jsx)(t.h1,{id:"3-microtvm-aot-\u7F16\u8BD1",children:"3. microTVM AoT \u7F16\u8BD1"})}),"\n",(0,o.jsx)(t.admonition,{type:"note",children:(0,o.jsxs)(t.p,{children:["\u5355\u51FB ",(0,o.jsx)(t.a,{href:"https://tvm.apache.org/docs/how_to/work_with_microtvm/micro_aot.html#sphx-glr-download-how-to-work-with-microtvm-micro-aot-py",children:"\u6B64\u5904"})," \u4E0B\u8F7D\u5B8C\u6574\u7684\u793A\u4F8B\u4EE3\u7801"]})}),"\n",(0,o.jsxs)(t.p,{children:[(0,o.jsx)(t.strong,{children:"\u4F5C\u8005"}),"\uFF1A",(0,o.jsx)(t.a,{href:"https://github.com/mehrdadh",children:"Mehrdad Hessar"}),"\uFF0C",(0,o.jsx)(t.a,{href:"https://github.com/alanmacd",children:"Alan MacDonald"})]}),"\n",(0,o.jsx)(t.p,{children:"\u672C\u6559\u7A0B\u5C55\u793A\u4E86 microTVM\uFF08\u4F7F\u7528 TFLite \u6A21\u578B\uFF09\u4E3B\u673A\u9A71\u52A8\u7684 AoT \u7F16\u8BD1\u3002\u4E0E GraphExecutor \u76F8\u6BD4\uFF0CAoTExecutor \u51CF\u5C11\u4E86\u8FD0\u884C\u65F6\u89E3\u6790\u56FE\u7684\u5F00\u9500\u3002\u6B64\u5916\uFF0C\u6211\u4EEC\u53EF\u4EE5\u901A\u8FC7\u63D0\u524D\u7F16\u8BD1\u66F4\u597D\u5730\u8FDB\u884C\u5185\u5B58\u7BA1\u7406\u3002\u672C\u6559\u7A0B\u53EF\u4EE5\u4F7F\u7528 C \u8FD0\u884C\u65F6\uFF08CRT\uFF09\u5728 x86 CPU \u4E0A\u6267\u884C\uFF0C\u4E5F\u53EF\u4EE5\u5728 Zephyr \u652F\u6301\u7684\u5FAE\u63A7\u5236\u5668/\u677F\u4E0A\u7684 Zephyr \u5E73\u53F0\u4E0A\u6267\u884C\u3002"}),"\n",(0,o.jsx)(t.h2,{id:"\u5B89\u88C5-microtvm-python-\u4F9D\u8D56\u9879",children:"\u5B89\u88C5 microTVM Python \u4F9D\u8D56\u9879"}),"\n",(0,o.jsx)(t.p,{children:"TVM \u4E0D\u5305\u542B\u7528\u4E8E Python \u4E32\u884C\u901A\u4FE1\u5305\uFF0C\u56E0\u6B64\u5728\u4F7F\u7528 microTVM \u4E4B\u524D\u6211\u4EEC\u5FC5\u987B\u5148\u5B89\u88C5\u4E00\u4E2A\u3002\u6211\u4EEC\u8FD8\u9700\u8981TFLite\u6765\u52A0\u8F7D\u6A21\u578B\u3002"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:"pip install pyserial==3.5 tflite==2.1\n"})}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-python",children:'import os\n\n\n# \u672C\u6307\u5357\u9ED8\u8BA4\u8FD0\u884C\u5728\u4F7F\u7528 TVM \u7684 C \u8FD0\u884C\u65F6\u7684 x86 CPU \u4E0A\uFF0C\u5982\u679C\u4F60\u60F3\n# \u5728 Zephyr \u5B9E\u673A\u786C\u4EF6\u4E0A\u8FD0\u884C\uFF0C\u4F60\u5FC5\u987B\u5BFC\u5165 `TVM_MICRO_USE_HW` \u73AF\u5883\n# \u53D8\u91CF\u3002\u6B64\u5916\u5982\u679C\u4F60\u4F7F\u7528 C \u8FD0\u884C\u65F6\uFF0C\u4F60\u53EF\u4EE5\u8DF3\u8FC7\u5B89\u88C5 Zephyr\u3002\n# \u5C06\u82B1\u8D39\u5927\u7EA620\u5206\u949F\u5B89\u88C5 Zephyr\u3002\nuse_physical_hw = bool(os.getenv("TVM_MICRO_USE_HW"))\n\n'})}),"\n",(0,o.jsx)(t.h2,{id:"\u5B89\u88C5-zephyr",children:"\u5B89\u88C5 Zephyr"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:'# \u5B89\u88C5 west \u548C ninja\npython3 -m pip install west\napt-get install -y ninja-build\n\n# \u5B89\u88C5 ZephyrProject\nZEPHYR_PROJECT_PATH="/content/zephyrproject"\nexport ZEPHYR_BASE=${ZEPHYR_PROJECT_PATH}/zephyr\nwest init ${ZEPHYR_PROJECT_PATH}\ncd ${ZEPHYR_BASE}\ngit checkout v3.2-branch\ncd ..\nwest update\nwest zephyr-export\nchmod -R o+w ${ZEPHYR_PROJECT_PATH}\n\n# \u5B89\u88C5 Zephyr SDK\ncd /content\nZEPHYR_SDK_VERSION="0.15.2"\nwget "https://github.com/zephyrproject-rtos/sdk-ng/releases/download/v${ZEPHYR_SDK_VERSION}/zephyr-sdk-${ZEPHYR_SDK_VERSION}_linux-x86_64.tar.gz"\ntar xvf "zephyr-sdk-${ZEPHYR_SDK_VERSION}_linux-x86_64.tar.gz"\nmv "zephyr-sdk-${ZEPHYR_SDK_VERSION}" zephyr-sdk\nrm "zephyr-sdk-${ZEPHYR_SDK_VERSION}_linux-x86_64.tar.gz"\n\n# \u5B89\u88C5 python \u4F9D\u8D56\npython3 -m pip install -r "${ZEPHYR_BASE}/scripts/requirements.txt"\n'})}),"\n",(0,o.jsx)(t.h2,{id:"\u5BFC\u5165-python-\u4F9D\u8D56\u9879",children:"\u5BFC\u5165 Python \u4F9D\u8D56\u9879"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-python",children:"import numpy as np\nimport pathlib\nimport json\n\nimport tvm\nfrom tvm import relay\nimport tvm.micro.testing\nfrom tvm.relay.backend import Executor, Runtime\nfrom tvm.contrib.download import download_testdata\n"})}),"\n",(0,o.jsx)(t.h2,{id:"\u5BFC\u5165-tflite-\u6A21\u578B",children:"\u5BFC\u5165 TFLite \u6A21\u578B"}),"\n",(0,o.jsxs)(t.p,{children:["\u9996\u5148\uFF0C\u4E0B\u8F7D\u5E76\u5BFC\u5165 Keyword Spotting TFLite \u6A21\u578B\u3002\u8BE5\u6A21\u578B\u6700\u521D\u6765\u81EA ",(0,o.jsx)(t.a,{href:"https://github.com/mlcommons/tiny",children:"MLPerf Tiny \u4ED3\u5E93"}),"\u3002\u4F7F\u7528 ",(0,o.jsx)(t.a,{href:"https://ai.googleblog.com/2017/08/launching-speech-commands-dataset.html",children:"Google \u63D0\u4F9B\u7684 KWS \u6570\u636E\u96C6\u7684\u6837\u672C"})," \u6765\u6D4B\u8BD5\u8FD9\u4E2A\u6A21\u578B\u3002"]}),"\n",(0,o.jsxs)(t.p,{children:["**\u6CE8\u610F\uFF1A**\u9ED8\u8BA4\u60C5\u51B5\u4E0B\uFF0C\u672C\u6559\u7A0B\u4F7F\u7528 CRT \u5728 x86 CPU \u4E0A\u8FD0\u884C\uFF0C\u82E5\u8981\u5728 Zephyr \u5E73\u53F0\u4E0A\u8FD0\u884C\uFF0C\u9700\u8981\u5BFC\u51FA ",(0,o.jsx)(t.em,{children:"TVM_MICRO_USE_HW"})," \u73AF\u5883\u53D8\u91CF\u3002"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-python",children:'MODEL_URL = "https://github.com/mlcommons/tiny/raw/bceb91c5ad2e2deb295547d81505721d3a87d578/benchmark/training/keyword_spotting/trained_models/kws_ref_model.tflite"\nMODEL_PATH = download_testdata(MODEL_URL, "kws_ref_model.tflite", module="model")\nSAMPLE_URL = "https://github.com/tlc-pack/web-data/raw/main/testdata/microTVM/data/keyword_spotting_int8_6.pyc.npy"\nSAMPLE_PATH = download_testdata(SAMPLE_URL, "keyword_spotting_int8_6.pyc.npy", module="data")\n\ntflite_model_buf = open(MODEL_PATH, "rb").read()\ntry:\n    import tflite\n\n    tflite_model = tflite.Model.GetRootAsModel(tflite_model_buf, 0)\nexcept AttributeError:\n    import tflite.Model\n\n    tflite_model = tflite.Model.Model.GetRootAsModel(tflite_model_buf, 0)\n\ninput_shape = (1, 49, 10, 1)\nINPUT_NAME = "input_1"\nrelay_mod, params = relay.frontend.from_tflite(\n    tflite_model, shape_dict={INPUT_NAME: input_shape}, dtype_dict={INPUT_NAME: "int8"}\n)\n'})}),"\n",(0,o.jsx)(t.h2,{id:"\u5B9A\u4E49-target",children:"\u5B9A\u4E49 target"}),"\n",(0,o.jsxs)(t.p,{children:["\u63A5\u4E0B\u6765\u5B9A\u4E49 target\u3001runtime \u548C executor\u3002\u672C\u6559\u7A0B\u5C06\u8BE6\u7EC6\u4ECB\u7ECD\u4F7F\u7528 AOT \u4E3B\u673A\u9A71\u52A8\u7684\u6267\u884C\u5668\u3002\u8FD9\u91CC\u4F7F\u7528\u7684\u4E3B\u673A\u5FAE target\uFF0C\u5B83\u4F7F\u7528 CRT runtime \u5728 x86 CPU \u4E0A\u8FD0\u884C\u6A21\u578B\uFF0C\u6216\u8005\u5728 qemu_x86 \u6A21\u62DF\u5668\u5355\u677F\u4E0A\u8FD0\u884C\u5E26\u6709 Zephyr \u5E73\u53F0\u7684\u6A21\u578B\u3002\u5BF9\u4E8E\u7269\u7406\u5FAE\u63A7\u5236\u5668\uFF0C\u83B7\u53D6\u7269\u7406\u5355\u677F\uFF08\u4F8B\u5982 nucleo_l4r5zi\uFF09\u7684 target \u6A21\u578B\uFF0C\u5E76\u5C06\u5176\u4FEE\u6539 ",(0,o.jsx)(t.code,{children:"BOARD"})," \u652F\u6301 Zephyr \u5355\u677F\u3002"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-python",children:'# \u4F7F\u7528 C runtime\uFF08crt\uFF09\uFF0C\u5E76\u901A\u8FC7\u5C06 system-lib \u8BBE\u7F6E\u4E3A True \u6765\u542F\u7528\u9759\u6001\u94FE\u63A5\nRUNTIME = Runtime("crt", {"system-lib": True})\n\n# \u5728\u4E3B\u673A\u4E0A\u6A21\u62DF\u4E00\u4E2A\u5FAE\u63A7\u5236\u5668\u3002\u4F7F\u7528\u6765\u81EA `src/runtime/crt/host/main.cc`_ \u7684 main()\u3002\n# \u82E5\u8981\u4F7F\u7528\u7269\u7406\u786C\u4EF6\uFF0C\u8BF7\u5C06\u300Chost\u300D\u66FF\u6362\u4E3A\u4E0E\u4F60\u7684\u786C\u4EF6\u5339\u914D\u7684\u5185\u5BB9\u3002\nTARGET = tvm.micro.testing.get_target("crt")\n\n# \u4F7F\u7528 AOT \u6267\u884C\u5668\uFF0C\u800C\u975E\u8BA1\u7B97\u56FE\u6216\u662F\u865A\u62DF\u673A\u6267\u884C\u5668\u3002\u4E0D\u8981\u4F7F\u7528\u672A\u6253\u5305\u7684 API \u6216 C \u8C03\u7528\u98CE\u683C\u3002\nEXECUTOR = Executor("aot")\n\nif use_physical_hw:\n    BOARD = os.getenv("TVM_MICRO_BOARD", default="nucleo_l4r5zi")\n    SERIAL = os.getenv("TVM_MICRO_SERIAL", default=None)\n    TARGET = tvm.micro.testing.get_target("zephyr", BOARD)\n'})}),"\n",(0,o.jsx)(t.h2,{id:"\u7F16\u8BD1\u6A21\u578B",children:"\u7F16\u8BD1\u6A21\u578B"}),"\n",(0,o.jsx)(t.p,{children:"\u63A5\u4E0B\u6765\u4E3A target \u7F16\u8BD1\u6A21\u578B\uFF1A"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-python",children:'with tvm.transform.PassContext(opt_level=3, config={"tir.disable_vectorize": True}):\n    module = tvm.relay.build(\n        relay_mod, target=TARGET, params=params, runtime=RUNTIME, executor=EXECUTOR\n    )\n'})}),"\n",(0,o.jsx)(t.p,{children:"\u8F93\u51FA\u7ED3\u679C\uFF1A"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:'/workspace/python/tvm/driver/build_module.py:267: UserWarning: target_host parameter is going to be deprecated. Please pass in tvm.target.Target(target, host=target_host) instead.\n  "target_host parameter is going to be deprecated. "\n'})}),"\n",(0,o.jsx)(t.h2,{id:"\u521B\u5EFA\u4E00\u4E2A-microtvm-\u9879\u76EE",children:"\u521B\u5EFA\u4E00\u4E2A microTVM \u9879\u76EE"}),"\n",(0,o.jsx)(t.p,{children:"\u5C06\u7F16\u8BD1\u597D\u7684\u6A21\u578B\u4F5C\u4E3A IRModule\uFF0C\u7136\u540E\u521B\u5EFA\u4E00\u4E2A\u56FA\u4EF6\u9879\u76EE\uFF0C\u5C06\u7F16\u8BD1\u597D\u7684\u6A21\u578B\u4E0E microTVM \u914D\u5408\u4F7F\u7528\u3002\u53EF\u4EE5\u501F\u52A9 Project API \u6765\u5B9E\u73B0\u3002\u6211\u4EEC\u5B9A\u4E49\u4E86 CRT \u548C Zephyr microTVM \u6A21\u677F\u9879\u76EE\uFF0C\u5206\u522B\u7528\u4E8E x86 CPU \u548C Zephyr \u677F\u3002"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-python",children:'template_project_path = pathlib.Path(tvm.micro.get_microtvm_template_projects("crt"))\nproject_options = {}  # \u53EF\u4EE5\u7528\u9009\u9879\u901A\u8FC7 TVM \u63D0\u4F9B\u7279\u5B9A\u4E8E\u5E73\u53F0\u7684\u9009\u9879\u3002\n\nif use_physical_hw:\n    template_project_path = pathlib.Path(tvm.micro.get_microtvm_template_projects("zephyr"))\n    project_options = {\n        "project_type": "host_driven",\n        "board": BOARD,\n        "serial_number": SERIAL,\n        "config_main_stack_size": 4096,\n        "zephyr_base": os.getenv("ZEPHYR_BASE", default="/content/zephyrproject/zephyr"),\n    }\n\ntemp_dir = tvm.contrib.utils.tempdir()\ngenerated_project_dir = temp_dir / "project"\nproject = tvm.micro.generate_project(\n    template_project_path, module, generated_project_dir, project_options\n)\n'})}),"\n",(0,o.jsx)(t.h2,{id:"\u6784\u5EFA\u70E7\u5F55\u548C\u6267\u884C\u6A21\u578B",children:"\u6784\u5EFA\u3001\u70E7\u5F55\u548C\u6267\u884C\u6A21\u578B"}),"\n",(0,o.jsx)(t.p,{children:"\u63A5\u4E0B\u6765\u6784\u5EFA microTVM \u9879\u76EE\uFF0C\u5E76\u5C06\u5176\u70E7\u5F55\u3002Flash \u6B65\u9AA4\u662F\u7279\u5B9A\u4E8E\u7269\u7406\u5FAE\u63A7\u5236\u5668\u7684\u3002\u82E5\u5B83\u901A\u8FC7\u4E3B\u673A main.cc \u6765\u6A21\u62DF\u5FAE\u63A7\u5236\u5668\uFF0C\u6216\u662F\u5C06 Zephyr \u4EFF\u771F\u677F\u4F5C\u4E3A target\uFF0C\u5219\u4F1A\u8DF3\u8FC7\u8BE5\u6B65\u9AA4\u3002\u63A5\u4E0B\u6765\uFF0C\u4E3A\u6A21\u578B\u8F93\u51FA\u5B9A\u4E49\u6807\u7B7E\uFF0C\u5E76\u4F7F\u7528\u671F\u671B\u503C\u4E3A 6 \u7684\u6837\u672C\uFF08label: left\uFF09\u6267\u884C\u6A21\u578B\u3002"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-python",children:'project.build()\nproject.flash()\n\nlabels = [\n    "_silence_",\n    "_unknown_",\n    "yes",\n    "no",\n    "up",\n    "down",\n    "left",\n    "right",\n    "on",\n    "off",\n    "stop",\n    "go",\n]\nwith tvm.micro.Session(project.transport()) as session:\n    aot_executor = tvm.runtime.executor.aot_executor.AotModule(session.create_aot_executor())\n    sample = np.load(SAMPLE_PATH)\n    aot_executor.get_input(INPUT_NAME).copyfrom(sample)\n    aot_executor.run()\n    result = aot_executor.get_output(0).numpy()\n    print(f"Label is `{labels[np.argmax(result)]}` with index `{np.argmax(result)}`")\n#\n# \u8F93\u51FA\uFF1A\n# label \u4E3A `left`\uFF0C\u5176 index \u4E3A `6`\n#\n'})}),"\n",(0,o.jsx)(t.p,{children:"\u8F93\u51FA\u7ED3\u679C\uFF1A"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:"Label is `left` with index `6`\n"})}),"\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.a,{href:"https://tvm.apache.org/docs/v0.13.0/_downloads/f8a7209a0e66b246185bfc41bbc82f54/micro_aot.py",children:"\u4E0B\u8F7D Python \u6E90\u4EE3\u7801\uFF1Amicro_aot.py"})}),"\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.a,{href:"https://tvm.apache.org/docs/v0.13.0/_downloads/c00933f3fbcf90c4f584d54607b33805/micro_aot.ipynb",children:"\u4E0B\u8F7D Jupyter Notebook\uFF1Amicro_aot.ipynb"})})]})}function p(e={}){let{wrapper:t}={...(0,i.a)(),...e.components};return t?(0,o.jsx)(t,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}},21494:function(e,t,n){n.d(t,{Z:function(){return c},a:function(){return a}});var r=n(39546);let o={},i=r.createContext(o);function a(e){let t=r.useContext(i);return r.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function c(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:a(e.components),r.createElement(i.Provider,{value:t},e.children)}}}]);