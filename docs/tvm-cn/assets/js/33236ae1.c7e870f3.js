"use strict";(self.webpackChunktvm_cn=self.webpackChunktvm_cn||[]).push([["86259"],{25684:function(s,n,e){e.r(n),e.d(n,{default:()=>h,frontMatter:()=>c,metadata:()=>t,assets:()=>i,toc:()=>l,contentTitle:()=>o});var t=JSON.parse('{"id":"arch/arch/pass_infra","title":"Pass Infrastructure","description":"Relay \u548C TVM IR \u90FD\u5305\u542B\u4E86\u4E00\u7CFB\u5217\u4F18\u5316 pass\uFF0C\u5B83\u4EEC\u53EF\u63D0\u9AD8\u6A21\u578B\u7684\u6027\u80FD\u6307\u6807\uFF0C\u5982\u5E73\u5747\u63A8\u7406\u3001\u5185\u5B58\u5360\u7528\u6216\u7279\u5B9A\u8BBE\u5907\u7684\u529F\u8017\u3002\u6709\u4E00\u5957\u6807\u51C6\u4F18\u5316\u4EE5\u53CA\u673A\u5668\u5B66\u4E60\u7279\u5B9A\u7684\u4F18\u5316\uFF0C\u5305\u62EC\u5E38\u91CF\u6298\u53E0\u3001\u6B7B\u4EE3\u7801\u6D88\u9664\u3001\u7B97\u5B50\u5E03\u5C40\u66F4\u6539\u3001\u7B97\u5B50\u878D\u5408\u3001buffer \u5904\u7406\u548C\u5FAA\u73AF\u8F6C\u6362\u7B49\u3002\u6BCF\u4E2A pass \u90FD\u88AB\u6784\u9020\u4E3A ir-to-ir \u8F6C\u6362\uFF0C\u5B83\u4EEC\u7528\u904D\u5386\u671F\u95F4\u548C/\u6216\u904D\u5386\u4E4B\u524D\u6536\u96C6\u7684\u5206\u6790\u7ED3\u679C\u8FDB\u884C\u8F6C\u6362\u3002","source":"@site/versioned_docs/version-0.10.0/arch/arch/06-pass_infra.md","sourceDirName":"arch/arch","slug":"/arch/arch/pass_infra","permalink":"/docs/tvm-cn/docs/0.10.0/arch/arch/pass_infra","draft":false,"unlisted":false,"editUrl":"https://github.com/hyperai/tvm-cn/edit/master/versioned_docs/version-0.10.0/arch/arch/06-pass_infra.md","tags":[],"version":"0.10.0","lastUpdatedBy":"sparanoid","lastUpdatedAt":1744717810000,"sidebarPosition":160,"frontMatter":{"title":"Pass Infrastructure","sidebar_position":160},"sidebar":"tutorialSidebar","previous":{"title":"\u8BBE\u5907/Target \u4EA4\u4E92","permalink":"/docs/tvm-cn/docs/0.10.0/arch/arch/device_target_interactions"},"next":{"title":"InferBound Pass","permalink":"/docs/tvm-cn/docs/0.10.0/arch/arch/inferbound"}}'),a=e("74132"),r=e("21494");let c={title:"Pass Infrastructure",sidebar_position:160},o="Pass Infrastructure",i={},l=[{value:"\u8BBE\u8BA1",id:"\u8BBE\u8BA1",level:2},{value:"C++ \u540E\u7AEF",id:"c-\u540E\u7AEF",level:3},{value:"PassContext",id:"passcontext",level:4},{value:"Pass \u6784\u9020",id:"pass-\u6784\u9020",level:4},{value:"\u6A21\u5757\u7EA7 Pass",id:"\u6A21\u5757\u7EA7-pass",level:4},{value:"\u51FD\u6570\u7EA7 Pass",id:"\u51FD\u6570\u7EA7-pass",level:4},{value:"\u987A\u5E8F Pass",id:"\u987A\u5E8F-pass",level:4},{value:"Pass \u6CE8\u518C",id:"pass-\u6CE8\u518C",level:4},{value:"Pass Instrument",id:"pass-instrument",level:4},{value:"\u5185\u7F6E\u5DE5\u5177",id:"\u5185\u7F6E\u5DE5\u5177",level:4},{value:"Python \u524D\u7AEF",id:"python-\u524D\u7AEF",level:3},{value:"PassContext",id:"passcontext-1",level:4},{value:"Pass \u5BF9\u8C61",id:"pass-\u5BF9\u8C61",level:4},{value:"Pass Instrument",id:"pass-instrument-1",level:4},{value:"\u5728\u5F53\u524D PassContext \u4E2D\u8986\u76D6\u5DE5\u5177",id:"\u5728\u5F53\u524D-passcontext-\u4E2D\u8986\u76D6\u5DE5\u5177",level:4}];function d(s){let n={a:"a",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,r.a)(),...s.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.header,{children:(0,a.jsx)(n.h1,{id:"pass-infrastructure",children:"Pass Infrastructure"})}),"\n",(0,a.jsx)(n.p,{children:"Relay \u548C TVM IR \u90FD\u5305\u542B\u4E86\u4E00\u7CFB\u5217\u4F18\u5316 pass\uFF0C\u5B83\u4EEC\u53EF\u63D0\u9AD8\u6A21\u578B\u7684\u6027\u80FD\u6307\u6807\uFF0C\u5982\u5E73\u5747\u63A8\u7406\u3001\u5185\u5B58\u5360\u7528\u6216\u7279\u5B9A\u8BBE\u5907\u7684\u529F\u8017\u3002\u6709\u4E00\u5957\u6807\u51C6\u4F18\u5316\u4EE5\u53CA\u673A\u5668\u5B66\u4E60\u7279\u5B9A\u7684\u4F18\u5316\uFF0C\u5305\u62EC\u5E38\u91CF\u6298\u53E0\u3001\u6B7B\u4EE3\u7801\u6D88\u9664\u3001\u7B97\u5B50\u5E03\u5C40\u66F4\u6539\u3001\u7B97\u5B50\u878D\u5408\u3001buffer \u5904\u7406\u548C\u5FAA\u73AF\u8F6C\u6362\u7B49\u3002\u6BCF\u4E2A pass \u90FD\u88AB\u6784\u9020\u4E3A ir-to-ir \u8F6C\u6362\uFF0C\u5B83\u4EEC\u7528\u904D\u5386\u671F\u95F4\u548C/\u6216\u904D\u5386\u4E4B\u524D\u6536\u96C6\u7684\u5206\u6790\u7ED3\u679C\u8FDB\u884C\u8F6C\u6362\u3002"}),"\n",(0,a.jsx)(n.p,{children:"TVM \u7684\u5FEB\u901F\u53D1\u5C55\u50AC\u751F\u66F4\u52A0\u7CFB\u7EDF\u5316\u548C\u6709\u6548\u7684\u65B9\u5F0F\uFF0C\u6765\u7BA1\u7406\u8FD9\u4E9B pass\u3002\u6B64\u5916\uFF0C\u7BA1\u7406 TVM \u5806\u6808\u4E0D\u540C\u5C42\uFF08\u4F8B\u5982 Relay \u548C tir\uFF09pass \u7684\u901A\u7528\u6846\u67B6\u6781\u5927\u4FBF\u5229\u4E86\u5F00\u53D1\u8005\uFF0C\u4F7F\u4ED6\u4EEC\u53EF\u4EE5\u5FEB\u901F\u539F\u578B\u5316\u5E76\u5C06\u5B9E\u73B0\u7684 pass \u63D2\u5165\u81F3\u7CFB\u7EDF\u3002"}),"\n",(0,a.jsx)(n.p,{children:"\u8BE5\u6587\u6863\u63CF\u8FF0\u4E86\u4E00\u4E2A infra \u7684\u8BBE\u8BA1\u2014\u2014\u5229\u7528\u751F\u4EA7\u7F16\u8BD1\u5668\u6765\u7BA1\u7406\u4F18\u5316 pass \u7684\u65B9\u5F0F\uFF0C\u4EE5\u53CA\u7528\u4E8E\u6784\u5EFA\u5C42\u7684\u73B0\u4EE3\u6DF1\u5EA6\u5B66\u4E60\u6846\u67B6\u7684\u98CE\u683C\u3002"}),"\n",(0,a.jsx)(n.p,{children:"\u4F8B\u5982\uFF0C\u8BB8\u591A\u73B0\u6709\u7684\u751F\u4EA7\u7F16\u8BD1\u5668\uFF0C\u5982 GCC \u548C LLVM\uFF0C\u90FD\u4F7F\u7528 pass \u7BA1\u7406\u5668\u6765\u6709\u6548\u5730\u7BA1\u7406 pass \u7684\u6267\u884C\u3002\u6700\u521D\u7BA1\u7406 pass \u5F88\u7B80\u5355\uFF0C\u56E0\u4E3A pass \u7684\u6570\u91CF\u5F88\u5C11\uFF0C\u4F46\u6210\u719F\u7684\u7F16\u8BD1\u5668\u5305\u542B\u6570\u767E\u4E2A\u5355\u72EC\u7684 pass\u3002\u5916\u90E8\u7528\u6237\u901A\u5E38\u5E0C\u671B\u6B63\u786E\u8C03\u5EA6\u81EA\u5B9A\u4E49 pass\uFF0C\u800C\u65E0\u9700\u4FEE\u6539\u5355\u4E2A\u624B\u5DE5\u5236\u4F5C\u7684 pass \u987A\u5E8F\u3002"}),"\n",(0,a.jsxs)(n.p,{children:["\u7C7B\u4F3C\u5730\uFF0C\u73B0\u4EE3\u6DF1\u5EA6\u5B66\u4E60\u6846\u67B6\uFF0C\u5982 Pytorch \u548C MXNet Gluon\uFF0C\u4E5F\u503E\u5411\u4E8E\u5206\u522B\u901A\u8FC7 ",(0,a.jsx)(n.a,{href:"https://pytorch.org/docs/stable/nn.html?highlight=sequential#torch.nn.Sequential",children:"Sequential"})," \u548C ",(0,a.jsx)(n.a,{href:"https://mxnet.apache.org/api/python/docs/api/gluon/block.html#gluon-block",children:"Block"})," \u5B9E\u73B0 pass \u6A21\u5F0F\u7684\u5C42\u6784\u5EFA\u65B9\u6848\u3002\u5F97\u5230\u4E86\u8FD9\u6837\u7684\u7ED3\u6784\u540E\uFF0C\u8FD9\u4E9B\u73B0\u4EE3\u6846\u67B6\u80FD\u591F\u65B9\u4FBF\u5730\u5C06\u6A21\u5757/\u5C42\u6DFB\u52A0\u5230\u5BB9\u5668\u4E2D\uFF0C\u5E76\u8F7B\u677E\u5730\u6784\u5EFA\u795E\u7ECF\u7F51\u7EDC\u3002"]}),"\n",(0,a.jsx)(n.p,{children:"Relay pass infra \u7684\u8BBE\u8BA1\uFF0C\u5F88\u5927\u7A0B\u5EA6\u4E0A\u662F\u53D7\u5230 LLVM \u4E2D\u4F7F\u7528\u7684\u5206\u5C42 pass \u7BA1\u7406\u5668\uFF0C\u4EE5\u53CA\u6D41\u884C\u7684\u6DF1\u5EA6\u5B66\u4E60\u6846\u67B6\u4E2D\u4F7F\u7528\u7684\u5757\u5F0F\u5BB9\u5668\u7684\u542F\u53D1\u3002Pass infra \u7684\u4E3B\u8981\u76EE\u6807\uFF1A"}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsx)(n.li,{children:"\u5B9E\u73B0\u66F4\u597D\u7684\u4F18\u5316\u7A0B\u5E8F\u7F16\u6392\u3002\u7528\u6237\u53EF\u4EE5\u7075\u6D3B\u5730\u5B9A\u5236\u548C\u6784\u5EFA\u81EA\u5DF1\u7684\u4F18\u5316 pipeline\u3002"}),"\n",(0,a.jsx)(n.li,{children:"\u63D0\u4F9B\u4E00\u79CD\u5BF9\u7528\u6237\u66F4\u53CB\u597D\u7684\u65B9\u5F0F\u6765\u8C03\u8BD5\u4F18\u5316 pass\u3002"}),"\n",(0,a.jsx)(n.li,{children:"\u51CF\u8F7B\u5F00\u53D1\u8005\u624B\u52A8\u89E3\u51B3 pass \u4E4B\u95F4\u7684\u4F9D\u8D56\u5173\u7CFB\u7684\u5DE5\u4F5C\u91CF\u3002"}),"\n",(0,a.jsx)(n.li,{children:"\u4E3A\u5F00\u53D1\u8005\u7B80\u5316\u65B0 pass \u7684\u5B9E\u73B0\u3002\u5141\u8BB8\u7528\u6237\u5728 Python \u4E2D\u5B9E\u73B0 pass\uFF0C\u5E76\u8BA9 pass \u57FA\u7840\u67B6\u6784\u64CD\u7EB5\u5176\u6267\u884C\u3002"}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"\u8BBE\u8BA1",children:"\u8BBE\u8BA1"}),"\n",(0,a.jsx)(n.p,{children:"\u805A\u7126\u7528\u6237\u6269\u5C55\u7684\u7B80\u6613\u6027\uFF0C\u4F7F\u7528\u6237\u53EF\u4EE5\u5FEB\u901F\u6DFB\u52A0\u65B0\u7684 pass\uFF0C\u4E14\u5411\u540E\u517C\u5BB9\u3002\u8BBE\u8BA1\u5305\u542B\u540E\u7AEF\u548C\u524D\u7AEF\u3002\u524D\u8005\uFF08\u5373\u540E\u7AEF\uFF09\u5B9E\u73B0\u4E86 pass infra \u7684\u4E3B\u8981\u903B\u8F91\u3002\u540E\u8005\uFF08\u5373\u524D\u7AEF\uFF09\u4E3A\u7528\u6237\u63D0\u4F9B\u7B80\u5355\u7684 API \u8FDB\u884C\u4EA4\u4E92\uFF0C\u5141\u8BB8\u7528\u6237\u5FEB\u901F\u521B\u5EFA\u81EA\u5DF1\u7684\u4F18\u5316 pipeline\u3002"}),"\n",(0,a.jsx)(n.h3,{id:"c-\u540E\u7AEF",children:"C++ \u540E\u7AEF"}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.code,{children:"PassInfo"})," \u5BF9\u8C61\u5305\u542B\u4E00\u4E2A pass \u6240\u9700\u7684\u57FA\u672C\u4FE1\u606F\uFF0C\u5176\u4E2D ",(0,a.jsx)(n.code,{children:"name"})," \u662F pass \u540D\u79F0\uFF0C",(0,a.jsx)(n.code,{children:"opt_level"})," \u8868\u793A\u5C06\u5728\u54EA\u4E2A\u4F18\u5316\u7EA7\u522B\u542F\u7528 pass\uFF0C",(0,a.jsx)(n.code,{children:"required"})," \u8868\u793A\u6267\u884C\u67D0\u4E2A pass \u6240\u9700\u7684 pass\uFF08\u6709\u5173\u8BE6\u7EC6\u4FE1\u606F\uFF0C\u53C2\u9605 ",(0,a.jsx)(n.a,{href:"https://github.com/apache/tvm/blob/main/include/tvm/ir/transform.h",children:"include/tvm/ir/transform.h"}),"\uFF09\u3002\u4F8B\u5982\uFF0C\u5728\u6CE8\u518C pass  \u671F\u95F4\uFF08\u7A0D\u540E\u4ECB\u7ECD\uFF09\uFF0Cpass \u5F00\u53D1\u8005\u53EF\u4EE5\u6307\u5B9A pass \u7684\u540D\u79F0\u3001\u6267\u884C\u7684\u4F18\u5316\u7EA7\u522B\u548C/\u6216\u6240\u9700\u7684 pass\u3002",(0,a.jsx)(n.code,{children:"opt_level"})," \u53EF\u5E2E\u52A9 pass infra \u8BC6\u522B\u5728\u7528\u6237\u63D0\u4F9B\u7684\u4F18\u5316\u7EA7\u522B\u4E0B\u8FD0\u884C\u65F6\uFF0C\u662F\u5426\u9700\u8981\u6267\u884C\u67D0\u4E2A pass\u3002pass infra \u53EF\u4EE5\u7528 ",(0,a.jsx)(n.code,{children:"required"})," \u5B57\u6BB5\u6765\u89E3\u51B3 pass \u4F9D\u8D56\u3002"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-c++",children:"class PassInfoNode : public Object {\n  String name;\n  int opt_level;\n  Array<String> required;\n};\n"})}),"\n",(0,a.jsx)(n.h4,{id:"passcontext",children:"PassContext"}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.code,{children:"PassContext"})," \u5177\u5907\u4F18\u5316 pass \u7684\u6709\u7528\u4FE1\u606F\u3002\u4F8B\u5982\uFF0C\u5B83\u5305\u542B\u9519\u8BEF\u62A5\u544A\u7CFB\u7EDF\uFF0C\u53EF\u4EE5\u63D0\u4F9B\u4F18\u5316\u5931\u8D25\u539F\u56E0\u7684\u8BCA\u65AD\u3002 ",(0,a.jsx)(n.code,{children:"PassContext"})," \u7528\u6765\u66FF\u6362\u65E7\u7684 ",(0,a.jsx)(n.code,{children:"BuildConfig"}),"\uFF0C",(0,a.jsx)(n.code,{children:"BuildConfig"})," \u7528\u4E8E\u5E2E\u52A9\u7528\u6237\u914D\u7F6E\u7F16\u8BD1\u9009\u9879\uFF0C\u5305\u62EC\u4F18\u5316\u7EA7\u522B\u548C\u5FC5\u9700/\u7981\u7528\u7684 pass \u7B49\u3002\u4F8B\u5982\uFF0C\u6709\u4E00\u4E2A\u914D\u7F6E\uFF0C\u5728 ",(0,a.jsx)(n.code,{children:"opt_level=3"})," \u6267\u884C\u6240\u6709 pass \uFF0C\u540C\u65F6\u7528 ",(0,a.jsx)(n.code,{children:"PassContext"})," \u63D0\u4F9B\u7684 ",(0,a.jsx)(n.code,{children:"disabled_pass=xx"})," \u6765\u7981\u7528\u4E00\u4E9B pass \u3002\u5728 ",(0,a.jsx)(n.code,{children:"opt_level=3"})," \u5904\u5168\u5C40\u5316\u6240\u6709 pass \uFF0C\u5E76\u6392\u9664\u7981\u7528 pass \u5217\u8868\u4E2D\u7684\u6240\u6709 pass\u3002",(0,a.jsx)(n.code,{children:"PassContext"})," \u8FD8\u63D0\u4F9B\u4E86\u4E00\u79CD\u68C0\u6D4B\u6240\u6709 pass \u7684\u65B9\u6CD5\u3002\u53C2\u9605 ",(0,a.jsx)(n.a,{href:"https://tvm.apache.org/docs/arch/pass_infra.html#pass-instrument-cpp-backend",children:"Pass Instrument"})," \u8FD9\u4E00\u8282\u3002"]}),"\n",(0,a.jsxs)(n.p,{children:["\u7528\u6237\u53EF\u4EE5\u7528\u8FD9\u4E2A\u7C7B\u7F16\u5199 Python ",(0,a.jsx)(n.code,{children:"with"})," \u8BED\u6CD5\uFF0C\u4ECE\u800C\u5728\u4E00\u5B9A\u7684\u914D\u7F6E\u4E0B\u8FDB\u884C\u4F18\u5316\u3002\u6B64\u5916\uFF0C\u7528\u6237\u53EF\u4EE5\u901A\u8FC7 ",(0,a.jsx)(n.code,{children:"PassContext::Current()"})," \u4EE5\u7EBF\u7A0B\u5B89\u5168\u7684\u65B9\u5F0F\u83B7\u53D6\u67D0\u4E2A\u7A0B\u5E8F\u8303\u56F4\u5185\u53EF\u7528\u7684\u4E0A\u4E0B\u6587\uFF0C\u56E0\u4E3A\u7EBF\u7A0B\u672C\u5730\u5B58\u50A8\u7684 ",(0,a.jsx)(n.code,{children:"PassContextThreadLocalStore"})," \u7528\u4E8E\u4FDD\u5B58\u521B\u5EFA\u7684 pass \u4E0A\u4E0B\u6587\u5BF9\u8C61\u3002\u7A0D\u540E\u7528\u793A\u4F8B\u6765\u5C55\u793A\u5982\u4F55\u7528 C++ \u548C Python API \u6765\u901A\u8FC7 pass \u4E0A\u4E0B\u6587\u521B\u5EFA\u7F16\u8BD1 pipeline\u3002"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-c++",children:"class PassContextNode : public Object {\n public:\n  int opt_level{2};\n  tvm::Array<tvm::Expr> required_pass;\n  tvm::Array<tvm::Expr> disabled_pass;\n  mutable Optional<DiagnosticContext> diag_ctx;\n  Map<String, ObjectRef> config;\n  Array<instrument::PassInstrument> instruments;\n};\n\nclass PassContext : public NodeRef {\n public:\n  TVM_DLL static PassContext Create();\n  TVM_DLL static PassContext Current();\n  TVM_DLL void InstrumentEnterPassContext();\n  TVM_DLL void InstrumentExitPassContext();\n  TVM_DLL bool InstrumentBeforePass(const IRModule& mod, const PassInfo& info) const;\n  TVM_DLL void InstrumentAfterPass(const IRModule& mod, const PassInfo& info) const;\n  /* \u7701\u7565\u5176\u4ED6\u5B57\u6BB5\u3002 */\n\n private:\n  // pass \u4E0A\u4E0B\u6587\u8303\u56F4\u7684\u5165\u53E3\u3002\n  TVM_DLL void EnterWithScope();\n  // pass \u4E0A\u4E0B\u6587\u8303\u56F4\u7684\u9000\u51FA\u3002\n  TVM_DLL void ExitWithScope();\n\n  // \u83B7\u53D6 Python `with` \u8BED\u6CD5\u7684\u7C7B\u3002\n  friend class tvm::With<PassContext>;\n};\n\nstruct PassContextThreadLocalEntry {\n  /*\uFF01 \\\u6458\u8981\uFF1A\u9ED8\u8BA4 pass \u4E0A\u4E0B\u6587\u3002 */\n  PassContext default_context;\n  /*! \\\u6458\u8981\uFF1A\u5F53\u524D pass \u4E0A\u4E0B\u6587 */\n  std::stack<PassContext> context_stack;\n  PassContextThreadLocalEntry() {\n    default_context = PassContext(make_node<PassContextNode>());\n  }\n};\n\n/*\uFF01 \u4FDD\u5B58 pass \u4E0A\u4E0B\u6587\u7684\u7EBF\u7A0B\u672C\u5730\u5B58\u50A8 */\ntypedef dmlc::ThreadLocalStore<PassContextThreadLocalEntry>\n     PassContextThreadLocalStore;\n"})}),"\n",(0,a.jsx)(n.h4,{id:"pass-\u6784\u9020",children:"Pass \u6784\u9020"}),"\n",(0,a.jsxs)(n.p,{children:["pass infra \u4EE5\u5206\u5C42\u7684\u65B9\u5F0F\u8BBE\u8BA1\uFF0C\u53EF\u4EE5\u5728\u4E0D\u540C\u7C92\u5EA6\u7684 Relay/tir \u7A0B\u5E8F\u4E0B\u5DE5\u4F5C\u3002\u6211\u4EEC\u5F15\u5165\u4E00\u4E2A\u7EAF\u865A\u7C7B ",(0,a.jsx)(n.code,{children:"PassNode"}),"\uFF0C\u4F5C\u4E3A\u4E0D\u540C\u4F18\u5316 pass \u7684\u57FA\u7840\u3002\u8FD9\u4E2A\u7C7B\u5305\u542B\u51E0\u4E2A\u5FC5\u987B\u7531\u5B50\u7C7B\u5728\u6A21\u5757\u3001\u51FD\u6570\u6216 pass \u5E8F\u5217\u7EA7\u522B\u5B9E\u73B0\u7684\u865A\u62DF\u65B9\u6CD5\u3002"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-c++",children:"class PassNode : Object {\n  virtual PassInfo Info() const = 0;\n  virtual Module operator()(const IRModule& mod\n                            const PassContext& pass_ctx) const = 0;\n};\n"})}),"\n",(0,a.jsxs)(n.p,{children:["\u4EFF\u51FD\u6570\u5C55\u793A\u4E86 pass \u662F\u5982\u4F55\u5B9E\u73B0\u7684\uFF0C\u5373\u5B83\u59CB\u7EC8\u5728\u7279\u5B9A\u4E0A\u4E0B\u6587\u5BF9 ",(0,a.jsx)(n.code,{children:"IRModule"})," \u8D77\u4F5C\u7528\u3002\u6240\u6709 pass  \u90FD\u4EE5 ",(0,a.jsx)(n.code,{children:"Module"})," \u5230 ",(0,a.jsx)(n.code,{children:"Module"})," \u7684\u65B9\u5F0F\u8BBE\u8BA1\u3002\u56E0\u6B64\uFF0C\u7531 pass infra \u7BA1\u7406\u7684\u4F18\u5316\u5C06\u59CB\u7EC8\u66F4\u65B0\u6574\u4E2A\u6A21\u5757\u3002"]}),"\n",(0,a.jsxs)(n.p,{children:["\u5DF2\u7ECF\u521B\u5EFA\u4E86\u51E0\u4E2A\u5B50\u7C7B\u6765\u5B9E\u73B0\u4E0D\u540C\u7C7B\u578B\u7684\u4F18\u5316 pass\uFF0C\u4F8B\u5982\uFF0C\u51FD\u6570\u7EA7 pass\u3001\u6A21\u5757\u7EA7 pass \u548C\u987A\u5E8F pass\u3002\u6BCF\u4E2A\u5B50\u7C7B\u672C\u8EAB\u90FD\u53EF\u4EE5\u5145\u5F53 pass \u7BA1\u7406\u5668\u3002\u4F8B\u5982\uFF0C\u5B83\u4EEC\u53EF\u4EE5\u6536\u96C6\u6240\u9700\u7684 pass \u5E76\u6267\u884C\uFF0C\u6216\u662F\u57FA\u4E8E\u7ED9\u5B9A\u7684\u5143\u6570\u636E\u6784\u5EFA\u4F9D\u8D56\u5173\u7CFB\u56FE\u3002\u8BBF\u95EE ",(0,a.jsx)(n.a,{href:"https://github.com/apache/tvm/blob/main/src/relay/ir/transform.cc",children:"src/relay/ir/transform.cc"})," \u548C ",(0,a.jsx)(n.a,{href:"https://github.com/apache/tvm/blob/main/src/ir/transform.cc",children:"src/ir/transform.cc"}),"\uFF0C\u67E5\u770B\u5B8C\u6574\u5B9A\u4E49\u3002"]}),"\n",(0,a.jsx)(n.h4,{id:"\u6A21\u5757\u7EA7-pass",children:"\u6A21\u5757\u7EA7 Pass"}),"\n",(0,a.jsx)(n.p,{children:"\u6A21\u5757\u7EA7 pass \u4E3B\u8981\u9488\u5BF9\u5168\u5C40\u548C\u8FC7\u7A0B\u95F4\u4F18\u5316\uFF08IPO\uFF09\uFF0C\u7C7B\u4F3C\u4E8E LLVM \u4E2D\u7684\u6A21\u5757 pass\u3002Relay \u4E2D\u4E00\u4E9B\u9700\u8981\u6A21\u5757\u5168\u5C40\u56FE\u7684\u5178\u578B pass\uFF0C\u5982 A-normal form \u8F6C\u6362\u548C lambda \u63D0\u5347\u7B49\uFF0C\u90FD\u5C5E\u4E8E\u8FD9\u4E2A\u96C6\u5408\u3002\u5728\u8FD9\u4E2A\u7EA7\u522B\uFF0C\u7528\u6237\u751A\u81F3\u53EF\u4EE5\u5728\u6A21\u5757\u4E2D\u6DFB\u52A0\u548C/\u6216\u5220\u9664\u529F\u80FD\u3002\u6CE8\u610F\uFF0C\u662F\u6240\u6709 pass\u3002"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-c++",children:"class ModulePassNode : PassNode {\n  PassInfo pass_info;\n  runtime::TypedPackedFunc<Module(Module, PassContext)> pass_func;\n  Module operator()(const Module& mod, const PassContext& pass_ctx) const final;\n  // \u5176\u4ED6\u6210\u5458/\u65B9\u6CD5\u7701\u7565\n};\n"})}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.code,{children:"pass_info"})," \u7EF4\u62A4\u6A21\u5757\u7EA7 pass \u6240\u9700\u7684\u4FE1\u606F\u3002",(0,a.jsx)(n.code,{children:"pass_func"})," \u63CF\u8FF0\u771F\u6B63\u7684\u4F18\u5316\u3002\u4F8B\u5982\uFF0C\u53EF\u80FD\u9700\u8981\u6D88\u9664\u6A21\u5757\u7684\u6B7B\u4EE3\u7801\u3002\u53EF\u5728 ",(0,a.jsx)(n.code,{children:"pass_func"})," \u4E2D\u5B9E\u73B0\u7B97\u6CD5\uFF0C\u5E76\u8BA9\u5B83\u5728\u6A21\u5757\u4E0A\u8FD0\u884C\u3002\u7136\u540E\u5B83\u5C06\u5220\u9664\u6B7B\u4EE3\u7801\uFF0C\u5305\u62EC\u6A21\u5757\u4E2D\u672A\u4F7F\u7528\u7684\u51FD\u6570\u3002\u6CE8\u610F\uFF0C\u8BE5\u5B57\u6BB5\u88AB\u8BBE\u8BA1\u4E3A\u4E00\u4E2A\u6253\u5305\u51FD\u6570\uFF0C\u53EF\u4EE5\u5728 C++ \u548C Python \u4E2D\u5B9E\u73B0\u4F18\u5316\u3002"]}),"\n",(0,a.jsx)(n.h4,{id:"\u51FD\u6570\u7EA7-pass",children:"\u51FD\u6570\u7EA7 Pass"}),"\n",(0,a.jsxs)(n.p,{children:["\u51FD\u6570\u7EA7 pass \u7528\u4E8E\u5BF9\u7ED9\u5B9A\u7684 Relay/tir \u6A21\u5757\u8FDB\u884C\u5404\u79CD\u51FD\u6570\u5185\u7684\u4F18\u5316\u3002\u5B83\u6BCF\u6B21\u4ECE\u6A21\u5757\u7684\u51FD\u6570\u5217\u8868\u4E2D\u83B7\u53D6\u4E00\u4E2A\u51FD\u6570\u8FDB\u884C\u4F18\u5316\uFF0C\u5E76\u4EA7\u751F\u4E00\u4E2A\u91CD\u5199\u7684 Relay ",(0,a.jsx)(n.code,{children:"Function"})," \u6216 tir ",(0,a.jsx)(n.code,{children:"PrimFunc"}),"\u3002\u5927\u90E8\u5206 pass \u90FD\u53EF\u4EE5\u5F52\u4E3A\u8FD9\u4E00\u7C7B\uFF0C\u6BD4\u5982 Relay \u4E2D\u5E38\u89C1\u7684\u5B50\u8868\u8FBE\u5F0F\u6D88\u9664\u548C\u63A8\u7406\u7B80\u5316\uFF0C\u4EE5\u53CA tir \u4E2D\u7684\u5411\u91CF\u5316\u548C\u5C55\u5E73\u5B58\u50A8\u7B49\u3002"]}),"\n",(0,a.jsx)(n.p,{children:"\u6CE8\u610F\uFF0C\u8FD9\u4E2A\u7EA7\u522B\u7684 pass \u8303\u56F4\u662F Relay \u51FD\u6570\u6216 tir \u539F\u59CB\u51FD\u6570\u3002\u56E0\u4E3A\u5B83\u4EEC\u4E0D\u77E5\u9053\u5168\u5C40\u4FE1\u606F\uFF0C\u6240\u4EE5\u65E0\u6CD5\u901A\u8FC7\u8FD9\u4E9B pass \u6DFB\u52A0\u6216\u5220\u9664\u529F\u80FD\u3002"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-c++",children:"class FunctionPassNode : PassNode {\n  PassInfo pass_info;\n  runtime::TypedPackedFunc<Function(Function, Module, PassContext)> pass_func;\n  Module operator()(const Module& mod, const PassContext& pass_ctx) const final;\n  bool SkipFunction(const Function& func) const;\n  // \u5176\u4ED6\u6210\u5458/\u65B9\u6CD5\u7701\u7565...\n};\n"})}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.code,{children:"pass_info"})," \u4E0E\u6A21\u5757 pass \u4E2D\u7684\u63CF\u8FF0\u76F8\u540C\u3002",(0,a.jsx)(n.code,{children:"pass_func"})," \u63A5\u6536\u4E00\u4E2A\u51FD\u6570\u8FDB\u884C\u4F18\u5316\uFF0C\u8FD8\u9700\u8981\u4E00\u4E2A\u6A21\u5757\uFF0C\u53EF\u4EE5\u4F7F\u7528\u6A21\u5757\u6765\u62A5\u9519\u3002\u7528\u300CSkipOptimization\u300D\u6CE8\u89E3\u51FD\u6570\uFF0C\u4ECE\u800C\u5728\u4F18\u5316\u671F\u95F4\u5C06\u5FFD\u7565\u5B83\u3002"]}),"\n",(0,a.jsx)(n.h4,{id:"\u987A\u5E8F-pass",children:"\u987A\u5E8F Pass"}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.code,{children:"SequentialPass"})," \u7C7B\u4F3C\u4E8E Pytorch \u4E2D ",(0,a.jsx)(n.code,{children:"nn.Sequential"}),"\uFF0C\u5305\u542B\u8BB8\u591A\u7528\u4E8E\u6267\u884C\u7684 pass\u3002"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-c++",children:"class SequentialPassNode : PassNode {\n  PassInfo pass_info;\n  // \u8981\u6267\u884C\u7684 Pass\u3002\n  Array<Pass> passes;\n  bool PassEnabled(const PassInfo& info) const;\n  Module operator()(const Module& mod, const PassContext& pass_ctx) const final;\n};\n"})}),"\n",(0,a.jsxs)(n.p,{children:["\u76EE\u524D\u5728 Relay \u4E2D\u53EA\u6709\u5C11\u6570 pass \u88AB\u653E\u5165\u8BE5\u7EC4\u3002\u4F8B\u5982\uFF0C",(0,a.jsx)(n.code,{children:"FoldScaleAxis"})," \u9700\u8981\u5728\u5185\u90E8\u8C03\u5EA6 ",(0,a.jsx)(n.code,{children:"ForwardFoldScaleAxis"})," \u548C ",(0,a.jsx)(n.code,{children:"BackwardFoldScaleAxis"}),"\u3002\u53E6\u5916\uFF0C\u63A8\u8350\u5148\u5B9E\u73B0 ",(0,a.jsx)(n.code,{children:"BackwardFoldScaleAxis"}),"\u3002\u56E0\u6B64\uFF0C\u8FD9\u4E2A pass \u662F ",(0,a.jsx)(n.code,{children:"SequentialPass"})," \u7684\u7406\u60F3\u5019\u9009\u3002"]}),"\n",(0,a.jsx)(n.p,{children:"\u4EE5\u4E0B\u4EE3\u7801\u5C55\u793A\u4E86\u5982\u4F55\u8C03\u7528\u987A\u5E8F pass \u4E2D\u7684\u5404\u4E2A pass\u3002\u672C\u8D28\u4E0A\uFF0C\u6309\u7167\u5B83\u4EEC\u5728 pass \u5217\u8868\u4E2D\u7684\u987A\u5E8F\u4F9D\u6B21\u6267\u884C\u6BCF\u4E2A pass\u3002"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-c++",children:'Module SequentialNode::operator()(const Module& module,\n                                  const PassContext& pass_ctx) const {\n  Module mod = module;\n  for (const Pass& pass : passes) {\n    ICHECK(pass.defined()) << "Found undefined pass for optimization.";\n    const PassInfo& pass_info = pass->Info();\n    if (!PassEnabled(pass_info))  continue;\n    for (const auto& it : pass_info->required) {\n      const auto* name = it.as<tvm::ir::StringImm>();\n      ICHECK(name);\n      mod = GetPass(name->value)(mod, pass_ctx);\n    }\n    mod = pass(mod, pass_ctx);\n  }\n  return mod;\n}\n'})}),"\n",(0,a.jsxs)(n.p,{children:["\u8C03\u7528 pass \u9996\u5148\u4F1A\u68C0\u67E5\u8FD9\u4E2A pass \u662F\u5426\u542F\u7528\u2014\u2014\u9996\u5148\u68C0\u67E5 pass \u662F\u5426\u88AB\u7528\u6237\u660E\u786E\u7981\u7528\uFF0C\u7136\u540E\u68C0\u67E5\u5B83\u662F\u5426\u88AB\u7528\u6237\u6307\u5B9A\u4E3A\u5FC5\u9700 pass\u3002\u5982\u679C\u4ECD\u4E0D\u80FD\u786E\u5B9A\uFF0C\u5219\u68C0\u67E5\u5176 ",(0,a.jsx)(n.code,{children:"opt_level"}),"\u3002\u53EA\u6709\u5F53\u5B83\u7684\u4F18\u5316\u7EA7\u522B\u4E0D\u4F4E\u4E8E\u5728 pass \u4E0A\u4E0B\u6587\u4E2D\u914D\u7F6E\u7684\u4F18\u5316\u7EA7\u522B\u65F6\uFF0C\u624D\u4F1A\u542F\u7528\u5E76\u6267\u884C\u6B64 pass\u3002"]}),"\n",(0,a.jsx)(n.p,{children:"\u8981\u6267\u884C pass\uFF0C\u9996\u5148\u8981\u7528 pass \u540D\u79F0\u5728 TVM \u6253\u5305\u51FD\u6570\u6CE8\u518C\u8868\u4E2D\u68C0\u7D22\u5DF2\u6CE8\u518C\u7684 pass\u3002\u6BCF\u4E2A pass \u90FD\u6CE8\u518C\u4E86\u4E00\u4E2A API \u7AEF\u70B9\uFF0C\u5C06\u5728\u540E\u9762\u5C55\u793A\u3002"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-c++",children:'Pass GetPass(const std::string& pass_name) {\n  using tvm::runtime::Registry;\n  std::string fpass_name = "relay._transform." + pass_name;\n  const auto* f = Registry::Get(fpass_name);\n  ICHECK(f != nullptr) << "Cannot find " << fpass_name\n                      << "to create the pass " << pass_name;\n  return (*f)();\n}\n'})}),"\n",(0,a.jsx)(n.p,{children:"\u4E00\u4E9B\u8F85\u52A9\u51FD\u6570\u53EF\u4EE5\u521B\u5EFA\u4E0A\u8FF0\u8FD9\u4E9B pass \u7684\u6BCF\u79CD\u7C7B\u578B\u3002\u8FD9\u4E9B\u8F85\u52A9\u51FD\u6570\u4E5F\u63D0\u4F9B\u7ED9 Python \u524D\u7AEF\uFF0C\u4EE5\u4FBF\u7528\u6237\u66F4\u597D\u5730\u4F7F\u7528 Python API \u6765\u521B\u5EFA\u7279\u5B9A\u7684 pass \u5BF9\u8C61\u3002"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-c++",children:"Pass CreateFunctionPass(\n    const runtime::TypedPackedFunc<Function(Function, IRModule, PassContext)>& pass_func,\n    int opt_level,\n    String name,\n    Array<String> required);\n\nPass CreatePrimFuncPass(\n    const runtime::TypedPackedFunc<PrimFunc(PrimFunc, IRModule, PassContext)>& pass_func,\n    int opt_level,\n    String name,\n    Array<String> required);\n\nPass CreateModulePass(\n    const runtime::TypedPackedFunc<IRModule(IRModule, PassContext)>& pass_func,\n    int opt_level,\n    String name,\n    Array<String> required);\n\nPass Sequential(tvm::Array<Pass> passes, PassInfo pass_info);\n"})}),"\n",(0,a.jsx)(n.h4,{id:"pass-\u6CE8\u518C",children:"Pass \u6CE8\u518C"}),"\n",(0,a.jsxs)(n.p,{children:["\u524D\u9762\u5DF2\u7ECF\u4ECB\u7ECD\u4E86\u4E0D\u540C\u7EA7\u522B pass \u7684\u6982\u5FF5\u548C\u7528\u4E8E\u7F16\u8BD1\u7684\u4E0A\u4E0B\u6587\u3002\u63A5\u4E0B\u6765\u4EE5\u5E38\u91CF\u6298\u53E0\u4E3A\u4F8B\uFF0C\u4ECB\u7ECD\u7528\u6237\u6CE8\u518C pass\u3002\u8FD9\u4E2A pass \u53EF\u4EE5\u5728 Relay \u51FD\u6570\uFF08\u5728 ",(0,a.jsx)(n.a,{href:"https://github.com/apache/tvm/blob/main/src/relay/transforms/fold_constant.cc",children:"src/relay/transforms/fold_constant.cc"})," \u4E2D\uFF09\u4E2D\u6298\u53E0\u5E38\u91CF\u3002"]}),"\n",(0,a.jsxs)(n.p,{children:["\u63D0\u4F9B\u4E00\u4E2A API \u6765\u6267\u884C ",(0,a.jsx)(n.code,{children:"Expr"})," \u5230 ",(0,a.jsx)(n.code,{children:"Expr"})," \u7684\u8F6C\u6362\u3002"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-c++",children:"Expr FoldConstant(const Expr& expr);\n"})}),"\n",(0,a.jsxs)(n.p,{children:["\u4E3A\u4E86\u5C06\u8FD9\u4E2A pass \u6CE8\u518C\u5230 pass infra\uFF0C\u9996\u5148\u51B3\u5B9A\u8FD9\u4E2A pass \u8981\u5728\u54EA\u4E2A\u7EA7\u522B\u6267\u884C\u3002\u7531\u4E8E\u5E38\u91CF\u6298\u53E0\u53D1\u751F\u5728\u5355\u4E2A\u51FD\u6570\u4E0A\uFF0C\u5E94\u8BE5\u901A\u8FC7 ",(0,a.jsx)(n.code,{children:"CreateFunctionPass"})," \u76F4\u89C2\u5730\u4E3A\u5B83\u521B\u5EFA\u4E00\u4E2A ",(0,a.jsx)(n.code,{children:"FunctionPass"}),"\u3002",(0,a.jsx)(n.code,{children:"pass_func"})," \u4F5C\u4E3A\u4E00\u4E2A\u6253\u5305\u51FD\u6570\u8FD4\u56DE\uFF0C\u8BE5\u51FD\u6570\u5728 ",(0,a.jsx)(n.em,{children:"IRModule"})," \u4E2D\u7684\u6BCF\u4E2A\u51FD\u6570\u4E0A\u8C03\u7528 ",(0,a.jsx)(n.code,{children:"Expr"})," \u5230 ",(0,a.jsx)(n.code,{children:"Expr"})," API\u3002",(0,a.jsx)(n.code,{children:"{}"})," \u8868\u793A\u6B64 pass \u4E0D\u9700\u8981\u4EFB\u4F55\u5148\u51B3\u6761\u4EF6\u3002\u5426\u5219\uFF0Cpass \u5F00\u53D1\u8005\u5FC5\u987B\u8BC6\u522B\u5E76\u5217\u51FA\u5B83\u4EEC\u3002"]}),"\n",(0,a.jsxs)(n.p,{children:["\u540C\u65F6\uFF0C\u901A\u8FC7\u540D\u79F0 ",(0,a.jsx)(n.code,{children:"relay._transform.FoldConstant"})," \u6CE8\u518C\u4E86\u4E00\u4E2A pass API \u7AEF\u70B9\u3002\u56E0\u6B64\uFF0C\u6B64 pass \u6210\u4E3A\u6CE8\u518C\u8868\u4E2D\u7684\u4E00\u4E2A\u6761\u76EE\uFF0C\u53EF\u4EE5\u5728\u9700\u8981\u65F6\u7531 C++\uFF08\u4F8B\u5982\u4E0A\u9762\u7684 ",(0,a.jsx)(n.code,{children:"GetPass"}),"\uFF09\u548C Python \u8BBF\u95EE\u3002"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-c++",children:'namespace transform {\n\nPass FoldConstant() {\n  runtime::TypedPackedFunc<Function(Function, IRModule, PassContext)> pass_func =\n    [=](Function f, IRModule m, PassContext pc) {\n      return Downcast<Function>(FoldConstant(f));\n  };\n  return CreateFunctionPass(pass_func, 2, "FoldConstant", {});\n}\n\nTVM_REGISTER_GLOBAL("relay._transform.FoldConstant")\n.set_body_typed(FoldConstant);\n\n}  // \u547D\u540D\u7A7A\u95F4\u53D8\u6362\n'})}),"\n",(0,a.jsxs)(n.p,{children:["\u4E3A\u4E86\u5141\u8BB8\u5176\u4ED6 C++ \u6A21\u5757\u5E94\u7528\u6B64 pass\uFF0C\u5728 ",(0,a.jsx)(n.a,{href:"https://github.com/apache/tvm/blob/main/include/tvm/relay/transform.h",children:"include/tvm/relay/transform.h"})," \u4E2D\u58F0\u660E\u4E86\u4E00\u4E2A\u81EA\u7531\u51FD\u6570\uFF0C\u5982\u4E0B\u6240\u793A\uFF1A"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-c++",children:"TVM_DLL Pass FoldConstant();\n"})}),"\n",(0,a.jsx)(n.h4,{id:"pass-instrument",children:"Pass Instrument"}),"\n",(0,a.jsx)(n.p,{children:"Pass Instrument \u662F\u4E00\u79CD\u5206\u6790 pass \u672C\u8EAB\u7684\u673A\u5236\u3002\u4F8B\u5982\uFF0C\u53EF\u4EE5\u7528\u57FA\u7840\u67B6\u6784\u6765\u4E86\u89E3 pass \u9700\u8981\u591A\u5C11\u65F6\u95F4\u548C\u5185\u5B58\uFF0C\u6216\u8005 pass \u5982\u4F55\u8F6C\u6362 IR \u6A21\u5757\u3002"}),"\n",(0,a.jsxs)(n.p,{children:["\u5728 ",(0,a.jsx)(n.code,{children:"PassContext"})," \u7684\u751F\u547D\u5468\u671F\u4E2D\u5F15\u5165\u4E86\u56DB\u4E2A\u68C0\u6D4B\u70B9\u3002"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-c++",children:"TVM_DLL void InstrumentEnterPassContext();\nTVM_DLL void InstrumentExitPassContext();\nTVM_DLL bool InstrumentBeforePass(const IRModule& mod, const PassInfo& info) const;\nTVM_DLL void InstrumentAfterPass(const IRModule& mod, const PassInfo& info) const;\n"})}),"\n",(0,a.jsxs)(n.p,{children:["\u8FDB\u5165 ",(0,a.jsx)(n.code,{children:"PassContext"})," \u5B9E\u4F8B\u7684\u8303\u56F4\u65F6\uFF0C\u7ACB\u5373\u8C03\u7528 ",(0,a.jsx)(n.code,{children:"InstrumentEnterPassContext"}),"\u3002"]}),"\n",(0,a.jsxs)(n.p,{children:["\u79BB\u5F00\u4E86 ",(0,a.jsx)(n.code,{children:"PassContext"})," \u7684\u8303\u56F4\u6216\u8005 pass \u6267\u884C\u8FC7\u7A0B\u4E2D\u53D1\u751F\u4E86\u5F02\u5E38\uFF0C\u4F1A\u8C03\u7528 ",(0,a.jsx)(n.code,{children:"InstrumentExitPassContext"}),"\u3002\u5F53\u5DE5\u5177\u7C7B\u88AB ",(0,a.jsx)(n.code,{children:"tvm.transform.PassContext"})," \u4E2D\u7684 ",(0,a.jsx)(n.code,{children:"override_instruments"})," \u8986\u76D6\u65F6\uFF0C\u4E5F\u4F1A\u8C03\u7528\u6B64\u65B9\u6CD5\u3002\u53C2\u9605 ",(0,a.jsx)(n.a,{href:"https://tvm.apache.org/docs/arch/pass_infra.html#pass-instrument-overriden",children:"\u5728\u5F53\u524D PassContext \u4E2D\u590D\u5199\u5DE5\u5177\u7C7B"}),"\u3002"]}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.code,{children:"InstrumentBeforePass"})," \u5728\u6267\u884C\u524D\u88AB\u8C03\u7528\u3002\u5982\u679C\u8981\u5728\u6267\u884C\u540E\u8FD0\u884C pass\uFF0C\u5219\u8C03\u7528 ",(0,a.jsx)(n.code,{children:"InstrumentAfterPass"}),"\u3002\u884C\u4E3A\u5982\u4E0B\uFF1A"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-c++",children:"if (pass_ctx.InstrumentBeforePass(ir_module, pass_info)) {\n  new_ir_module = run_pass(ir_module, pass_ctx);\n  pass_ctx.InstrumentAfterPass(new_ir_module, pass_info);\n  return new_ir_module;\n}\n"})}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.code,{children:"PassInstrument"})," \u63A5\u53E3\u5141\u8BB8\u5728\u4E0A\u8FF0\u56DB\u79CD\u65B9\u6CD5\u4E2D\u8FD0\u884C\u4EFB\u610F\u4EE3\u7801\u3002\u591A\u4E2A ",(0,a.jsx)(n.code,{children:"PassInstrument"})," \u5B9E\u4F8B\u53EF\u4EE5\u6CE8\u518C\u5230\u4E00\u4E2A ",(0,a.jsx)(n.code,{children:"PassContext"})," \u4E2D\u3002",(0,a.jsx)(n.code,{children:"PassInstrument"})," \u5B9E\u4F8B\u6309\u7167\u4F20\u9012\u7ED9 ",(0,a.jsx)(n.code,{children:"PassContext"})," \u7684 ",(0,a.jsx)(n.code,{children:"instruments"})," \u53C2\u6570\u7684\u987A\u5E8F\u4F9D\u6B21\u8C03\u7528\u3002"]}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.code,{children:"PassInstrument"})," \u63D0\u4F9B\u4EE5\u4E0B\u63A5\u53E3\uFF1A"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-c++",children:"namespace instrument {\n\nclass PassInstrumentNode : public Object {\n public:\n  String name;\n  virtual void EnterPassContext() const = 0;\n  virtual void ExitPassContext() const = 0;\n  virtual bool ShouldRun(const IRModule& mod, const transform::PassInfo& info) const = 0;\n  virtual void RunBeforePass(const IRModule& mod, const transform::PassInfo& info) const = 0;\n  virtual void RunAfterPass(const IRModule& mod, const transform::PassInfo& info) const = 0;\n  /* \u7701\u7565\u5176\u4ED6\u5B57\u6BB5\u3002 */\n};\n\nclass PassInstrument : public ObjectRef {\n public:\n  TVM_DEFINE_OBJECT_REF_METHODS(PassInstrument, ObjectRef, PassInstrumentNode);\n};\n\n}  // \u547D\u540D\u7A7A\u95F4\u5DE5\u5177\n"})}),"\n",(0,a.jsxs)(n.p,{children:["\u63D0\u4F9B Python \u524D\u7AEF\u5FEB\u901F\u5B9E\u73B0 ",(0,a.jsx)(n.code,{children:"PassInstrument"}),"\u3002\u53C2\u9605 ",(0,a.jsx)(n.a,{href:"https://tvm.apache.org/docs/arch/pass_infra.html#pass-instrument-py-frontend",children:"Pass \u5DE5\u5177"}),"\u3002"]}),"\n",(0,a.jsxs)(n.p,{children:["\u5728 ",(0,a.jsx)(n.code,{children:"PassContext"})," \u4E2D\uFF0C",(0,a.jsx)(n.code,{children:"PassInstrument"})," \u5B9E\u4F8B\u7684\u8C03\u7528\u987A\u5E8F\u5982\u4E0B\uFF1A"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-python",children:"with PassContext(instruments=[pi]) # pi = a PassInstrument implementation. # pi = PassInstrument \u5B9E\u73B0\u3002\n    pi.EnterPassContext()\n\n    if pi.ShouldRun(Pass1):\n        pi.RunBeforePass()\n        Pass1()\n        pi.RunAfterPass()\n\n    if pi.ShouldRun(Pass2):\n        pi.RunBeforePass()\n        Pass2()\n        pi.RunAfterPass()\n\n    pi.ExitPassContext()\n"})}),"\n",(0,a.jsxs)(n.p,{children:["\u63A5\u4E0B\u6765\u7B80\u5355\u4ECB\u7ECD ",(0,a.jsx)(n.code,{children:"PassInstrument"})," \u63A5\u53E3\u548C ",(0,a.jsx)(n.code,{children:"PassContext"})," \u65B9\u6CD5\u7684\u5173\u7CFB\u3002\u66F4\u591A\u8BE6\u7EC6\u4FE1\u606F\uFF0C\u53C2\u9605\uFF08",(0,a.jsx)(n.a,{href:"https://github.com/apache/tvm/blob/main/src/ir/transform.cc",children:"src/ir/transform.cc"}),"\uFF09\u3002"]}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"InstrumentEnterPassContext"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"EnterPassContext()"})," \u6309\u7167\u4F20\u9012\u7ED9 ",(0,a.jsx)(n.code,{children:"PassContext"})," \u7684 ",(0,a.jsx)(n.code,{children:"instruments"})," \u7684\u987A\u5E8F\u6267\u884C\u3002"]}),"\n",(0,a.jsxs)(n.li,{children:["\u5F53\u629B\u51FA\u5F02\u5E38\u65F6\uFF0C",(0,a.jsx)(n.code,{children:"PassContext"})," \u901A\u8FC7\u6E05\u9664\u6240\u6709\u5DF2\u6CE8\u518C\u7684 ",(0,a.jsx)(n.code,{children:"PassInstrument"})," \u5B9E\u4F8B\u6765\u7981\u7528 pass \u5DE5\u5177\u3002"]}),"\n",(0,a.jsxs)(n.li,{children:["\u7136\u540E ",(0,a.jsx)(n.code,{children:"PassContext"})," \u6267\u884C\u6BCF\u4E2A\u6210\u529F\u5B8C\u6210 ",(0,a.jsx)(n.code,{children:"EnterPassContext()"})," \u7684 ",(0,a.jsx)(n.code,{children:"PassInstrument"})," \u5B9E\u4F8B\u7684 ",(0,a.jsx)(n.code,{children:"ExitPassContext()"})," \u65B9\u6CD5"]}),"\n",(0,a.jsxs)(n.li,{children:["\u4F8B\u5982\uFF0C\u5982\u679C\u5C06 ",(0,a.jsx)(n.code,{children:"PassInstrument"}),"  A\u3001B \u548C C \u6CE8\u518C\u5230 ",(0,a.jsx)(n.code,{children:"PassContext"})," \u5E76\u4E14 A \u5B8C\u6210 ",(0,a.jsx)(n.code,{children:"EnterPassContext()"})," \u800C B \u629B\u51FA\u5F02\u5E38\uFF0C\u5219\u6C38\u8FDC\u4E0D\u4F1A\u6267\u884C C\uFF1B\u800C\u6267\u884C A \u7684 ",(0,a.jsx)(n.code,{children:"ExitPassContext()"}),"\u3002"]}),"\n"]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"InstrumentExitPassContext"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["\u6309\u7167\u4F20\u9012\u7ED9 ",(0,a.jsx)(n.code,{children:"PassContext"})," \u7684 ",(0,a.jsx)(n.code,{children:"instruments"})," \u7684\u987A\u5E8F\u6267\u884C\u6BCF\u4E2A ",(0,a.jsx)(n.code,{children:"PassInstrument"})," \u5B9E\u4F8B\u7684 ",(0,a.jsx)(n.code,{children:"ExitPassContext()"}),"\u3002"]}),"\n",(0,a.jsxs)(n.li,{children:["\u53D1\u751F\u5F02\u5E38\u65F6\uFF0C",(0,a.jsx)(n.code,{children:"instruments"})," \u88AB\u6E05\u9664\u3002"]}),"\n",(0,a.jsxs)(n.li,{children:["\u5728\u629B\u51FA\u5F02\u5E38\u540E\u6CE8\u518C\u7684 ",(0,a.jsx)(n.code,{children:"PassInstrument"})," \u5B9E\u4F8B\u4E0D\u6267\u884C ",(0,a.jsx)(n.code,{children:"ExitPassContext"}),"\u3002"]}),"\n"]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"InstrumentBeforePass"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["\u5982\u679C\u8BE5 pass \u672A\u5217\u4E3A\u5FC5\u9700 pass\uFF0C\u5219\u6267\u884C ",(0,a.jsx)(n.code,{children:"ShouldRun"}),"\u3002"]}),"\n",(0,a.jsxs)(n.li,{children:["\u5982\u679C pass \u6CA1\u6709\u88AB ",(0,a.jsx)(n.code,{children:"ShouldRun"})," \u963B\u6B62\uFF0C\u5219 ",(0,a.jsx)(n.code,{children:"RunBeforePass"})," \u5C06\u6309\u7167 ",(0,a.jsx)(n.code,{children:"instruments"})," \u7684\u987A\u5E8F\u6267\u884C\u3002"]}),"\n",(0,a.jsxs)(n.li,{children:["\u8BF7\u6CE8\u610F\uFF0C ",(0,a.jsx)(n.code,{children:"InstrumentBeforePass"})," \u8FD4\u56DE\u4E00\u4E2A\u5E03\u5C14\u503C\uFF0C\u6307\u793A\u662F\u5426\u5E94\u8BE5\u8FD0\u884C pass\u3002"]}),"\n",(0,a.jsxs)(n.li,{children:["\u5F53\u5F02\u5E38\u53D1\u751F\u65F6\uFF0C\u7ACB\u5373\u629B\u51FA\u3002\u6211\u4EEC\u4F9D\u8D56 Python \u4E0A\u4E0B\u6587\u7BA1\u7406\u5668\u5B89\u5168\u9000\u51FA ",(0,a.jsx)(n.code,{children:"PassContext"}),"\uFF08\u610F\u5473\u7740\u6BCF\u4E2A\u5DE5\u5177\u7684 ",(0,a.jsx)(n.code,{children:"ExitPassContext"})," \u90FD\u4F1A\u8FD0\u884C\u3002\u5BF9\u4E8E C++\uFF0C\u53C2\u8003 ",(0,a.jsx)(n.a,{href:"https://github.com/apache/tvm/blob/main/include/tvm/support/with.h",children:"include/tvm/support/with.h"}),"\u3002\uFF09"]}),"\n"]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"InstrumentAfterPass"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"RunAfterPass"})," \u6309\u7167\u4F20\u9012\u7ED9 ",(0,a.jsx)(n.code,{children:"PassContext"})," \u7684 ",(0,a.jsx)(n.code,{children:"instruments"})," \u7684\u987A\u5E8F\u6267\u884C\u3002"]}),"\n",(0,a.jsxs)(n.li,{children:["\u5F53\u5F02\u5E38\u53D1\u751F\u65F6\uFF0C\u7ACB\u5373\u629B\u51FA\u3002\u4F9D\u9760 Python \u4E0A\u4E0B\u6587\u7BA1\u7406\u5668\u6216 ",(0,a.jsx)(n.code,{children:"With"})," \u7C7B\uFF08",(0,a.jsx)(n.a,{href:"https://github.com/apache/tvm/blob/main/include/tvm/support/with.h",children:"include/tvm/support/with.h"}),"\uFF09\u5B89\u5168\u9000\u51FA ",(0,a.jsx)(n.code,{children:"PassContext"}),"\u3002"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,a.jsx)(n.h4,{id:"\u5185\u7F6E\u5DE5\u5177",children:"\u5185\u7F6E\u5DE5\u5177"}),"\n",(0,a.jsxs)(n.p,{children:["\u4EE5\u4E0B\u662F\u51E0\u79CD\u5185\u7F6E\u5DE5\u5177\u3002\u6807\u6709 ",(0,a.jsx)(n.em,{children:"TODO"})," \u7684\u8FD8\u6CA1\u6709\u5B9E\u73B0\u3002"]}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["PassTimingInstrument\uFF08\u53C2\u8003 ",(0,a.jsx)(n.a,{href:"https://github.com/apache/tvm/blob/main/src/ir/instrument.cc",children:"src/ir/instrument.cc"}),"\uFF09","\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"\u5206\u6790 pass \u7684\u6267\u884C\u65F6\u95F4"}),"\n"]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["PrintIRBefore (TODO)","\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["\u5728 pass \u8F6C\u6362\u4E4B\u524D\u6253\u5370 IR \u6A21\u5757\u3002\u82E5\u5728 pass \u5468\u56F4\u63D2\u5165 ",(0,a.jsx)(n.code,{children:"tvm.transform.PrintIR()"})," \u4E5F\u53EF\u4EE5\u8FBE\u5230\u8FD9\u4E2A\u76EE\u7684\u3002\u4F46\u4F7F\u7528 ",(0,a.jsx)(n.code,{children:"PassInstrument"}),"\uFF0C\u4E0D\u9700\u8981\u4FEE\u6539 pass \u7684\u987A\u5E8F\u3002"]}),"\n"]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["PrintAfter (TODO)","\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"\u5728 pass \u8F6C\u6362\u540E\u6253\u5370 IR \u6A21\u5757\u3002"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,a.jsx)(n.h3,{id:"python-\u524D\u7AEF",children:"Python \u524D\u7AEF"}),"\n",(0,a.jsxs)(n.p,{children:["\u524D\u7AEF\u53EA\u9700\u8981\u4E00\u4E9B\u7B80\u5355\u7684 API\u3002\u4F8B\u5982\uFF0C\u53EF\u4EE5\u4E3A\u7528\u6237\u63D0\u4F9B\u4EE5\u4E0B API \u6765\u521B\u5EFA\u548C\u6267\u884C pass\uFF08\u5B8C\u6574\u7684\u5B9E\u73B0\u5728 ",(0,a.jsx)(n.a,{href:"https://github.com/apache/tvm/blob/main/python/tvm/relay/transform/transform.py",children:"python/tvm/relay/transform/transform.py"})," \u548C ",(0,a.jsx)(n.a,{href:"https://github.com/apache/tvm/blob/main/python/tvm/ir/transform.py",children:"python/tvm/ir/transform.py"})," \u4E2D\uFF09\u3002\u540E\u7AEF\u63A5\u6536\u4FE1\u606F\uFF0C\u5E76\u51B3\u5B9A\u7528\u54EA\u4E2A\u51FD\u6570\u6765\u521B\u5EFA Pass \u5BF9\u8C61\u3002"]}),"\n",(0,a.jsx)(n.h4,{id:"passcontext-1",children:"PassContext"}),"\n",(0,a.jsxs)(n.p,{children:["Python \u524D\u7AEF\u4E3A ",(0,a.jsx)(n.code,{children:"PassContext"})," \u63D0\u4F9B\u4E86\u4E00\u4E2A wrapper\uFF0C\u901A\u8FC7\u8986\u76D6 ",(0,a.jsx)(n.code,{children:"__enter__"})," \u548C ",(0,a.jsx)(n.code,{children:"__exit__"})," \u6765\u542F\u7528 ",(0,a.jsx)(n.code,{children:"with"})," \u8BED\u6CD5\u3002\u63D0\u4F9B\u4E00\u79CD ",(0,a.jsx)(n.code,{children:"current"})," \u9759\u6001\u65B9\u6CD5\uFF0C\u4F9B\u7528\u6237\u83B7\u53D6\u5728\u4E00\u5B9A\u8303\u56F4\u5185\u4F7F\u7528\u7684\u4E0A\u4E0B\u6587\u3002"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-python",children:'@tvm._ffi.register_object("transform.PassContext")\nclass PassContext(tvm.runtime.Object):\n    def __enter__(self):\n        _transform.EnterPassContext(self)\n        return self\n\n    def __exit__(self, ptype, value, trace, config):\n        _transform.ExitPassContext(self)\n\n    @staticmethod\n    def current():\n        """\u8FD4\u56DE\u5F53\u524D pass \u4E0A\u4E0B\u6587\u3002"""\n        return _transform.GetCurrentPassContext()\n'})}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.code,{children:"PassContext"})," \u7528\u4E8E\u914D\u7F6E\u7F16\u8BD1\u9009\u9879\uFF0C\u5305\u62EC\u4F18\u5316\u7EA7\u522B\u548C\u5FC5\u9700\u53CA\u7981\u7528\u7684 pass\u3002\u5B83\u8FD8\u63A5\u6536\u4E00\u4E2A\u914D\u7F6E\u5B57\u5178\uFF0C\u4EE5\u4FBF\u4E0D\u540C\u7684 pass \u53EF\u4EE5\u65B9\u4FBF\u5730\u83B7\u53D6\u4F20\u9012\u7684\u6570\u636E\uFF0C\u4F8B\u5982\u56DE\u9000\u8BBE\u5907\u4FE1\u606F\u548C\u5FAA\u73AF\u5C55\u5F00\u7684\u6B65\u957F/\u6DF1\u5EA6\u7B49\u3002\u4E3A\u4E86\u80FD\u591F\u83B7\u53D6\u6240\u9700\u7684\u914D\u7F6E\uFF0C\u5FC5\u987B\u901A\u8FC7 ",(0,a.jsx)(n.code,{children:"TVM_REGISTER_PASS_CONFIG_OPTION"})," \u6CE8\u518C\u5BC6\u94A5\u3002\u4F8B\u5982\uFF0C\u5FAA\u73AF\u5C55\u5F00 pass \u4F7F\u7528\u4EE5\u4E0B\u5185\u5BB9\u3002"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-python",children:'TVM_REGISTER_PASS_CONFIG_OPTION("tir.UnrollLoop", UnrollLoopConfig);\n'})}),"\n",(0,a.jsxs)(n.p,{children:["\u66F4\u591A\u8BE6\u60C5\u53C2\u9605 ",(0,a.jsx)(n.a,{href:"https://github.com/apache/tvm/blob/main/src/tir/transforms/unroll_loop.cc",children:"src/tir/transforms/unroll_loop.cc"}),"\u3002"]}),"\n",(0,a.jsx)(n.h4,{id:"pass-\u5BF9\u8C61",children:"Pass \u5BF9\u8C61"}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.code,{children:"Pass"})," \u662F\u6240\u6709 pass \u5BF9\u8C61\u7684\u57FA\u7C7B\u3002\u8FD9\u91CC\u7684\u6240\u6709\u65B9\u6CD5\u90FD\u53EA\u662F\u5728\u540E\u7AEF\u5B9E\u73B0\u7684\u7B80\u5355 wrapper\u3002\u662F\u4E3A\u65B9\u4FBF\u7528\u6237\u4E0E Python \u4E2D\u7684\u57FA\u7C7B\u4EA4\u4E92\u800C\u5B9A\u4E49\u7684\u3002\u5728 pass \u57FA\u7C7B\u4E2D\u53EA\u5B9A\u4E49\u4E86\u4E00\u4E2A ",(0,a.jsx)(n.code,{children:"__call__"}),"\uFF0C\u4F7F\u5B50\u7C7B\u6210\u4E3A\u53EF\u8C03\u7528\u5BF9\u8C61\uFF0C\u8FDB\u800C\u53EF\u4EE5\u8F7B\u677E\u8C03\u7528\u5B83\u4EEC\uFF08\u4F8B\u5982 ",(0,a.jsx)(n.code,{children:"pass_xx(arg)"}),"\uFF09\u8FDB\u884C\u6267\u884C\u3002"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-python",children:"@register_relay_node\nclass Pass(RelayNode):\n   def __call__(self, mod):\n       return _transform.RunPass(self, mod)\n"})}),"\n",(0,a.jsxs)(n.p,{children:["\u63D0\u4F9B\u4E00\u4E9B\u8F85\u52A9 API\uFF0C\u65B9\u4FBF\u4ECE Python \u524D\u7AEF\u8F7B\u677E\u521B\u5EFA pass\uFF0C\u5E76\u8BA9 pass infra \u63A7\u5236\u6267\u884C\u3002\u4F8B\u5982\uFF0C",(0,a.jsx)(n.code,{children:"module_pass"}),"\u3001",(0,a.jsx)(n.code,{children:"function_pass"})," \u548C ",(0,a.jsx)(n.code,{children:"sequential"})," \u63D0\u4F9B\u7ED9\u7528\u6237\uFF0C\u65B9\u4FBF\u7528\u6237\u81EA\u5B9A\u4E49 pass \u6216 pass pipeline\u3002"]}),"\n",(0,a.jsxs)(n.p,{children:["\u5BF9\u4E8E\u5728 C++ \u540E\u7AEF\u5B9E\u73B0\u7684\u6240\u6709 pass\uFF0C\u5206\u522B\u5728 ",(0,a.jsx)(n.a,{href:"https://github.com/apache/tvm/blob/main/python/tvm/ir/transform.py",children:"python/tvm/ir/transform.py"})," \u548C ",(0,a.jsx)(n.a,{href:"https://github.com/apache/tvm/blob/main/python/tvm/relay/transform/transform.py",children:"python/tvm/relay/transform/transform.py"})," \u4E2D\u63D0\u4F9B\u4E86\u76F8\u5E94\u7684 Python API\u3002\u4F8B\u5982\uFF0C\u5E38\u91CF\u6298\u53E0\u6709\u4E00\u4E2A Python API\uFF0C\u5982\u4E0B\u6240\u793A\uFF1A"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-python",children:"def FoldConstant():\n    return _transform.FoldConstant()\n"})}),"\n",(0,a.jsx)(n.p,{children:"\u901A\u8FC7\u88C5\u9970\u5668\u8FDB\u884C\u88C5\u9970\uFF0C\u521B\u5EFA\u4E00\u4E2A pass\uFF0C\u5982\u4E0B\u6240\u793A\uFF1A"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-python",children:' @relay.transform.module_pass(opt_level=2)\n def transform(mod, ctx):\n    tp = relay.TensorType((10,), "float32")\n    x = relay.var("x", tp)\n    gv = relay.GlobalVar("abs")\n    func = relay.Function([x], relay.abs(x))\n    new_mod = tvm.IRModule({gv: func})\n    new_mod.update(mod)\n    return new_mod\n\nmodule_pass = transform\nassert isinstance(module_pass, transform.ModulePass)\nassert module_pass.info.opt_level == 2\n'})}),"\n",(0,a.jsxs)(n.p,{children:["\u8FD9\u91CC\u7684 ",(0,a.jsx)(n.code,{children:"transform"})," \u51FD\u6570\u4E3A\u8F93\u5165\u6A21\u5757\u6DFB\u52A0\u4E86\u4E00\u4E2A ",(0,a.jsx)(n.code,{children:"abs"})," \u51FD\u6570\uFF0C\u5B83\u53EF\u4EE5\u662F\u6A21\u5757\u7EA7\u522B\u7684\u4EFB\u4F55\u81EA\u5B9A\u4E49\u4F18\u5316\u3002\u521B\u5EFA\u6B64 ",(0,a.jsx)(n.code,{children:"module_pass"})," \u540E\uFF0C\u7528\u6237\u53EF\u4EE5\u5C06\u5176\u5E94\u7528\u4E8E\u4EFB\u4F55 Relay \u6A21\u5757\u3002\u4F8B\u5982\uFF0C\u53EF\u4EE5\u6784\u5EFA\u4E00\u4E2A\u7A7A\u6A21\u5757\uFF0C\u5E94\u7528\u8FD9\u4E2A pass\uFF0C\u6DFB\u52A0\u4E00\u4E2A ",(0,a.jsx)(n.code,{children:"abs"})," \u51FD\u6570\u3002"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-python",children:"mod = tvm.IRModule()\nmod = module_pass(mod)\n"})}),"\n",(0,a.jsxs)(n.p,{children:["\u76F8\u5E94\u5730\uFF0C\u4E5F\u4E3A ",(0,a.jsx)(n.code,{children:"function_pass"})," \u63D0\u4F9B\u4E86\u8FD9\u6837\u7684\u529F\u80FD\u3002\u4F8B\u5982\uFF0C\u51FD\u6570\u7EA7 pass \u7F16\u5199\u793A\u4F8B\u5982\u4E0B\uFF1A"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-python",children:'@relay.transform.function_pass(opt_level=1)\nclass TestReplaceFunc:\n   def __init__(self, new_func):\n      self.new_func = new_func\n      def transform_function(self, func, mod, ctx):\n         # \u4EC5\u7528\u4E8E\u6F14\u793A\n         # \u5C06 func \u8F6C\u6362\u4E3A new_func\n         return self.new_func\n\nx = relay.var("x", shape=(10, 20))\nf1 = relay.Function([x], x)\nf2 = relay.Function([x], relay.log(x))\n# fpass \u73B0\u5728\u662F\u4E00\u4E2A\u7279\u6B8A\u7684 pass\uFF0C\u5B83\u53D6\u4EE3\u4E86\u6BCF\u4E00\u4E2A\n# \u51FD\u6570\u4E3A f1\nfpass = TestReplaceFunc(f1)\n# \u73B0\u5728 input_mod \u4E2D\u7684\u6BCF\u4E2A\u51FD\u6570\u90FD\u88AB f1 \u66FF\u6362\u4E86\nres_mod = fpass(input_mod)\n'})}),"\n",(0,a.jsxs)(n.p,{children:["\u6216\u8005\uFF0C\u7528\u6237\u4E5F\u53EF\u4EE5\u4E0D\u4F7F\u7528\u88C5\u9970\u5668\u76F4\u63A5\u6CE8\u518C\u4E00\u4E2A pass\uFF0C\u7136\u540E\u8C03\u7528\u5B83\u3002\u6709\u5173\u5982\u4F55\u81EA\u5B9A\u4E49\u4F18\u5316 pipeline \u548C\u8C03\u8BD5 Relay \u548C tir pass \u7684\u66F4\u591A\u793A\u4F8B\uFF0C\u53C2\u9605 ",(0,a.jsx)(n.a,{href:"https://github.com/apache/tvm/blob/main/tutorials/dev/use_pass_infra.py",children:"\u4F7F\u7528 pass \u57FA\u7840\u67B6\u6784"})," \u6559\u7A0B\u3002"]}),"\n",(0,a.jsx)(n.h4,{id:"pass-instrument-1",children:"Pass Instrument"}),"\n",(0,a.jsxs)(n.p,{children:["\u53EF\u4EE5\u901A\u8FC7\u5728\u5B9E\u73B0\u4EE5\u4E0B\u65B9\u6CD5\u7684\u7C7B\u4E0A\u4F7F\u7528 ",(0,a.jsx)(n.code,{children:"pass_instrument"})," \u88C5\u9970\u5668\uFF08",(0,a.jsx)(n.a,{href:"https://github.com/apache/tvm/blob/main/python/tvm/ir/instrument.py",children:"python/tvm/ir/instrument.py"}),"\uFF09\u6765\u5B9E\u73B0 ",(0,a.jsx)(n.code,{children:"PassInstrument"}),"\u3002\u6CE8\u610F\uFF0C\u63A8\u8350\u4F7F\u7528 ",(0,a.jsx)(n.code,{children:"pass_instrument"})," \u88C5\u9970\u5668\u6765\u5B9E\u73B0 ",(0,a.jsx)(n.code,{children:"PassInstrument"}),"\uFF0C\u800C\u4E0D\u662F\u8986\u76D6\u6216\u5B50\u7C7B\u5316\u3002"]}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"enter_pass_ctx"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["\u8BE5\u65B9\u6CD5\u5728\u8FDB\u5165 ",(0,a.jsx)(n.code,{children:"PassContext"})," \u65F6\u8FD0\u884C\u3002"]}),"\n"]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"exit_pass_ctx"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["\u6B64\u65B9\u6CD5\u5728\u9000\u51FA ",(0,a.jsx)(n.code,{children:"PassContext"})," \u65F6\u8FD0\u884C\u3002"]}),"\n"]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"should_run"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"\u6B64\u65B9\u6CD5\u5728\u6267\u884C pass \u4E4B\u524D\u8FD0\u884C\uFF0C\u8FD4\u56DE\u4E00\u4E2A\u5E03\u5C14\u503C\uFF0C\u6307\u793A\u662F\u5426\u5E94\u8BE5\u8FD0\u884C pass\u3002"}),"\n"]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"run_before_pass"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"\u82E5\u8981\u8FD0\u884C\u67D0 pass\uFF0C\u5219\u5728 pass \u6267\u884C\u4E4B\u524D\u8FD0\u884C\u6B64\u65B9\u6CD5\u3002"}),"\n"]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"run_after_pass"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"\u6B64\u65B9\u6CD5\u5728\u6267\u884C pass \u540E\u7ACB\u5373\u8FD0\u884C\u3002"}),"\n",(0,a.jsx)(n.li,{}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.code,{children:"PassInstrument"})," \u5B9E\u4F8B\u53EF\u4EE5\u901A\u8FC7 ",(0,a.jsx)(n.code,{children:"tvm.transform.PassContext"})," \u4E2D\u7684 ",(0,a.jsx)(n.code,{children:"instruments"})," \u53C2\u6570\u6CE8\u518C\u3002"]}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.a,{href:"https://github.com/apache/tvm/blob/main/tutorials/dev/use_pass_instrument.py",children:"\u4F7F\u7528 pass Instrument"})," \u6559\u7A0B\u63D0\u4F9B\u4E86\u5982\u4F55\u4F7F\u7528 Python API \u5B9E\u73B0 ",(0,a.jsx)(n.code,{children:"PassInstrument"})," \u7684\u793A\u4F8B\u3002"]}),"\n",(0,a.jsx)(n.h4,{id:"\u5728\u5F53\u524D-passcontext-\u4E2D\u8986\u76D6\u5DE5\u5177",children:"\u5728\u5F53\u524D PassContext \u4E2D\u8986\u76D6\u5DE5\u5177"}),"\n",(0,a.jsxs)(n.p,{children:["\u63D0\u4F9B ",(0,a.jsx)(n.code,{children:"override_instruments"})," \u65B9\u6CD5\u6765\u8986\u76D6\u5F53\u524D ",(0,a.jsx)(n.code,{children:"PassContext"})," \u7684 ",(0,a.jsx)(n.code,{children:"instruments"}),"\u3002\u4F8B\u5982\uFF0C\u82E5\u5728\u6CA1\u6709\u663E\u5F0F\u521B\u5EFA\u65B0 ",(0,a.jsx)(n.code,{children:"PassContext"})," \u7684\u60C5\u51B5\u4E0B\u8FD0\u884C pass\uFF0C\u4ECD\u7136\u53EF\u4EE5\u901A\u8FC7\u4EE5\u4E0B\u65B9\u5F0F\u5C06 ",(0,a.jsx)(n.code,{children:"PassInstrument"})," \u6CE8\u518C\u5230\u5168\u5C40 ",(0,a.jsx)(n.code,{children:"PassContext"})," \u4E2D\uFF1A"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-python",children:"cur_pass_ctx = tvm.transform.PassContext.current()\n# \u8986\u76D6 PassInstrument \u5B9E\u4F8B\ncur_pass_ctx.override_instruments([pass_inst])\nmod = pass_seq(mod)\nresult = pass_inst.get_result()\n"})}),"\n",(0,a.jsxs)(n.p,{children:["\u6CE8\u610F\uFF0C\u8C03\u7528 ",(0,a.jsx)(n.code,{children:"override_instruments"})," \u540C\u65F6\u4E5F\u4F1A\u8C03\u7528\u65E7 ",(0,a.jsx)(n.code,{children:"PassInstrument"})," \u5B9E\u4F8B\u7684 ",(0,a.jsx)(n.code,{children:"exit_pass_ctx"})," \u65B9\u6CD5\u3002\u7136\u540E\u8C03\u7528\u65B0 ",(0,a.jsx)(n.code,{children:"PassInstrument"})," \u7684 ",(0,a.jsx)(n.code,{children:"enter_pass_ctx"})," \u65B9\u6CD5\u3002"]})]})}function h(s={}){let{wrapper:n}={...(0,r.a)(),...s.components};return n?(0,a.jsx)(n,{...s,children:(0,a.jsx)(d,{...s})}):d(s)}},21494:function(s,n,e){e.d(n,{Z:function(){return o},a:function(){return c}});var t=e(39546);let a={},r=t.createContext(a);function c(s){let n=t.useContext(r);return t.useMemo(function(){return"function"==typeof s?s(n):{...n,...s}},[n,s])}function o(s){let n;return n=s.disableParentContext?"function"==typeof s.components?s.components(a):s.components||a:c(s.components),t.createElement(r.Provider,{value:n},s.children)}}}]);