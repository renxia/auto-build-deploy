"use strict";(self.webpackChunktvm_cn=self.webpackChunktvm_cn||[]).push([["66673"],{71496:function(e,n,t){t.r(n),t.d(n,{default:()=>p,frontMatter:()=>s,metadata:()=>o,assets:()=>d,toc:()=>i,contentTitle:()=>l});var o=JSON.parse('{"id":"how_to/deploy/deploy_models/deploy_pi","title":"\u5728\u6811\u8393\u6D3E\u4E0A\u90E8\u7F72\u9884\u8BAD\u7EC3\u6A21\u578B","description":"\u5355\u51FB \u6B64\u5904 \u4E0B\u8F7D\u5B8C\u6574\u7684\u793A\u4F8B\u4EE3\u7801","source":"@site/versioned_docs/version-0.10.0/how_to/deploy/deploy_models/03-deploy_pi.md","sourceDirName":"how_to/deploy/deploy_models","slug":"/how_to/deploy/deploy_models/deploy_pi","permalink":"/docs/tvm-cn/docs/0.10.0/how_to/deploy/deploy_models/deploy_pi","draft":false,"unlisted":false,"editUrl":"https://github.com/hyperai/tvm-cn/edit/master/versioned_docs/version-0.10.0/how_to/deploy/deploy_models/03-deploy_pi.md","tags":[],"version":"0.10.0","lastUpdatedBy":"sparanoid","lastUpdatedAt":1744717810000,"sidebarPosition":3,"frontMatter":{"title":"\u5728\u6811\u8393\u6D3E\u4E0A\u90E8\u7F72\u9884\u8BAD\u7EC3\u6A21\u578B"},"sidebar":"tutorialSidebar","previous":{"title":"\u5728 Jetson Nano \u4E0A\u90E8\u7F72\u9884\u8BAD\u7EC3\u6A21\u578B","permalink":"/docs/tvm-cn/docs/0.10.0/how_to/deploy/deploy_models/deploy_nano"},"next":{"title":"\u7F16\u8BD1 PyTorch \u76EE\u6807\u68C0\u6D4B\u6A21\u578B","permalink":"/docs/tvm-cn/docs/0.10.0/how_to/deploy/deploy_models/compile_od"}}'),r=t("74132"),a=t("21494");let s={title:"\u5728\u6811\u8393\u6D3E\u4E0A\u90E8\u7F72\u9884\u8BAD\u7EC3\u6A21\u578B"},l="\u5728\u6811\u8393\u6D3E\u4E0A\u90E8\u7F72\u9884\u8BAD\u7EC3\u6A21\u578B",d={},i=[{value:"\u5728\u8BBE\u5907\u4E0A\u6784\u5EFA TVM Runtime",id:"\u5728\u8BBE\u5907\u4E0A\u6784\u5EFA-tvm-runtime",level:2},{value:"\u5728\u8BBE\u5907\u4E0A\u8BBE\u7F6E RPC \u670D\u52A1\u5668",id:"\u5728\u8BBE\u5907\u4E0A\u8BBE\u7F6E-rpc-\u670D\u52A1\u5668",level:2},{value:"\u51C6\u5907\u9884\u8BAD\u7EC3\u6A21\u578B",id:"\u51C6\u5907\u9884\u8BAD\u7EC3\u6A21\u578B",level:2},{value:"\u7F16\u8BD1\u8BA1\u7B97\u56FE",id:"\u7F16\u8BD1\u8BA1\u7B97\u56FE",level:2},{value:"\u901A\u8FC7 RPC \u8FDC\u7A0B\u90E8\u7F72\u6A21\u578B",id:"\u901A\u8FC7-rpc-\u8FDC\u7A0B\u90E8\u7F72\u6A21\u578B",level:2}];function c(e){let n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",header:"header",p:"p",pre:"pre",strong:"strong",...(0,a.a)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"\u5728\u6811\u8393\u6D3E\u4E0A\u90E8\u7F72\u9884\u8BAD\u7EC3\u6A21\u578B",children:"\u5728\u6811\u8393\u6D3E\u4E0A\u90E8\u7F72\u9884\u8BAD\u7EC3\u6A21\u578B"})}),"\n",(0,r.jsx)(n.admonition,{type:"note",children:(0,r.jsxs)(n.p,{children:["\u5355\u51FB ",(0,r.jsx)(n.a,{href:"https://tvm.apache.org/docs/how_to/deploy_models/deploy_model_on_rasp.html#sphx-glr-download-how-to-deploy-models-deploy-model-on-rasp-py",children:"\u6B64\u5904"})," \u4E0B\u8F7D\u5B8C\u6574\u7684\u793A\u4F8B\u4EE3\u7801"]})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"\u4F5C\u8005"}),"\uFF1A",(0,r.jsx)(n.a,{href:"https://ziheng.org/",children:"Ziheng Jiang"}),"\uFF0C",(0,r.jsx)(n.a,{href:"https://makihiro.github.io/",children:"Hiroyuki Makino"})]}),"\n",(0,r.jsx)(n.p,{children:"\u6B64\u6559\u7A0B\u4ECB\u7ECD\u5982\u4F55\u7528 Relay \u7F16\u8BD1 ResNet \u6A21\u578B\uFF0C\u5E76\u5C06\u5176\u90E8\u7F72\u5230\u6811\u8393\u6D3E\u3002"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:"import tvm\nfrom tvm import te\nimport tvm.relay as relay\nfrom tvm import rpc\nfrom tvm.contrib import utils, graph_executor as runtime\nfrom tvm.contrib.download import download_testdata\n"})}),"\n",(0,r.jsx)(n.h2,{id:"\u5728\u8BBE\u5907\u4E0A\u6784\u5EFA-tvm-runtime",children:"\u5728\u8BBE\u5907\u4E0A\u6784\u5EFA TVM Runtime"}),"\n",(0,r.jsx)(n.p,{children:"\u9996\u5148\u5728\u8FDC\u7A0B\u8BBE\u5907\u4E0A\u6784\u5EFA TVM runtime\u3002"}),"\n",(0,r.jsx)(n.admonition,{type:"note",children:(0,r.jsx)(n.p,{children:"\u672C\u8282\u548C\u4E0B\u4E00\u8282\u4E2D\u7684\u6240\u6709\u6307\u4EE4\u90FD\u5E94\u5728\u76EE\u6807\u8BBE\u5907\uFF08\u4F8B\u5982\u6811\u8393\u6D3E\uFF09\u53CA Linux \u4E0A\u6267\u884C\u3002"})}),"\n",(0,r.jsx)(n.p,{children:"\u7531\u4E8E\u6211\u4EEC\u662F\u5728\u672C\u5730\u673A\u5668\u4E0A\u8FDB\u884C\u7F16\u8BD1\uFF0C\u8FDC\u7A0B\u8BBE\u5907\u4EC5\u7528\u4E8E\u8FD0\u884C\u751F\u6210\u7684\u4EE3\u7801\uFF0C\u56E0\u6B64\u53EA\u9700\u5728\u8FDC\u7A0B\u8BBE\u5907\u4E0A\u6784\u5EFA TVM runtime\u3002"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"git clone --recursive https://github.com/apache/tvm tvm\ncd tvm\nmkdir build\ncp cmake/config.cmake build\ncd build\ncmake ..\nmake runtime -j4\n"})}),"\n",(0,r.jsxs)(n.p,{children:["runtime \u6784\u5EFA\u5B8C\u6210\u540E\uFF0C\u5728 ",(0,r.jsx)(n.code,{children:"~/.bashrc"})," \u6587\u4EF6\u4E2D\u8BBE\u7F6E\u73AF\u5883\u53D8\u91CF\u2014\u2014\u7528 ",(0,r.jsx)(n.code,{children:"vi ~/.bashrc"})," \u547D\u4EE4\u6765\u7F16\u8F91 ",(0,r.jsx)(n.code,{children:"~/.bashrc"}),"\uFF0C\u6DFB\u52A0\u4E0B\u9762\u8FD9\u884C\u4EE3\u7801\uFF08\u5047\u8BBE TVM \u76EE\u5F55\u5728 ",(0,r.jsx)(n.code,{children:"~/tvm"})," \u4E2D\uFF09\uFF1A"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"export PYTHONPATH=$PYTHONPATH:~/tvm/python\n"})}),"\n",(0,r.jsxs)(n.p,{children:["\u6267\u884C ",(0,r.jsx)(n.code,{children:"source ~/.bashrc"})," \u6765\u66F4\u65B0\u73AF\u5883\u53D8\u91CF\u3002"]}),"\n",(0,r.jsx)(n.h2,{id:"\u5728\u8BBE\u5907\u4E0A\u8BBE\u7F6E-rpc-\u670D\u52A1\u5668",children:"\u5728\u8BBE\u5907\u4E0A\u8BBE\u7F6E RPC \u670D\u52A1\u5668"}),"\n",(0,r.jsx)(n.p,{children:"\u5728\u8FDC\u7A0B\u8BBE\u5907\uFF08\u8BE5\u793A\u4F8B\u4E2D\u4E3A\u6811\u8393\u6D3E\uFF09\u4E0A\u8FD0\u884C\u4EE5\u4E0B\u547D\u4EE4\uFF0C\u542F\u52A8 RPC \u670D\u52A1\u5668\uFF1A"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"python -m tvm.exec.rpc_server --host 0.0.0.0 --port=9090\n"})}),"\n",(0,r.jsx)(n.p,{children:"\u770B\u5230\u5982\u4E0B\u7ED3\u679C\uFF0C\u5219\u8868\u793A RPC \u670D\u52A1\u5668\u542F\u52A8\u6210\u529F\uFF1A"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"INFO:root:RPCServer: bind to 0.0.0.0:9090\n"})}),"\n",(0,r.jsx)(n.h2,{id:"\u51C6\u5907\u9884\u8BAD\u7EC3\u6A21\u578B",children:"\u51C6\u5907\u9884\u8BAD\u7EC3\u6A21\u578B"}),"\n",(0,r.jsx)(n.p,{children:"\u6CE8\u610F\uFF1A\u786E\u4FDD\u4E3B\u673A\u5DF2\u7ECF\uFF08\u7528 LLVM\uFF09\u5B89\u88C5\u4E86\u5B8C\u6574\u7684 TVM\u3002"}),"\n",(0,r.jsxs)(n.p,{children:["\u4F7F\u7528 ",(0,r.jsx)(n.a,{href:"https://mxnet.apache.org/api/python/gluon/model_zoo.html",children:"MXNet Gluon \u6A21\u578B\u96C6\u5408"})," \u4E2D\u7684\u9884\u8BAD\u7EC3\u6A21\u578B\u3002\u66F4\u591A\u6709\u5173\u8FD9\u90E8\u5206\u7684\u4FE1\u606F\u8BE6\u89C1 ",(0,r.jsx)(n.a,{href:"/docs/how_to/compile/compile_mxnet",children:"\u7F16\u8BD1 MXNet \u6A21\u578B"})," \u6559\u7A0B\u3002"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'from mxnet.gluon.model_zoo.vision import get_model\nfrom PIL import Image\nimport numpy as np\n\n# \u7528\u4E00\u884C\u4EE3\u7801\u6765\u83B7\u53D6\u6A21\u578B\nblock = get_model("resnet18_v1", pretrained=True)\n'})}),"\n",(0,r.jsx)(n.p,{children:"\u4E3A\u4E86\u6D4B\u8BD5\u6A21\u578B\uFF0C\u4E0B\u8F7D\u4E00\u5F20\u732B\u7684\u56FE\u7247\uFF0C\u5E76\u8F6C\u6362\u5176\u683C\u5F0F\uFF1A"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'img_url = "https://github.com/dmlc/mxnet.js/blob/main/data/cat.png?raw=true"\nimg_name = "cat.png"\nimg_path = download_testdata(img_url, img_name, module="data")\nimage = Image.open(img_path).resize((224, 224))\n\ndef transform_image(image):\n    image = np.array(image) - np.array([123.0, 117.0, 104.0])\n    image /= np.array([58.395, 57.12, 57.375])\n    image = image.transpose((2, 0, 1))\n    image = image[np.newaxis, :]\n    return image\n\nx = transform_image(image)\n'})}),"\n",(0,r.jsx)(n.p,{children:"synset \u7528\u4E8E\u5C06 ImageNet \u7C7B\u7684\u6807\u7B7E\uFF0C\u8F6C\u6362\u4E3A\u4EBA\u7C7B\u66F4\u5BB9\u6613\u7406\u89E3\u7684\u5355\u8BCD\u3002"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'synset_url = "".join(\n    [\n        "https://gist.githubusercontent.com/zhreshold/",\n        "4d0b62f3d01426887599d4f7ede23ee5/raw/",\n        "596b27d23537e5a1b5751d2b0481ef172f58b539/",\n        "imagenet1000_clsid_to_human.txt",\n    ]\n)\nsynset_name = "imagenet1000_clsid_to_human.txt"\nsynset_path = download_testdata(synset_url, synset_name, module="data")\nwith open(synset_path) as f:\n    synset = eval(f.read())\n'})}),"\n",(0,r.jsx)(n.p,{children:"\u4EE5\u4E0B\u4EE3\u7801\u53EF\u5C06 Gluon \u6A21\u578B\u79FB\u690D\u5230\u53EF\u79FB\u690D\u7684\u8BA1\u7B97\u56FE\u4E0A\uFF1A"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'# \u5728 mxnet.gluon \u4E2D\u652F\u6301 MXNet \u9759\u6001\u8BA1\u7B97\u56FE\uFF08\u7B26\u53F7\uFF09\u548C HybridBlock\nshape_dict = {"data": x.shape}\nmod, params = relay.frontend.from_mxnet(block, shape_dict)\n# \u6DFB\u52A0 softmax \u7B97\u5B50\u63D0\u9AD8\u6982\u7387\nfunc = mod["main"]\nfunc = relay.Function(func.params, relay.nn.softmax(func.body), None, func.type_params, func.attrs)\n'})}),"\n",(0,r.jsx)(n.p,{children:"\u4EE5\u4E0B\u662F\u4E00\u4E9B\u57FA\u672C\u7684\u6570\u636E\u5DE5\u4F5C\u8D1F\u8F7D\u914D\u7F6E\uFF1A"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:"batch_size = 1\nnum_classes = 1000\nimage_shape = (3, 224, 224)\ndata_shape = (batch_size,) + image_shape\n"})}),"\n",(0,r.jsx)(n.h2,{id:"\u7F16\u8BD1\u8BA1\u7B97\u56FE",children:"\u7F16\u8BD1\u8BA1\u7B97\u56FE"}),"\n",(0,r.jsxs)(n.p,{children:["\u7528\u8BA1\u7B97\u56FE\u7684\u914D\u7F6E\u548C\u53C2\u6570\u8C03\u7528 ",(0,r.jsx)(n.code,{children:"relay.build()"})," \u51FD\u6570\uFF0C\u4ECE\u800C\u7F16\u8BD1\u8BA1\u7B97\u56FE\u3002\u4F46\u662F\uFF0C\u4E0D\u80FD\u5728\u5177\u6709 ARM \u6307\u4EE4\u96C6\u7684\u8BBE\u5907\u4E0A\u90E8\u7F72 x86 \u7A0B\u5E8F\u3002\u9664\u4E86\u7528\u6765\u6307\u5B9A\u6DF1\u5EA6\u5B66\u4E60\u5DE5\u4F5C\u8D1F\u8F7D\u7684\u53C2\u6570 ",(0,r.jsx)(n.code,{children:"net"})," \u548C ",(0,r.jsx)(n.code,{children:"params"}),"\uFF0CRelay \u8FD8\u9700\u8981\u77E5\u9053\u76EE\u6807\u8BBE\u5907\u7684\u7F16\u8BD1\u9009\u9879\u3002\u4E0D\u540C\u9009\u9879\u4F1A\u5BFC\u81F4\u6027\u80FD\u4E0D\u540C\u3002"]}),"\n",(0,r.jsxs)(n.p,{children:["\u5982\u679C\u5728 x86 \u670D\u52A1\u5668\u4E0A\u8FD0\u884C\u793A\u4F8B\uFF0C\u53EF\u5C06\u5176\u8BBE\u7F6E\u4E3A ",(0,r.jsx)(n.code,{children:"llvm"}),"\u3002\u5982\u679C\u5728\u6811\u8393\u6D3E\u4E0A\u8FD0\u884C\uFF0C\u9700\u8981\u6307\u5B9A\u5B83\u7684\u6307\u4EE4\u96C6\u3002\u82E5\u8981\u5728\u771F\u5B9E\u8BBE\u5907\u4E0A\u8FD0\u884C\uFF0C\u9700\u5C06 ",(0,r.jsx)(n.code,{children:"local_demo"})," \u8BBE\u7F6E\u4E3A False\u3002"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'local_demo = True\n\nif local_demo:\n    target = tvm.target.Target("llvm")\nelse:\n    target = tvm.target.arm_cpu("rasp3b")\n    # \u4E0A\u9762\u4E00\u884C\u4EE3\u7801\u662F\u4E0B\u9762\u4EE3\u7801\u7684\u7B80\u5355\u5F62\u5F0F\uFF1A\n    # target = tvm.target.Target(\'llvm -device=arm_cpu -model=bcm2837 -mtriple=armv7l-linux-gnueabihf -mattr=+neon\')\n\nwith tvm.transform.PassContext(opt_level=3):\n    lib = relay.build(func, target, params=params)\n\n# \u5728 `relay.build` \u4E4B\u540E\uFF0C\u4F1A\u5F97\u5230\u4E09\u4E2A\u8FD4\u56DE\u503C\uFF1A\u8BA1\u7B97\u56FE\uFF0C\u5E93\u548C\u65B0\u53C2\u6570\uFF0C\u56E0\u4E3A\u6211\u4EEC\u505A\u4E86\u4E00\u4E9B\u4F18\u5316\uFF0C\u5B83\u4EEC\u4F1A\u6539\u53D8\u53C2\u6570\uFF0C\u4F46\u6A21\u578B\u7684\u7ED3\u679C\u4E0D\u53D8\u3002\n\n# \u5C06\u5E93\u4FDD\u5B58\u5728\u672C\u5730\u4E34\u65F6\u76EE\u5F55\u4E2D\u3002\ntmp = utils.tempdir()\nlib_fname = tmp.relpath("net.tar")\nlib.export_library(lib_fname)\n'})}),"\n",(0,r.jsx)(n.p,{children:"\u8F93\u51FA\u7ED3\u679C\uFF1A"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'/workspace/python/tvm/relay/build_module.py:411: DeprecationWarning: Please use input parameter mod (tvm.IRModule) instead of deprecated parameter mod (tvm.relay.function.Function)\n  DeprecationWarning,\n/workspace/python/tvm/driver/build_module.py:268: UserWarning: target_host parameter is going to be deprecated. Please pass in tvm.target.Target(target, host=target_host) instead.\n  "target_host parameter is going to be deprecated. "\n'})}),"\n",(0,r.jsx)(n.h2,{id:"\u901A\u8FC7-rpc-\u8FDC\u7A0B\u90E8\u7F72\u6A21\u578B",children:"\u901A\u8FC7 RPC \u8FDC\u7A0B\u90E8\u7F72\u6A21\u578B"}),"\n",(0,r.jsx)(n.p,{children:"\u5229\u7528 RPC \u53EF\u5C06\u6A21\u578B\u4ECE\u4E3B\u673A\u90E8\u7F72\u5230\u8FDC\u7A0B\u8BBE\u5907\u3002"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'# \u4ECE\u8FDC\u7A0B\u8BBE\u5907\u83B7\u53D6 RPC session\u3002\nif local_demo:\n    remote = rpc.LocalSession()\nelse:\n    # \u4E0B\u9762\u662F\u6559\u7A0B\u73AF\u5883\uFF0C\u628A\u8FD9\u4E2A\u6539\u6210\u4F60\u76EE\u6807\u8BBE\u5907\u7684 IP \u5730\u5740\n    host = "10.77.1.162"\n    port = 9090\n    remote = rpc.connect(host, port)\n\n# \u5C06\u5E93\u4E0A\u4F20\u5230\u8FDC\u7A0B\u8BBE\u5907\uFF0C\u5E76\u52A0\u8F7D\u5B83\nremote.upload(lib_fname)\nrlib = remote.load_module("net.tar")\n\n# \u521B\u5EFA\u8FDC\u7A0B runtime \u6A21\u5757\ndev = remote.cpu(0)\nmodule = runtime.GraphModule(rlib["default"](dev))\n# \u8BBE\u7F6E\u8F93\u5165\u6570\u636E\nmodule.set_input("data", tvm.nd.array(x.astype("float32")))\n# \u8FD0\u884C\nmodule.run()\n# \u5F97\u5230\u7ED3\u679C\nout = module.get_output(0)\n# \u5F97\u5230\u6392\u7B2C\u4E00\u7684\u7ED3\u679C\ntop1 = np.argmax(out.numpy())\nprint("TVM prediction top-1: {}".format(synset[top1]))\n'})}),"\n",(0,r.jsx)(n.p,{children:"\u8F93\u51FA\u7ED3\u679C\uFF1A"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"TVM prediction top-1: tiger cat\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.a,{href:"https://tvm.apache.org/docs/_downloads/408ef96692a668b33d94eca33cac7e0a/deploy_model_on_rasp.py",children:"\u4E0B\u8F7D Python \u6E90\u4EE3\u7801\uFF1Adeploy_model_on_rasp.py"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.a,{href:"https://tvm.apache.org/docs/_downloads/7c392f39b90d93406ef30c6185c5686c/deploy_model_on_rasp.ipynb",children:"\u4E0B\u8F7D Jupyter Notebook\uFF1Adeploy_model_on_rasp.ipynb"})})]})}function p(e={}){let{wrapper:n}={...(0,a.a)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(c,{...e})}):c(e)}},21494:function(e,n,t){t.d(n,{Z:function(){return l},a:function(){return s}});var o=t(39546);let r={},a=o.createContext(r);function s(e){let n=o.useContext(a);return o.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:s(e.components),o.createElement(a.Provider,{value:n},e.children)}}}]);