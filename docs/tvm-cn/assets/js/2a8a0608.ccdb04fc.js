"use strict";(self.webpackChunktvm_cn=self.webpackChunktvm_cn||[]).push([["44808"],{29384:function(e,n,o){o.r(n),o.d(n,{default:()=>c,frontMatter:()=>s,metadata:()=>t,assets:()=>i,toc:()=>p,contentTitle:()=>l});var t=JSON.parse('{"id":"how_to/compile/compile_tensorflow","title":"\u7F16\u8BD1 TensorFlow \u6A21\u578B","description":"\u5355\u51FB \u6B64\u5904 \u4E0B\u8F7D\u5B8C\u6574\u7684\u793A\u4F8B\u4EE3\u7801","source":"@site/versioned_docs/version-0.12.0/how_to/compile/02-compile_tensorflow.md","sourceDirName":"how_to/compile","slug":"/how_to/compile/compile_tensorflow","permalink":"/docs/tvm-cn/docs/0.12.0/how_to/compile/compile_tensorflow","draft":false,"unlisted":false,"editUrl":"https://github.com/hyperai/tvm-cn/edit/master/versioned_docs/version-0.12.0/how_to/compile/02-compile_tensorflow.md","tags":[],"version":"0.12.0","lastUpdatedBy":"sparanoid","lastUpdatedAt":1744717810000,"sidebarPosition":2,"frontMatter":{"title":"\u7F16\u8BD1 TensorFlow \u6A21\u578B"},"sidebar":"tutorialSidebar","previous":{"title":"\u7F16\u8BD1 PyTorch \u6A21\u578B","permalink":"/docs/tvm-cn/docs/0.12.0/how_to/compile/compile_pytorch"},"next":{"title":"\u7F16\u8BD1 MXNet \u6A21\u578B","permalink":"/docs/tvm-cn/docs/0.12.0/how_to/compile/compile_mxnet"}}'),r=o("74132"),a=o("21494");let s={title:"\u7F16\u8BD1 TensorFlow \u6A21\u578B"},l="\u7F16\u8BD1 TensorFlow \u6A21\u578B",i={},p=[{value:"\u6559\u7A0B",id:"\u6559\u7A0B",level:2},{value:"\u4E0B\u8F7D\u6240\u9700\u6587\u4EF6",id:"\u4E0B\u8F7D\u6240\u9700\u6587\u4EF6",level:2},{value:"\u5BFC\u5165\u6A21\u578B",id:"\u5BFC\u5165\u6A21\u578B",level:2},{value:"\u89E3\u7801\u56FE\u50CF",id:"\u89E3\u7801\u56FE\u50CF",level:2},{value:"\u5C06\u8BA1\u7B97\u56FE\u5BFC\u5165 Relay",id:"\u5C06\u8BA1\u7B97\u56FE\u5BFC\u5165-relay",level:2},{value:"Relay \u6784\u5EFA",id:"relay-\u6784\u5EFA",level:2},{value:"\u5728 TVM \u4E0A\u6267\u884C\u53EF\u79FB\u690D\u8BA1\u7B97\u56FE",id:"\u5728-tvm-\u4E0A\u6267\u884C\u53EF\u79FB\u690D\u8BA1\u7B97\u56FE",level:2},{value:"\u5904\u7406\u8F93\u51FA",id:"\u5904\u7406\u8F93\u51FA",level:2},{value:"\u5728 TensorFlow \u4E0A\u63A8\u7406",id:"\u5728-tensorflow-\u4E0A\u63A8\u7406",level:2}];function d(e){let n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.a)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"\u7F16\u8BD1-tensorflow-\u6A21\u578B",children:"\u7F16\u8BD1 TensorFlow \u6A21\u578B"})}),"\n",(0,r.jsx)(n.admonition,{type:"note",children:(0,r.jsxs)(n.p,{children:["\u5355\u51FB ",(0,r.jsx)(n.a,{href:"https://tvm.apache.org/docs/how_to/compile_models/from_tensorflow.html#sphx-glr-download-how-to-compile-models-from-tensorflow-py",children:"\u6B64\u5904"})," \u4E0B\u8F7D\u5B8C\u6574\u7684\u793A\u4F8B\u4EE3\u7801"]})}),"\n",(0,r.jsx)(n.p,{children:"\u672C\u6587\u4ECB\u7ECD\u4E86\u5982\u4F55\u7528 TVM \u90E8\u7F72 TensorFlow \u6A21\u578B\u3002"}),"\n",(0,r.jsxs)(n.p,{children:["\u9996\u5148\u5B89\u88C5 TensorFlow Python \u6A21\u5757\uFF08\u53EF\u53C2\u8003 ",(0,r.jsx)(n.a,{href:"https://www.tensorflow.org/install%EF%BC%89%E3%80%82",children:"https://www.tensorflow.org/install\uFF09\u3002"})]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'# \u5BFC\u5165 tvm \u548C relay\nimport tvm\nfrom tvm import te\nfrom tvm import relay\n\n# \u5BFC\u5165 os \u548C numpy\nimport numpy as np\nimport os.path\n\n# \u5BFC\u5165 TensorFlow\nimport tensorflow as tf\n\n# \u8BA9 TensorFlow \u5C06 GPU \u5185\u5B58\u9650\u5236\u4E3A\u5B9E\u9645\u9700\u8981\u7684\u5185\u5B58\uFF0C\u800C\u975E\u5360\u7528\u6240\u6709\u53EF\u7528\u7684\u5185\u5B58\u3002\n# https://www.tensorflow.org/guide/gpu#limiting_gpu_memory_growth\n# \u672C\u6559\u7A0B\u8FD9\u6837\u505A\uFF0C\u5BF9 sphinx-gallery \u66F4\u53CB\u597D\u3002\ngpus = tf.config.list_physical_devices("GPU")\nif gpus:\n    try:\n        for gpu in gpus:\n            tf.config.experimental.set_memory_growth(gpu, True)\n        print("tensorflow will use experimental.set_memory_growth(True)")\n    except RuntimeError as e:\n        print("experimental.set_memory_growth option is not available: {}".format(e))\n\ntry:\n    tf_compat_v1 = tf.compat.v1\nexcept ImportError:\n    tf_compat_v1 = tf\n\n# TensorFlow \u5B9E\u7528\u51FD\u6570\nimport tvm.relay.testing.tf as tf_testing\n\n# \u6A21\u578B\u76F8\u5173\u6587\u4EF6\u7684\u57FA\u672C\u4F4D\u7F6E\nrepo_base = "https://github.com/dmlc/web-data/raw/main/tensorflow/models/InceptionV1/"\n\n# \u6D4B\u8BD5\u56FE\u50CF\nimg_name = "elephant-299.jpg"\nimage_url = os.path.join(repo_base, img_name)\n'})}),"\n",(0,r.jsx)(n.h2,{id:"\u6559\u7A0B",children:"\u6559\u7A0B"}),"\n",(0,r.jsx)(n.p,{children:"\u53C2\u8003 docs/frontend/tensorflow.md\uFF0C\u83B7\u53D6 TensorFlow \u4E2D\u5404\u79CD\u6A21\u578B\u7684\u66F4\u591A\u4FE1\u606F\u3002"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'model_name = "classify_image_graph_def-with_shapes.pb"\nmodel_url = os.path.join(repo_base, model_name)\n\n# \u56FE\u50CF\u6807\u7B7E\u56FE\nmap_proto = "imagenet_2012_challenge_label_map_proto.pbtxt"\nmap_proto_url = os.path.join(repo_base, map_proto)\n\n# \u53EF\u8BFB\u7684\u6807\u7B7E\u6587\u672C\nlabel_map = "imagenet_synset_to_human_label_map.txt"\nlabel_map_url = os.path.join(repo_base, label_map)\n\n# target \u8BBE\u7F6E\n# \u7528\u4E0B\u9762\u8FD9\u4E9B\u6CE8\u91CA\u4E3A cuda \u6784\u5EFA\n# target = tvm.target.Target("cuda", host="llvm")\n# layout = "NCHW"\n# dev = tvm.cuda(0)\ntarget = tvm.target.Target("llvm", host="llvm")\nlayout = None\ndev = tvm.cpu(0)\n'})}),"\n",(0,r.jsx)(n.h2,{id:"\u4E0B\u8F7D\u6240\u9700\u6587\u4EF6",children:"\u4E0B\u8F7D\u6240\u9700\u6587\u4EF6"}),"\n",(0,r.jsx)(n.p,{children:"\u4E0B\u8F7D\u4E0A\u8FF0\u5217\u51FA\u7684\u6587\u4EF6\uFF1A"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'from tvm.contrib.download import download_testdata\n\nimg_path = download_testdata(image_url, img_name, module="data")\nmodel_path = download_testdata(model_url, model_name, module=["tf", "InceptionV1"])\nmap_proto_path = download_testdata(map_proto_url, map_proto, module="data")\nlabel_path = download_testdata(label_map_url, label_map, module="data")\n'})}),"\n",(0,r.jsx)(n.h2,{id:"\u5BFC\u5165\u6A21\u578B",children:"\u5BFC\u5165\u6A21\u578B"}),"\n",(0,r.jsx)(n.p,{children:"\u4ECE protobuf \u6587\u4EF6\u521B\u5EFA TensorFlow \u8BA1\u7B97\u56FE\u5B9A\u4E49\u3002"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'with tf_compat_v1.gfile.GFile(model_path, "rb") as f:\n    graph_def = tf_compat_v1.GraphDef()\n    graph_def.ParseFromString(f.read())\n    graph = tf.import_graph_def(graph_def, name="")\n    # \u8C03\u7528\u51FD\u6570\u5C06\u8BA1\u7B97\u56FE\u5B9A\u4E49\u5BFC\u5165\u9ED8\u8BA4\u8BA1\u7B97\u56FE\u3002\n    graph_def = tf_testing.ProcessGraphDefParam(graph_def)\n    # \u7ED9\u8BA1\u7B97\u56FE\u6DFB\u52A0 shape\n    with tf_compat_v1.Session() as sess:\n        graph_def = tf_testing.AddShapesToGraphDef(sess, "softmax")\n'})}),"\n",(0,r.jsx)(n.h2,{id:"\u89E3\u7801\u56FE\u50CF",children:"\u89E3\u7801\u56FE\u50CF"}),"\n",(0,r.jsx)(n.admonition,{type:"note",children:(0,r.jsx)(n.p,{children:"TensorFlow \u524D\u7AEF\u5BFC\u5165\u4E0D\u652F\u6301 JpegDecode \u7B49\u9884\u5904\u7406\u64CD\u4F5C\u3002 JpegDecode \u88AB\u7ED5\u8FC7\uFF08\u53EA\u8FD4\u56DE\u6E90\u8282\u70B9\uFF09\uFF0C\u56E0\u6B64\u6211\u4EEC\u53EA\u5411 TVM \u63D0\u4F9B\u89E3\u7801\u540E\u7684\u5E27\u3002"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:"from PIL import Image\n\nimage = Image.open(img_path).resize((299, 299))\n\nx = np.array(image)\n"})}),"\n",(0,r.jsx)(n.h2,{id:"\u5C06\u8BA1\u7B97\u56FE\u5BFC\u5165-relay",children:"\u5C06\u8BA1\u7B97\u56FE\u5BFC\u5165 Relay"}),"\n",(0,r.jsx)(n.p,{children:"\u5C06 TensorFlow \u8BA1\u7B97\u56FE\u5B9A\u4E49\u5BFC\u5165\u5230 Relay \u524D\u7AEF\u3002"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"\u7ED3\u679C\uFF1A"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"sym\uFF1A\u7ED9\u5B9A TensorFlow protobuf \u7684 Relay \u8868\u8FBE\u5F0F\u3002"}),"\n",(0,r.jsx)(n.li,{children:"params\uFF1A\u4ECE TensorFlow \u53C2\u6570 (tensor protobuf) \u8F6C\u6362\u800C\u6765\u7684\u53C2\u6570\u3002"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'shape_dict = {"DecodeJpeg/contents": x.shape}\ndtype_dict = {"DecodeJpeg/contents": "uint8"}\nmod, params = relay.frontend.from_tensorflow(graph_def, layout=layout, shape=shape_dict)\n\nprint("Tensorflow protobuf imported to relay frontend.")\n'})}),"\n",(0,r.jsx)(n.p,{children:"\u8F93\u51FA\u7ED3\u679C\uFF1A"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'/workspace/python/tvm/relay/frontend/tensorflow.py:535: UserWarning: Ignore the passed shape. Shape in graphdef will be used for operator DecodeJpeg/contents.\n  "will be used for operator %s." % node.name\n/workspace/python/tvm/relay/frontend/tensorflow_ops.py:1009: UserWarning: DecodeJpeg: It\'s a pass through, please handle preprocessing before input\n  warnings.warn("DecodeJpeg: It\'s a pass through, please handle preprocessing before input")\nTensorflow protobuf imported to relay frontend.\n'})}),"\n",(0,r.jsx)(n.h2,{id:"relay-\u6784\u5EFA",children:"Relay \u6784\u5EFA"}),"\n",(0,r.jsx)(n.p,{children:"\u7528\u7ED9\u5B9A\u7684\u8F93\u5165\u89C4\u8303\uFF0C\u5C06\u8BA1\u7B97\u56FE\u7F16\u8BD1\u4E3A LLVM target\u3002"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"\u7ED3\u679C\uFF1A"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"graph\uFF1A\u7F16\u8BD1\u540E\u7684\u6700\u7EC8\u8BA1\u7B97\u56FE\u3002"}),"\n",(0,r.jsx)(n.li,{children:"params\uFF1A\u7F16\u8BD1\u540E\u7684\u6700\u7EC8\u53C2\u6570\u3002"}),"\n",(0,r.jsx)(n.li,{children:"lib\uFF1Atarget \u5E93\uFF08\u53EF\u7528 TVM runtime \u90E8\u7F72\u5230 target \u4E0A\uFF09 \u3002"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:"with tvm.transform.PassContext(opt_level=3):\n    lib = relay.build(mod, target, params=params)\n"})}),"\n",(0,r.jsx)(n.p,{children:"\u8F93\u51FA\u7ED3\u679C\uFF1A"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'/workspace/python/tvm/driver/build_module.py:268: UserWarning: target_host parameter is going to be deprecated. Please pass in tvm.target.Target(target, host=target_host) instead.\n  "target_host parameter is going to be deprecated. "\n'})}),"\n",(0,r.jsx)(n.h2,{id:"\u5728-tvm-\u4E0A\u6267\u884C\u53EF\u79FB\u690D\u8BA1\u7B97\u56FE",children:"\u5728 TVM \u4E0A\u6267\u884C\u53EF\u79FB\u690D\u8BA1\u7B97\u56FE"}),"\n",(0,r.jsx)(n.p,{children:"\u63A5\u4E0B\u6765\u5728 target \u4E0A\u90E8\u7F72\u7F16\u8BD1\u597D\u7684\u6A21\u578B\uFF1A"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'from tvm.contrib import graph_executor\n\ndtype = "uint8"\nm = graph_executor.GraphModule(lib["default"](dev))\n# \u8BBE\u7F6E\u8F93\u5165\nm.set_input("DecodeJpeg/contents", tvm.nd.array(x.astype(dtype)))\n# \u6267\u884C\nm.run()\n# \u5F97\u5230\u8F93\u51FA\ntvm_output = m.get_output(0, tvm.nd.empty(((1, 1008)), "float32"))\n'})}),"\n",(0,r.jsx)(n.h2,{id:"\u5904\u7406\u8F93\u51FA",children:"\u5904\u7406\u8F93\u51FA"}),"\n",(0,r.jsx)(n.p,{children:"\u5C06 InceptionV1 \u6A21\u578B\u7684\u8F93\u51FA\u5904\u7406\u4E3A\u4EBA\u7C7B\u53EF\u8BFB\u6587\u672C\u3002"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'predictions = tvm_output.numpy()\npredictions = np.squeeze(predictions)\n\n# \u521B\u5EFA\u8282\u70B9 ID --\x3e \u82F1\u6587\u5B57\u7B26\u4E32\u67E5\u627E\nnode_lookup = tf_testing.NodeLookup(label_lookup_path=map_proto_path, uid_lookup_path=label_path)\n\n# \u6253\u5370 TVM \u8F93\u51FA\u7684\u524D 5 \u4E2A\u9884\u6D4B\u3002\ntop_k = predictions.argsort()[-5:][::-1]\nfor node_id in top_k:\n    human_string = node_lookup.id_to_string(node_id)\n    score = predictions[node_id]\n    print("%s (score = %.5f)" % (human_string, score))\n'})}),"\n",(0,r.jsx)(n.p,{children:"\u8F93\u51FA\u7ED3\u679C\uFF1A"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"African elephant, Loxodonta africana (score = 0.61481)\ntusker (score = 0.30387)\nIndian elephant, Elephas maximus (score = 0.03343)\nbanana (score = 0.00023)\nrapeseed (score = 0.00021)\n"})}),"\n",(0,r.jsx)(n.h2,{id:"\u5728-tensorflow-\u4E0A\u63A8\u7406",children:"\u5728 TensorFlow \u4E0A\u63A8\u7406"}),"\n",(0,r.jsx)(n.p,{children:"\u5728 TensorFlow \u4E0A\u8FD0\u884C\u5BF9\u5E94\u7684\u6A21\u578B\uFF1A"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'def create_graph():\n    """\u4ECE\u5DF2\u4FDD\u5B58\u7684 GraphDef \u6587\u4EF6\u521B\u5EFA\u4E00\u4E2A\u8BA1\u7B97\u56FE\uFF0C\u5E76\u8FD4\u56DE saver\u3002"""\n    # \u4ECE\u5DF2\u4FDD\u5B58\u7684 graph_def.pb \u521B\u5EFA\u56FE\u5F62\n    with tf_compat_v1.gfile.GFile(model_path, "rb") as f:\n        graph_def = tf_compat_v1.GraphDef()\n        graph_def.ParseFromString(f.read())\n        graph = tf.import_graph_def(graph_def, name="")\n        # \u8C03\u7528\u51FD\u6570\u5C06\u8BA1\u7B97\u56FE\u5B9A\u4E49\u5BFC\u5165\u9ED8\u8BA4\u8BA1\u7B97\u56FE\u3002\n        graph_def = tf_testing.ProcessGraphDefParam(graph_def)\n\ndef run_inference_on_image(image):\n    """\u5728\u56FE\u50CF\u4E0A\u8FDB\u884C\u63A8\u7406\u3002\n\n    \u53C2\u6570\n    ----------\n    image: String \u7C7B\u578B\n        \u56FE\u50CF\u6587\u4EF6\u540D\u3002\n\n    \u8FD4\u56DE\u503C\n    -------\n        \u65E0\n    """\n    if not tf_compat_v1.gfile.Exists(image):\n        tf.logging.fatal("File does not exist %s", image)\n    image_data = tf_compat_v1.gfile.GFile(image, "rb").read()\n\n    # \u4ECE\u5DF2\u4FDD\u5B58\u7684 GraphDef \u521B\u5EFA\u8BA1\u7B97\u56FE\u3002\n    create_graph()\n\n    with tf_compat_v1.Session() as sess:\n        softmax_tensor = sess.graph.get_tensor_by_name("softmax:0")\n        predictions = sess.run(softmax_tensor, {"DecodeJpeg/contents:0": image_data})\n\n        predictions = np.squeeze(predictions)\n\n        # \u521B\u5EFA\u8282\u70B9 ID --\x3e \u82F1\u6587\u5B57\u7B26\u67E5\u627E\n        node_lookup = tf_testing.NodeLookup(\n            label_lookup_path=map_proto_path, uid_lookup_path=label_path\n        )\n\n        # \u6253\u5370 TensorFlow \u7684\u524D 5 \u4E2A\u9884\u6D4B\u3002\n        top_k = predictions.argsort()[-5:][::-1]\n        print("===== TENSORFLOW RESULTS =======")\n        for node_id in top_k:\n            human_string = node_lookup.id_to_string(node_id)\n            score = predictions[node_id]\n            print("%s (score = %.5f)" % (human_string, score))\n\nrun_inference_on_image(img_path)\n'})}),"\n",(0,r.jsx)(n.p,{children:"\u8F93\u51FA\u7ED3\u679C\uFF1A"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"===== TENSORFLOW RESULTS =======\nAfrican elephant, Loxodonta africana (score = 0.58394)\ntusker (score = 0.33909)\nIndian elephant, Elephas maximus (score = 0.03186)\nbanana (score = 0.00022)\ndesk (score = 0.00019)\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"\u811A\u672C\u603B\u8FD0\u884C\u65F6\u957F\uFF1A"})," \uFF081 \u5206 6.352 \u79D2\uFF09"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.a,{href:"https://tvm.apache.org/docs/_downloads/7f1d3d1b878694c201c614c807cdebc8/from_tensorflow.py",children:"\u4E0B\u8F7D Python \u6E90\u4EE3\u7801\uFF1Afrom_tensorflow.py"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.a,{href:"https://tvm.apache.org/docs/_downloads/83e3b018e8bac8d31bb331d200a33a04/from_tensorflow.ipynb",children:"\u4E0B\u8F7D Jupyter Notebook\uFF1Afrom_tensorflow.ipynb"})})]})}function c(e={}){let{wrapper:n}={...(0,a.a)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},21494:function(e,n,o){o.d(n,{Z:function(){return l},a:function(){return s}});var t=o(39546);let r={},a=t.createContext(r);function s(e){let n=t.useContext(a);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:s(e.components),t.createElement(a.Provider,{value:n},e.children)}}}]);