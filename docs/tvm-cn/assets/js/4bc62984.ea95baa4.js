"use strict";(self.webpackChunktvm_cn=self.webpackChunktvm_cn||[]).push([["17349"],{60735:function(e,n,o){o.r(n),o.d(n,{default:()=>p,frontMatter:()=>s,metadata:()=>t,assets:()=>l,toc:()=>c,contentTitle:()=>i});var t=JSON.parse('{"id":"how_to/compile/compile_onnx","title":"\u7F16\u8BD1 ONNX \u6A21\u578B","description":"\u5355\u51FB \u6B64\u5904 \u4E0B\u8F7D\u5B8C\u6574\u7684\u793A\u4F8B\u4EE3\u7801","source":"@site/versioned_docs/version-0.10.0/how_to/compile/04-compile_onnx.md","sourceDirName":"how_to/compile","slug":"/how_to/compile/compile_onnx","permalink":"/docs/tvm-cn/docs/0.10.0/how_to/compile/compile_onnx","draft":false,"unlisted":false,"editUrl":"https://github.com/hyperai/tvm-cn/edit/master/versioned_docs/version-0.10.0/how_to/compile/04-compile_onnx.md","tags":[],"version":"0.10.0","lastUpdatedBy":"sparanoid","lastUpdatedAt":1744717810000,"sidebarPosition":4,"frontMatter":{"title":"\u7F16\u8BD1 ONNX \u6A21\u578B"},"sidebar":"tutorialSidebar","previous":{"title":"\u7F16\u8BD1 MXNet \u6A21\u578B","permalink":"/docs/tvm-cn/docs/0.10.0/how_to/compile/compile_mxnet"},"next":{"title":"\u7F16\u8BD1 Keras \u6A21\u578B","permalink":"/docs/tvm-cn/docs/0.10.0/how_to/compile/compile_keras"}}'),r=o("74132"),a=o("21494");let s={title:"\u7F16\u8BD1 ONNX \u6A21\u578B"},i="\u7F16\u8BD1 ONNX \u6A21\u578B",l={},c=[{value:"\u52A0\u8F7D\u9884\u8BAD\u7EC3\u7684 ONNX \u6A21\u578B",id:"\u52A0\u8F7D\u9884\u8BAD\u7EC3\u7684-onnx-\u6A21\u578B",level:2},{value:"\u52A0\u8F7D\u6D4B\u8BD5\u56FE\u50CF",id:"\u52A0\u8F7D\u6D4B\u8BD5\u56FE\u50CF",level:2},{value:"\u4F7F\u7528 Relay \u7F16\u8BD1\u6A21\u578B",id:"\u4F7F\u7528-relay-\u7F16\u8BD1\u6A21\u578B",level:2},{value:"\u5728 TVM \u4E0A\u6267\u884C",id:"\u5728-tvm-\u4E0A\u6267\u884C",level:2},{value:"\u67E5\u770B\u7ED3\u679C",id:"\u67E5\u770B\u7ED3\u679C",level:2},{value:"\u6CE8\u610F",id:"\u6CE8\u610F",level:2}];function d(e){let n={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",header:"header",img:"img",p:"p",pre:"pre",strong:"strong",...(0,a.a)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"\u7F16\u8BD1-onnx-\u6A21\u578B",children:"\u7F16\u8BD1 ONNX \u6A21\u578B"})}),"\n",(0,r.jsx)(n.admonition,{type:"note",children:(0,r.jsxs)(n.p,{children:["\u5355\u51FB ",(0,r.jsx)(n.a,{href:"https://tvm.apache.org/docs/how_to/compile_models/from_onnx.html#sphx-glr-download-how-to-compile-models-from-onnx-py",children:"\u6B64\u5904"})," \u4E0B\u8F7D\u5B8C\u6574\u7684\u793A\u4F8B\u4EE3\u7801"]})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"\u4F5C\u8005"}),"\uFF1A",(0,r.jsx)(n.a,{href:"https://zhreshold.github.io/",children:"Joshua Z. Zhang"})]}),"\n",(0,r.jsx)(n.p,{children:"\u672C\u6587\u5C06\u4ECB\u7ECD\u5982\u4F55\u7528 Relay \u90E8\u7F72 ONNX \u6A21\u578B\u3002"}),"\n",(0,r.jsx)(n.p,{children:"\u9996\u5148\u5B89\u88C5 ONNX \u5305\uFF0C\u6700\u4FBF\u6377\u7684\u65B9\u6CD5\u63A8\u8350\u5B89\u88C5 protobuf \u7F16\u8BD1\u5668\uFF1A"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"pip install --user onnx onnxoptimizer\n"})}),"\n",(0,r.jsxs)(n.p,{children:["\u6216\u53C2\u8003\u5B98\u65B9\u7F51\u7AD9\uFF1A",(0,r.jsx)(n.a,{href:"https://github.com/onnx/onnx",children:"https://github.com/onnx/onnx"})]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:"import onnx\nimport numpy as np\nimport tvm\nfrom tvm import te\nimport tvm.relay as relay\nfrom tvm.contrib.download import download_testdata\n"})}),"\n",(0,r.jsx)(n.h2,{id:"\u52A0\u8F7D\u9884\u8BAD\u7EC3\u7684-onnx-\u6A21\u578B",children:"\u52A0\u8F7D\u9884\u8BAD\u7EC3\u7684 ONNX \u6A21\u578B"}),"\n",(0,r.jsxs)(n.p,{children:["\u4E0B\u9762\u793A\u4F8B\u4E2D\u7684\u8D85\u5206\u8FA8\u7387\u6A21\u578B\u4E0E ",(0,r.jsx)(n.a,{href:"http://pytorch.org/tutorials/advanced/super_resolution_with_caffe2.html",children:"ONNX \u6559\u7A0B"})," \u4E2D\u7684\u6A21\u578B\u5B8C\u5168\u76F8\u540C\uFF0C\u8DF3\u8FC7 PyTorch \u6A21\u578B\u7684\u6784\u5EFA\u90E8\u5206\uFF0C\u4E0B\u8F7D\u4FDD\u5B58\u7684 ONNX \u6A21\u578B\uFF1A"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'model_url = "".join(\n    [\n        "https://gist.github.com/zhreshold/",\n        "bcda4716699ac97ea44f791c24310193/raw/",\n        "93672b029103648953c4e5ad3ac3aadf346a4cdc/",\n        "super_resolution_0.2.onnx",\n    ]\n)\nmodel_path = download_testdata(model_url, "super_resolution.onnx", module="onnx")\n# \u73B0\u5728\u78C1\u76D8\u4E0A\u6709 super_resolution.onnx \u6A21\u578B\nonnx_model = onnx.load(model_path)\n'})}),"\n",(0,r.jsx)(n.h2,{id:"\u52A0\u8F7D\u6D4B\u8BD5\u56FE\u50CF",children:"\u52A0\u8F7D\u6D4B\u8BD5\u56FE\u50CF"}),"\n",(0,r.jsxs)(n.p,{children:["\u8BE5\u6A21\u578B\u63A5\u6536\u5927\u5C0F\u4E3A 224x224 \u7684\u5355\u4E2A\u56FE\u50CF\u4F5C\u4E3A\u8F93\u5165\uFF0C\u8F93\u51FA\u6CBF\u6BCF\u4E2A\u8F74\u653E\u5927 3 \u500D\u7684\u56FE\u50CF\uFF08\u5373\u5927\u5C0F\u4E3A 672x672\uFF09\u3002\u4E3A\u9002\u914D\u8F93\u5165\u7684 shape\uFF0C\u91CD\u65B0\u7F29\u653E\u732B\u56FE\u50CF\uFF0C\u5E76\u8F6C\u6362\u4E3A ",(0,r.jsx)(n.em,{children:"YCbCr"}),"\u3002\u7136\u540E\u8D85\u5206\u8FA8\u7387\u6A21\u578B\u5E94\u7528\u4E8E\u4EAE\u5EA6\uFF08",(0,r.jsx)(n.em,{children:"Y"}),"\uFF09\u901A\u9053\u3002"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'from PIL import Image\n\nimg_url = "https://github.com/dmlc/mxnet.js/blob/main/data/cat.png?raw=true"\nimg_path = download_testdata(img_url, "cat.png", module="data")\nimg = Image.open(img_path).resize((224, 224))\nimg_ycbcr = img.convert("YCbCr")  # convert to YCbCr\nimg_y, img_cb, img_cr = img_ycbcr.split()\nx = np.array(img_y)[np.newaxis, np.newaxis, :, :]\n'})}),"\n",(0,r.jsx)(n.h2,{id:"\u4F7F\u7528-relay-\u7F16\u8BD1\u6A21\u578B",children:"\u4F7F\u7528 Relay \u7F16\u8BD1\u6A21\u578B"}),"\n",(0,r.jsxs)(n.p,{children:["\u901A\u5E38 ONNX \u6A21\u578B\u5C06\u8F93\u5165\u503C\u4E0E\u53C2\u6570\u503C\u6DF7\u5408\u5728\u4E00\u8D77\uFF0C\u8F93\u5165\u540D\u79F0\u4E3A ",(0,r.jsx)(n.em,{children:"1"}),"\uFF0C\u5177\u4F53\u8981\u67E5\u770B\u6A21\u578B\u6587\u6863\u6765\u786E\u5B9A\u5B8C\u6574\u7684\u8F93\u5165\u548C\u53C2\u6570\u540D\u79F0\u7A7A\u95F4\u3002"]}),"\n",(0,r.jsxs)(n.p,{children:["\u5C06 shape \u5B57\u5178\u4F20\u7ED9 ",(0,r.jsx)(n.em,{children:"relay.frontend.from_onnx"})," \u65B9\u6CD5\uFF0C\u4EE5\u4FBF Relay \u77E5\u9053\u54EA\u4E9B ONNX \u53C2\u6570\u662F\u8F93\u5165\uFF0C\u54EA\u4E9B\u662F\u53C2\u6570\uFF0C\u5E76\u63D0\u4F9B\u8F93\u5165\u5C3A\u5BF8\u7684\u9759\u6001\u5B9A\u4E49\uFF1A"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'target = "llvm"\n\ninput_name = "1"\nshape_dict = {input_name: x.shape}\nmod, params = relay.frontend.from_onnx(onnx_model, shape_dict)\n\nwith tvm.transform.PassContext(opt_level=1):\n    executor = relay.build_module.create_executor(\n        "graph", mod, tvm.cpu(0), target, params\n    ).evaluate()\n'})}),"\n",(0,r.jsx)(n.p,{children:"\u8F93\u51FA\u7ED3\u679C\uFF1A"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"/workspace/python/tvm/relay/frontend/onnx.py:5785: UserWarning: Mismatched attribute type in ' : kernel_shape'\n\n==> Context: Bad node spec for node. Name:  OpType: Conv\n  warnings.warn(str(e))\n/workspace/python/tvm/driver/build_module.py:268: UserWarning: target_host parameter is going to be deprecated. Please pass in tvm.target.Target(target, host=target_host) instead.\n  \"target_host parameter is going to be deprecated. \"\n"})}),"\n",(0,r.jsx)(n.h2,{id:"\u5728-tvm-\u4E0A\u6267\u884C",children:"\u5728 TVM \u4E0A\u6267\u884C"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'dtype = "float32"\ntvm_output = executor(tvm.nd.array(x.astype(dtype))).numpy()\n'})}),"\n",(0,r.jsx)(n.h2,{id:"\u67E5\u770B\u7ED3\u679C",children:"\u67E5\u770B\u7ED3\u679C"}),"\n",(0,r.jsxs)(n.p,{children:["\u5C06\u8F93\u5165\u548C\u8F93\u51FA\u56FE\u50CF\u653E\u5728\u4E00\u8D77\u6BD4\u5BF9\u3002\u4EAE\u5EA6\u901A\u9053 ",(0,r.jsx)(n.em,{children:"Y"}),"\u662F\u6A21\u578B\u7684\u8F93\u51FA\u3002\u5C06\u8272\u5EA6\u901A\u9053 ",(0,r.jsx)(n.em,{children:"Cb"})," \u548C ",(0,r.jsx)(n.em,{children:"Cr"})," \u8C03\u6574\u5230\u5339\u914D\u7B80\u5355\u7684\u53CC\u4E09\u6B21\u7B97\u6CD5\uFF0C\u7136\u540E\u5C06\u56FE\u50CF\u91CD\u65B0\u7EC4\u5408\uFF0C\u5E76\u8F6C\u6362\u56DE ",(0,r.jsx)(n.em,{children:"RGB"}),"\u3002"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'from matplotlib import pyplot as plt\n\nout_y = Image.fromarray(np.uint8((tvm_output[0, 0]).clip(0, 255)), mode="L")\nout_cb = img_cb.resize(out_y.size, Image.BICUBIC)\nout_cr = img_cr.resize(out_y.size, Image.BICUBIC)\nresult = Image.merge("YCbCr", [out_y, out_cb, out_cr]).convert("RGB")\ncanvas = np.full((672, 672 * 2, 3), 255)\ncanvas[0:224, 0:224, :] = np.asarray(img)\ncanvas[:, 672:, :] = np.asarray(result)\nplt.imshow(canvas.astype(np.uint8))\nplt.show()\n'})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{src:"https://tvm.apache.org/docs/_images/sphx_glr_from_onnx_001.png",alt:"from onnx"})}),"\n",(0,r.jsx)(n.p,{children:"\u8F93\u51FA\u7ED3\u679C\uFF1A"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"/workspace/gallery/how_to/compile_models/from_onnx.py:120: DeprecationWarning: BICUBIC is deprecated and will be removed in Pillow 10 (2023-07-01). Use Resampling.BICUBIC instead.\n  out_cb = img_cb.resize(out_y.size, Image.BICUBIC)\n/workspace/gallery/how_to/compile_models/from_onnx.py:121: DeprecationWarning: BICUBIC is deprecated and will be removed in Pillow 10 (2023-07-01). Use Resampling.BICUBIC instead.\n  out_cr = img_cr.resize(out_y.size, Image.BICUBIC)\n"})}),"\n",(0,r.jsx)(n.h2,{id:"\u6CE8\u610F",children:"\u6CE8\u610F"}),"\n",(0,r.jsx)(n.p,{children:"ONNX \u5BFC\u5165\u5668\u5728\u5BFC\u5165\u65F6\u9ED8\u8BA4\u6839\u636E\u52A8\u6001 shape \u5B9A\u4E49\u6A21\u578B\uFF0C\u7F16\u8BD1\u5668\u5728\u7F16\u8BD1\u65F6\u5C06\u6A21\u578B\u8F6C\u6362\u4E3A\u9759\u6001 shape\u3002\u5982\u679C\u5931\u8D25\uFF0C\u6A21\u578B\u4E2D\u53EF\u80FD\u4ECD\u5B58\u5728\u52A8\u6001\u64CD\u4F5C\u3002\u76EE\u524D\u5E76\u975E\u6240\u6709 TVM \u5185\u6838\u90FD\u652F\u6301\u52A8\u6001 shape\uFF0C\u5982\u679C\u9047\u5230\u52A8\u6001\u5185\u6838\u9519\u8BEF\uFF0C\u8BF7\u5728 discuss.tvm.apache.org \u4E0A\u63D0\u4EA4 issue\u3002"}),"\n",(0,r.jsx)(n.p,{children:"\u8FD9\u4E2A\u7279\u5B9A\u7684\u6A21\u578B\u662F\u7528\u65E7\u7248\u672C\u7684 ONNX \u6784\u5EFA\u7684\u3002\u5728\u5BFC\u5165\u9636\u6BB5\uFF0CONNX \u5BFC\u5165\u5668\u8FD0\u884C ONNX \u9A8C\u8BC1\u7A0B\u5E8F\uFF08\u53EF\u80FD\u629B\u51FA\u5C5E\u6027\u7C7B\u578B\u4E0D\u5339\u914D\u7684\u8B66\u544A\uFF09\u3002\u7531\u4E8E TVM \u652F\u6301\u8BB8\u591A\u4E0D\u540C\u7684 ONNX \u7248\u672C\uFF0C\u6240\u4EE5 Relay \u6A21\u578B\u4ECD\u7136\u6709\u6548\u3002"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.a,{href:"https://tvm.apache.org/docs/_downloads/eb551cfff8900ec35fae9f15aa728e45/from_onnx.py",children:"\u4E0B\u8F7D Python \u6E90\u4EE3\u7801\uFF1Afrom_onnx.py"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.a,{href:"https://tvm.apache.org/docs/_downloads/779f52a44f2b8ab22dc21eee0c27fd4d/from_onnx.ipynb",children:"\u4E0B\u8F7D Jupyter Notebook\uFF1Afrom_onnx.ipynb"})})]})}function p(e={}){let{wrapper:n}={...(0,a.a)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},21494:function(e,n,o){o.d(n,{Z:function(){return i},a:function(){return s}});var t=o(39546);let r={},a=t.createContext(r);function s(e){let n=t.useContext(a);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:s(e.components),t.createElement(a.Provider,{value:n},e.children)}}}]);