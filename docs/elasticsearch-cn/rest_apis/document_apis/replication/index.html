<!doctype html>
<html lang="zh" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-rest_apis/document_apis/replication">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">读写文档 | Elasticsearch 中文文档</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://lzw.me/docs/elasticsearch-cn/rest_apis/document_apis/replication"><meta data-rh="true" name="docusaurus_locale" content="zh"><meta data-rh="true" name="docsearch:language" content="zh"><meta data-rh="true" name="keywords" content="Elastic,Elasticsearch,Elasticsearch api,ElasticStack,ELK,Document,docs,文档,中文文档,入门"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="读写文档 | Elasticsearch 中文文档"><meta data-rh="true" name="description" content="简介"><meta data-rh="true" property="og:description" content="简介"><link data-rh="true" rel="icon" href="/docs/elasticsearch-cn/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://lzw.me/docs/elasticsearch-cn/rest_apis/document_apis/replication"><link data-rh="true" rel="alternate" href="https://lzw.me/docs/elasticsearch-cn/rest_apis/document_apis/replication" hreflang="zh"><link data-rh="true" rel="alternate" href="https://lzw.me/docs/elasticsearch-cn/rest_apis/document_apis/replication" hreflang="x-default"><script src="https://lzw.me/x/lib/utils/h5-common.min.js"></script><link rel="stylesheet" href="/docs/elasticsearch-cn/assets/css/styles.a40c990e.css">
<link rel="preload" href="/docs/elasticsearch-cn/assets/js/runtime~main.4a16cc88.js" as="script">
<link rel="preload" href="/docs/elasticsearch-cn/assets/js/main.15caa9bc.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/docs/elasticsearch-cn/"><div class="navbar__logo"><img src="/docs/elasticsearch-cn/img/favicon.ico" alt="elasticsearch Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/docs/elasticsearch-cn/img/favicon.ico" alt="elasticsearch Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Elasticsearch 中文文档</b></a></div><div class="navbar__items navbar__items--right"><a href="https://lzw.me/docs/elasticsearch-cn/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">首页<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://docs.bookhub.tech" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">中文文档<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://github.com/dev2007/elasticsearch-doc" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub 仓库"></a><div class="searchBox_ZlJk"><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input type="search" id="search_input_react" placeholder="Loading..." aria-label="Search" class="navbar__search-input search-bar" disabled=""></div></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/elasticsearch-cn/">Elasticsearch 翻译说明</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/elasticsearch-cn/intro/">什么是 Elasticsearch？</a><button aria-label="打开/收起侧边栏菜单「什么是 Elasticsearch？」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/elasticsearch-cn/getting_started/">Elasticsearch 入门</a><button aria-label="打开/收起侧边栏菜单「Elasticsearch 入门」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/elasticsearch-cn/set_up_elasticsearch/">设置 Elasticsearch</a><button aria-label="打开/收起侧边栏菜单「设置 Elasticsearch」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/elasticsearch-cn/index_modules/">索引模块</a><button aria-label="打开/收起侧边栏菜单「索引模块」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/elasticsearch-cn/rest_apis/">REST API</a><button aria-label="打开/收起侧边栏菜单「REST API」" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/elasticsearch-cn/rest_apis/api_convention/">API 约定</a><button aria-label="打开/收起侧边栏菜单「API 约定」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/elasticsearch-cn/rest_apis/autoscaling_apis/">自动伸缩 API</a><button aria-label="打开/收起侧边栏菜单「自动伸缩 API」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/elasticsearch-cn/rest_apis/behavioral_analytics_apis/">行为分析 API</a><button aria-label="打开/收起侧边栏菜单「行为分析 API」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/elasticsearch-cn/rest_apis/cluster_apis/">集群 API</a><button aria-label="打开/收起侧边栏菜单「集群 API」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/elasticsearch-cn/rest_apis/data_stream_apis/">数据流 API</a><button aria-label="打开/收起侧边栏菜单「数据流 API」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/docs/elasticsearch-cn/rest_apis/document_apis/">文档 API</a><button aria-label="打开/收起侧边栏菜单「文档 API」" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/elasticsearch-cn/rest_apis/document_apis/replication">读写文档</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/elasticsearch-cn/rest_apis/document_apis/docs_index">索引 API</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/elasticsearch-cn/rest_apis/document_apis/get">获取 API</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/elasticsearch-cn/rest_apis/document_apis/delete">删除 API</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/elasticsearch-cn/rest_apis/document_apis/delete_by_query">按查询删除 API</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/elasticsearch-cn/rest_apis/document_apis/update">更新 API</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/elasticsearch-cn/rest_apis/document_apis/update_by_query">按查询更新 API</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/elasticsearch-cn/rest_apis/document_apis/multi_get">多重获取（mget） API</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/elasticsearch-cn/rest_apis/document_apis/bulk">批量 API</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/elasticsearch-cn/rest_apis/document_apis/reindex">重索引 API</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/elasticsearch-cn/rest_apis/document_apis/termvectors">词向量 API</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/elasticsearch-cn/rest_apis/document_apis/multi_termvectors">多词向量 API</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/elasticsearch-cn/rest_apis/document_apis/refresh">?refresh</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/elasticsearch-cn/rest_apis/document_apis/optimistic_concurrency_control">乐观并发控制</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/elasticsearch-cn/rest_apis/index_apis/">索引 API</a><button aria-label="打开/收起侧边栏菜单「索引 API」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/elasticsearch-cn/rest_apis/search_apis/">搜索相关 API</a><button aria-label="打开/收起侧边栏菜单「搜索相关 API」" type="button" class="clean-btn menu__caret"></button></div></li></ul></li></ul></nav><button type="button" title="收起侧边栏" aria-label="收起侧边栏" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/docs/elasticsearch-cn/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/elasticsearch-cn/rest_apis/"><span itemprop="name">REST API</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/elasticsearch-cn/rest_apis/document_apis/"><span itemprop="name">文档 API</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">读写文档</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><h1>读写文档</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="简介">简介<a href="#简介" class="hash-link" aria-label="简介的直接链接" title="简介的直接链接">​</a></h2><p>Elasticsearch 中的每个索引都被<a href="/docs/elasticsearch-cn/intro/scalability">划分为分片</a>，每个分片可以有多个副本。这些副本被称为复制组，在添加或删除文档时必须保持同步。如果我们做不到这一点，从一个副本读取的结果就会与从另一个副本读取的结果大相径庭。保持分片副本同步并提供读取服务的过程就是我们所说的<em>数据复制模型</em>。</p><p>Elasticsearch 的数据复制模型基于主备份模型，在微软研究院的 <a href="https://www.microsoft.com/en-us/research/publication/pacifica-replication-in-log-based-distributed-storage-systems/" target="_blank" rel="noopener noreferrer">PacificA 论文</a>中有详细描述。该模型的基础是复制组中的单个副本作为主分片。其他副本称为副本分片。主分片是所有索引操作的主要入口。它负责验证这些操作并确保其正确性。一旦主分区接受了索引操作，主分区还负责将该操作复制到其他副本。</p><p>本节旨在对 Elasticsearch 复制模型进行高层概述，并讨论它对写操作和读操作之间各种交互的影响。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="基本写模型">基本写模型<a href="#基本写模型" class="hash-link" aria-label="基本写模型的直接链接" title="基本写模型的直接链接">​</a></h2><p>Elasticsearch 中的每个索引操作都会首先通过<a href="/docs/elasticsearch-cn/rest_apis/document_apis/docs_index#%E8%B7%AF%E7%94%B1">路由</a>（通常基于文档 ID）解析到一个复制组。一旦确定了复制组，操作就会在内部转发到该组的当前主分区。索引编制的这一阶段被称为<em>协调阶段</em>。</p><p>索引的下一个阶段是在主分区上执行的<em>主分区阶段</em>。主分区负责验证操作并将其转发给其他副本。由于副本可能处于离线状态，因此主分片不需要复制到所有副本。相反，Elasticsearch 会维护一个应接收操作的分片副本列表。该列表称为<em>同步副本</em>，由主节点维护。顾名思义，这些是一组 &quot;良好 &quot;的分片副本，它们保证已经处理了所有向用户确认的索引和删除操作。主分片负责维护这一不变性，因此必须将所有操作复制到这一组中的每个副本。</p><p>主分区遵循以下基本流程</p><ol><li>验证传入的操作，如果结构上无效，则拒绝该操作（例如：有一个对象字段，而该字段应为数字）</li><li>在本地执行操作，即索引或删除相关文档。这也会验证字段的内容，并在必要时拒绝（例如：关键字值太长，不适合 Lucene 索引）。</li><li>将操作转发给当前同步副本集中的每个副本。如果有多个副本，则会并行执行。</li><li>一旦所有同步副本都成功执行了操作并向主副本做出响应，主副本就会向客户端确认请求已成功完成。</li></ol><p>每个同步副本在本地执行索引操作，以便拥有一个副本。这个索引阶段就是<em>副本阶段</em>。</p><p>这些索引阶段（协调、主要和副本）都是顺序进行的。为实现内部重试，每个阶段的生命周期都包含后续每个阶段的生命周期。例如，协调阶段在每个主阶段（可能分布在不同的主分片上）完成之前不会完成。在同步副本完成本地文档索引并响应副本请求之前，每个主阶段都不会完成。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="失败处理">失败处理<a href="#失败处理" class="hash-link" aria-label="失败处理的直接链接" title="失败处理的直接链接">​</a></h2><p>在索引编制过程中，很多事情都可能出错：磁盘可能损坏，节点之间可能断开连接，或者某些配置错误可能导致副本上的操作失败，尽管该操作在主节点上是成功的。这些情况并不常见，但主节点必须对此做出响应。</p><p>如果主节点本身发生故障，托管主节点的节点将向主节点发送相关消息。索引操作将等待（<a href="/docs/elasticsearch-cn/index_modules/index_modules#%E5%8A%A8%E6%80%81%E7%B4%A2%E5%BC%95%E8%AE%BE%E7%BD%AE">默认</a>情况下最长 1 分钟）主节点将其中一个副本提升为主节点。然后，操作将被转发到新的主服务器进行处理。请注意，主节点还会监控节点的健康状况，并可能决定主动降级主节点。这种情况通常发生在持有主节点的节点因网络问题与集群隔离时。更多详情，参阅<a href="#%E5%A6%82%E6%9E%9C%E6%B2%A1%E6%9C%89%E5%89%AF%E6%9C%AC%E4%BC%9A%E6%80%8E%E6%A0%B7">此处</a>。</p><p>在主节点上成功执行操作后，主节点在副本分片上执行操作时必须处理潜在的故障。这可能是由于副本上的实际故障，也可能是由于网络问题导致操作无法到达副本（或副本无法响应）。所有这些情况的最终结果都是一样的：作为同步副本集一部分的副本会错过即将确认的操作。为了避免违反不变式，主节点会向主节点发送信息，要求将有问题的分片从同步副本集中移除。只有当主节点确认删除分块后，主节点才会确认该操作。请注意，主节点还会指示另一个节点开始构建新的分片副本，以便将系统恢复到健康状态。</p><p>在向副本转发操作时，主节点将使用副本来验证自己是否仍是活动主节点。如果主控因网络分区（或长时间 GC）而被隔离，它可能会在意识到自己已被降级之前继续处理传入的索引操作。来自过期主节点的操作将被副本拒绝。当主节点收到副本因其不再是主节点而拒绝其请求的响应时，它就会与主节点联系，并得知自己已被替换。然后，操作将被路由到新的主节点。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="如果没有副本会怎样">如果没有副本会怎样？<a href="#如果没有副本会怎样" class="hash-link" aria-label="如果没有副本会怎样？的直接链接" title="如果没有副本会怎样？的直接链接">​</a></h3><p>这是一种有效的情况，可能是由于索引配置，也可能仅仅是因为所有副本都失败了。在这种情况下，主分片会在没有任何外部验证的情况下处理操作，这看起来可能会有问题。另一方面，主分片无法自行使其他分片失效，只能请求主分片代其失效。这意味着主分片知道主分片是唯一的一个良好副本。因此，我们可以保证主分区不会将任何其他（过时的）分区副本提升为新的主分区，并且任何索引到主分区的操作都不会丢失。当然，由于此时我们只使用单一数据副本，物理硬件问题可能会导致数据丢失。参阅<a href="/docs/elasticsearch-cn/rest_apis/document_apis/docs_index#%E6%B4%BB%E5%8A%A8%E5%88%86%E7%89%87">活动分片</a>了解一些缓解方案。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="基本读取模型">基本读取模型<a href="#基本读取模型" class="hash-link" aria-label="基本读取模型的直接链接" title="基本读取模型的直接链接">​</a></h2><p>Elasticsearch 中的读取可以是非常轻量级的 ID 查找，也可以是需要消耗大量 CPU 性能的复杂聚合搜索请求。主备份模型的优点之一是，它能使所有分片副本保持一致（飞行中的操作除外）。因此，一个同步副本就足以满足读取请求。</p><p>当一个节点收到读取请求时，该节点负责将其转发给持有相关分片的节点，整理响应并回复客户端。我们称该节点为该请求的协调节点。基本流程如下：</p><ol><li>将读取请求解析到相关分片。请注意，由于大多数搜索都会发送到一个或多个索引，因此通常需要从多个分片读取数据，每个分片代表不同的数据子集。</li><li>从分片复制组中选择每个相关分片的活动副本。这可以是主副本，也可以是副本。默认情况下，Elasticsearch 使用<a href="/docs/elasticsearch-cn/search_your_data/the_search_api/search_shard_routing">自适应副本选择</a>来选择分片副本。</li><li>向所选副本发送分片级读取请求。</li><li>合并结果并做出响应。请注意，在通过 ID 查找获取的情况下，只有一个分片是相关的，因此可以跳过这一步。</li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="分片失败">分片失败<a href="#分片失败" class="hash-link" aria-label="分片失败的直接链接" title="分片失败的直接链接">​</a></h3><p>当分片无法响应读取请求时，协调节点会将请求发送到同一复制组中的另一个分片副本。重复故障会导致没有可用的分片副本。
为确保快速响应，如果一个或多个分片发生故障，以下 API 将响应部分结果：</p><ul><li><a href="/docs/elasticsearch-cn/rest_apis/search_apis/seach">搜索</a></li><li><a href="/docs/elasticsearch-cn/rest_apis/search_apis/multi_search">多重搜索</a></li><li><a href="//rest_apis/document_apis/multi_get" target="_blank" rel="noopener noreferrer">多重获取</a></li></ul><p>包含部分结果的响应仍提供 <code>200 OK</code> HTTP 状态代码。分片失败由响应头的 <code>timed_out</code> 和 <code>_shards</code> 字段表示。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="几个简单的影响">几个简单的影响<a href="#几个简单的影响" class="hash-link" aria-label="几个简单的影响的直接链接" title="几个简单的影响的直接链接">​</a></h3><p>这些基本流程中的每一个都决定了 Elasticsearch 作为一个系统在读取和写入时的行为方式。此外，由于读取和写入请求可以同时执行，因此这两个基本流程会相互影响。这就产生了一些固有的影响：</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="高效读取">高效读取<a href="#高效读取" class="hash-link" aria-label="高效读取的直接链接" title="高效读取的直接链接">​</a></h4><p>在正常运行情况下，每个相关复制组只执行一次读操作。只有在故障情况下，同一分片的多个副本才会执行相同的搜索。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="读取未确认">读取未确认<a href="#读取未确认" class="hash-link" aria-label="读取未确认的直接链接" title="读取未确认的直接链接">​</a></h4><p>由于主分区首先在本地建立索引，然后复制请求，因此并发读取有可能在确认之前就已看到更改。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="默认双副本">默认双副本<a href="#默认双副本" class="hash-link" aria-label="默认双副本的直接链接" title="默认双副本的直接链接">​</a></h4><p>这种模式可以容错，同时只维护两个数据副本。这与基于法定人数的系统形成鲜明对比，后者的容错副本最少为 3 份。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="失败">失败<a href="#失败" class="hash-link" aria-label="失败的直接链接" title="失败的直接链接">​</a></h2><p>在故障情况下，可能出现以下情况：</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="单个分区会降低索引速度">单个分区会降低索引速度<a href="#单个分区会降低索引速度" class="hash-link" aria-label="单个分区会降低索引速度的直接链接" title="单个分区会降低索引速度的直接链接">​</a></h3><p>由于主分区在每次操作过程中都会等待同步副本集中的所有副本，因此单个慢分区会拖慢整个复制组的速度。这就是我们为上述读取效率付出的代价。当然，单个慢分区也会拖慢路由到它的不幸搜索。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="脏读">脏读<a href="#脏读" class="hash-link" aria-label="脏读的直接链接" title="脏读的直接链接">​</a></h3><p>孤立的主分区可能会暴露出不被确认的写入。造成这种情况的原因是，被隔离的主分片只有在向其副本发送请求或与主分片联系时才会意识到自己被隔离了。此时，操作已被编入主索引，可以通过并发读取进行读取。Elasticsearch 通过每秒 ping 一次主索引（默认情况下）以及在不知道主索引的情况下拒绝索引操作来降低这种风险。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="冰山一角">冰山一角<a href="#冰山一角" class="hash-link" aria-label="冰山一角的直接链接" title="冰山一角的直接链接">​</a></h2><p>本文档提供了 Elasticsearch 如何处理数据的高层概述。当然，引擎盖下还有更多工作要做。主条件、集群状态发布和主选举等都对系统的正常运行起着重要作用。本文档也不包括已知和重要的 bug（包括已关闭和开放的）。我们认识到 <a href="https://github.com/elastic/elasticsearch/issues?q=label%3Aresiliency" target="_blank" rel="noopener noreferrer">GitHub 很难跟上时代的步伐</a>。为了帮助大家了解这些问题，我们在网站上维护了一个专门的<a href="https://www.elastic.co/guide/en/elasticsearch/resiliency/current/index.html" target="_blank" rel="noopener noreferrer">弹性页面</a>。我们强烈建议您阅读该页面。</p><blockquote><p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-replication.html" target="_blank" rel="noopener noreferrer">原文链接</a></p></blockquote></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文件选项卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/elasticsearch-cn/rest_apis/document_apis/"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">文档 API</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/elasticsearch-cn/rest_apis/document_apis/docs_index"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">索引 API</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#简介" class="table-of-contents__link toc-highlight">简介</a></li><li><a href="#基本写模型" class="table-of-contents__link toc-highlight">基本写模型</a></li><li><a href="#失败处理" class="table-of-contents__link toc-highlight">失败处理</a><ul><li><a href="#如果没有副本会怎样" class="table-of-contents__link toc-highlight">如果没有副本会怎样？</a></li></ul></li><li><a href="#基本读取模型" class="table-of-contents__link toc-highlight">基本读取模型</a><ul><li><a href="#分片失败" class="table-of-contents__link toc-highlight">分片失败</a></li><li><a href="#几个简单的影响" class="table-of-contents__link toc-highlight">几个简单的影响</a></li></ul></li><li><a href="#失败" class="table-of-contents__link toc-highlight">失败</a><ul><li><a href="#单个分区会降低索引速度" class="table-of-contents__link toc-highlight">单个分区会降低索引速度</a></li><li><a href="#脏读" class="table-of-contents__link toc-highlight">脏读</a></li></ul></li><li><a href="#冰山一角" class="table-of-contents__link toc-highlight">冰山一角</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">IT工具</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://tools.lzw.me" target="_blank" rel="noopener noreferrer" class="footer__link-item">有趣工具箱<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://lzw.me/x/reference/" target="_blank" rel="noopener noreferrer" class="footer__link-item">IT速查清单<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">其他文档</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://lzw.me/docs/gemini-cli-learning" target="_blank" rel="noopener noreferrer" class="footer__link-item">Gemini CLI 中文教程<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://lzw.me/docs/quant-wiki" target="_blank" rel="noopener noreferrer" class="footer__link-item">量化百科<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://lzw.me/docs/tvm-cn/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Apache TVM 中文站<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 bookHub.tech</div></div></div></footer></div>
<script src="/docs/elasticsearch-cn/assets/js/runtime~main.4a16cc88.js"></script>
<script src="/docs/elasticsearch-cn/assets/js/main.15caa9bc.js"></script>
<script src="https://lzw.me/x/lib/utils/h5-common.js?v=016"></script></body>
</html>